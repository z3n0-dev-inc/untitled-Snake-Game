<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Z3N0 SNAKE REALM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
:root {
  --void:#000008; --deep:#05050f;
  --panel:rgba(0,255,140,0.04); --border:rgba(0,255,140,0.2);
  --glow:#00ff8c; --glow2:#ff2244; --glow3:#aa44ff;
  --gold:#ffd700; --text:#c8ffd4; --dim:rgba(200,255,212,0.5);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--void);}
body{font-family:'Rajdhani',sans-serif;color:var(--text);}
/* CRT scanline overlay */
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,140,0.012) 2px,rgba(0,255,140,0.012) 4px);pointer-events:none;z-index:9999;}

#gameCanvas{position:fixed;inset:0;display:none;cursor:none;}
#cursor{position:fixed;width:18px;height:18px;border:2px solid var(--glow);border-radius:50%;pointer-events:none;z-index:10000;transform:translate(-50%,-50%);box-shadow:0 0 10px var(--glow),inset 0 0 5px rgba(0,255,140,0.3);}
#cursor::after{content:'';position:absolute;top:50%;left:50%;width:4px;height:4px;background:var(--glow);border-radius:50%;transform:translate(-50%,-50%);}

.screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;}
.screen.hidden{display:none!important;}

/* ===== MENU ===== */
#menuScreen{background:radial-gradient(ellipse at 50% 30%,rgba(0,255,140,0.07) 0%,transparent 60%),radial-gradient(ellipse at 80% 70%,rgba(170,68,255,0.05) 0%,transparent 50%),var(--void);flex-direction:column;gap:0;}
.menu-bg-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.mp{position:absolute;width:2px;height:2px;background:var(--glow);border-radius:50%;animation:float-up linear infinite;opacity:0;}
@keyframes float-up{0%{opacity:0;transform:translateY(100vh)}10%{opacity:1}90%{opacity:.4}100%{opacity:0;transform:translateY(-20px)}}

.logo-wrap{text-align:center;margin-bottom:20px;position:relative;}
.logo-z3n0{font-family:'Orbitron',monospace;font-size:clamp(52px,9vw,110px);font-weight:900;background:linear-gradient(135deg,#00ff8c,#aa44ff,#ff2244,#ffd700,#00ff8c);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gshift 3s ease infinite;letter-spacing:-2px;line-height:1;filter:drop-shadow(0 0 25px rgba(0,255,140,.45));}
@keyframes gshift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.logo-sub{font-family:'Orbitron',monospace;font-size:clamp(10px,1.8vw,15px);letter-spacing:7px;color:var(--dim);margin-top:4px;}
.logo-owner{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:4px;color:var(--gold);margin-top:5px;animation:pulse 1.5s ease infinite;}
.owner-crown{position:absolute;top:-28px;left:50%;transform:translateX(-50%);font-size:28px;animation:crown-bob 1.5s ease infinite;}
@keyframes crown-bob{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-7px)}}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}

.z3n0-wm{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:10px;letter-spacing:5px;color:rgba(255,215,0,.12);pointer-events:none;white-space:nowrap;}

.menu-panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:22px;width:min(455px,92vw);backdrop-filter:blur(20px);box-shadow:0 0 60px rgba(0,255,140,.04),inset 0 0 60px rgba(0,255,140,.02);position:relative;}
.menu-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--glow),transparent);}

.menu-tabs{display:flex;gap:4px;margin-bottom:14px;border-bottom:1px solid var(--border);padding-bottom:10px;}
.menu-tab-btn{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;padding:6px 12px;border-radius:2px;border:1px solid transparent;cursor:pointer;background:none;color:var(--dim);transition:all .2s;}
.menu-tab-btn:hover{color:var(--glow);border-color:rgba(0,255,140,.2);}
.menu-tab-btn.active{color:var(--glow);border-color:var(--glow);background:rgba(0,255,140,.05);}
.menu-tab-content{display:none;}.menu-tab-content.active{display:block;}

.input-group{display:flex;flex-direction:column;gap:5px;margin-bottom:14px;}
.input-label{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;}
.game-input{background:rgba(0,255,140,.04);border:1px solid rgba(0,255,140,.15);border-radius:2px;padding:11px 14px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:500;outline:none;transition:border-color .2s,box-shadow .2s;width:100%;}
.game-input:focus{border-color:var(--glow);box-shadow:0 0 18px rgba(0,255,140,.1);}

.skin-selector{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;margin-bottom:18px;}
.skin-opt{aspect-ratio:1;border-radius:4px;border:2px solid rgba(255,255,255,.1);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:19px;transition:all .2s;position:relative;overflow:hidden;}
.skin-opt:hover{transform:scale(1.08);border-color:#fff;}
.skin-opt.selected{border-color:var(--glow);box-shadow:0 0 14px rgba(0,255,140,.4);transform:scale(1.12);}
.skin-opt.owner-only{border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.3);}
.skin-opt.owner-only::after{content:'üëë';position:absolute;bottom:1px;right:1px;font-size:9px;}
.skin-opt.locked{opacity:.3;filter:grayscale(1);cursor:not-allowed;}

.btn{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;padding:13px 24px;border-radius:2px;border:none;cursor:pointer;text-transform:uppercase;transition:all .2s;position:relative;overflow:hidden;width:100%;}
.btn::before{content:'';position:absolute;inset:0;background:#fff;opacity:0;transition:opacity .2s;}
.btn:hover::before{opacity:.05;}.btn:active::before{opacity:.1;}
.btn-primary{background:linear-gradient(135deg,rgba(0,255,140,.18),rgba(0,255,140,.08));color:var(--glow);border:1px solid var(--glow);box-shadow:0 0 18px rgba(0,255,140,.12);}
.btn-primary:hover{box-shadow:0 0 35px rgba(0,255,140,.28);transform:translateY(-1px);}
.btn-danger{background:linear-gradient(135deg,rgba(255,34,68,.18),rgba(255,34,68,.08));color:var(--glow2);border:1px solid var(--glow2);}
.btn-gold{background:linear-gradient(135deg,rgba(255,215,0,.18),rgba(255,215,0,.08));color:var(--gold);border:1px solid var(--gold);}
.btn-blue{background:linear-gradient(135deg,rgba(0,180,255,.18),rgba(0,180,255,.08));color:#00ccff;border:1px solid #00ccff;}
.btn-blue:hover{box-shadow:0 0 28px rgba(0,180,255,.28);transform:translateY(-1px);}
.btn-purple{background:linear-gradient(135deg,rgba(170,68,255,.18),rgba(170,68,255,.08));color:#cc88ff;border:1px solid #aa44ff;}
.btn-sm{padding:7px 14px;font-size:9px;}
.btn-row{display:flex;gap:8px;}
.btn-row .btn{flex:1;}

.setting-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(0,255,140,.06);}
.setting-label{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;color:var(--dim);}
.setting-desc{font-size:11px;color:rgba(200,255,212,.3);margin-top:2px;}
.control-radio-group{display:flex;gap:4px;}
.control-radio{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:1px;padding:5px 9px;border-radius:2px;border:1px solid rgba(0,255,140,.15);cursor:pointer;background:none;color:var(--dim);transition:all .15s;}
.control-radio:hover{color:var(--glow);border-color:rgba(0,255,140,.3);}
.control-radio.active{color:var(--glow);border-color:var(--glow);background:rgba(0,255,140,.05);}

/* Account bar */
.account-bar{display:flex;align-items:center;justify-content:space-between;background:rgba(0,200,255,.05);border:1px solid rgba(0,200,255,.18);border-radius:3px;padding:8px 12px;margin-bottom:12px;gap:8px;}
.acct-status{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;}
.acct-status.linked{color:#00ccff;}.acct-status.unlinked{color:rgba(255,120,120,.8);}
.legacy-warn{background:rgba(255,150,0,.07);border:1px solid rgba(255,150,0,.28);border-radius:3px;padding:10px 12px;margin-bottom:12px;font-size:12px;color:rgba(255,200,100,.88);line-height:1.5;}

/* ===== HUD ===== */
#hud{position:fixed;inset:0;pointer-events:none;display:none;z-index:200;}
#hud-score{position:absolute;top:20px;left:50%;transform:translateX(-50%);text-align:center;background:rgba(0,0,8,.7);border:1px solid var(--border);border-radius:3px;padding:8px 18px;backdrop-filter:blur(10px);}
#hud-score .val{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--glow);line-height:1;}
#hud-score .lbl{font-size:9px;letter-spacing:3px;color:var(--dim);}
#hud-score.score-bump{animation:score-bump .25s ease;}
@keyframes score-bump{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.13)}}
#hud-coins{position:absolute;top:20px;left:20px;background:rgba(0,0,8,.7);border:1px solid rgba(255,215,0,.2);border-radius:3px;padding:8px 14px;backdrop-filter:blur(10px);font-family:'Orbitron',monospace;font-size:14px;color:var(--gold);}
#hud-len{position:absolute;top:20px;right:20px;background:rgba(0,0,8,.7);border:1px solid var(--border);border-radius:3px;padding:8px 14px;backdrop-filter:blur(10px);text-align:center;}
#hud-len .val{font-family:'Orbitron',monospace;font-size:18px;color:var(--text);}
#hud-len .lbl{font-size:8px;letter-spacing:2px;color:var(--dim);}

/* Leaderboard */
#leaderboard{position:absolute;right:20px;top:90px;width:180px;background:rgba(0,0,8,.75);border:1px solid var(--border);border-radius:3px;padding:10px;backdrop-filter:blur(10px);}
#lb-title{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;color:var(--dim);margin-bottom:8px;text-align:center;}
.lb-entry{display:flex;align-items:center;gap:5px;padding:3px 0;border-bottom:1px solid rgba(0,255,140,.04);}
.lb-rank{font-family:'Space Mono',monospace;font-size:11px;color:var(--dim);width:24px;flex-shrink:0;}
.lb-rank.top1{color:#ffd700;}.lb-rank.top2{color:#c0c0c0;}.lb-rank.top3{color:#cd7f32;}
.lb-name{font-size:12px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lb-name.is-owner{color:var(--gold);}
.lb-len{font-family:'Space Mono',monospace;font-size:10px;color:var(--dim);width:36px;text-align:right;}
.lb-bot{font-size:8px;color:rgba(180,180,200,.4);margin-left:2px;}

/* Boost bar */
#boost-bar{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:200px;}
.boost-track{height:4px;background:rgba(0,255,140,.1);border-radius:2px;overflow:hidden;}
#boost-fill{height:100%;background:var(--glow);border-radius:2px;transition:width .05s linear;box-shadow:0 0 8px var(--glow);}
.boost-lbl{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:2px;color:var(--dim);text-align:center;margin-bottom:4px;}

/* Kill feed */
#killfeed{position:absolute;left:20px;bottom:80px;width:240px;}
.kf-entry{background:rgba(0,0,8,.8);border-left:2px solid var(--glow2);padding:5px 10px;margin-bottom:4px;font-size:12px;animation:kf-in .3s ease;border-radius:0 2px 2px 0;}
@keyframes kf-in{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}

/* Minimap */
#minimap{position:absolute;bottom:20px;right:20px;border:1px solid rgba(0,255,140,.2);border-radius:2px;overflow:hidden;}
#minimapCanvas{display:block;width:150px;height:150px;}

/* Event banner */
#eventBanner{position:absolute;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,8,.9);border:1px solid var(--glow3);border-radius:3px;padding:8px 20px;font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--glow3);display:none;animation:pulse 1.5s ease infinite;white-space:nowrap;}

/* In-game cosmetics */
#inGameCosmeticsBtn{position:absolute;bottom:20px;left:calc(50% + 130px);transform:translateX(-50%);pointer-events:auto;display:none;}
#ingameCosmeticsPanel{position:fixed;right:0;top:0;height:100%;width:min(340px,90vw);background:rgba(0,0,12,.97);border-left:1px solid var(--border);z-index:500;display:none;overflow-y:auto;padding:20px;}
#ingameCosmeticsPanel::-webkit-scrollbar{width:4px;}
#ingameCosmeticsPanel::-webkit-scrollbar-thumb{background:rgba(0,255,140,.2);border-radius:2px;}
.ingame-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.ingame-panel-title{font-family:'Orbitron',monospace;font-size:12px;letter-spacing:3px;color:var(--glow);}
.coin-hud{display:flex;align-items:center;gap:8px;background:rgba(255,215,0,.06);border:1px solid rgba(255,215,0,.2);border-radius:3px;padding:8px 14px;margin-bottom:14px;}
.coin-amount{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:var(--gold);}
.coin-label{font-size:9px;letter-spacing:2px;color:rgba(255,215,0,.4);}
.equipped-summary{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;font-size:12px;color:var(--dim);}
.cosmetic-section-label{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;color:var(--dim);margin:14px 0 8px;border-bottom:1px solid rgba(0,255,140,.08);padding-bottom:6px;}
.cosmetic-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px;}
.cosmetic-card{background:rgba(0,255,140,.03);border:1px solid rgba(0,255,140,.1);border-radius:3px;padding:10px 6px;text-align:center;position:relative;transition:all .15s;}
.cosmetic-card:hover{border-color:rgba(0,255,140,.25);background:rgba(0,255,140,.06);}
.cosmetic-card.equipped{border-color:var(--glow);background:rgba(0,255,140,.08);}
.cosmetic-card.owned{border-color:rgba(0,255,140,.2);}
.cosmetic-card.locked-shop{opacity:.6;}
.cosmetic-card.owner-only{border-color:rgba(255,215,0,.2);background:rgba(255,215,0,.02);}
.cosmetic-icon{font-size:22px;display:block;margin-bottom:4px;}
.cosmetic-name{font-size:9px;font-family:'Orbitron',monospace;letter-spacing:.5px;color:var(--dim);margin-bottom:4px;}
.equipped-label{position:absolute;top:3px;left:3px;font-size:7px;color:var(--glow);font-family:'Orbitron',monospace;}
.cosmetic-badge{position:absolute;top:3px;right:3px;font-size:11px;}

/* Owner panel */
#owner-tag-hud{position:absolute;top:20px;left:50%;transform:translateX(-50%);margin-top:60px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.3);border-radius:2px;padding:4px 12px;font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:var(--gold);display:none;pointer-events:auto;cursor:pointer;white-space:nowrap;}
#ownerPanel{position:fixed;inset:0;background:rgba(0,0,8,.98);z-index:600;display:flex;}
#ownerPanel.hidden{display:none!important;}
.owner-sidebar{width:200px;background:rgba(255,215,0,.03);border-right:1px solid rgba(255,215,0,.1);display:flex;flex-direction:column;}
.owner-sidebar-header{padding:20px;border-bottom:1px solid rgba(255,215,0,.1);}
.owner-sidebar-header h2{font-family:'Orbitron',monospace;font-size:13px;letter-spacing:2px;color:var(--gold);}
.owner-sidebar-header p{font-size:10px;color:rgba(255,215,0,.4);margin-top:3px;}
.owner-nav{display:flex;flex-direction:column;padding:10px 0;flex:1;}
.owner-nav-btn{padding:11px 18px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .15s;border-left:3px solid transparent;font-size:12px;font-weight:600;color:rgba(255,215,0,.45);background:none;border-top:none;border-right:none;border-bottom:none;text-align:left;font-family:'Rajdhani',sans-serif;}
.owner-nav-btn:hover{background:rgba(255,215,0,.05);color:var(--gold);border-left-color:rgba(255,215,0,.25);}
.owner-nav-btn.active{background:rgba(255,215,0,.07);color:var(--gold);border-left-color:var(--gold);}
.owner-nav-icon{font-size:15px;width:18px;}
.owner-main{flex:1;background:rgba(0,0,8,.98);display:flex;flex-direction:column;overflow:hidden;}
.owner-topbar{padding:14px 22px;border-bottom:1px solid rgba(255,215,0,.1);display:flex;align-items:center;justify-content:space-between;}
.owner-topbar h1{font-family:'Orbitron',monospace;font-size:14px;letter-spacing:3px;color:var(--gold);}
.owner-content{flex:1;overflow-y:auto;padding:22px;}
.owner-content::-webkit-scrollbar{width:4px;}
.owner-content::-webkit-scrollbar-thumb{background:rgba(255,215,0,.18);border-radius:2px;}
.owner-tab{display:none;}.owner-tab.active{display:block;}
.o-card{background:rgba(255,215,0,.025);border:1px solid rgba(255,215,0,.08);border-radius:4px;padding:18px;margin-bottom:14px;}
.o-card h3{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:rgba(255,215,0,.5);margin-bottom:14px;border-bottom:1px solid rgba(255,215,0,.08);padding-bottom:7px;}
.player-table{width:100%;border-collapse:collapse;}
.player-table th{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:rgba(255,215,0,.35);padding:5px 7px;text-align:left;border-bottom:1px solid rgba(255,215,0,.08);}
.player-table td{padding:7px 7px;font-size:12px;border-bottom:1px solid rgba(255,215,0,.04);vertical-align:middle;}
.player-table tr:hover td{background:rgba(255,215,0,.025);}
.o-input{background:rgba(255,215,0,.04);border:1px solid rgba(255,215,0,.15);border-radius:2px;padding:9px 12px;color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;width:100%;margin-bottom:7px;}
.o-input:focus{border-color:var(--gold);box-shadow:0 0 12px rgba(255,215,0,.1);}
.o-select{background:rgba(0,0,0,.5);border:1px solid rgba(255,215,0,.15);border-radius:2px;padding:9px 12px;color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;width:100%;margin-bottom:7px;cursor:pointer;}
.event-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;}
.event-card{background:rgba(170,68,255,.05);border:1px solid rgba(170,68,255,.2);border-radius:4px;padding:14px;text-align:center;cursor:pointer;transition:all .2s;}
.event-card:hover{background:rgba(170,68,255,.1);border-color:var(--glow3);transform:translateY(-2px);}
.event-card .event-icon{font-size:28px;display:block;margin-bottom:6px;}
.event-card .event-name{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;color:var(--glow3);}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
.stat-card{background:rgba(255,215,0,.025);border:1px solid rgba(255,215,0,.08);border-radius:4px;padding:14px;text-align:center;}
.stat-card .sv{font-family:'Orbitron',monospace;font-size:26px;font-weight:900;color:var(--gold);}
.stat-card .sl{font-size:9px;letter-spacing:2px;color:rgba(255,215,0,.35);}
.o-alert{padding:9px 12px;border-radius:2px;margin-bottom:10px;font-size:12px;display:none;}
.o-alert.success{background:rgba(0,255,140,.08);border:1px solid var(--glow);color:var(--glow);}
.o-alert.error{background:rgba(255,34,68,.08);border:1px solid var(--glow2);color:var(--glow2);}

/* Death screen */
#deathScreen{position:fixed;inset:0;background:rgba(0,0,8,.96);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:400;backdrop-filter:blur(6px);}
#deathScreen.hidden{display:none!important;}
.death-title{font-family:'Orbitron',monospace;font-size:clamp(36px,7vw,72px);font-weight:900;color:var(--glow2);animation:death-flash 1.2s ease infinite;margin-bottom:8px;}
@keyframes death-flash{0%,100%{text-shadow:0 0 30px var(--glow2)}50%{text-shadow:0 0 60px var(--glow2),0 0 80px rgba(255,34,68,.5)}}
.death-killer{font-size:14px;color:var(--dim);margin-bottom:20px;letter-spacing:2px;}
.death-stats{display:flex;gap:20px;margin-bottom:28px;}
.ds{text-align:center;}
.ds .dv{font-family:'Orbitron',monospace;font-size:24px;font-weight:900;color:var(--glow);}
.ds .dl{font-size:10px;letter-spacing:3px;color:var(--dim);}
.death-coins{font-family:'Orbitron',monospace;font-size:14px;color:var(--gold);margin-bottom:16px;min-height:20px;}
.death-rank{font-family:'Orbitron',monospace;font-size:12px;color:var(--glow3);margin-bottom:24px;}
.death-btns{display:flex;gap:12px;}
.death-btns .btn{width:160px;}

/* Toasts & messages */
#toast-container{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column;gap:6px;align-items:center;}
.toast{background:rgba(0,0,8,.95);border:1px solid var(--glow);border-radius:2px;padding:8px 18px;font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;color:var(--glow);animation:toast-in .25s ease;white-space:nowrap;}
.toast.error{border-color:var(--glow2);color:var(--glow2);}
.toast.gold{border-color:var(--gold);color:var(--gold);}
@keyframes toast-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
#sysmsg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,8,.9);border:1px solid var(--glow);border-radius:3px;padding:12px 24px;font-family:'Orbitron',monospace;font-size:12px;letter-spacing:2px;color:var(--glow);z-index:1001;display:none;text-align:center;}

#broadcastBanner{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(90deg,rgba(255,215,0,.14),rgba(255,215,0,.04),rgba(255,215,0,.14));border-top:1px solid rgba(255,215,0,.28);padding:9px 22px;font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--gold);text-align:center;z-index:800;display:none;}
#musicControls{position:fixed;bottom:20px;left:20px;z-index:300;display:none;align-items:center;gap:7px;background:rgba(0,0,8,.8);border:1px solid var(--border);border-radius:2px;padding:7px 11px;pointer-events:auto;}
.music-btn{background:none;border:none;cursor:pointer;font-size:14px;padding:2px;opacity:.55;transition:opacity .2s;}
.music-btn:hover{opacity:1;}
.music-vis{display:flex;gap:2px;align-items:center;height:14px;}
.music-bar{width:3px;background:var(--glow);border-radius:2px;animation:music-b linear infinite;}
.music-bar:nth-child(1){height:5px;animation-duration:.4s;}
.music-bar:nth-child(2){height:11px;animation-duration:.6s;}
.music-bar:nth-child(3){height:7px;animation-duration:.5s;}
.music-bar:nth-child(4){height:13px;animation-duration:.7s;}
.music-bar:nth-child(5){height:5px;animation-duration:.45s;}
@keyframes music-b{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.3)}}
.music-paused .music-bar{animation-play-state:paused;}

/* PlayFab modal */
.pf-modal{position:fixed;inset:0;z-index:9000;display:none;background:rgba(0,0,8,.96);backdrop-filter:blur(18px);align-items:center;justify-content:center;}
.pf-modal.open{display:flex;}
.pf-box{background:rgba(0,8,18,.99);border:1px solid rgba(0,200,255,.28);border-radius:6px;padding:30px;width:min(415px,92vw);box-shadow:0 0 55px rgba(0,200,255,.1);position:relative;}
.pf-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#00ccff,transparent);}
.pf-title{font-family:'Orbitron',monospace;font-size:15px;letter-spacing:3px;color:#00ccff;margin-bottom:5px;}
.pf-sub{font-size:11px;color:rgba(0,200,255,.45);margin-bottom:18px;}
.pf-tabs{display:flex;gap:4px;margin-bottom:14px;}
.pf-tab{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;padding:5px 13px;border-radius:2px;border:1px solid transparent;cursor:pointer;background:none;color:rgba(0,200,255,.38);transition:all .2s;}
.pf-tab:hover{color:#00ccff;border-color:rgba(0,200,255,.25);}
.pf-tab.active{color:#00ccff;border-color:#00ccff;background:rgba(0,200,255,.05);}
.pf-content{display:none;}.pf-content.active{display:block;}
.pf-msg{font-size:11px;margin-top:7px;padding:7px;border-radius:2px;display:none;}
.pf-msg.ok{background:rgba(0,255,140,.08);color:var(--glow);border:1px solid rgba(0,255,140,.28);}
.pf-msg.err{background:rgba(255,34,68,.08);color:#ff4466;border:1px solid rgba(255,34,68,.28);}

/* Menu stats */
#menuStats{display:flex;gap:20px;font-size:13px;color:var(--dim);}

@media(max-width:600px){
  .owner-sidebar{width:55px;}
  .owner-nav-btn span{display:none;}
  .owner-sidebar-header h2,.owner-sidebar-header p{display:none;}
}

/* ‚îÄ‚îÄ PERFORMANCE: contain layers ‚îÄ‚îÄ */
#gameCanvas{contain:strict;}

/* Score popup */
.score-pop{position:fixed;font-family:'Orbitron',monospace;font-size:13px;font-weight:900;pointer-events:none;z-index:9997;animation:score-rise 1.4s ease forwards;white-space:nowrap;text-shadow:0 0 12px currentColor;}
@keyframes score-rise{0%{opacity:1;transform:translateY(0) scale(1)}40%{opacity:1;transform:translateY(-30px) scale(1.15)}100%{opacity:0;transform:translateY(-72px) scale(0.8)}}
/* ‚îÄ‚îÄ FPS counter ‚îÄ‚îÄ */
#fps-hud{position:absolute;top:8px;right:8px;font-family:"Space Mono",monospace;font-size:9px;color:rgba(0,255,140,.35);pointer-events:none;letter-spacing:1px;}
/* ‚îÄ‚îÄ XP bar ‚îÄ‚îÄ */
#xp-bar{position:absolute;bottom:32px;left:50%;transform:translateX(-50%);width:160px;}
.xp-track{height:2px;background:rgba(170,68,255,.15);border-radius:2px;}
#xp-fill{height:100%;background:linear-gradient(90deg,#7722ff,#ff44aa);border-radius:2px;width:0%;transition:width .5s ease;}
.xp-lbl{font-family:"Orbitron",monospace;font-size:6px;letter-spacing:2px;color:rgba(170,68,255,.5);text-align:center;margin-bottom:2px;}
/* ‚îÄ‚îÄ Kill streak banner ‚îÄ‚îÄ */
#streak-banner{position:absolute;top:100px;left:50%;transform:translateX(-50%);font-family:"Orbitron",monospace;font-size:13px;letter-spacing:3px;color:var(--gold);opacity:0;pointer-events:none;transition:opacity .2s;text-shadow:0 0 20px var(--gold);white-space:nowrap;}
/* ‚îÄ‚îÄ Border danger ‚îÄ‚îÄ */
#danger-warn{position:absolute;bottom:50%;left:50%;transform:translate(-50%,50%);font-family:"Orbitron",monospace;font-size:12px;letter-spacing:4px;color:#ff2244;opacity:0;pointer-events:none;text-shadow:0 0 16px #ff2244;transition:opacity .2s;}
/* ‚îÄ‚îÄ Screen flash ‚îÄ‚îÄ */
#screen-flash{position:fixed;inset:0;pointer-events:none;z-index:9998;opacity:0;background:transparent;}
/* ‚îÄ‚îÄ Chat ‚îÄ‚îÄ */
#chat-wrap{position:absolute;bottom:75px;left:18px;width:260px;pointer-events:auto;}
#chat-msgs{max-height:100px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;margin-bottom:4px;}
#chat-msgs::-webkit-scrollbar{width:2px;}
#chat-msgs::-webkit-scrollbar-thumb{background:rgba(0,255,140,.15);}
.chat-line{background:rgba(0,0,8,.78);border-left:2px solid var(--glow);padding:2px 7px;font-size:11px;border-radius:0 2px 2px 0;animation:kf-in .2s ease;line-height:1.4;}
.chat-line .cn{color:var(--glow);font-weight:700;}
.chat-line.sys{border-left-color:var(--gold);color:var(--gold);}
#chat-input{width:100%;background:rgba(0,0,8,.92);border:1px solid rgba(0,255,140,.3);border-radius:2px;padding:5px 9px;color:var(--text);font-family:"Rajdhani",sans-serif;font-size:13px;outline:none;display:none;}
#chat-input:focus{border-color:var(--glow);}
#chat-hint{font-family:"Orbitron",monospace;font-size:7px;letter-spacing:2px;color:rgba(0,255,140,.18);margin-bottom:3px;}
/* ‚îÄ‚îÄ Combo popup ‚îÄ‚îÄ */
#combo-pop{position:absolute;top:80px;left:50%;transform:translateX(-50%);font-family:"Orbitron",monospace;font-size:20px;font-weight:900;color:var(--glow2);opacity:0;pointer-events:none;text-shadow:0 0 20px var(--glow2);transition:opacity .3s;white-space:nowrap;}
/* ‚îÄ‚îÄ High score on death ‚îÄ‚îÄ */
.death-hs{font-family:"Orbitron",monospace;font-size:11px;color:var(--gold);letter-spacing:2px;margin-bottom:10px;min-height:18px;}
/* ‚îÄ‚îÄ Leaderboard tweaks ‚îÄ‚îÄ */
.lb-entry{display:flex;align-items:center;gap:5px;padding:2px 0;}
.lb-rank{font-family:"Orbitron",monospace;font-size:9px;width:26px;text-align:center;}
.lb-rank.top1{color:#ffd700;}.lb-rank.top2{color:#c0c0c0;}.lb-rank.top3{color:#cd7f32;}
.lb-name{font-size:12px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px;}
.lb-name.is-owner{color:#ffd700;}
.lb-len{font-family:"Space Mono",monospace;font-size:10px;color:var(--dim);}
.lb-bot{font-size:7px;background:rgba(150,150,255,.15);border-radius:2px;padding:1px 3px;color:rgba(150,150,255,.6);}
/* ‚îÄ‚îÄ Rarity badges on cosmetic cards ‚îÄ‚îÄ */
.rarity-tag{position:absolute;bottom:2px;left:0;right:0;text-align:center;font-size:6px;font-family:"Orbitron",monospace;letter-spacing:1px;opacity:.7;}
.cosmetic-card.r-rare{border-color:rgba(0,160,255,.3);}.cosmetic-card.r-epic{border-color:rgba(160,0,255,.3);}.cosmetic-card.r-legendary{border-color:rgba(255,215,0,.3);}
.r-rare .rarity-tag{color:#00aaff;}.r-epic .rarity-tag{color:#aa44ff;}.r-legendary .rarity-tag{color:#ffd700;}
.cosmetic-card.r-mythic{border-color:rgba(255,50,255,.55);box-shadow:0 0 12px rgba(255,50,255,.18);animation:mythic-pulse 2s ease infinite;}
@keyframes mythic-pulse{0%,100%{box-shadow:0 0 8px rgba(255,50,255,.15)}50%{box-shadow:0 0 22px rgba(255,50,255,.38)}}
.r-mythic .rarity-tag{color:#ff44ff;animation:mythic-text 1s ease infinite;}
@keyframes mythic-text{0%,100%{color:#ff44ff}50%{color:#ffffff}}
/* ‚îÄ‚îÄ Spectate tag ‚îÄ‚îÄ */
#spectate-tag{position:absolute;top:60px;left:50%;transform:translateX(-50%);font-family:"Orbitron",monospace;font-size:9px;letter-spacing:3px;color:rgba(0,255,140,.35);pointer-events:none;display:none;}
</style>
</head>
<body>
<div id="cursor"></div>

<!-- ===================== MENU ===================== -->
<div class="screen" id="menuScreen">
  <div class="menu-bg-particles" id="bgParticles"></div>
  <div class="z3n0-wm">Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0</div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:22px;width:100%;max-width:490px;padding:18px;z-index:1;">
    <div class="logo-wrap">
      <span class="owner-crown">üëë</span>
      <div class="logo-z3n0">Z3N0</div>
      <div class="logo-sub">SNAKE REALM ¬∑ EST. 2026</div>
      <div class="logo-owner">CREATED & OWNED BY Z3N0</div>
    </div>

    <div class="menu-panel">
      <div class="menu-tabs">
        <button class="menu-tab-btn active" data-mtab="play">‚ñ∂ PLAY</button>
        <button class="menu-tab-btn" data-mtab="cosmetics">üé® COSMETICS</button>
        <button class="menu-tab-btn" data-mtab="settings">‚öôÔ∏è SETTINGS</button>
      </div>

      <!-- PLAY TAB -->
      <div class="menu-tab-content active" id="mtab-play">
        <div class="account-bar" id="accountBar">
          <div>
            <div class="acct-status unlinked" id="accountStatusText">‚ö†Ô∏è NO ACCOUNT LINKED</div>
            <div style="font-size:10px;color:rgba(255,255,255,.28);margin-top:2px;" id="accountNameText">Progress saves by name only</div>
          </div>
          <button class="btn btn-blue btn-sm" id="openAccountBtn" onclick="openPFModal()">SIGN IN / CREATE</button>
        </div>
        <div class="legacy-warn" id="legacyWarning" style="display:none;">
          ‚ö†Ô∏è <strong>Legacy account detected.</strong> Create a new account to save progress securely.
          <div class="btn-row" style="margin-top:7px;">
            <button class="btn btn-blue btn-sm" onclick="openPFModal('register')">üîó CREATE ACCOUNT</button>
            <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);" onclick="document.getElementById('legacyWarning').style.display='none'">Dismiss</button>
          </div>
        </div>

        <div class="input-group">
          <span class="input-label">Your Name</span>
          <input class="game-input" id="nameInput" type="text" placeholder="Enter your name..." maxlength="20" autocomplete="off">
        </div>
        <div class="input-group">
          <span class="input-label">Choose Skin</span>
          <div class="skin-selector" id="skinSelector"></div>
        </div>
        <div class="input-group" id="ownerPassGroup" style="display:none;">
          <span class="input-label">üîê Owner Code</span>
          <input class="game-input" id="ownerPass" type="password" placeholder="Enter owner password..." autocomplete="off">
        </div>
        <button class="btn btn-primary" id="playBtn" style="margin-bottom:8px;">‚ñ∂ PLAY</button>
        <div class="btn-row">
          <button class="btn btn-gold btn-sm" id="ownerToggleBtn">üëë OWNER</button>
          <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);" id="howToBtn">? HOW TO PLAY</button>
        </div>
      </div>

      <!-- COSMETICS TAB -->
      <div class="menu-tab-content" id="mtab-cosmetics">
        <div class="coin-hud" style="margin-bottom:10px;">
          <span style="font-size:18px;">üí∞</span>
          <div><div class="coin-amount" id="menuCoinBalance">0</div><div class="coin-label">COINS</div></div>
        </div>
        <p style="font-size:11px;color:var(--dim);margin-bottom:10px;">Enter the game to buy & equip cosmetics.</p>
      </div>

      <!-- SETTINGS TAB -->
      <div class="menu-tab-content" id="mtab-settings">
        <div class="setting-row">
          <div><div class="setting-label">CONTROL SCHEME</div><div class="setting-desc">How you steer</div></div>
          <div class="control-radio-group" id="controlSchemeGroup">
            <button class="control-radio" data-scheme="mouse">üñ±Ô∏è MOUSE</button>
            <button class="control-radio" data-scheme="wasd">WASD</button>
            <button class="control-radio" data-scheme="arrows">ARROWS</button>
            <button class="control-radio" data-scheme="both">WASD+‚Üë</button>
          </div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">BOOST KEY</div><div class="setting-desc">Also: hold click</div></div>
          <div class="control-radio-group" id="boostKeyGroup">
            <button class="control-radio" data-boost="shift">SHIFT</button>
            <button class="control-radio" data-boost="space">SPACE</button>
            <button class="control-radio" data-boost="both_boost">BOTH</button>
          </div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">MOUSE STEERING</div><div class="setting-desc">Even w/ keyboard</div></div>
          <div class="control-radio-group" id="mouseAlwaysGroup">
            <button class="control-radio" data-mouse="on">ON</button>
            <button class="control-radio" data-mouse="off">OFF</button>
          </div>
        </div>
        <div style="margin-top:14px;padding:9px;background:rgba(0,255,140,.03);border:1px solid rgba(0,255,140,.08);border-radius:2px;font-size:11px;color:var(--dim);line-height:1.6;">
          Settings auto-save. ¬∑ Owner panel: <span style="color:var(--gold);">F1</span>
        </div>
      </div>
    </div>

    <div id="menuStats">
      <span>üêç <span id="statPlayers">0</span> online</span>
      <span>ü§ñ <span id="statBots">0</span> bots</span>
      <span>üåü <span id="statOrbs">0</span> orbs</span>
      <span id="statEvent" style="display:none;color:var(--glow3);">‚ö° EVENT</span>
    </div>
    <div style="font-family:'Orbitron',monospace;font-size:8px;letter-spacing:4px;color:rgba(255,215,0,.25);">üëë Z3N0'S SNAKE GAME ‚Äî ALL RIGHTS RESERVED</div>
  </div>
</div>

<!-- ===================== CANVAS ===================== -->
<canvas id="gameCanvas"></canvas>

<!-- ===================== HUD ===================== -->
<div id="hud">
  <div id="hud-coins">üí∞ <span id="hudCoins">0</span></div>
  <div id="hud-score"><div class="val" id="scoreVal">0</div><div class="lbl">SCORE</div></div>
  <div id="hud-len"><div class="val" id="lengthVal">0</div><div class="lbl">LENGTH</div></div>

  <div id="leaderboard">
    <div id="lb-title">LEADERBOARD</div>
    <div id="lbList"></div>
  </div>

  <div id="boost-bar">
    <div class="boost-lbl" id="boostLabel">BOOST [SHIFT/CLICK]</div>
    <div class="boost-track"><div id="boost-fill" style="width:100%;"></div></div>
  </div>

  <div id="killfeed"></div>
  <div id="eventBanner">‚ö° EVENT</div>
  <div id="minimap"><canvas id="minimapCanvas" width="150" height="150"></canvas></div>
  <div id="sysmsg"></div>

  <!-- In-game cosmetics -->
  <button class="btn btn-primary btn-sm" id="inGameCosmeticsBtn" onclick="openIngameCosmetics()" style="pointer-events:auto;">üé® COSMETICS</button>
  <div id="owner-tag-hud">üëë Z3N0 ‚Äî OWNER PANEL [F1]</div>
  <div id="fps-hud">60 FPS</div>
  <div id="xp-bar"><div class="xp-lbl">LV<span id="xpLvl">1</span> ¬∑ <span id="xpRank" style="color:#aa44ff;">NOVICE</span></div><div class="xp-track"><div id="xp-fill"></div></div></div>
  <div id="streak-banner"></div>
  <div id="danger-warn">‚ö† BORDER DANGER ‚ö†</div>
  <div id="combo-pop"></div>
  <div id="spectate-tag">üëÅ SPECTATING</div>
  <div id="chat-wrap"><div id="chat-hint">T = CHAT</div><div id="chat-msgs"></div><input id="chat-input" placeholder="Press Enter to send..." maxlength="80"></div>
  <div id="screen-flash"></div>
</div>

<!-- ===================== IN-GAME COSMETICS ===================== -->
<div id="ingameCosmeticsPanel">
  <div class="ingame-panel-header">
    <div class="ingame-panel-title">üé® COSMETICS</div>
    <button onclick="closeIngameCosmetics()" style="background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;">‚úï</button>
  </div>
  <div class="coin-hud">
    <span style="font-size:18px;">üí∞</span>
    <div><div class="coin-amount" id="ingameCoinBalance">0</div><div class="coin-label">COINS</div></div>
  </div>
  <div class="equipped-summary">
    <span>Trail: <span id="equippedTrailDisplay" style="color:var(--glow);">None</span></span>
    <span> ¬∑ Title: <span id="equippedTitleDisplay" style="color:#aa44ff;">None</span></span>
    <span> ¬∑ Badge: <span id="equippedBadgeDisplay">‚Äî</span></span>
  </div>
  <div id="cosmeticsShopContent"></div>
</div>

<!-- ===================== DEATH SCREEN ===================== -->
<div id="deathScreen" class="screen hidden">
  <div class="death-title">üíÄ GAME OVER</div>
  <div class="death-killer" id="deathKiller">Eliminated</div>
  <div class="death-stats">
    <div class="ds"><div class="dv" id="deathScore">0</div><div class="dl">SCORE</div></div>
    <div class="ds"><div class="dv" id="deathLength">0</div><div class="dl">LENGTH</div></div>
    <div class="ds"><div class="dv" id="deathRank">‚Äî</div><div class="dl">RANK</div></div>
  </div>
  <div class="death-coins" id="deathCoinsEarned"></div>
  <div class="death-hs" id="deathHs"></div>
  <div class="death-btns">
    <button class="btn btn-primary" id="respawnBtn">‚ñ∂ RESPAWN</button>
    <button class="btn btn-danger" id="menuBtn">‚üµ MENU</button>
  </div>
</div>

<!-- ===================== OWNER PANEL ===================== -->
<div id="ownerPanel" class="hidden">
  <div class="owner-sidebar">
    <div class="owner-sidebar-header">
      <h2>üëë Z3N0</h2>
      <p>Owner Panel</p>
    </div>
    <nav class="owner-nav">
      <button class="owner-nav-btn active" data-tab="stats"><span class="owner-nav-icon">üìä</span><span>Stats</span></button>
      <button class="owner-nav-btn" data-tab="players"><span class="owner-nav-icon">üë•</span><span>Players</span></button>
      <button class="owner-nav-btn" data-tab="actions"><span class="owner-nav-icon">‚ö°</span><span>Actions</span></button>
      <button class="owner-nav-btn" data-tab="events"><span class="owner-nav-icon">üåü</span><span>Events</span></button>
      <button class="owner-nav-btn" data-tab="skins"><span class="owner-nav-icon">üé®</span><span>Skins</span></button>
      <button class="owner-nav-btn" data-tab="ownercosmetics"><span class="owner-nav-icon">üëë</span><span>Cosmetics</span></button>
      <button class="owner-nav-btn" data-tab="playfab"><span class="owner-nav-icon">üîß</span><span>PlayFab Catalog</span></button>
    </nav>
  </div>
  <div class="owner-main">
    <div class="owner-topbar">
      <h1>‚ö° OWNER CONTROL CENTER</h1>
      <button class="btn btn-sm btn-danger" id="closeOwnerPanel" style="width:auto;">‚úï CLOSE</button>
    </div>
    <div class="owner-content">
      <div class="o-alert" id="ownerAlert"></div>

      <!-- STATS -->
      <div class="owner-tab active" id="tab-stats">
        <div class="stats-grid">
          <div class="stat-card"><div class="sv" id="os-players">0</div><div class="sl">PLAYERS</div></div>
          <div class="stat-card"><div class="sv" id="os-orbs">0</div><div class="sl">ORBS</div></div>
          <div class="stat-card"><div class="sv" id="os-event">NONE</div><div class="sl">EVENT</div></div>
        </div>
        <div class="o-card"><h3>BROADCAST MESSAGE</h3>
          <input class="o-input" id="broadcastMsg" placeholder="Server announcement...">
          <button class="btn btn-gold" onclick="doBroadcast()">üì¢ BROADCAST</button>
        </div>
      </div>

      <!-- PLAYERS -->
      <div class="owner-tab" id="tab-players">
        <div class="o-card">
          <h3>ONLINE PLAYERS</h3>
          <table class="player-table">
            <thead><tr><th>NAME</th><th>LEN</th><th>SCORE</th><th>COINS</th><th>COSMETICS</th><th>ACTIONS</th></tr></thead>
            <tbody id="playerTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="owner-tab" id="tab-actions">
        <div class="o-card"><h3>GIVE SIZE</h3>
          <select class="o-select" id="sizeTarget"></select>
          <input class="o-input" id="sizeAmount" type="number" placeholder="Segments (e.g. 100)">
          <button class="btn btn-gold" onclick="doGiveSize()">üìè GIVE SIZE</button>
        </div>
        <div class="o-card"><h3>GIVE COINS</h3>
          <select class="o-select" id="coinsTarget"></select>
          <input class="o-input" id="coinsAmount" type="number" placeholder="Amount">
          <button class="btn btn-gold" onclick="doGiveCoins()">üí∞ GIVE COINS</button>
        </div>
        <div class="o-card"><h3>SWAP SIZE</h3>
          <select class="o-select" id="swapP1"></select>
          <select class="o-select" id="swapP2"></select>
          <button class="btn btn-gold" onclick="doSwapSize()">üîÑ SWAP</button>
        </div>
        <div class="o-card"><h3>KICK PLAYER</h3>
          <select class="o-select" id="kickTarget"></select>
          <input class="o-input" id="kickReason" placeholder="Reason...">
          <button class="btn btn-danger" onclick="doKick()">üö´ KICK</button>
        </div>
        <div class="o-card"><h3>INSTA-KILL</h3>
          <select class="o-select" id="killTarget"></select>
          <button class="btn btn-danger" onclick="doInstaKill()">‚ò†Ô∏è KILL</button>
        </div>
        <div class="o-card"><h3>FREEZE PLAYER</h3>
          <select class="o-select" id="freezeTarget"></select>
          <input class="o-input" id="freezeDuration" type="number" placeholder="Duration (ms, e.g. 3000)">
          <button class="btn btn-blue" onclick="doFreeze()">üßä FREEZE</button>
        </div>
        <div class="o-card"><h3>SET PLAYER SIZE</h3>
          <select class="o-select" id="setSizeTarget"></select>
          <input class="o-input" id="setSizeAmount" type="number" placeholder="Exact size (e.g. 500)">
          <button class="btn btn-gold" onclick="doSetSize()">üìê SET SIZE</button>
        </div>
      </div>

      <!-- EVENTS -->
      <div class="owner-tab" id="tab-events">
        <div class="o-card"><h3>START EVENT</h3>
          <div class="event-grid">
            <div class="event-card" onclick="ownerAction('startEvent','speedBoost')"><span class="event-icon">‚ö°</span><div class="event-name">HYPERSPEED</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','orbFrenzy')"><span class="event-icon">üåü</span><div class="event-name">ORB OVERLOAD</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','shrinkAll')"><span class="event-icon">üíÄ</span><div class="event-name">DEATH SHRINK</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','growAll')"><span class="event-icon">üêç</span><div class="event-name">TITAN RISE</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','reverseSteering')"><span class="event-icon">üîÑ</span><div class="event-name">REVERSE CHAOS</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','ghostMode')"><span class="event-icon">üëª</span><div class="event-name">GHOST MODE</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','rainbowOrbs')"><span class="event-icon">üåà</span><div class="event-name">RAINBOW FEAST</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','megaOrbs')"><span class="event-icon">üíé</span><div class="event-name">MEGA ORBS</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','invertColors')"><span class="event-icon">üé®</span><div class="event-name">NEON RAVE</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','coinRain')"><span class="event-icon">üí∞</span><div class="event-name">COIN RAIN</div></div>
            <div class="event-card" onclick="ownerAction('endEvent')"><span class="event-icon">üõë</span><div class="event-name">END EVENT</div></div>
          </div>
        </div>
      </div>

      <!-- SKINS -->
      <div class="owner-tab" id="tab-skins">
        <div class="o-card"><h3>GIVE SKIN</h3>
          <select class="o-select" id="skinTarget"></select>
          <select class="o-select" id="skinToGive">
            <option value="rainbow_god">üåà Rainbow God</option>
            <option value="void_lord">üåë Void Lord</option>
            <option value="galaxy_emperor">üåå Galaxy Emperor</option>
            <option value="neon_death">‚ö° Neon Death</option>
            <option value="chrome_divine">‚ú® Chrome Divine</option>
            <option value="classic">üêç Classic</option>
          </select>
          <button class="btn btn-gold" onclick="doGiveSkin()">üé® GIVE SKIN</button>
        </div>
      </div>

      <!-- OWNER COSMETICS -->
      <div class="owner-tab" id="tab-ownercosmetics">
        <div class="o-card"><h3>GRANT COSMETIC</h3>
          <select class="o-select" id="ownerCosmeticTarget"></select>
          <select class="o-select" id="ownerCosmeticToGive">
            <optgroup label="‚òÖ‚òÖ‚òÖ MYTHIC TRAILS ‚òÖ‚òÖ‚òÖ">
              <option value="owner_trail_genesis">üåå Genesis Storm [MYTHIC]</option>
              <option value="owner_trail_void_rift">üîÆ Void Rift Tear [MYTHIC]</option>
              <option value="owner_trail_divine_wrath">‚ö° Divine Wrath [MYTHIC]</option>
              <option value="owner_trail_cosmos">üå† Cosmos Shatter [MYTHIC]</option>
              <option value="owner_trail_sovereign_m">üëë Sovereign Gold [MYTHIC]</option>
              <option value="owner_trail_nebula">üå∫ Nebula Collapse [MYTHIC]</option>
              <option value="owner_trail_quantum">üî¨ Quantum Rift [MYTHIC]</option>
              <option value="owner_trail_solar_flare">‚òÄÔ∏è Solar Flare [MYTHIC]</option>
              <option value="owner_trail_dark_matter">üåë Dark Matter [MYTHIC]</option>
              <option value="owner_trail_omega">üî± Omega Burst [MYTHIC]</option>
              <option value="owner_trail_prism">üí† Prism Break [MYTHIC]</option>
              <option value="owner_trail_hellfire">üòà Hellfire [MYTHIC]</option>
              <option value="owner_trail_abyss_wave">üëÅÔ∏è Abyss Wave [MYTHIC]</option>
              <option value="owner_trail_supernova">üí• Supernova [MYTHIC]</option>
              <option value="owner_trail_time_rift">‚è≥ Time Rift [MYTHIC]</option>
              <option value="owner_trail_black_hole">üåÄ Black Hole [MYTHIC]</option>
              <option value="owner_trail_dragon_flame">üêâ Dragon Flame [MYTHIC]</option>
              <option value="owner_trail_astral">‚ú® Astral Projection [MYTHIC]</option>
              <option value="owner_trail_crimson_god">ü©∏ Crimson God [MYTHIC]</option>
              <option value="owner_trail_spirit">üëª Spirit Ghost [MYTHIC]</option>
            </optgroup>
            <optgroup label="‚îÄ‚îÄ LEGENDARY TRAILS ‚îÄ‚îÄ">
              <option value="owner_trail_divine">üëë Divine Gold Trail</option>
              <option value="owner_trail_void">üåå Void Rift Trail</option>
              <option value="owner_trail_inferno">üî• INFERNO STORM Trail</option>
              <option value="owner_trail_aurora">üåà Aurora Borealis Trail</option>
              <option value="owner_trail_lightning">‚ö° GODSTRIKE Lightning Trail</option>
              <option value="owner_trail_galaxy">üåÄ Galaxy Spiral Trail</option>
              <option value="owner_trail_blood">ü©∏ Crimson Blood Trail</option>
              <option value="owner_trail_antimatter">üíú Antimatter Trail</option>
              <option value="owner_trail_matrix">üíö Matrix Code Trail</option>
              <option value="owner_trail_angelic">ü§ç Angelic Halo Trail</option>
              <option value="owner_trail_phoenix">ü¶Ö Phoenix Rebirth Trail</option>
              <option value="owner_trail_tsunami">üåä TSUNAMI Wave Trail</option>
              <option value="owner_trail_prismatic">üå† Prismatic Storm Trail</option>
              <option value="owner_trail_singularity">üï≥Ô∏è Singularity Trail</option>
            </optgroup>
            <optgroup label="‚òÖ‚òÖ‚òÖ MYTHIC TITLES ‚òÖ‚òÖ‚òÖ">
              <option value="owner_title_genesis">[GENESIS] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_sovereign">[SOVEREIGN] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_celestial_king">[CELESTIAL KING] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_omega">[OMEGA] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_quantum">[QUANTUM] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_nebula_lord">[NEBULA LORD] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_dark_matter">[DARK MATTER] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_solar_king">[SOLAR KING] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_hellborn">[HELLBORN] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_god_of_death">[GOD OF DEATH] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_universe">[UNIVERSE] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_abyss_king">[ABYSS KING] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_prism_lord">[PRISM LORD] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_time_god">[TIME GOD] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_supernova">[SUPERNOVA] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_black_hole">[BLACK HOLE] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_dragon_god">[DRAGON GOD] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_astral_king">[ASTRAL KING] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_crimson_god">[CRIMSON GOD] ‚òÖ‚òÖ‚òÖ</option>
              <option value="owner_title_void_emperor">[VOID EMPEROR] ‚òÖ‚òÖ‚òÖ</option>
            </optgroup>
            <optgroup label="‚îÄ‚îÄ LEGENDARY TITLES ‚îÄ‚îÄ">
              <option value="owner_title_z3n0">[Z3N0]</option>
              <option value="owner_title_god">[GOD]</option>
              <option value="owner_title_supreme">[SUPREME]</option>
              <option value="owner_title_almighty">[ALMIGHTY]</option>
              <option value="owner_title_deathlord">[DEATHLORD]</option>
              <option value="owner_title_omnipotent">[OMNIPOTENT]</option>
              <option value="owner_title_galaxyking">[GALAXY KING]</option>
              <option value="owner_title_voidwalker">[VOID WALKER]</option>
              <option value="owner_title_serpentgod">[SERPENT GOD]</option>
              <option value="owner_title_transcendent">[TRANSCENDENT]</option>
              <option value="owner_title_eternal">[ETERNAL]</option>
              <option value="owner_title_dimension">[DIMENSION LORD]</option>
              <option value="owner_title_deathbringer">[DEATH BRINGER]</option>
              <option value="owner_title_chaos">[CHAOS]</option>
              <option value="owner_title_celestial">[CELESTIAL]</option>
              <option value="owner_title_singularity">[SINGULARITY]</option>
              <option value="owner_title_creator">[CREATOR]</option>
            </optgroup>
            <optgroup label="‚òÖ‚òÖ‚òÖ MYTHIC BADGES ‚òÖ‚òÖ‚òÖ">
              <option value="owner_badge_sovereign">üëë Sovereign Crown [MYTHIC]</option>
              <option value="owner_badge_genesis">üåå Genesis Eye [MYTHIC]</option>
              <option value="owner_badge_void_heart">üîÆ Void Heart [MYTHIC]</option>
              <option value="owner_badge_celestial_star">‚≠ê Celestial Star [MYTHIC]</option>
              <option value="owner_badge_omega_core">‚öõÔ∏è Omega Core [MYTHIC]</option>
              <option value="owner_badge_quantum_eye">üëÅÔ∏è Quantum Eye [MYTHIC]</option>
              <option value="owner_badge_nebula_heart">üíú Nebula Heart [MYTHIC]</option>
              <option value="owner_badge_solar_flare">‚òÄÔ∏è Solar Flare Core [MYTHIC]</option>
              <option value="owner_badge_dark_matter">üåë Dark Matter Shard [MYTHIC]</option>
              <option value="owner_badge_hellfire">üòà Hellfire Mark [MYTHIC]</option>
              <option value="owner_badge_prism">üí† Prism Crystal [MYTHIC]</option>
              <option value="owner_badge_universe">üåê Universe Core [MYTHIC]</option>
              <option value="owner_badge_abyss">üï∂Ô∏è Abyss Eye [MYTHIC]</option>
              <option value="owner_badge_supernova">üí• Supernova Shard [MYTHIC]</option>
              <option value="owner_badge_time">‚è≥ Time Crystal [MYTHIC]</option>
              <option value="owner_badge_black_hole">üåÄ Black Hole Shard [MYTHIC]</option>
              <option value="owner_badge_dragon_eye">üêâ Dragon Eye [MYTHIC]</option>
              <option value="owner_badge_astral">‚ú® Astral Core [MYTHIC]</option>
              <option value="owner_badge_crimson_heart">ü©∏ Crimson God Heart [MYTHIC]</option>
              <option value="owner_badge_void_emperor">üï≥Ô∏è Void Emperor Seal [MYTHIC]</option>
            </optgroup>
            <optgroup label="‚îÄ‚îÄ LEGENDARY BADGES ‚îÄ‚îÄ">
              <option value="owner_badge_crown">üëë Royal Crown</option>
              <option value="owner_badge_dragon">üêâ Dragon Emperor</option>
              <option value="owner_badge_skull">üíÄ Death Mark</option>
              <option value="owner_badge_lightning">‚ö° Thunder God</option>
              <option value="owner_badge_star">‚≠ê Supreme Star</option>
              <option value="owner_badge_fire">üî• Inferno Lord</option>
              <option value="owner_badge_gem">üíé Diamond Elite</option>
              <option value="owner_badge_infinity">‚ôæÔ∏è Infinite</option>
              <option value="owner_badge_alien">üëΩ Alien Overlord</option>
              <option value="owner_badge_devil">üòà Demon King</option>
              <option value="owner_badge_angel">üòá Celestial Angel</option>
              <option value="owner_badge_nuclear">‚ò¢Ô∏è Nuclear Core</option>
              <option value="owner_badge_trident">üî± God Trident</option>
              <option value="owner_badge_eye">üëÅÔ∏è All-Seeing Eye</option>
              <option value="owner_badge_void">üåë Void Shard</option>
              <option value="owner_badge_galaxy">üåå Galaxy Core</option>
              <option value="owner_badge_singularity">üï≥Ô∏è Singularity Core</option>
            </optgroup>
            <optgroup label="‚îÄ‚îÄ PUBLIC TRAILS (Give to anyone) ‚îÄ‚îÄ">
              <option value="trail_rainbow">üåà Rainbow Trail</option>
              <option value="trail_emerald">üíö Emerald Trail</option>
              <option value="trail_angel">üòá Angel Trail</option>
              <option value="trail_cosmic">üåå Cosmic Trail</option>
              <option value="trail_gold">‚≠ê Gold Trail</option>
              <option value="trail_electric">‚ö° Electric Trail</option>
            </optgroup>
          </select>
                    <button class="btn btn-gold" onclick="doGiveCosmetic()">üé® GRANT</button>
        </div>
      </div><!-- /tab-ownercosmetics -->

      <!-- PLAYFAB CATALOG TAB -->
      <div class="owner-tab" id="tab-playfab">
        <div class="o-card"><h3>PLAYFAB CATALOG JSON</h3>
          <p style="font-size:11px;color:rgba(255,215,0,.4);margin-bottom:10px;">Generate then paste into PlayFab &rsaquo; Economy &rsaquo; Catalog (version: Z3N0_v1)</p>
          <div style="display:flex;gap:6px;margin-bottom:8px;">
            <button class="btn btn-gold" onclick="generateCatalogJSON()" style="flex:1;">&#128203; GENERATE CATALOG</button>
            <button class="btn btn-sm" onclick="copyCatalogJSON()" style="width:auto;padding:7px 14px;border:1px solid rgba(255,215,0,.3);color:rgba(255,215,0,.7);">COPY</button>
          </div>
          <textarea id="catalogJsonOutput" style="width:100%;height:230px;background:rgba(0,0,0,.5);border:1px solid rgba(255,215,0,.18);border-radius:3px;color:rgba(255,215,0,.65);font-family:'Space Mono',monospace;font-size:8.5px;padding:10px;outline:none;resize:vertical;" readonly placeholder="Click Generate Catalog..."></textarea>
        </div>
        <div class="o-card"><h3>CLOUDSCRIPT (Automation)</h3>
          <p style="font-size:11px;color:rgba(255,215,0,.4);margin-bottom:10px;">Paste into PlayFab &rsaquo; Automation &rsaquo; CloudScript. Handles coins, purchases, equip, owner grants.</p>
          <div style="display:flex;gap:6px;margin-bottom:8px;">
            <button class="btn btn-gold" onclick="generateCloudScript()" style="flex:1;">&#128203; GENERATE CLOUDSCRIPT</button>
            <button class="btn btn-sm" onclick="copyCloudScript()" style="width:auto;padding:7px 14px;border:1px solid rgba(255,215,0,.3);color:rgba(255,215,0,.7);">COPY</button>
          </div>
          <textarea id="cloudScriptOutput" style="width:100%;height:230px;background:rgba(0,0,0,.5);border:1px solid rgba(255,215,0,.18);border-radius:3px;color:rgba(255,215,0,.65);font-family:'Space Mono',monospace;font-size:8.5px;padding:10px;outline:none;resize:vertical;" readonly placeholder="Click Generate CloudScript..."></textarea>
        </div>
        <div class="o-card"><h3>REQUIRED TITLE DATA KEYS</h3>
          <div style="font-family:'Space Mono',monospace;font-size:10px;color:rgba(255,215,0,.6);line-height:2.4;">
            <div>Key: <span style="color:#00ff8c">OwnerPassword</span> &rarr; your secret password</div>
            <div>Key: <span style="color:#00ff8c">GameVersion</span> &rarr; 1.0.0</div>
            <div>Key: <span style="color:#00ff8c">CoinMultiplier</span> &rarr; 1</div>
            <div>Key: <span style="color:#00ff8c">MaxPlayers</span> &rarr; 200</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<div id="musicControls">
  <button class="music-btn" id="musicToggle">üéµ</button>
  <div class="music-vis" id="musicVis"><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div></div>
</div>
<div id="broadcastBanner"><span>üëë Z3N0: </span><span id="broadcastText"></span></div>

<!-- ===================== PLAYFAB MODAL ===================== -->
<div class="pf-modal" id="playfabModal">
  <div class="pf-box">
    <button onclick="closePFModal()" style="position:absolute;top:10px;right:12px;background:none;border:none;color:rgba(0,200,255,.4);font-size:17px;cursor:pointer;">‚úï</button>
    <div class="pf-title">üîê PLAYER ACCOUNT</div>
    <div class="pf-sub">Link your progress to a secure account</div>
    <div class="pf-tabs">
      <button class="pf-tab active" id="pf-tab-login" onclick="pfTab('login')">SIGN IN</button>
      <button class="pf-tab" id="pf-tab-register" onclick="pfTab('register')">CREATE NEW</button>
      <button class="pf-tab" id="pf-tab-loggedin" onclick="pfTab('loggedin')" style="display:none;">MY ACCOUNT</button>
    </div>

    <div class="pf-content active" id="pf-login">
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Username or Email</span>
        <input class="game-input" id="pfLoginUser" placeholder="Username or email..." autocomplete="username">
      </div>
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Password</span>
        <input class="game-input" id="pfLoginPass" type="password" placeholder="Password..." autocomplete="current-password">
      </div>
      <button class="btn btn-blue" onclick="pfLogin()" id="pfLoginBtn">SIGN IN</button>
      <div class="pf-msg" id="pfLoginMsg"></div>
    </div>

    <div class="pf-content" id="pf-register">
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Display Name</span>
        <input class="game-input" id="pfRegName" placeholder="Your snake name..." maxlength="20" autocomplete="off">
      </div>
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Username</span>
        <input class="game-input" id="pfRegUser" placeholder="Username..." autocomplete="username">
      </div>
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Email</span>
        <input class="game-input" id="pfRegEmail" type="email" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Password</span>
        <input class="game-input" id="pfRegPass" type="password" placeholder="Min 6 characters..." autocomplete="new-password">
      </div>
      <button class="btn btn-blue" onclick="pfRegister()" id="pfRegBtn">CREATE ACCOUNT</button>
      <div class="pf-msg" id="pfRegMsg"></div>
    </div>

    <div class="pf-content" id="pf-loggedin">
      <div style="text-align:center;padding:12px 0;">
        <div style="font-size:30px;margin-bottom:8px;">‚úÖ</div>
        <div style="font-family:'Orbitron',monospace;font-size:13px;color:#00ccff;letter-spacing:2px;" id="pfLoggedInName">Welcome!</div>
        <div style="font-size:11px;color:rgba(0,200,255,.35);margin-top:4px;">Account linked</div>
      </div>
      <button class="btn btn-blue" onclick="closePFModal()" style="margin-bottom:8px;">‚ñ∂ CONTINUE</button>
      <button class="btn btn-sm btn-danger" onclick="pfLogout()" style="margin-top:4px;">Sign Out</button>
    </div>
  </div>
</div>


<script>
'use strict';
// ================================================================
//  Z3N0 SNAKE REALM ‚Äî Complete Client Script
//  Performance-first, bug-free, slither.io killer
// ================================================================

// ‚îÄ‚îÄ SKIN DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SKINS = {
  classic:        {name:'Classic',       emoji:'üêç', colors:['#00ff8c','#00cc70'], glow:'#00ff8c'},
  fire:           {name:'Fire',          emoji:'üî•', colors:['#ff4400','#ff8800'], glow:'#ff6600'},
  ice:            {name:'Ice',           emoji:'‚ùÑÔ∏è', colors:['#00ccff','#0066ff'], glow:'#00ccff'},
  toxic:          {name:'Toxic',         emoji:'‚ò£Ô∏è', colors:['#88ff00','#44aa00'], glow:'#88ff00'},
  gold:           {name:'Gold',          emoji:'‚≠ê', colors:['#ffd700','#ffaa00'], glow:'#ffd700'},
  midnight:       {name:'Midnight',      emoji:'üåô', colors:['#4400ff','#8800ff'], glow:'#6600ff'},
  sunset:         {name:'Sunset',        emoji:'üåÖ', colors:['#ff0066','#ff8800'], glow:'#ff4488'},
  ocean:          {name:'Ocean',         emoji:'üåä', colors:['#0044ff','#00ffcc'], glow:'#00aaff'},
  lava:           {name:'Lava',          emoji:'üåã', colors:['#ff2200','#ffdd00'], glow:'#ff4400'},
  forest:         {name:'Forest',        emoji:'üå≤', colors:['#006600','#88cc00'], glow:'#44aa00'},
  rose:           {name:'Rose',          emoji:'üåπ', colors:['#ff4488','#ff88aa'], glow:'#ff66aa'},
  arctic:         {name:'Arctic',        emoji:'üèîÔ∏è', colors:['#aaddff','#ffffff'], glow:'#cceeff'},
  shadow:         {name:'Shadow',        emoji:'üë§', colors:['#222233','#5555aa'], glow:'#8888ff'},
  copper:         {name:'Copper',        emoji:'üî∂', colors:['#cc6600','#ff9944'], glow:'#ff8822'},
  rainbow_god:    {name:'Rainbow God',   emoji:'üåà', colors:['rainbow'],           glow:'#ffffff', ownerOnly:true},
  void_lord:      {name:'Void Lord',     emoji:'üåë', colors:['#110011','#440044'], glow:'#aa00ff', ownerOnly:true},
  galaxy_emperor: {name:'Galaxy',        emoji:'üåå', colors:['#000033','#0000aa'], glow:'#4488ff', ownerOnly:true},
  neon_death:     {name:'Neon Death',    emoji:'‚ö°', colors:['#ff0000','#00ffff'], glow:'#ffffff', ownerOnly:true},
  chrome_divine:  {name:'Chrome Divine', emoji:'‚ú®', colors:['#888888','#ffffff'], glow:'#ffffff', ownerOnly:true},
  inferno_god:    {name:'Inferno God',   emoji:'üî±', colors:['#ff0000','#ff8800'], glow:'#ff4400', ownerOnly:true},
  abyss_king:     {name:'Abyss King',    emoji:'üëÅÔ∏è', colors:['#000000','#220022'], glow:'#cc00ff', ownerOnly:true},
  divine_serpent: {name:'Divine Serpent',emoji:'üêâ', colors:['#ffcc00','#ff6600'], glow:'#ffaa00', ownerOnly:true},
};

// ‚îÄ‚îÄ TRAIL COLOR TABLE (no per-frame string building) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TRAIL_CLR = {
  // Public trails
  trail_fire:'#ff4400',trail_ice:'#00ccff',trail_gold:'#ffd700',trail_void:'#aa00ff',
  trail_electric:'#00ffff',trail_toxic:'#88ff00',trail_blood:'#cc0000',trail_cosmic:'#4488ff',
  trail_plasma:'#ff00ff',trail_neon:'#ff00aa',trail_lava:'#ff2200',trail_storm:'#aaccff',
  trail_angel:'#ffffff',trail_nature:'#44ff44',trail_ocean:'#00aaff',trail_rose:'#ff66aa',
  trail_copper:'#ff8822',trail_shadow:'#8888ff',trail_thunder:'#ffff00',trail_emerald:'#00ff88',
  trail_rainbow:'#ffffff',
  // Owner legendary trails
  owner_trail_divine:'#ffd700',owner_trail_void:'#aa00ff',owner_trail_inferno:'#ff2200',
  owner_trail_aurora:'#00ffcc',owner_trail_lightning:'#ffffff',owner_trail_galaxy:'#4488ff',
  owner_trail_blood:'#ff0000',owner_trail_antimatter:'#cc00ff',owner_trail_matrix:'#00ff00',
  owner_trail_angelic:'#ffffff',owner_trail_phoenix:'#ff8800',owner_trail_tsunami:'#00ccff',
  owner_trail_prismatic:'#ff44ff',owner_trail_singularity:'#880088',
  // Owner mythic trails
  owner_trail_genesis:'#00ffff',owner_trail_void_rift:'#4400cc',owner_trail_divine_wrath:'#ffff00',
  owner_trail_cosmos:'#ff00ff',owner_trail_sovereign_m:'#ffd700',owner_trail_nebula:'#ff44cc',
  owner_trail_quantum:'#44ffff',owner_trail_solar_flare:'#ffcc00',owner_trail_dark_matter:'#220055',
  owner_trail_omega:'#ffffff',owner_trail_prism:'#00ffff',owner_trail_hellfire:'#ff1100',
  owner_trail_abyss_wave:'#cc00ff',owner_trail_supernova:'#ffaa00',owner_trail_time_rift:'#88ffff',
  owner_trail_black_hole:'#330033',owner_trail_dragon_flame:'#ff6600',owner_trail_astral:'#ccaaff',
  owner_trail_crimson_god:'#990000',owner_trail_spirit:'#aaffee',
};

// ‚îÄ‚îÄ COSMETICS CATALOG (full) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CATALOG = {
  // TRAILS - Rare
  trail_fire:       {id:'trail_fire',      type:'trail',name:'Fire Trail',       emoji:'üî•',price:300, glow:'#ff4400',rarity:'rare'},
  trail_ice:        {id:'trail_ice',       type:'trail',name:'Ice Trail',        emoji:'‚ùÑÔ∏è',price:300, glow:'#00ccff',rarity:'rare'},
  trail_toxic:      {id:'trail_toxic',     type:'trail',name:'Toxic Trail',      emoji:'‚ò£Ô∏è',price:350, glow:'#88ff00',rarity:'rare'},
  trail_electric:   {id:'trail_electric',  type:'trail',name:'Electric Trail',   emoji:'‚ö°',price:400, glow:'#00ffff',rarity:'rare'},
  trail_nature:     {id:'trail_nature',    type:'trail',name:'Nature Trail',     emoji:'üåø',price:300, glow:'#44ff44',rarity:'rare'},
  trail_ocean:      {id:'trail_ocean',     type:'trail',name:'Ocean Trail',      emoji:'üåä',price:400, glow:'#00aaff',rarity:'rare'},
  trail_rose:       {id:'trail_rose',      type:'trail',name:'Rose Trail',       emoji:'üåπ',price:350, glow:'#ff66aa',rarity:'rare'},
  trail_copper:     {id:'trail_copper',    type:'trail',name:'Copper Trail',     emoji:'üî∂',price:350, glow:'#ff8822',rarity:'rare'},
  // TRAILS - Epic
  trail_gold:       {id:'trail_gold',      type:'trail',name:'Gold Trail',       emoji:'‚≠ê',price:500, glow:'#ffd700',rarity:'epic'},
  trail_void:       {id:'trail_void',      type:'trail',name:'Void Trail',       emoji:'üíú',price:500, glow:'#aa00ff',rarity:'epic'},
  trail_blood:      {id:'trail_blood',     type:'trail',name:'Blood Trail',      emoji:'ü©∏',price:600, glow:'#cc0000',rarity:'epic'},
  trail_cosmic:     {id:'trail_cosmic',    type:'trail',name:'Cosmic Trail',     emoji:'üåå',price:700, glow:'#4488ff',rarity:'epic'},
  trail_plasma:     {id:'trail_plasma',    type:'trail',name:'Plasma Trail',     emoji:'üîÆ',price:450, glow:'#ff00ff',rarity:'epic'},
  trail_neon:       {id:'trail_neon',      type:'trail',name:'Neon Trail',       emoji:'üí°',price:550, glow:'#ff00aa',rarity:'epic'},
  trail_lava:       {id:'trail_lava',      type:'trail',name:'Lava Trail',       emoji:'üåã',price:600, glow:'#ff2200',rarity:'epic'},
  trail_storm:      {id:'trail_storm',     type:'trail',name:'Storm Trail',      emoji:'üå™Ô∏è',price:650, glow:'#aaccff',rarity:'epic'},
  trail_shadow:     {id:'trail_shadow',    type:'trail',name:'Shadow Trail',     emoji:'üë§',price:550, glow:'#8888ff',rarity:'epic'},
  trail_thunder:    {id:'trail_thunder',   type:'trail',name:'Thunder Trail',    emoji:'‚ö°',price:600, glow:'#ffff00',rarity:'epic'},
  // TRAILS - Legendary
  trail_rainbow:    {id:'trail_rainbow',   type:'trail',name:'Rainbow Trail',    emoji:'üåà',price:800, glow:'#ffffff',rarity:'legendary'},
  trail_angel:      {id:'trail_angel',     type:'trail',name:'Angel Trail',      emoji:'üòá',price:750, glow:'#ffffff',rarity:'legendary'},
  trail_emerald:    {id:'trail_emerald',   type:'trail',name:'Emerald Trail',    emoji:'üíö',price:900, glow:'#00ff88',rarity:'legendary'},
  // TITLES - Rare
  title_snake:      {id:'title_snake',     type:'title',name:'[SNAKE]',     text:'[SNAKE]',     emoji:'üêç',price:200, rarity:'rare'},
  title_hunter:     {id:'title_hunter',    type:'title',name:'[HUNTER]',    text:'[HUNTER]',    emoji:'üéØ',price:300, rarity:'rare'},
  title_phantom:    {id:'title_phantom',   type:'title',name:'[PHANTOM]',   text:'[PHANTOM]',   emoji:'üëª',price:350, rarity:'rare'},
  title_viper:      {id:'title_viper',     type:'title',name:'[VIPER]',     text:'[VIPER]',     emoji:'üêç',price:350, rarity:'rare'},
  // TITLES - Epic
  title_killer:     {id:'title_killer',    type:'title',name:'[KILLER]',    text:'[KILLER]',    emoji:'üíÄ',price:400, rarity:'epic'},
  title_beast:      {id:'title_beast',     type:'title',name:'[BEAST]',     text:'[BEAST]',     emoji:'üî•',price:500, rarity:'epic'},
  title_titan:      {id:'title_titan',     type:'title',name:'[TITAN]',     text:'[TITAN]',     emoji:'üí™',price:550, rarity:'epic'},
  title_shadow:     {id:'title_shadow',    type:'title',name:'[SHADOW]',    text:'[SHADOW]',    emoji:'üåë',price:500, rarity:'epic'},
  title_reaper:     {id:'title_reaper',    type:'title',name:'[REAPER]',    text:'[REAPER]',    emoji:'‚öîÔ∏è',price:700, rarity:'epic'},
  title_elite:      {id:'title_elite',     type:'title',name:'[ELITE]',     text:'[ELITE]',     emoji:'üíé',price:800, rarity:'epic'},
  // TITLES - Legendary
  title_legend:     {id:'title_legend',    type:'title',name:'[LEGEND]',    text:'[LEGEND]',    emoji:'‚≠ê',price:600, rarity:'legendary'},
  title_destroyer:  {id:'title_destroyer', type:'title',name:'[DESTROYER]', text:'[DESTROYER]', emoji:'üí•',price:900, rarity:'legendary'},
  title_warlord:    {id:'title_warlord',   type:'title',name:'[WARLORD]',   text:'[WARLORD]',   emoji:'‚öîÔ∏è',price:1000,rarity:'legendary'},
  title_galaxy:     {id:'title_galaxy',    type:'title',name:'[GALAXY]',    text:'[GALAXY]',    emoji:'üåå',price:1200,rarity:'legendary'},
  title_overlord:   {id:'title_overlord',  type:'title',name:'[OVERLORD]',  text:'[OVERLORD]',  emoji:'üëë',price:1500,rarity:'legendary'},
  // BADGES - Rare
  badge_snake:      {id:'badge_snake',     type:'badge',name:'Snake',       emoji:'üêç',price:100, rarity:'rare'},
  badge_heart:      {id:'badge_heart',     type:'badge',name:'Heart',       emoji:'‚ù§Ô∏è',price:100, rarity:'rare'},
  badge_fire:       {id:'badge_fire',      type:'badge',name:'Fire',        emoji:'üî•',price:150, rarity:'rare'},
  badge_ice:        {id:'badge_ice',       type:'badge',name:'Ice',         emoji:'‚ùÑÔ∏è',price:150, rarity:'rare'},
  badge_ghost:      {id:'badge_ghost',     type:'badge',name:'Ghost',       emoji:'üëª',price:200, rarity:'rare'},
  badge_toxic:      {id:'badge_toxic',     type:'badge',name:'Toxic',       emoji:'‚ò£Ô∏è',price:200, rarity:'rare'},
  badge_sword:      {id:'badge_sword',     type:'badge',name:'Sword',       emoji:'‚öîÔ∏è',price:300, rarity:'rare'},
  badge_skull:      {id:'badge_skull',     type:'badge',name:'Skull',       emoji:'üíÄ',price:300, rarity:'rare'},
  badge_spider:     {id:'badge_spider',    type:'badge',name:'Spider',      emoji:'üï∑Ô∏è',price:300, rarity:'rare'},
  badge_robot:      {id:'badge_robot',     type:'badge',name:'Robot',       emoji:'ü§ñ',price:350, rarity:'rare'},
  badge_thunder:    {id:'badge_thunder',   type:'badge',name:'Thunder',     emoji:'‚ö°',price:250, rarity:'rare'},
  // BADGES - Epic
  badge_demon:      {id:'badge_demon',     type:'badge',name:'Demon',       emoji:'üòà',price:350, rarity:'epic'},
  badge_rocket:     {id:'badge_rocket',    type:'badge',name:'Rocket',      emoji:'üöÄ',price:400, rarity:'epic'},
  badge_alien:      {id:'badge_alien',     type:'badge',name:'Alien',       emoji:'üëΩ',price:450, rarity:'epic'},
  badge_star:       {id:'badge_star',      type:'badge',name:'Star',        emoji:'‚≠ê',price:400, rarity:'epic'},
  badge_nuclear:    {id:'badge_nuclear',   type:'badge',name:'Nuclear',     emoji:'‚ò¢Ô∏è',price:600, rarity:'epic'},
  badge_diamond:    {id:'badge_diamond',   type:'badge',name:'Diamond',     emoji:'üíé',price:500, rarity:'epic'},
  badge_dragon:     {id:'badge_dragon',    type:'badge',name:'Dragon',      emoji:'üêâ',price:550, rarity:'epic'},
  badge_lightning:  {id:'badge_lightning', type:'badge',name:'Lightning',   emoji:'üå©Ô∏è',price:450, rarity:'epic'},
  // BADGES - Legendary
  badge_infinity:   {id:'badge_infinity',  type:'badge',name:'Infinity',    emoji:'‚ôæÔ∏è',price:800, rarity:'legendary'},
  badge_crystal:    {id:'badge_crystal',   type:'badge',name:'Crystal',     emoji:'üí†',price:700, rarity:'legendary'},
  badge_crown:      {id:'badge_crown',     type:'badge',name:'Crown',       emoji:'üëë',price:1000,rarity:'legendary'},
  // OWNER ONLY ‚Äî TRAILS
  owner_trail_divine:      {id:'owner_trail_divine',      type:'trail',name:'Divine Gold',        emoji:'üëë',ownerOnly:true,glow:'#ffd700',rarity:'legendary'},
  owner_trail_void:        {id:'owner_trail_void',        type:'trail',name:'Void Rift',          emoji:'üåå',ownerOnly:true,glow:'#aa00ff',rarity:'legendary'},
  owner_trail_inferno:     {id:'owner_trail_inferno',     type:'trail',name:'INFERNO STORM',      emoji:'üî•',ownerOnly:true,glow:'#ff2200',rarity:'legendary'},
  owner_trail_aurora:      {id:'owner_trail_aurora',      type:'trail',name:'Aurora Borealis',    emoji:'üåà',ownerOnly:true,glow:'#00ffcc',rarity:'legendary'},
  owner_trail_lightning:   {id:'owner_trail_lightning',   type:'trail',name:'GODSTRIKE Lightning',emoji:'‚ö°',ownerOnly:true,glow:'#ffffff',rarity:'legendary'},
  owner_trail_galaxy:      {id:'owner_trail_galaxy',      type:'trail',name:'Galaxy Spiral',      emoji:'üåÄ',ownerOnly:true,glow:'#4488ff',rarity:'legendary'},
  owner_trail_blood:       {id:'owner_trail_blood',       type:'trail',name:'Crimson Blood',      emoji:'ü©∏',ownerOnly:true,glow:'#ff0000',rarity:'legendary'},
  owner_trail_antimatter:  {id:'owner_trail_antimatter',  type:'trail',name:'Antimatter',         emoji:'üíú',ownerOnly:true,glow:'#cc00ff',rarity:'legendary'},
  owner_trail_matrix:      {id:'owner_trail_matrix',      type:'trail',name:'Matrix Code',        emoji:'üíö',ownerOnly:true,glow:'#00ff00',rarity:'legendary'},
  owner_trail_angelic:     {id:'owner_trail_angelic',     type:'trail',name:'Angelic Halo',       emoji:'ü§ç',ownerOnly:true,glow:'#ffffff',rarity:'legendary'},
  owner_trail_phoenix:     {id:'owner_trail_phoenix',     type:'trail',name:'Phoenix Rebirth',    emoji:'ü¶Ö',ownerOnly:true,glow:'#ff8800',rarity:'legendary'},
  owner_trail_tsunami:     {id:'owner_trail_tsunami',     type:'trail',name:'TSUNAMI Wave',       emoji:'üåä',ownerOnly:true,glow:'#00ccff',rarity:'legendary'},
  owner_trail_prismatic:   {id:'owner_trail_prismatic',   type:'trail',name:'Prismatic Storm',    emoji:'üå†',ownerOnly:true,glow:'#ff44ff',rarity:'legendary'},
  owner_trail_singularity: {id:'owner_trail_singularity', type:'trail',name:'Singularity',        emoji:'üï≥Ô∏è',ownerOnly:true,glow:'#440000',rarity:'legendary'},
  // OWNER ONLY ‚Äî TITLES
  owner_title_z3n0:        {id:'owner_title_z3n0',        type:'title',name:'[Z3N0]',           text:'[Z3N0]',           emoji:'üëë',ownerOnly:true,rarity:'legendary'},
  owner_title_god:         {id:'owner_title_god',         type:'title',name:'[GOD]',            text:'[GOD]',            emoji:'‚ö°',ownerOnly:true,rarity:'legendary'},
  owner_title_supreme:     {id:'owner_title_supreme',     type:'title',name:'[SUPREME]',        text:'[SUPREME]',        emoji:'üåü',ownerOnly:true,rarity:'legendary'},
  owner_title_almighty:    {id:'owner_title_almighty',    type:'title',name:'[ALMIGHTY]',       text:'[ALMIGHTY]',       emoji:'üí´',ownerOnly:true,rarity:'legendary'},
  owner_title_deathlord:   {id:'owner_title_deathlord',   type:'title',name:'[DEATHLORD]',      text:'[DEATHLORD]',      emoji:'üíÄ',ownerOnly:true,rarity:'legendary'},
  owner_title_omnipotent:  {id:'owner_title_omnipotent',  type:'title',name:'[OMNIPOTENT]',     text:'[OMNIPOTENT]',     emoji:'‚ôæÔ∏è',ownerOnly:true,rarity:'legendary'},
  owner_title_galaxyking:  {id:'owner_title_galaxyking',  type:'title',name:'[GALAXY KING]',    text:'[GALAXY KING]',    emoji:'üåå',ownerOnly:true,rarity:'legendary'},
  owner_title_voidwalker:  {id:'owner_title_voidwalker',  type:'title',name:'[VOID WALKER]',    text:'[VOID WALKER]',    emoji:'üåë',ownerOnly:true,rarity:'legendary'},
  owner_title_serpentgod:  {id:'owner_title_serpentgod',  type:'title',name:'[SERPENT GOD]',    text:'[SERPENT GOD]',    emoji:'üêç',ownerOnly:true,rarity:'legendary'},
  owner_title_transcendent:{id:'owner_title_transcendent',type:'title',name:'[TRANSCENDENT]',   text:'[TRANSCENDENT]',   emoji:'‚ú®',ownerOnly:true,rarity:'legendary'},
  owner_title_eternal:     {id:'owner_title_eternal',     type:'title',name:'[ETERNAL]',        text:'[ETERNAL]',        emoji:'‚ôæÔ∏è',ownerOnly:true,rarity:'legendary'},
  owner_title_dimension:   {id:'owner_title_dimension',   type:'title',name:'[DIMENSION LORD]', text:'[DIMENSION LORD]', emoji:'üåÄ',ownerOnly:true,rarity:'legendary'},
  owner_title_deathbringer:{id:'owner_title_deathbringer',type:'title',name:'[DEATH BRINGER]',  text:'[DEATH BRINGER]',  emoji:'‚öîÔ∏è',ownerOnly:true,rarity:'legendary'},
  owner_title_chaos:       {id:'owner_title_chaos',       type:'title',name:'[CHAOS]',          text:'[CHAOS]',          emoji:'üî•',ownerOnly:true,rarity:'legendary'},
  owner_title_celestial:   {id:'owner_title_celestial',   type:'title',name:'[CELESTIAL]',      text:'[CELESTIAL]',      emoji:'üå†',ownerOnly:true,rarity:'legendary'},
  owner_title_singularity: {id:'owner_title_singularity', type:'title',name:'[SINGULARITY]',    text:'[SINGULARITY]',    emoji:'üï≥Ô∏è',ownerOnly:true,rarity:'legendary'},
  owner_title_creator:     {id:'owner_title_creator',     type:'title',name:'[CREATOR]',        text:'[CREATOR]',        emoji:'üî±',ownerOnly:true,rarity:'legendary'},
  // OWNER ONLY ‚Äî BADGES
  owner_badge_crown:       {id:'owner_badge_crown',       type:'badge',name:'Royal Crown',      emoji:'üëë',ownerOnly:true,rarity:'legendary'},
  owner_badge_dragon:      {id:'owner_badge_dragon',      type:'badge',name:'Dragon Emperor',   emoji:'üêâ',ownerOnly:true,rarity:'legendary'},
  owner_badge_skull:       {id:'owner_badge_skull',       type:'badge',name:'Death Mark',       emoji:'üíÄ',ownerOnly:true,rarity:'legendary'},
  owner_badge_lightning:   {id:'owner_badge_lightning',   type:'badge',name:'Thunder God',      emoji:'‚ö°',ownerOnly:true,rarity:'legendary'},
  owner_badge_star:        {id:'owner_badge_star',        type:'badge',name:'Supreme Star',     emoji:'‚≠ê',ownerOnly:true,rarity:'legendary'},
  owner_badge_fire:        {id:'owner_badge_fire',        type:'badge',name:'Inferno Lord',     emoji:'üî•',ownerOnly:true,rarity:'legendary'},
  owner_badge_gem:         {id:'owner_badge_gem',         type:'badge',name:'Diamond Elite',    emoji:'üíé',ownerOnly:true,rarity:'legendary'},
  owner_badge_infinity:    {id:'owner_badge_infinity',    type:'badge',name:'Infinite',         emoji:'‚ôæÔ∏è',ownerOnly:true,rarity:'legendary'},
  owner_badge_alien:       {id:'owner_badge_alien',       type:'badge',name:'Alien Overlord',   emoji:'üëΩ',ownerOnly:true,rarity:'legendary'},
  owner_badge_devil:       {id:'owner_badge_devil',       type:'badge',name:'Demon King',       emoji:'üòà',ownerOnly:true,rarity:'legendary'},
  owner_badge_angel:       {id:'owner_badge_angel',       type:'badge',name:'Celestial',        emoji:'üòá',ownerOnly:true,rarity:'legendary'},
  owner_badge_nuclear:     {id:'owner_badge_nuclear',     type:'badge',name:'Nuclear',          emoji:'‚ò¢Ô∏è',ownerOnly:true,rarity:'legendary'},
  owner_badge_trident:     {id:'owner_badge_trident',     type:'badge',name:'God Trident',      emoji:'üî±',ownerOnly:true,rarity:'legendary'},
  owner_badge_eye:         {id:'owner_badge_eye',         type:'badge',name:'All-Seeing Eye',   emoji:'üëÅÔ∏è',ownerOnly:true,rarity:'legendary'},
  owner_badge_void:        {id:'owner_badge_void',        type:'badge',name:'Void Shard',       emoji:'üåë',ownerOnly:true,rarity:'legendary'},
  owner_badge_galaxy:      {id:'owner_badge_galaxy',      type:'badge',name:'Galaxy Core',      emoji:'üåå',ownerOnly:true,rarity:'legendary'},
  owner_badge_singularity: {id:'owner_badge_singularity', type:'badge',name:'Singularity',      emoji:'üï≥Ô∏è',ownerOnly:true,rarity:'legendary'},
};
// ‚ïê‚ïê‚ïê MYTHIC-ONLY ADDITIONS (new items not in base CATALOG) ‚ïê‚ïê‚ïê
Object.assign(CATALOG,{
  // MYTHIC TRAILS ‚Äî new unique items only
  owner_trail_genesis:     {id:'owner_trail_genesis',    type:'trail',name:'Genesis Storm',      emoji:'üåå',ownerOnly:true,glow:'#00ffff',rarity:'mythic'},
  owner_trail_void_rift:   {id:'owner_trail_void_rift',  type:'trail',name:'Void Rift Tear',     emoji:'üîÆ',ownerOnly:true,glow:'#4400cc',rarity:'mythic'},
  owner_trail_divine_wrath:{id:'owner_trail_divine_wrath',type:'trail',name:'Divine Wrath',      emoji:'‚ö°',ownerOnly:true,glow:'#ffff00',rarity:'mythic'},
  owner_trail_cosmos:      {id:'owner_trail_cosmos',     type:'trail',name:'Cosmos Shatter',     emoji:'üå†',ownerOnly:true,glow:'#ff00ff',rarity:'mythic'},
  owner_trail_sovereign_m: {id:'owner_trail_sovereign_m',type:'trail',name:'Sovereign Gold',     emoji:'üëë',ownerOnly:true,glow:'#ffd700',rarity:'mythic'},
  owner_trail_nebula:      {id:'owner_trail_nebula',     type:'trail',name:'Nebula Collapse',    emoji:'üå∫',ownerOnly:true,glow:'#ff44cc',rarity:'mythic'},
  owner_trail_quantum:     {id:'owner_trail_quantum',    type:'trail',name:'Quantum Rift',       emoji:'üî¨',ownerOnly:true,glow:'#44ffff',rarity:'mythic'},
  owner_trail_solar_flare: {id:'owner_trail_solar_flare',type:'trail',name:'Solar Flare',        emoji:'‚òÄÔ∏è',ownerOnly:true,glow:'#ffcc00',rarity:'mythic'},
  owner_trail_dark_matter: {id:'owner_trail_dark_matter',type:'trail',name:'Dark Matter',        emoji:'üåë',ownerOnly:true,glow:'#220055',rarity:'mythic'},
  owner_trail_omega:       {id:'owner_trail_omega',      type:'trail',name:'Omega Burst',        emoji:'üî±',ownerOnly:true,glow:'#ffffff',rarity:'mythic'},
  owner_trail_prism:       {id:'owner_trail_prism',      type:'trail',name:'Prism Break',        emoji:'üí†',ownerOnly:true,glow:'#00ffff',rarity:'mythic'},
  owner_trail_hellfire:    {id:'owner_trail_hellfire',   type:'trail',name:'Hellfire',           emoji:'üòà',ownerOnly:true,glow:'#ff1100',rarity:'mythic'},
  owner_trail_abyss_wave:  {id:'owner_trail_abyss_wave', type:'trail',name:'Abyss Wave',         emoji:'üëÅÔ∏è',ownerOnly:true,glow:'#cc00ff',rarity:'mythic'},
  owner_trail_supernova:   {id:'owner_trail_supernova',  type:'trail',name:'Supernova',          emoji:'üí•',ownerOnly:true,glow:'#ffaa00',rarity:'mythic'},
  owner_trail_time_rift:   {id:'owner_trail_time_rift',  type:'trail',name:'Time Rift',          emoji:'‚è≥',ownerOnly:true,glow:'#88ffff',rarity:'mythic'},
  owner_trail_black_hole:  {id:'owner_trail_black_hole', type:'trail',name:'Black Hole',         emoji:'üåÄ',ownerOnly:true,glow:'#000000',rarity:'mythic'},
  owner_trail_dragon_flame:{id:'owner_trail_dragon_flame',type:'trail',name:'Dragon Flame',      emoji:'üêâ',ownerOnly:true,glow:'#ff6600',rarity:'mythic'},
  owner_trail_astral:      {id:'owner_trail_astral',     type:'trail',name:'Astral Projection',  emoji:'‚ú®',ownerOnly:true,glow:'#ccaaff',rarity:'mythic'},
  owner_trail_crimson_god: {id:'owner_trail_crimson_god',type:'trail',name:'Crimson God',        emoji:'ü©∏',ownerOnly:true,glow:'#990000',rarity:'mythic'},
  owner_trail_spirit:      {id:'owner_trail_spirit',     type:'trail',name:'Spirit Ghost',       emoji:'üëª',ownerOnly:true,glow:'#aaffee',rarity:'mythic'},
  // MYTHIC TITLES ‚Äî new unique items only
  owner_title_genesis:        {id:'owner_title_genesis',       type:'title',name:'[GENESIS]',        text:'[GENESIS]',        emoji:'üåå',ownerOnly:true,rarity:'mythic'},
  owner_title_sovereign:      {id:'owner_title_sovereign',     type:'title',name:'[SOVEREIGN]',      text:'[SOVEREIGN]',      emoji:'üëë',ownerOnly:true,rarity:'mythic'},
  owner_title_celestial_king: {id:'owner_title_celestial_king',type:'title',name:'[CELESTIAL KING]', text:'[CELESTIAL KING]', emoji:'‚ú®',ownerOnly:true,rarity:'mythic'},
  owner_title_omega:          {id:'owner_title_omega',         type:'title',name:'[OMEGA]',          text:'[OMEGA]',          emoji:'üî±',ownerOnly:true,rarity:'mythic'},
  owner_title_quantum:        {id:'owner_title_quantum',       type:'title',name:'[QUANTUM]',        text:'[QUANTUM]',        emoji:'üî¨',ownerOnly:true,rarity:'mythic'},
  owner_title_nebula_lord:    {id:'owner_title_nebula_lord',   type:'title',name:'[NEBULA LORD]',    text:'[NEBULA LORD]',    emoji:'üå∫',ownerOnly:true,rarity:'mythic'},
  owner_title_dark_matter:    {id:'owner_title_dark_matter',   type:'title',name:'[DARK MATTER]',    text:'[DARK MATTER]',    emoji:'üåë',ownerOnly:true,rarity:'mythic'},
  owner_title_solar_king:     {id:'owner_title_solar_king',    type:'title',name:'[SOLAR KING]',     text:'[SOLAR KING]',     emoji:'‚òÄÔ∏è',ownerOnly:true,rarity:'mythic'},
  owner_title_hellborn:       {id:'owner_title_hellborn',      type:'title',name:'[HELLBORN]',       text:'[HELLBORN]',       emoji:'üòà',ownerOnly:true,rarity:'mythic'},
  owner_title_god_of_death:   {id:'owner_title_god_of_death',  type:'title',name:'[GOD OF DEATH]',   text:'[GOD OF DEATH]',   emoji:'üíÄ',ownerOnly:true,rarity:'mythic'},
  owner_title_universe:       {id:'owner_title_universe',      type:'title',name:'[UNIVERSE]',       text:'[UNIVERSE]',       emoji:'üåê',ownerOnly:true,rarity:'mythic'},
  owner_title_abyss_king:     {id:'owner_title_abyss_king',    type:'title',name:'[ABYSS KING]',     text:'[ABYSS KING]',     emoji:'üëÅÔ∏è',ownerOnly:true,rarity:'mythic'},
  owner_title_prism_lord:     {id:'owner_title_prism_lord',    type:'title',name:'[PRISM LORD]',     text:'[PRISM LORD]',     emoji:'üí†',ownerOnly:true,rarity:'mythic'},
  owner_title_time_god:       {id:'owner_title_time_god',      type:'title',name:'[TIME GOD]',       text:'[TIME GOD]',       emoji:'‚è≥',ownerOnly:true,rarity:'mythic'},
  owner_title_supernova:      {id:'owner_title_supernova',     type:'title',name:'[SUPERNOVA]',      text:'[SUPERNOVA]',      emoji:'üí•',ownerOnly:true,rarity:'mythic'},
  owner_title_black_hole:     {id:'owner_title_black_hole',    type:'title',name:'[BLACK HOLE]',     text:'[BLACK HOLE]',     emoji:'üåÄ',ownerOnly:true,rarity:'mythic'},
  owner_title_dragon_god:     {id:'owner_title_dragon_god',    type:'title',name:'[DRAGON GOD]',     text:'[DRAGON GOD]',     emoji:'üêâ',ownerOnly:true,rarity:'mythic'},
  owner_title_astral_king:    {id:'owner_title_astral_king',   type:'title',name:'[ASTRAL KING]',    text:'[ASTRAL KING]',    emoji:'‚ú®',ownerOnly:true,rarity:'mythic'},
  owner_title_crimson_god:    {id:'owner_title_crimson_god',   type:'title',name:'[CRIMSON GOD]',    text:'[CRIMSON GOD]',    emoji:'ü©∏',ownerOnly:true,rarity:'mythic'},
  owner_title_void_emperor:   {id:'owner_title_void_emperor',  type:'title',name:'[VOID EMPEROR]',   text:'[VOID EMPEROR]',   emoji:'üï≥Ô∏è',ownerOnly:true,rarity:'mythic'},
  // MYTHIC BADGES ‚Äî new unique items only
  owner_badge_sovereign:      {id:'owner_badge_sovereign',    type:'badge',name:'Sovereign Crown',  emoji:'üëë',ownerOnly:true,rarity:'mythic'},
  owner_badge_genesis:        {id:'owner_badge_genesis',      type:'badge',name:'Genesis Eye',      emoji:'üåå',ownerOnly:true,rarity:'mythic'},
  owner_badge_void_heart:     {id:'owner_badge_void_heart',   type:'badge',name:'Void Heart',       emoji:'üîÆ',ownerOnly:true,rarity:'mythic'},
  owner_badge_celestial_star: {id:'owner_badge_celestial_star',type:'badge',name:'Celestial Star',  emoji:'‚≠ê',ownerOnly:true,rarity:'mythic'},
  owner_badge_omega_core:     {id:'owner_badge_omega_core',   type:'badge',name:'Omega Core',       emoji:'‚öõÔ∏è',ownerOnly:true,rarity:'mythic'},
  owner_badge_quantum_eye:    {id:'owner_badge_quantum_eye',  type:'badge',name:'Quantum Eye',      emoji:'üëÅÔ∏è',ownerOnly:true,rarity:'mythic'},
  owner_badge_nebula_heart:   {id:'owner_badge_nebula_heart', type:'badge',name:'Nebula Heart',     emoji:'üíú',ownerOnly:true,rarity:'mythic'},
  owner_badge_solar_flare:    {id:'owner_badge_solar_flare',  type:'badge',name:'Solar Flare Core', emoji:'‚òÄÔ∏è',ownerOnly:true,rarity:'mythic'},
  owner_badge_dark_matter:    {id:'owner_badge_dark_matter',  type:'badge',name:'Dark Matter Shard',emoji:'üåë',ownerOnly:true,rarity:'mythic'},
  owner_badge_hellfire:       {id:'owner_badge_hellfire',     type:'badge',name:'Hellfire Mark',    emoji:'üòà',ownerOnly:true,rarity:'mythic'},
  owner_badge_prism:          {id:'owner_badge_prism',        type:'badge',name:'Prism Crystal',    emoji:'üí†',ownerOnly:true,rarity:'mythic'},
  owner_badge_universe:       {id:'owner_badge_universe',     type:'badge',name:'Universe Core',    emoji:'üåê',ownerOnly:true,rarity:'mythic'},
  owner_badge_abyss:          {id:'owner_badge_abyss',        type:'badge',name:'Abyss Eye',        emoji:'üï∂Ô∏è',ownerOnly:true,rarity:'mythic'},
  owner_badge_supernova:      {id:'owner_badge_supernova',    type:'badge',name:'Supernova Shard',  emoji:'üí•',ownerOnly:true,rarity:'mythic'},
  owner_badge_time:           {id:'owner_badge_time',         type:'badge',name:'Time Crystal',     emoji:'‚è≥',ownerOnly:true,rarity:'mythic'},
  owner_badge_black_hole:     {id:'owner_badge_black_hole',   type:'badge',name:'Black Hole Shard', emoji:'üåÄ',ownerOnly:true,rarity:'mythic'},
  owner_badge_dragon_eye:     {id:'owner_badge_dragon_eye',   type:'badge',name:'Dragon Eye',       emoji:'üêâ',ownerOnly:true,rarity:'mythic'},
  owner_badge_astral:         {id:'owner_badge_astral',       type:'badge',name:'Astral Core',      emoji:'‚ú®',ownerOnly:true,rarity:'mythic'},
  owner_badge_crimson_heart:  {id:'owner_badge_crimson_heart',type:'badge',name:'Crimson God Heart',emoji:'ü©∏',ownerOnly:true,rarity:'mythic'},
  owner_badge_void_emperor:   {id:'owner_badge_void_emperor', type:'badge',name:'Void Emperor Seal',emoji:'üï≥Ô∏è',ownerOnly:true,rarity:'mythic'},
});
let cosmeticsCatalog = {...CATALOG};

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let controlScheme,boostKey,mouseAlways;
try{
  controlScheme = localStorage.getItem('controlScheme') || 'mouse';
  boostKey      = localStorage.getItem('boostKey')      || 'shift';
  mouseAlways   = localStorage.getItem('mouseAlways')   !== 'off';
}catch(e){controlScheme='mouse';boostKey='shift';mouseAlways=true;}

function saveSettings(){
  try{
    localStorage.setItem('controlScheme',controlScheme);
    localStorage.setItem('boostKey',boostKey);
    localStorage.setItem('mouseAlways',mouseAlways?'on':'off');
  }catch(e){}
  updateBoostLabel();
}
function updateBoostLabel(){
  const m={shift:'BOOST [SHIFT/CLICK]',space:'BOOST [SPACE/CLICK]',both_boost:'BOOST [SHIFT+SPACE/CLICK]'};
  const el=document.getElementById('boostLabel');
  if(el) el.textContent=m[boostKey]||'BOOST [HOLD CLICK]';
}
function initRadioGroup(gid,attr,cur,cb){
  document.querySelectorAll('#'+gid+' .control-radio').forEach(b=>{
    b.classList.toggle('active',b.dataset[attr]===cur);
    b.onclick=()=>{
      document.querySelectorAll('#'+gid+' .control-radio').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); cb(b.dataset[attr]);
    };
  });
}
initRadioGroup('controlSchemeGroup','scheme',controlScheme,v=>{controlScheme=v;saveSettings();});
initRadioGroup('boostKeyGroup','boost',boostKey,v=>{boostKey=v;saveSettings();});
initRadioGroup('mouseAlwaysGroup','mouse',mouseAlways?'on':'off',v=>{mouseAlways=(v==='on');saveSettings();});
document.querySelectorAll('.menu-tab-btn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.menu-tab-btn').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.menu-tab-content').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.getElementById('mtab-'+b.dataset.mtab).classList.add('active');
  };
});

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let socket=null, myPlayerId=null, isOwner=false;
let gameState={players:{},leaderboard:[],activeEvent:null};
let myAngle=0, boosting=false, boostEnergy=100;
const ALL_SKIN_IDS=Object.keys(SKINS);
const PUBLIC_SKINS=ALL_SKIN_IDS.filter(k=>!SKINS[k].ownerOnly);
let selectedSkin='classic';try{selectedSkin=localStorage.getItem('selectedSkin')||'classic';}catch(e){}
if(!ALL_SKIN_IDS.includes(selectedSkin)||(!isOwner&&SKINS[selectedSkin]?.ownerOnly)) selectedSkin='classic';
let ownerPass='', currentPlayerList=[], gameActive=false;
let myDeathScore=0, myDeathLength=0;
let camX=0, camY=0, camTX=0, camTY=0, camScale=1, camScaleTarget=1;
let MAP_SIZE=6000;
let orbsLocal={};
let rainbowHue=0;
let musicPlaying=false, audioCtx=null, musicInterval=null, noteIdx=0;
let myName='';
let myProfile={coins:0,unlockedCosmetics:[],equippedTrail:null,equippedTitle:null,equippedBadge:null};
let sessionCoins=0;
let frameCount=0, hudDirty=true;
let mmCtx=null;
let bgGrad=null, bgGradCX=-1, bgGradCY=-1;
// New gameplay features
let killStreak=0, killStreakTimer=null;
let highScore=0;try{highScore=parseInt(localStorage.getItem('z3n0_hs')||'0')||0;}catch(e){}
const XP_RANKS=['NOVICE','APPRENTICE','SLAYER','HUNTER','PREDATOR','ELITE','VIPER','PHANTOM','REAPER','TITAN','WARLORD','OVERLORD','LEGEND','GALAXY','MYTH','DEITY','Z3N0'];
let particles=[];
let nearBorder=false;
let chatOpen=false;
// FPS tracking
let fpsBucket=0, fpsElapsed=0, currentFPS=60;
// HUD element cache
const HDOM={};
const hel=id=>HDOM[id]||(HDOM[id]=document.getElementById(id));
// Last HUD values (skip DOM write if unchanged)
let _lastSc=-1, _lastLen=-1, _lastCoins=-1, _lastBoost=-1;

// ‚îÄ‚îÄ PLAYFAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PLAYFAB_TITLE_ID='YOUR_TITLE_ID';
let pfPlayerId=null, pfSessionTicket=null, pfDisplayName=null;

(function restorePFSession(){
  try{
    const d=JSON.parse(localStorage.getItem('z3n0_pf_session')||'null');
    if(d){
      pfPlayerId=d.playerId; pfSessionTicket=d.sessionTicket; pfDisplayName=d.displayName;
      updateAccountBar(true,d.displayName);
      const ni=document.getElementById('nameInput');
      if(ni&&d.displayName) ni.value=d.displayName;
    }
  }catch(e){}
})();

function updateAccountBar(linked,name){
  const st=hel('accountStatusText'), nt=hel('accountNameText'), btn=hel('openAccountBtn');
  if(!st) return;
  if(linked){
    st.textContent='‚úÖ ACCOUNT LINKED'; st.className='acct-status linked';
    nt.textContent='Playing as: '+(name||'Player');
    if(btn) btn.textContent='ACCOUNT';
  } else {
    st.textContent='‚ö†Ô∏è NO ACCOUNT LINKED'; st.className='acct-status unlinked';
    nt.textContent='Progress saves by name only';
    if(btn) btn.textContent='SIGN IN / CREATE';
  }
}
function openPFModal(tab){
  document.getElementById('playfabModal').classList.add('open');
  pfTab(pfPlayerId?'loggedin':(tab||'login'));
  if(pfPlayerId){ const el=hel('pfLoggedInName'); if(el) el.textContent=pfDisplayName||'Player'; }
}
function closePFModal(){document.getElementById('playfabModal').classList.remove('open');}
function pfTab(tab){
  ['login','register','loggedin'].forEach(t=>{
    const b=document.getElementById('pf-tab-'+t);
    if(b){
      b.classList.toggle('active',t===tab);
      // loggedin tab button only shows when we're on that tab
      if(t==='loggedin') b.style.display=(tab==='loggedin'?'inline-block':'none');
    }
    const c=document.getElementById('pf-'+t);
    if(c) c.classList.toggle('active',t===tab);
  });
}
function pfMsg(id,msg,ok){
  const el=document.getElementById(id); if(!el) return;
  el.textContent=msg; el.className='pf-msg '+(ok?'ok':'err'); el.style.display='block';
}
async function pfCall(endpoint,body){
  const r=await fetch(`https://${PLAYFAB_TITLE_ID}.playfabapi.com/Client/${endpoint}`,
    {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  return r.json();
}
async function pfLogin(){
  if(!PLAYFAB_TITLE_ID||PLAYFAB_TITLE_ID==='YOUR_TITLE_ID'){pfMsg('pfLoginMsg','‚ùå Replace YOUR_TITLE_ID in the code with your actual PlayFab Title ID.',false);return;}
  const user=(hel('pfLoginUser')||{}).value?.trim()||'';
  const pass=(hel('pfLoginPass')||{}).value||'';
  if(!user||!pass){pfMsg('pfLoginMsg','Enter username/email and password.',false);return;}
  const btn=hel('pfLoginBtn'); btn.textContent='SIGNING IN...'; btn.disabled=true;
  try{
    const isEmail=user.includes('@');
    const data=await pfCall(isEmail?'LoginWithEmailAddress':'LoginWithPlayFab',
      isEmail?{TitleId:PLAYFAB_TITLE_ID,Email:user,Password:pass,InfoRequestParameters:{GetPlayerProfile:true}}
             :{TitleId:PLAYFAB_TITLE_ID,Username:user,Password:pass,InfoRequestParameters:{GetPlayerProfile:true}});
    if(data.code===200){
      pfPlayerId=data.data.PlayFabId; pfSessionTicket=data.data.SessionTicket;
      pfDisplayName=data.data.InfoResultPayload?.PlayerProfile?.DisplayName||user;
      localStorage.setItem('z3n0_pf_session',JSON.stringify({playerId:pfPlayerId,sessionTicket:pfSessionTicket,displayName:pfDisplayName}));
      updateAccountBar(true,pfDisplayName);
      const ni=hel('nameInput'); if(ni) ni.value=pfDisplayName;
      pfMsg('pfLoginMsg','‚úÖ Welcome back, '+pfDisplayName,true);
      setTimeout(()=>{pfTab('loggedin');const el=hel('pfLoggedInName');if(el)el.textContent=pfDisplayName;},700);
    } else pfMsg('pfLoginMsg',data.errorMessage||'Login failed.',false);
  }catch(e){pfMsg('pfLoginMsg','Connection error. Check PLAYFAB_TITLE_ID.',false);}
  btn.textContent='SIGN IN'; btn.disabled=false;
}
async function pfRegister(){
  if(!PLAYFAB_TITLE_ID||PLAYFAB_TITLE_ID==='YOUR_TITLE_ID'){pfMsg('pfRegMsg','‚ùå Replace YOUR_TITLE_ID in the code first.',false);return;}
  const name=(hel('pfRegName')||{}).value?.trim()||'';
  const user=(hel('pfRegUser')||{}).value?.trim()||'';
  const email=(hel('pfRegEmail')||{}).value?.trim()||'';
  const pass=(hel('pfRegPass')||{}).value||'';
  if(!name||!user||!email||!pass){pfMsg('pfRegMsg','All fields required.',false);return;}
  if(pass.length<6){pfMsg('pfRegMsg','Password must be ‚â• 6 characters.',false);return;}
  if(!/^[a-zA-Z0-9_]{3,20}$/.test(user)){pfMsg('pfRegMsg','Username: 3-20 chars, letters/numbers/_',false);return;}
  const btn=hel('pfRegBtn'); btn.textContent='CREATING...'; btn.disabled=true;
  try{
    const data=await pfCall('RegisterPlayFabUser',{TitleId:PLAYFAB_TITLE_ID,Username:user,Email:email,Password:pass,DisplayName:name,RequireBothUsernameAndEmail:true});
    if(data.code===200){
      pfPlayerId=data.data.PlayFabId; pfSessionTicket=data.data.SessionTicket; pfDisplayName=name;
      localStorage.setItem('z3n0_pf_session',JSON.stringify({playerId:pfPlayerId,sessionTicket:pfSessionTicket,displayName:pfDisplayName}));
      updateAccountBar(true,pfDisplayName);
      const ni=hel('nameInput'); if(ni) ni.value=pfDisplayName;
      pfMsg('pfRegMsg','‚úÖ Account created! Welcome, '+pfDisplayName,true);
      setTimeout(()=>{pfTab('loggedin');const el=hel('pfLoggedInName');if(el)el.textContent=pfDisplayName;},700);
    } else pfMsg('pfRegMsg',data.errorMessage||'Registration failed.',false);
  }catch(e){pfMsg('pfRegMsg','Connection error.',false);}
  btn.textContent='CREATE ACCOUNT'; btn.disabled=false;
}
function pfLogout(){
  pfPlayerId=null; pfSessionTicket=null; pfDisplayName=null;
  try{localStorage.removeItem('z3n0_pf_session');}catch(e){}
  myProfile={coins:0,unlockedCosmetics:[],equippedTrail:null,equippedTitle:null,equippedBadge:null};
  updateAccountBar(false,null); updateCoinDisplays();
  pfTab('login'); closePFModal();
  showToast('Signed out.');
}

// ‚îÄ‚îÄ SKIN SELECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildSkinSelector(){
  const sel=hel('skinSelector'); if(!sel) return;
  sel.innerHTML='';
  for(const[id,skin]of Object.entries(SKINS)){
    if(skin.ownerOnly&&!isOwner) continue;
    const d=document.createElement('div');
    d.className='skin-opt'+(skin.ownerOnly?' owner-only':'')+(id===selectedSkin?' selected':'');
    d.title=skin.name; d.textContent=skin.emoji;
    d.onclick=()=>{
      selectedSkin=id; try{localStorage.setItem('selectedSkin',id);}catch(e){}
      document.querySelectorAll('.skin-opt').forEach(s=>s.classList.remove('selected'));
      d.classList.add('selected');
    };
    sel.appendChild(d);
  }
}
buildSkinSelector();

// ‚îÄ‚îÄ MUSIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MELODY=[261,293,329,349,392,440,493,523,493,440,392,349,329,293,261,293,329,392,440,493,523,587,523,493,440,392,349,329];
const BASS=[65,73,82,87,98,110,65,73];
function initMusic(){if(audioCtx)return;try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}
function playNote(freq,type,dur,gain,t){
  if(!audioCtx||!musicPlaying)return;
  const osc=audioCtx.createOscillator(),g=audioCtx.createGain(),flt=audioCtx.createBiquadFilter();
  flt.type='lowpass';flt.frequency.value=1800;
  osc.connect(flt);flt.connect(g);g.connect(audioCtx.destination);
  osc.type=type;osc.frequency.value=freq;
  g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(gain,t+0.02);g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  osc.start(t);osc.stop(t+dur+0.05);
}
function scheduleMusicNotes(){
  if(musicInterval)clearInterval(musicInterval);
  const tempo=0.18;let beat=0;
  musicInterval=setInterval(()=>{
    if(!musicPlaying||!audioCtx)return;
    const now=audioCtx.currentTime;
    playNote(MELODY[noteIdx%MELODY.length],'triangle',tempo*1.5,0.065,now);
    playNote(MELODY[noteIdx%MELODY.length]*2,'sine',tempo,0.022,now+0.05);
    if(beat%2===0) playNote(BASS[beat%BASS.length],'sawtooth',tempo*2,0.045,now);
    if(beat%4===0){
      const k=audioCtx.createOscillator(),kg=audioCtx.createGain();
      k.connect(kg);kg.connect(audioCtx.destination);
      k.frequency.setValueAtTime(150,now);k.frequency.exponentialRampToValueAtTime(0.001,now+0.28);
      kg.gain.setValueAtTime(0.22,now);kg.gain.exponentialRampToValueAtTime(0.001,now+0.28);
      k.start(now);k.stop(now+0.32);
    }
    noteIdx++;beat++;
  },tempo*1000);
}
function playMusic(){musicPlaying=true;hel('musicVis').classList.remove('music-paused');hel('musicToggle').textContent='üéµ';scheduleMusicNotes();}
function pauseMusic(){musicPlaying=false;hel('musicVis').classList.add('music-paused');hel('musicToggle').textContent='‚è∏';if(musicInterval){clearInterval(musicInterval);musicInterval=null;}}
hel('musicToggle').onclick=()=>{if(!audioCtx){initMusic();if(audioCtx)playMusic();return;}musicPlaying?pauseMusic():playMusic();};

// ‚îÄ‚îÄ PLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
hel('playBtn').onclick=()=>{
  const name=(hel('nameInput').value.trim()||'Snake').substring(0,20);
  myName=name; ownerPass=hel('ownerPass').value;
  connectAndJoin(name,selectedSkin,ownerPass);
};
hel('nameInput').addEventListener('keydown',e=>{if(e.key==='Enter')hel('playBtn').click();});
hel('ownerToggleBtn').addEventListener('click',()=>{
  const g=hel('ownerPassGroup');
  g.style.display=g.style.display==='none'?'flex':'none';
});

// ‚îÄ‚îÄ SOCKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectAndJoin(name,skin,password){
  if(socket){socket.disconnect();socket=null;}
  killStreak=0; particles=[];
  socket=io({transports:['websocket'],reconnectionAttempts:5,reconnectionDelay:1000});

  socket.on('connect',()=>socket.emit('joinGame',{name,skin,password,playfabId:pfPlayerId||null}));
  socket.on('connect_error',()=>showToast('Connection failed ‚Äî retrying...','error'));

  socket.on('joined',data=>{
    myPlayerId=data.playerId; isOwner=!!data.isOwner; MAP_SIZE=data.mapSize||6000;
    orbsLocal={}; if(data.orbs) data.orbs.forEach(o=>orbsLocal[o.id]=o);
    if(data.profile) myProfile={...myProfile,...data.profile};
    if(!Array.isArray(myProfile.unlockedCosmetics)) myProfile.unlockedCosmetics=[];
    if(data.cosmeticsCatalog&&Object.keys(data.cosmeticsCatalog).length)
      cosmeticsCatalog={...cosmeticsCatalog,...data.cosmeticsCatalog};
    if(data.profile?.isLegacyAccount&&!pfPlayerId)
      hel('legacyWarning').style.display='block';
    startGame();
    if(isOwner){hel('owner-tag-hud').style.display='block';buildSkinSelector();showToast('üëë Welcome back, Z3N0','gold');}
    initMusic(); updateCoinDisplays();
  });

  socket.on('gameState',data=>{
    if(!data) return;
    gameState=data;
    if(!gameState.leaderboard) gameState.leaderboard=[];
    if(!gameState.players)     gameState.players={};
    hudDirty=true;
  });

  // Orb updates ‚Äî guard against null newOrb
  socket.on('orbEaten',({oid,newOrb})=>{delete orbsLocal[oid];if(newOrb)orbsLocal[newOrb.id]=newOrb;});
  socket.on('orbSpawned',orb=>{if(orb)orbsLocal[orb.id]=orb;});
  socket.on('orbFrenzy',orbs=>{if(orbs)orbs.forEach(o=>orbsLocal[o.id]=o);});

  socket.on('playerDied',({id,killerName,droppedOrbs})=>{
    if(droppedOrbs) droppedOrbs.forEach(o=>orbsLocal[o.id]=o);
    if(id!==myPlayerId) addKillFeed(id,killerName);
  });
  socket.on('youDied',({killerName,coinsEarned})=>{
    myProfile.coins+=(coinsEarned||0);
    handleDeath(killerName,coinsEarned||0);
  });
  socket.on('kicked',({reason})=>{
    if(socket){socket.disconnect();socket=null;}
    gameActive=false; hideGameUI(); showScreen('menuScreen');
    showToast('üö´ '+(reason||'Kicked.'),'error');
  });
  socket.on('systemMessage',d=>showSysMsg(typeof d==='string'?d:d.message||''));
  socket.on('skinGranted',({skin:s})=>{selectedSkin=s;showToast('üé® Skin: '+(SKINS[s]?.name||s),'gold');});
  socket.on('orbEatenClient',({points})=>{if(points)showScorePop('+'+points,'#ffd700');});
  socket.on('killConfirmed',({victimName})=>{
    killStreak++; clearTimeout(killStreakTimer);
    killStreakTimer=setTimeout(()=>{killStreak=0;},10000);
    showToast('üíÄ Eliminated '+victimName);
    if(killStreak>=2) showStreakBanner(killStreak);
    spawnKillParticles(); screenFlash('rgba(255,34,68,0.18)');
  });
  socket.on('chatMessage',({name:n,message:m,isOwner:io})=>addChatLine(n,m,io));
  socket.on('liveEvent',ev=>{
    const el=hel('eventBanner'); if(!el) return;
    el.textContent='‚ö° '+(ev.name||'EVENT'); el.style.display='block';
    const se=hel('statEvent'); if(se) se.style.display='inline';
    showToast('‚ö° '+(ev.name||'EVENT'),'gold');
    screenFlash('rgba(170,68,255,0.2)');
  });
  socket.on('eventEnded',()=>{
    const el=hel('eventBanner'); if(el) el.style.display='none';
    const se=hel('statEvent'); if(se) se.style.display='none';
    showToast('Event ended.');
  });
  socket.on('ownerBroadcast',({message})=>{
    hel('broadcastText').textContent=message;
    hel('broadcastBanner').style.display='block';
    setTimeout(()=>hel('broadcastBanner').style.display='none',9000);
  });
  socket.on('ownerSuccess',msg=>{showOwnerAlert(msg,'success');refreshPlayers();});
  socket.on('ownerError',msg=>showOwnerAlert(msg,'error'));
  socket.on('playerList',list=>{currentPlayerList=list;renderPlayerTable(list);populateSelects(list);});
  socket.on('coinsGranted',({amount,newBalance})=>{
    myProfile.coins=newBalance; updateCoinDisplays();
    showToast('üí∞ +'+amount+' coins!','gold');
  });
  socket.on('cosmeticBought',({cosmeticId,newCoinBalance,unlockedCosmetics})=>{
    myProfile.coins=newCoinBalance;
    if(unlockedCosmetics) myProfile.unlockedCosmetics=unlockedCosmetics;
    updateCoinDisplays(); renderCosmeticsShop();
    showToast('üé® Bought: '+(cosmeticsCatalog[cosmeticId]?.name||cosmeticId),'gold');
  });
  socket.on('cosmeticGranted',({unlockedCosmetics})=>{
    if(unlockedCosmetics) myProfile.unlockedCosmetics=unlockedCosmetics;
    renderCosmeticsShop(); showToast('üé® Cosmetic granted!','gold');
  });
  socket.on('cosmeticEquipped',({equippedTrail,equippedTitle,equippedBadge})=>{
    myProfile.equippedTrail=equippedTrail;
    myProfile.equippedTitle=equippedTitle;
    myProfile.equippedBadge=equippedBadge;
    updateEquippedDisplay(); renderCosmeticsShop();
  });
  socket.on('cosmeticError',msg=>showToast(msg,'error'));
  socket.on('disconnect',reason=>{if(gameActive){showToast('Disconnected: '+reason,'error');pauseMusic();}});
}

// ‚îÄ‚îÄ GAME START/STOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideGameUI(){
  ['hud','gameCanvas','musicControls','inGameCosmeticsBtn','ingameCosmeticsPanel',
   'owner-tag-hud','streak-banner'].forEach(id=>{
    const el=hel(id); if(el) el.style.display='none';
  });
  hel('deathScreen').classList.add('hidden');
  const cb=hel('chat-wrap'); if(cb) cb.style.display='none';
  const db=hel('danger-warn'); if(db) db.style.opacity='0';
  const sb=hel('streak-banner'); if(sb) sb.style.opacity='0';
}

function startGame(){
  gameActive=true; killStreak=0; particles=[];
  _lastSc=-1;_lastLen=-1;_lastCoins=-1;_lastBoost=-1;
  camScale=1; camScaleTarget=1;
  showScreen('game');
  hel('gameCanvas').style.display='block';
  hel('hud').style.display='block';
  hel('musicControls').style.display='flex';
  hel('deathScreen').classList.add('hidden');
  hel('inGameCosmeticsBtn').style.display='block';
  hel('ingameCosmeticsPanel').style.display='none';
  const cw=hel('chat-wrap'); if(cw) cw.style.display='block';
  setupCanvas(); bgGrad=null; bgGradCX=-1; bgGradCY=-1;
  mmCtx=document.getElementById('minimapCanvas').getContext('2d');
  lastFrameTs=0; fpsBucket=0; fpsElapsed=0;
  requestAnimationFrame(gameLoop);
}

function handleDeath(killerName,coinsEarned){
  gameActive=false; killStreak=0;
  if(chatOpen) closeChat();
  clearTimeout(killStreakTimer);
  const me=gameState?.players?.[myPlayerId];
  myDeathScore=me?.score||0;
  myDeathLength=me?.segments?.length||0;
  const isNewHS=myDeathScore>highScore;
  if(isNewHS){highScore=myDeathScore;try{localStorage.setItem('z3n0_hs',highScore);}catch(e){}}
  const hsEl=hel('deathHs');
  if(hsEl) hsEl.textContent=isNewHS?'üèÜ NEW HIGH SCORE!':'Best: '+highScore;
  hel('deathKiller').textContent='Eliminated by '+(killerName||'the void');
  hel('deathScore').textContent=myDeathScore;
  hel('deathLength').textContent=myDeathLength;
  hel('deathCoinsEarned').textContent=coinsEarned>0?'üí∞ +'+coinsEarned+' coins earned':'';
  const rank=(gameState.leaderboard||[]).findIndex(e=>e.id===myPlayerId);
  hel('deathRank').textContent=rank>=0?'#'+(rank+1):'‚Äî';
  hel('ingameCosmeticsPanel').style.display='none';
  hel('deathScreen').classList.remove('hidden');
  hel('inGameCosmeticsBtn').style.display='none';
  const sb=hel('streak-banner'); if(sb) sb.style.opacity='0';
  screenFlash(isNewHS?'rgba(255,215,0,0.3)':'rgba(255,34,68,0.3)');
}

hel('respawnBtn').onclick=()=>{
  hel('deathScreen').classList.add('hidden');
  gameState={players:{},leaderboard:[],activeEvent:null};
  orbsLocal={}; particles=[];
  connectAndJoin(myName,selectedSkin,ownerPass);
};
hel('menuBtn').onclick=()=>{
  hideGameUI();
  hel('deathScreen').classList.add('hidden');
  showScreen('menuScreen');
  if(socket){socket.disconnect();socket=null;}
  gameActive=false;
  gameState={players:{},leaderboard:[],activeEvent:null};
  orbsLocal={}; particles=[];
};

// ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
function setupCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;bgGrad=null;}
window.addEventListener('resize',setupCanvas,{passive:true});

// Custom cursor
const cursorEl=document.getElementById('cursor');
document.addEventListener('mousemove',e=>{
  cursorEl.style.left=e.clientX+'px';
  cursorEl.style.top=e.clientY+'px';
},{passive:true});

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastEmitTs=0;
function emitInput(){
  const now=performance.now();
  if(now-lastEmitTs<16)return;
  lastEmitTs=now;
  if(socket) socket.emit('input',{angle:myAngle,boosting});
}

canvas.addEventListener('mousemove',e=>{
  if(!gameActive||!myPlayerId||chatOpen)return;
  if(controlScheme!=='mouse'&&!mouseAlways)return;
  const me=gameState.players[myPlayerId];
  if(!me?.segments?.length)return;
  // BUG FIX: account for camera scale transform
  const cx=canvas.width/2,cy=canvas.height/2;
  const wx=(e.clientX-cx)/camScale+cx, wy=(e.clientY-cy)/camScale+cy;
  myAngle=Math.atan2(wy-(me.segments[0].y-camY),wx-(me.segments[0].x-camX));
  emitInput();
},{passive:true});
canvas.addEventListener('mousedown',e=>{if(e.button===0||e.button===2){boosting=true;emitInput();}});
canvas.addEventListener('mouseup',()=>{boosting=false;emitInput();});
canvas.addEventListener('contextmenu',e=>e.preventDefault());
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(!gameActive||chatOpen)return;
  const t=e.touches[0], me=gameState.players[myPlayerId];
  if(!me?.segments?.length)return;
  myAngle=Math.atan2(t.clientY-(me.segments[0].y-camY),t.clientX-(me.segments[0].x-camX));
  emitInput();
},{passive:false});
canvas.addEventListener('touchstart',()=>{boosting=true;emitInput();},{passive:true});
canvas.addEventListener('touchend',()=>{boosting=false;emitInput();},{passive:true});

const keys={};
document.addEventListener('keydown',e=>{
  keys[e.key]=true;
  if(e.key==='F1'||(e.ctrlKey&&e.key==='o')){e.preventDefault();if(isOwner)openOwnerPanel();return;}
  if(e.key==='Escape'){
    hel('ownerPanel').classList.add('hidden');
    hel('ingameCosmeticsPanel').style.display='none';
    if(chatOpen)closeChat(); return;
  }
  if((e.key==='t'||e.key==='T')&&gameActive&&!chatOpen){e.preventDefault();openChat();return;}
  if(!gameActive||!socket)return;
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key))e.preventDefault();
  if((e.key==='Shift'&&(boostKey==='shift'||boostKey==='both_boost'))||
     (e.key===' '   &&(boostKey==='space' ||boostKey==='both_boost'))){boosting=true;emitInput();}
});
document.addEventListener('keyup',e=>{
  keys[e.key]=false;
  if(!gameActive||!socket)return;
  if((e.key==='Shift'&&(boostKey==='shift'||boostKey==='both_boost'))||
     (e.key===' '   &&(boostKey==='space' ||boostKey==='both_boost'))){boosting=false;emitInput();}
});

function handleKeyboardSteering(){
  if(!gameActive||chatOpen)return;
  const useW=controlScheme==='wasd'||controlScheme==='both';
  const useA=controlScheme==='arrows'||controlScheme==='both'||(controlScheme==='mouse'&&mouseAlways);
  const L=(useW&&(keys['a']||keys['A']))||(useA&&keys['ArrowLeft']);
  const R=(useW&&(keys['d']||keys['D']))||(useA&&keys['ArrowRight']);
  const U=(useW&&(keys['w']||keys['W']))||(useA&&keys['ArrowUp']);
  const D=(useW&&(keys['s']||keys['S']))||(useA&&keys['ArrowDown']);
  if(!L&&!R&&!U&&!D)return;
  const dx=(R?1:0)-(L?1:0), dy=(D?1:0)-(U?1:0);
  if(!dx&&!dy)return;
  const target=Math.atan2(dy,dx);
  let diff=target-myAngle;
  while(diff>Math.PI)diff-=Math.PI*2;
  while(diff<-Math.PI)diff+=Math.PI*2;
  myAngle+=Math.sign(diff)*Math.min(Math.abs(diff),0.18);
  emitInput();
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openChat(){
  chatOpen=true; boosting=false;
  const inp=hel('chat-input'); if(!inp)return;
  inp.style.display='block'; inp.focus();
  inp.onkeydown=e=>{
    if(e.key==='Enter'){
      const m=inp.value.trim();
      if(m&&socket)socket.emit('chatMessage',{message:m.substring(0,80)});
      inp.value=''; closeChat(); e.preventDefault();
    }
    if(e.key==='Escape'){closeChat();e.preventDefault();}
    e.stopPropagation();
  };
}
function closeChat(){
  chatOpen=false; boosting=false;
  const inp=hel('chat-input'); if(!inp)return;
  inp.style.display='none'; inp.blur();
}
function addChatLine(name,msg,isSys){
  const box=hel('chat-msgs'); if(!box)return;
  const d=document.createElement('div');
  d.className='chat-line'+(isSys?' sys':'');
  d.innerHTML='<span class="cn">'+sanitize(name)+':</span> '+sanitize(msg);
  box.appendChild(d);
  while(box.children.length>12)box.removeChild(box.firstChild);
  box.scrollTop=box.scrollHeight;
  setTimeout(()=>{if(d.parentNode)d.remove();},12000);
}
function sanitize(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnKillParticles(){
  const me=gameState.players[myPlayerId]; if(!me?.segments?.length)return;
  const sx=me.segments[0].x-camX, sy=me.segments[0].y-camY;
  const colors=['#ff2244','#ff8800','#ffd700','#ff44aa','#ffffff'];
  for(let i=0;i<28;i++){
    const a=(i/28)*Math.PI*2, spd=2+Math.random()*7;
    particles.push({x:sx,y:sy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-2,life:1,decay:0.020+Math.random()*0.022,color:colors[i%colors.length],size:2.5+Math.random()*4});
  }
  // Extra white burst ring
  for(let i=0;i<8;i++){
    const a=(i/8)*Math.PI*2, spd=5+Math.random()*3;
    particles.push({x:sx,y:sy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:0.65,decay:0.016,color:'#ffffff',size:1.5+Math.random()*2});
  }
}
function updateParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; p.life-=p.decay;
    if(p.life<=0)particles.splice(i,1);
  }
}
function drawParticles(){
  if(!particles.length)return;
  const TAU=Math.PI*2;
  ctx.save();
  for(const p of particles){
    ctx.globalAlpha=Math.max(0,p.life*0.85);
    ctx.fillStyle=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.size*p.life,0,TAU); ctx.fill();
  }
  ctx.globalAlpha=1; ctx.restore();
}

// ‚îÄ‚îÄ SCREEN EFFECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function screenFlash(color){
  const el=hel('screen-flash'); if(!el)return;
  el.style.transition='none'; el.style.background=color; el.style.opacity='1';
  requestAnimationFrame(()=>{el.style.transition='opacity 0.45s ease';el.style.opacity='0';});
}
function showStreakBanner(n){
  const el=hel('streak-banner'); if(!el)return;
  const msgs={2:'DOUBLE KILL üî•',3:'TRIPLE KILL üíÄ',4:'QUAD KILL ‚ö°',5:'PENTA KILL üåü',6:'GODLIKE üëë',7:'UNSTOPPABLE ‚ôæÔ∏è',8:'LEGENDARY üåå',9:'MYTHIC ‚òÖ‚òÖ‚òÖ',10:'Z3N0 MODE üî±',11:'TRANSCENDENT ‚ú®',12:'OMEGA KILLER ‚ò†Ô∏è'};
  el.textContent=msgs[n]||(n>7?n+'x KILL STREAK üî±':null)||'';
  if(!el.textContent)return;
  el.style.opacity='1'; clearTimeout(el._t);
  el._t=setTimeout(()=>el.style.opacity='0',3000);
}

// ‚îÄ‚îÄ GAME LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastFrameTs=0;
const TAU=Math.PI*2;

function gameLoop(ts){
  if(!gameActive){return;}
  requestAnimationFrame(gameLoop);
  const dt=ts-lastFrameTs;
  if(dt<15.9)return; // ~63fps cap ‚Äî enough headroom for 60hz monitors
  lastFrameTs=ts;

  // FPS counter (update every second)
  fpsBucket++; fpsElapsed+=dt;
  if(fpsElapsed>=1000){
    currentFPS=Math.round(fpsBucket*1000/fpsElapsed);
    fpsBucket=0; fpsElapsed=0;
    const fe=hel('fps-hud'); if(fe) fe.textContent=currentFPS+' FPS';
  }

  frameCount++;
  rainbowHue=(rainbowHue+1.1)%360;
  handleKeyboardSteering();

  // Camera smooth lerp + dynamic zoom
  const me=gameState.players[myPlayerId];
  if(me?.segments?.length){
    const h=me.segments[0];
    camTX=h.x-canvas.width*0.5; camTY=h.y-canvas.height*0.5;
    camScaleTarget=Math.max(0.42,1-Math.min(1,(me.segments.length-10)/380)*0.58);
  }
  camX+=(camTX-camX)*0.1; camY+=(camTY-camY)*0.1;
  camScale+=(camScaleTarget-camScale)*0.045;

  // Boost energy update
  if(boosting) boostEnergy=Math.max(0,boostEnergy-0.5);
  else         boostEnergy=Math.min(100,boostEnergy+0.3);

  // Border proximity warning
  if(me?.segments?.length){
    const h=me.segments[0];
    const bd=Math.min(h.x,h.y,MAP_SIZE-h.x,MAP_SIZE-h.y);
    nearBorder=bd<500;
    const dw=hel('danger-warn');
    if(dw) dw.style.opacity=nearBorder?Math.min(1,(500-bd)/500).toFixed(2):'0';
  }

  updateParticles();

  // CLEAR
  ctx.fillStyle='#02020c';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // DRAW with zoom transform
  ctx.save();
  if(camScale!==1){
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.scale(camScale,camScale);
    ctx.translate(-canvas.width/2,-canvas.height/2);
  }
  drawBackground();
  drawGrid();
  drawOrbs();

  const pids=Object.keys(gameState.players);
  for(let i=0;i<pids.length;i++){
    if(pids[i]!==myPlayerId) drawSnake(gameState.players[pids[i]],false);
  }
  if(me) drawSnake(me,true);

  drawParticles();
  drawBorder();
  ctx.restore();

  // DOM HUD ‚Äî throttled, skip if nothing changed
  if(frameCount%3===0||hudDirty){updateHUD();hudDirty=false;}
  if(frameCount%8===0)drawMinimap();
}


// ‚îÄ‚îÄ PARALLAX STARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BG_STARS=[];
(function(){for(let i=0;i<130;i++)BG_STARS.push({x:Math.random()*8000-1000,y:Math.random()*8000-1000,r:Math.random()*1.3+0.3,b:Math.random()});})();

// ‚îÄ‚îÄ BACKGROUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBackground(){
  const mcx=(MAP_SIZE/2-camX)|0, mcy=(MAP_SIZE/2-camY)|0;
  const d=Math.abs(mcx-bgGradCX)+Math.abs(mcy-bgGradCY);
  if(!bgGrad||d>50){
    bgGrad=ctx.createRadialGradient(mcx,mcy,0,mcx,mcy,MAP_SIZE*0.55);
    bgGrad.addColorStop(0,'rgba(0,100,50,0.07)');
    bgGrad.addColorStop(0.35,'rgba(0,30,70,0.05)');
    bgGrad.addColorStop(0.7,'rgba(30,0,60,0.04)');
    bgGrad.addColorStop(1,'rgba(0,0,0,0)');
    bgGradCX=mcx; bgGradCY=mcy;
  }
  ctx.fillStyle=bgGrad;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // Parallax twinkling stars
  const _t=frameCount*0.013;
  const _sx=camX*0.18,_sy=camY*0.18;
  ctx.fillStyle='rgba(210,230,255,0.6)';
  ctx.beginPath();
  for(let i=0;i<BG_STARS.length;i++){
    const st=BG_STARS[i];
    const px=((st.x-_sx)%canvas.width+canvas.width)%canvas.width;
    const py=((st.y-_sy)%canvas.height+canvas.height)%canvas.height;
    const tw=st.r*(0.65+Math.sin(_t+st.b*10)*0.35);
    ctx.moveTo(px+tw,py);ctx.arc(px,py,tw,0,TAU);
  }
  ctx.fill();
}

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawGrid(){
  const gs=80;
  const ox=((-camX%gs)+gs)%gs|0, oy=((-camY%gs)+gs)%gs|0;
  const W=canvas.width, H=canvas.height;
  // Dot intersections
  ctx.fillStyle='rgba(0,255,140,0.07)';
  ctx.beginPath();
  for(let x=ox;x<W;x+=gs)for(let y=oy;y<H;y+=gs){ctx.moveTo(x+1.2,y);ctx.arc(x,y,1.2,0,TAU);}
  ctx.fill();
  // Faint grid lines
  ctx.strokeStyle='rgba(0,255,140,0.013)';
  ctx.lineWidth=1;
  ctx.beginPath();
  for(let x=ox;x<W;x+=gs){ctx.moveTo(x,0);ctx.lineTo(x,H);}
  for(let y=oy;y<H;y+=gs){ctx.moveTo(0,y);ctx.lineTo(W,y);}
  ctx.stroke();
}

// ‚îÄ‚îÄ ORBS (fully batched per-color) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawOrbs(){
  const W=canvas.width, H=canvas.height;
  const byClr={};
  const pulse=0.65+Math.sin(frameCount*0.07)*0.35;
  for(const oid in orbsLocal){
    const o=orbsLocal[oid];
    const sx=o.x-camX, sy=o.y-camY;
    if(sx<-10||sx>W+10||sy<-10||sy>H+10)continue;
    if(!byClr[o.color])byClr[o.color]=[];
    byClr[o.color].push(sx,sy,o.size);
  }
  for(const clr in byClr){
    const arr=byClr[clr];
    // Glow halo
    ctx.shadowColor=clr; ctx.shadowBlur=8*pulse;
    ctx.fillStyle=clr; ctx.globalAlpha=0.22;
    ctx.beginPath();
    for(let i=0;i<arr.length;i+=3){const r=arr[i+2]*2.3;ctx.moveTo(arr[i]+r,arr[i+1]);ctx.arc(arr[i],arr[i+1],r,0,TAU);}
    ctx.fill(); ctx.shadowBlur=0;
    // Core
    ctx.fillStyle=clr; ctx.globalAlpha=1;
    ctx.beginPath();
    for(let i=0;i<arr.length;i+=3){ctx.moveTo(arr[i]+arr[i+2],arr[i+1]);ctx.arc(arr[i],arr[i+1],arr[i+2],0,TAU);}
    ctx.fill();
    // Specular highlight
    ctx.fillStyle='#fff'; ctx.globalAlpha=0.38;
    ctx.beginPath();
    for(let i=0;i<arr.length;i+=3){
      const r=arr[i+2]*0.28, hx=arr[i]-arr[i+2]*0.24, hy=arr[i+1]-arr[i+2]*0.24;
      ctx.moveTo(hx+r,hy); ctx.arc(hx,hy,r,0,TAU);
    }
    ctx.fill(); ctx.globalAlpha=1;
  }
}

// ‚îÄ‚îÄ SNAKE COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function skinClrs(p){
  const s=SKINS[p.grantedSkin||p.skin]||SKINS.classic;
  if(s.colors[0]==='rainbow'){
    return ['hsl('+rainbowHue+',100%,52%)','hsl('+((rainbowHue+60)%360)+',100%,60%)'];
  }
  return s.colors;
}
function skinGlw(p){
  const s=SKINS[p.grantedSkin||p.skin]||SKINS.classic;
  if(s.colors[0]==='rainbow') return 'hsl('+rainbowHue+',100%,60%)';
  return s.glow;
}

// ‚îÄ‚îÄ SNAKE DRAW (optimized two-pass) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSnake(player,isMe){
  const segs=player.segments;
  if(!segs||segs.length<2)return;
  const [c1,c2]=skinClrs(player);
  const glow=skinGlw(player);
  const w=player.width||8;
  const W=canvas.width, H=canvas.height;
  const h0=segs[0];
  const hsx=h0.x-camX, hsy=h0.y-camY;
  const mg=w*5+80;
  // BUG FIX: cull only when head+tail on SAME off-screen side
  if(hsx<-mg||hsx>W+mg||hsy<-mg||hsy>H+mg){
    const tl=segs[segs.length-1];
    const tlx=tl.x-camX,tly=tl.y-camY;
    if((hsx<-mg&&tlx<-mg)||(hsx>W+mg&&tlx>W+mg)||(hsy<-mg&&tly<-mg)||(hsy>H+mg&&tly>H+mg))return;
  }
  const skip=segs.length>160?4:segs.length>80?3:segs.length>40?2:1;
  const wEnd=Math.max(1.5,w*0.58);

  ctx.save();
  ctx.lineCap='round'; ctx.lineJoin='round';

  // Glow (only self + owner, head area only = cheap)
  if(isMe||player.isOwner){
    ctx.shadowColor=glow; ctx.shadowBlur=8;
    ctx.strokeStyle=glow; ctx.globalAlpha=0.16; ctx.lineWidth=w*2.2;
    const n=Math.min(5,segs.length);
    ctx.beginPath(); ctx.moveTo(segs[0].x-camX,segs[0].y-camY);
    for(let i=1;i<n;i++) ctx.lineTo(segs[i].x-camX,segs[i].y-camY);
    ctx.stroke(); ctx.shadowBlur=0; ctx.globalAlpha=1;
  }

  // Pass 1: body tapered ‚Äî BUG FIX new path per lineWidth change
  ctx.strokeStyle=c1;
  let open=false,lastLW=-1;
  for(let i=segs.length-1;i>=0;i-=skip){
    const sx=segs[i].x-camX, sy=segs[i].y-camY;
    if(sx<-w-18||sx>W+w+18||sy<-w-18||sy>H+w+18){
      if(open){ctx.stroke();open=false;}continue;
    }
    const t=i/segs.length;
    const lw=Math.max(1.5,w-t*(w-wEnd))*2;
    if(Math.abs(lw-lastLW)>0.3){
      if(open){ctx.stroke();open=false;}
      ctx.lineWidth=lw;lastLW=lw;
    }
    if(!open){ctx.beginPath();ctx.moveTo(sx,sy);open=true;}
    else ctx.lineTo(sx,sy);
  }
  if(open)ctx.stroke();

  // Pass 2: stripe (c2, every ~4 segments, thinner) ‚Äî BUG FIX: separate open2
  if(c1!==c2&&segs.length>8){
    const ss=skip*4||4;
    ctx.strokeStyle=c2; ctx.globalAlpha=0.48;
    let open2=false;
    for(let i=segs.length-1;i>=0;i-=ss){
      const sx=segs[i].x-camX, sy=segs[i].y-camY;
      if(sx<-w-18||sx>W+w+18||sy<-w-18||sy>H+w+18){if(open2){ctx.stroke();open2=false;}continue;}
      const t=i/segs.length;
      ctx.lineWidth=Math.max(1,(w-t*(w-wEnd))*1.05);
      if(!open2){ctx.beginPath();ctx.moveTo(sx,sy);open2=true;}
      else ctx.lineTo(sx,sy);
    }
    if(open2)ctx.stroke();
    ctx.globalAlpha=1;
  }

  // Trail cosmetic ‚Äî batched arcs
  if(player.equippedTrail){
    const isRainbow=player.equippedTrail==='trail_rainbow';
    const tc=isRainbow?'hsl('+rainbowHue+',100%,58%)':(TRAIL_CLR[player.equippedTrail]||'#fff');
    const end=Math.min(24,segs.length);
    ctx.fillStyle=tc;
    ctx.beginPath();
    for(let i=3;i<end;i+=2){
      const sx=segs[i].x-camX, sy=segs[i].y-camY;
      if(sx<-20||sx>W+20||sy<-20||sy>H+20)continue;
      ctx.globalAlpha=0.48*(1-i/end);
      ctx.moveTo(sx+2.5,sy); ctx.arc(sx,sy,2.5,0,TAU);
    }
    ctx.fill(); ctx.globalAlpha=1;
  }

  // Boost particles
  if(player.boosting&&segs.length>3&&frameCount%3===0){
    ctx.fillStyle=glow; ctx.globalAlpha=0.5;
    ctx.beginPath();
    for(let i=1;i<5;i++){
      const seg=segs[Math.min(i,segs.length-1)];
      const sx=seg.x-camX, sy=seg.y-camY;
      ctx.moveTo(sx+2,sy); ctx.arc(sx,sy,2,0,TAU);
    }
    ctx.fill(); ctx.globalAlpha=1;
  }

  // Head
  if(isMe||player.isOwner){ctx.shadowColor=glow;ctx.shadowBlur=12;}
  ctx.beginPath(); ctx.arc(hsx,hsy,w,0,TAU);
  ctx.fillStyle=c1; ctx.globalAlpha=1; ctx.fill(); ctx.shadowBlur=0;

  // Eyes
  const ang=player.angle||myAngle;
  const ed=w*0.52, er=w*0.27;
  const ex1=hsx+Math.cos(ang-0.55)*ed, ey1=hsy+Math.sin(ang-0.55)*ed;
  const ex2=hsx+Math.cos(ang+0.55)*ed, ey2=hsy+Math.sin(ang+0.55)*ed;
  const pa=Math.cos(ang)*0.6, qa=Math.sin(ang)*0.6;
  ctx.fillStyle='#fff';
  ctx.beginPath();ctx.arc(ex1,ey1,er,0,TAU);ctx.arc(ex2,ey2,er,0,TAU);ctx.fill();
  ctx.fillStyle='#111';
  ctx.beginPath();ctx.arc(ex1+pa,ey1+qa,er*0.48,0,TAU);ctx.arc(ex2+pa,ey2+qa,er*0.48,0,TAU);ctx.fill();

  // Owner crown
  if(player.isOwner){
    ctx.font=(w*1.4|0)+'px serif';
    ctx.textAlign='center';ctx.textBaseline='bottom';
    ctx.fillText('üëë',hsx,hsy-w);
  }
  ctx.restore();

  // Name tag
  if(hsx>-150&&hsx<W+150&&hsy>-60&&hsy<H+60){
    // Resolve badge/title from ID if server sends ID, or use directly if server sends emoji/text
    const _rawBadge=player.equippedBadge||'';
    const badge=_rawBadge?(cosmeticsCatalog[_rawBadge]?.emoji||_rawBadge):'';
    const _rawTitle=player.equippedTitle||'';
    const ttl=_rawTitle?(cosmeticsCatalog[_rawTitle]?.text||_rawTitle):'';
    const nm=(player.isOwner?'üëë ':'')+badge+(player.name||'Snake')+(player.isBot?' ü§ñ':'');
    const ny=hsy-w-5;
    ctx.textAlign='center';ctx.textBaseline='bottom';
    if(ttl){
      ctx.font='bold 10px Orbitron,monospace';
      const tw=ctx.measureText(ttl).width;
      ctx.fillStyle='rgba(0,0,8,0.75)';
      ctx.fillRect(hsx-tw/2-5,ny-28,tw+10,14);
      ctx.fillStyle=player.isOwner?'#ffd700':'#aa44ff';
      ctx.fillText(ttl,hsx,ny-16);
    }
    ctx.font='bold '+(Math.max(10,w+3)|0)+'px Rajdhani,sans-serif';
    const nw=ctx.measureText(nm).width;
    ctx.fillStyle='rgba(0,0,8,0.72)';
    ctx.fillRect(hsx-nw/2-4,ny-14,nw+8,15);
    ctx.fillStyle=player.isBot?'rgba(190,190,210,0.8)':player.isOwner?'#ffd700':isMe?'#fff':'#ccffdd';
    ctx.fillText(nm,hsx,ny);
    ctx.textBaseline='alphabetic';
  }
}

// ‚îÄ‚îÄ BORDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBorder(){
  const bx=-camX, by=-camY;
  const pulse=nearBorder?(Math.sin(frameCount*0.14)*0.35+0.65):0.4;
  ctx.save();
  ctx.setLineDash([16,8]);
  ctx.strokeStyle='rgba(255,34,68,'+pulse+')'; ctx.lineWidth=3;
  ctx.strokeRect(bx,by,MAP_SIZE,MAP_SIZE);
  ctx.setLineDash([]);
  ctx.strokeStyle='rgba(255,34,68,'+(pulse*0.45)+')'; ctx.lineWidth=12;
  ctx.strokeRect(bx,by,MAP_SIZE,MAP_SIZE);
  ctx.restore();
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHUD(){
  const me=gameState.players[myPlayerId];
  if(me){
    const sc=me.score||0, ln=me.segments?.length||0;
    const coins=(myProfile.coins+(me.sessionCoins||0))|0;
    const bf=boostEnergy|0;
    if(sc!==_lastSc){hel('scoreVal').textContent=sc;_lastSc=sc;}
    if(ln!==_lastLen){hel('lengthVal').textContent=ln;_lastLen=ln;}
    if(coins!==_lastCoins){hel('hudCoins').textContent=coins;_lastCoins=coins;}
    if(bf!==_lastBoost){hel('boost-fill').style.width=bf+'%';_lastBoost=bf;}
    sessionCoins=me.sessionCoins||0;
    // XP level (cosmetic, sqrt-based)
    const lvl=Math.max(1,Math.floor(Math.sqrt(sc/80))+1);
    const xpNeeded=lvl*lvl*80, xpPrev=(lvl-1)*(lvl-1)*80;
    const pct=Math.min(100,((sc-xpPrev)/(xpNeeded-xpPrev)*100))||0;
    const rankIdx=Math.min(XP_RANKS.length-1,Math.floor((lvl-1)/3));
    const lv=hel('xpLvl'); if(lv) lv.textContent=lvl;
    const rv=hel('xpRank'); if(rv) rv.textContent=XP_RANKS[rankIdx];
    const xf=hel('xp-fill'); if(xf) xf.style.width=pct.toFixed(1)+'%';
  }
  // Leaderboard
  const lb=gameState.leaderboard||[];
  const lbel=hel('lbList'); if(!lbel) return;
  let h=''; const max=Math.min(lb.length,10);
  for(let i=0;i<max;i++){
    const e=lb[i];
    const rc=i===0?'top1':i===1?'top2':i===2?'top3':'';
    const sym=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'#'+(i+1);
    const _et=e.equippedTitle;const _etDisplay=_et?(cosmeticsCatalog[_et]?.text||_et):'';
    const ttl=_etDisplay?'<span style="font-size:8px;color:#aa44ff;">'+_etDisplay+' </span>':'';
    const bot=e.isBot?'<span class="lb-bot">BOT</span>':'';
    const isme=e.id===myPlayerId?' style="color:#00ff8c;"':'';
    h+='<div class="lb-entry"><div class="lb-rank '+rc+'">'+sym+'</div><div class="lb-name'+(e.isOwner?' is-owner':'')+'"'+isme+'>'+ttl+(e.isOwner?'üëë ':'')+(e.equippedBadge||'')+sanitize(e.name||'?')+bot+'</div><div class="lb-len">'+e.length+'</div></div>';
  }
  lbel.innerHTML=h;
}

// ‚îÄ‚îÄ MINIMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawMinimap(){
  if(!mmCtx)return;
  const W=150,H=150,sc=W/MAP_SIZE;
  mmCtx.clearRect(0,0,W,H);
  mmCtx.fillStyle='rgba(0,0,8,0.9)';mmCtx.fillRect(0,0,W,H);
  for(const oid in orbsLocal){
    const o=orbsLocal[oid];
    mmCtx.fillStyle=o.color;
    mmCtx.fillRect((o.x*sc)|0,(o.y*sc)|0,1.5,1.5);
  }
  for(const pid in gameState.players){
    const p=gameState.players[pid]; if(!p.segments?.length)continue;
    const hd=p.segments[0]; const r=pid===myPlayerId?4.5:2.8;
    mmCtx.fillStyle=pid===myPlayerId?'#00ff8c':p.isOwner?'#ffd700':'rgba(255,255,255,0.5)';
    mmCtx.beginPath();mmCtx.arc(hd.x*sc,hd.y*sc,r,0,Math.PI*2);mmCtx.fill();
    if(pid===myPlayerId){
      const ang=p.angle||myAngle;
      mmCtx.strokeStyle='rgba(0,255,140,0.6)';mmCtx.lineWidth=1;
      mmCtx.beginPath();mmCtx.moveTo(hd.x*sc,hd.y*sc);
      mmCtx.lineTo(hd.x*sc+Math.cos(ang)*9,hd.y*sc+Math.sin(ang)*9);mmCtx.stroke();
    }
  }
  const vw=canvas.width*sc/camScale,vh=canvas.height*sc/camScale;
  mmCtx.strokeStyle='rgba(0,255,140,0.38)';mmCtx.lineWidth=1;
  mmCtx.strokeRect(camX*sc,camY*sc,vw,vh);
  mmCtx.strokeStyle='rgba(255,34,68,0.65)';mmCtx.lineWidth=1.5;
  mmCtx.strokeRect(0,0,W,H);
  const cnt=Object.keys(gameState.players).length;
  mmCtx.fillStyle='rgba(0,255,140,0.35)';
  mmCtx.font='8px Orbitron,monospace';
  mmCtx.textAlign='left';mmCtx.textBaseline='bottom';
  mmCtx.fillText(cnt+' ONLINE',3,H-3);
}

// ‚îÄ‚îÄ KILL FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addKillFeed(killedId,killerName){
  const killedName=gameState.players?.[killedId]?.name||'Someone';
  const kf=hel('killfeed'); if(!kf)return;
  const el=document.createElement('div'); el.className='kf-entry';
  el.innerHTML='<span style="color:#aaa">'+sanitize(killedName)+'</span> <span style="color:#ff2244">‚úï</span> <span style="color:#00ff8c">'+sanitize(killerName)+'</span>';
  kf.appendChild(el);
  while(kf.children.length>6)kf.removeChild(kf.firstChild);
  setTimeout(()=>{if(el.parentNode)el.remove();},5000);
}

// ‚îÄ‚îÄ TOASTS / SYS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showScorePop(text,color){
  const me=gameState.players[myPlayerId]; if(!me?.segments?.length)return;
  const sx=(me.segments[0].x-camX)*camScale+(canvas.width/2)*(1-camScale);
  const sy=(me.segments[0].y-camY)*camScale+(canvas.height/2)*(1-camScale);
  const el=document.createElement('div');el.className='score-pop';
  el.textContent=text;el.style.cssText='left:'+sx+'px;top:'+(sy-30)+'px;color:'+(color||'#00ff8c')+';';
  document.body.appendChild(el);setTimeout(()=>el.remove(),1400);
}
function showSysMsg(msg){
  const el=hel('sysmsg'); if(!el)return;
  el.textContent=msg; el.style.display='block';
  clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',4000);
}
function showToast(msg,type){
  const t=document.createElement('div');
  t.className='toast'+(type?' '+type:''); t.textContent=msg;
  hel('toast-container').appendChild(t);
  setTimeout(()=>{t.style.transition='opacity .3s';t.style.opacity='0';setTimeout(()=>t.remove(),300);},2800);
}
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  if(name==='menuScreen') hel('menuScreen').classList.remove('hidden');
  // 'game' mode: all .screen elements hidden, canvas/hud shown separately in startGame()
}

// ‚îÄ‚îÄ COSMETICS DISPLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCoinDisplays(){
  const total=myProfile.coins+sessionCoins;
  const mc=hel('menuCoinBalance'); if(mc) mc.textContent=myProfile.coins;
  const ic=hel('ingameCoinBalance'); if(ic) ic.textContent=total;
  updateEquippedDisplay();
}
function updateEquippedDisplay(){
  const et=hel('equippedTrailDisplay'),etl=hel('equippedTitleDisplay'),eb=hel('equippedBadgeDisplay');
  if(et) et.textContent=myProfile.equippedTrail?(cosmeticsCatalog[myProfile.equippedTrail]?.name||myProfile.equippedTrail):'None';
  if(etl) etl.textContent=myProfile.equippedTitle?(cosmeticsCatalog[myProfile.equippedTitle]?.name||myProfile.equippedTitle):'None';
  if(eb) eb.textContent=myProfile.equippedBadge?(cosmeticsCatalog[myProfile.equippedBadge]?.emoji||myProfile.equippedBadge):'‚Äî';
}
function openIngameCosmetics(){hel('ingameCosmeticsPanel').style.display='block';updateCoinDisplays();renderCosmeticsShop();}
function closeIngameCosmetics(){hel('ingameCosmeticsPanel').style.display='none';}

const RARITY_CLS={rare:'r-rare',epic:'r-epic',legendary:'r-legendary',mythic:'r-mythic'};
const RARITY_LBL={rare:'RARE',epic:'EPIC',legendary:'LEGENDARY',mythic:'MYTHIC ‚òÖ‚òÖ‚òÖ'};

function renderCosmeticsShop(){
  const cont=hel('cosmeticsShopContent'); if(!cont)return;
  const total=myProfile.coins+sessionCoins;
  const all=Object.values(cosmeticsCatalog);
  const pub=all.filter(c=>!c.ownerOnly), own=all.filter(c=>c.ownerOnly);
  const secs=[
    {k:'trail',label:'üî• TRAILS',        items:pub.filter(c=>c.type==='trail')},
    {k:'title',label:'üìõ TITLES',         items:pub.filter(c=>c.type==='title')},
    {k:'badge',label:'üèÖ BADGES',         items:pub.filter(c=>c.type==='badge')},
    {k:'otr',  label:'üëë OWNER TRAILS',   items:own.filter(c=>c.type==='trail')},
    {k:'oti',  label:'üëë OWNER TITLES',   items:own.filter(c=>c.type==='title')},
    {k:'oba',  label:'üëë OWNER BADGES',   items:own.filter(c=>c.type==='badge')},
  ];
  let h='';
  for(const sec of secs){
    if(!sec.items.length)continue;
    if(sec.k.startsWith('o')&&!isOwner)continue;
    h+='<div class="cosmetic-section-label">'+sec.label+'</div><div class="cosmetic-grid">';
    for(const c of sec.items){
      const owned=isOwner||(Array.isArray(myProfile.unlockedCosmetics)&&myProfile.unlockedCosmetics.includes(c.id));
      const equipped=(c.type==='trail'&&myProfile.equippedTrail===c.id)
                    ||(c.type==='title'&&(myProfile.equippedTitle===c.id||myProfile.equippedTitle===c.text))
                    ||(c.type==='badge'&&(myProfile.equippedBadge===c.id||myProfile.equippedBadge===c.emoji));
      const ownerOnly=!!c.ownerOnly;
      const rcls=c.rarity?' '+(RARITY_CLS[c.rarity]||''):'';
      const cls='cosmetic-card'+rcls+(equipped?' equipped':owned?' owned':ownerOnly?' owner-only locked-shop':' locked-shop');
      let btn='';
      if(equipped){
        btn='<button onclick="doUnequip(\''+c.type+'\')" style="margin-top:4px;width:100%;padding:3px;background:rgba(255,34,68,.12);border:1px solid rgba(255,34,68,.28);border-radius:2px;color:#ff4466;font-size:8px;cursor:pointer;font-family:Orbitron,monospace;">UNEQUIP</button>';
      }else if(owned){
        btn='<button onclick="doEquip(\''+c.id+'\')" style="margin-top:4px;width:100%;padding:3px;background:rgba(0,255,140,.07);border:1px solid rgba(0,255,140,.25);border-radius:2px;color:var(--glow);font-size:8px;cursor:pointer;font-family:Orbitron,monospace;">EQUIP</button>';
      }else if(ownerOnly){
        btn='<div style="margin-top:4px;font-size:7px;color:rgba(255,215,0,.4);text-align:center;font-family:Orbitron,monospace;">OWNER ONLY</div>';
      }else{
        const aff=total>=(c.price||0);
        btn='<button onclick="doBuy(\''+c.id+'\')" '+(aff?'':'disabled')+' style="margin-top:4px;width:100%;padding:3px;background:'+(aff?'rgba(255,215,0,.1)':'rgba(255,255,255,.02)')+';border:1px solid '+(aff?'rgba(255,215,0,.3)':'rgba(255,255,255,.07)')+';border-radius:2px;color:'+(aff?'var(--gold)':'rgba(255,255,255,.18)')+';font-size:8px;cursor:'+(aff?'pointer':'not-allowed')+';font-family:Orbitron,monospace;">'+(c.price||0)+' üí∞</button>';
      }
      const rt=c.rarity?'<div class="rarity-tag">'+(RARITY_LBL[c.rarity]||'')+'</div>':'';
      h+='<div class="'+cls+'">'+(equipped?'<div class="equipped-label">‚úì</div>':'')+(ownerOnly?'<div class="cosmetic-badge">üëë</div>':'')+'<span class="cosmetic-icon">'+c.emoji+'</span><div class="cosmetic-name">'+c.name+'</div>'+btn+rt+'</div>';
    }
    h+='</div>';
  }
  cont.innerHTML=h||'<p style="color:var(--dim);text-align:center;padding:20px;">No cosmetics available.</p>';
}
function doBuy(id){if(socket)socket.emit('buyCosmetic',{cosmeticId:id});}
function doEquip(id){if(socket)socket.emit('equipCosmetic',{cosmeticId:id});}
function doUnequip(s){if(socket)socket.emit('unequipCosmetic',{slot:s});}

// ‚îÄ‚îÄ OWNER PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
hel('closeOwnerPanel').onclick=()=>hel('ownerPanel').classList.add('hidden');
document.querySelectorAll('.owner-nav-btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.owner-nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.owner-tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    const tab=document.getElementById('tab-'+btn.dataset.tab);if(tab)tab.classList.add('active');
    if(['players','actions','skins','ownercosmetics'].includes(btn.dataset.tab))refreshPlayers();
    updateOwnerStats();
  };
});
function openOwnerPanel(){hel('ownerPanel').classList.remove('hidden');updateOwnerStats();refreshPlayers();}
hel('owner-tag-hud').onclick=openOwnerPanel;
function updateOwnerStats(){
  fetch('/api/stats').then(r=>r.json()).then(d=>{
    const s=(id,v)=>{const e=hel(id);if(e)e.textContent=v;};
    s('os-players',d.players);s('os-orbs',d.orbs);s('os-event',d.activeEvent||'NONE');
  }).catch(()=>{});
}
function refreshPlayers(){if(!socket)return;socket.emit('ownerAction',{action:'getPlayers',password:ownerPass||''});}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/'/g,'&#39;');}
function renderPlayerTable(list){
  const tb=hel('playerTableBody'); if(!tb)return;
  if(!list.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:rgba(255,215,0,.3);padding:20px;">No players</td></tr>';return;}
  tb.innerHTML=list.map(p=>`<tr>
    <td><span style="color:${p.isOwner?'#ffd700':'rgba(255,215,0,.8)'}">${p.isOwner?'üëë ':''}${esc(p.name)}${p.isBot?' ü§ñ':''}</span></td>
    <td style="font-family:Space Mono;font-size:11px;color:rgba(255,215,0,.55);">${p.length}</td>
    <td style="font-family:Space Mono;font-size:11px;color:rgba(255,215,0,.55);">${p.score}</td>
    <td style="font-family:Space Mono;font-size:11px;color:var(--gold);">üí∞${p.coins||0}</td>
    <td style="font-size:10px;color:rgba(255,215,0,.45);">${p.equippedBadge||''} ${p.equippedTitle||''} ${p.equippedTrail?'üé®':''}</td>
    <td><div style="display:flex;gap:3px;flex-wrap:wrap;">
      <button class="btn btn-danger btn-sm" onclick="quickKill('${p.id}','${esc(p.name)}')">‚ò†Ô∏è</button>
      ${!p.isBot?`<button class="btn btn-sm" style="border:1px solid rgba(255,34,68,.3);color:rgba(255,34,68,.6);padding:5px 7px;font-size:8px;" onclick="quickKick('${p.id}','${esc(p.name)}')">üö´</button>`:''}
      <button class="btn btn-gold btn-sm" onclick="quickSize('${p.id}','${esc(p.name)}')">üìè</button>
      ${!p.isBot?`<button class="btn btn-gold btn-sm" onclick="quickCoins('${p.id}','${esc(p.name)}')">üí∞</button>`:''}
    </div></td></tr>`).join('');
}
function populateSelects(list){
  ['sizeTarget','coinsTarget','swapP1','swapP2','kickTarget','killTarget','skinTarget','ownerCosmeticTarget','freezeTarget','setSizeTarget'].forEach(id=>{
    const el=hel(id); if(!el)return;
    el.innerHTML=list.map(p=>'<option value="'+p.id+'">'+(p.isOwner?'üëë ':'')+esc(p.name)+' ('+p.length+')</option>').join('');
  });
}
function showOwnerAlert(msg,type){
  const el=hel('ownerAlert'); if(!el)return;
  el.textContent=msg;el.className='o-alert '+type;el.style.display='block';
  setTimeout(()=>el.style.display='none',4000);
}
function ownerAction(action,value,targetId){
  if(!socket||!socket.connected){showToast('Not connected ‚Äî join the game first.','error');return;}
  socket.emit('ownerAction',{action,value,targetId,password:ownerPass||''});
}
function doGiveSize(){ownerAction('giveSize',hel('sizeAmount').value,hel('sizeTarget').value);}
function doGiveCoins(){ownerAction('giveCoins',hel('coinsAmount').value,hel('coinsTarget').value);}
function doSwapSize(){ownerAction('swapSize',hel('swapP2').value,hel('swapP1').value);}
function doKick(){ownerAction('kick',hel('kickReason').value||'Kicked by owner.',hel('kickTarget').value);}
function doInstaKill(){ownerAction('instaKill',null,hel('killTarget').value);}
function doGiveSkin(){ownerAction('giveSkin',hel('skinToGive').value,hel('skinTarget').value);}
function doGiveCosmetic(){ownerAction('giveCosmetic',hel('ownerCosmeticToGive').value,hel('ownerCosmeticTarget').value);}
function doBroadcast(){const m=hel('broadcastMsg').value.trim();if(!m)return;ownerAction('broadcast',m);hel('broadcastMsg').value='';}
function quickKill(id,n){if(!confirm('Kill '+n+'?'))return;ownerAction('instaKill',null,id);}
function quickKick(id,n){const r=prompt('Kick reason for '+n+':','Kicked by Z3N0');if(r===null)return;ownerAction('kick',r,id);}
function quickSize(id,n){const a=prompt('Give size to '+n+':','50');if(!a)return;ownerAction('giveSize',a,id);}
function quickCoins(id,n){const a=prompt('Give coins to '+n+':','500');if(!a)return;ownerAction('giveCoins',a,id);}
function doFreeze(){ownerAction('freeze',hel('freezeDuration').value||'3000',hel('freezeTarget').value);}
function doSetSize(){ownerAction('setSize',hel('setSizeAmount').value,hel('setSizeTarget').value);}

// ‚îÄ‚îÄ PLAYFAB CATALOG & CLOUDSCRIPT GENERATORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateCatalogJSON(){
  const all=Object.values(cosmeticsCatalog);
  const items=all.map(c=>({
    ItemId:c.id,
    DisplayName:c.name,
    Description:(c.emoji||'')+' '+c.name+' ‚Äî '+(c.rarity||'common').toUpperCase()+' '+c.type,
    VirtualCurrencyPrices:{GC:c.ownerOnly?0:(c.price||0)},
    Tags:[c.type,(c.rarity||'common'),'cosmetic',c.ownerOnly?'owner-only':'purchasable'],
    CustomData:JSON.stringify({type:c.type,rarity:c.rarity,emoji:c.emoji||'',glow:c.glow||null,text:c.text||null,ownerOnly:!!c.ownerOnly})
  }));
  const out=JSON.stringify({CatalogVersion:'Z3N0_v1',Catalog:items},null,2);
  const el=hel('catalogJsonOutput');if(el)el.value=out;
  showOwnerAlert('Catalog generated! '+items.length+' items ('+all.filter(c=>c.ownerOnly).length+' owner-only).','success');
}
function copyCatalogJSON(){
  const el=hel('catalogJsonOutput');
  if(!el||!el.value){showOwnerAlert('Generate catalog first!','error');return;}
  navigator.clipboard.writeText(el.value).then(()=>showOwnerAlert('Copied!','success')).catch(()=>showOwnerAlert('Select all text then Ctrl+C.','error'));
}
function generateCloudScript(){
  const lines=[
    "// Z3N0 SNAKE REALM ‚Äî PlayFab CloudScript v2.0",
    "// Paste into: PlayFab > Automation > CloudScript",
    "'use strict';",
    "const COIN_CURRENCY='GC';",
    "const CATALOG_VERSION='Z3N0_v1';",
    "",
    "handlers.grantCoins=function(args,context){",
    "  var amount=Math.max(0,Math.min(args.amount||1,10000));",
    "  try{",
    "    server.AddUserVirtualCurrency({PlayFabId:args.playerId,VirtualCurrency:COIN_CURRENCY,Amount:amount});",
    "    var bal=server.GetUserInventory({PlayFabId:args.playerId});",
    "    return{success:true,newBalance:bal.VirtualCurrency[COIN_CURRENCY]||0};",
    "  }catch(e){return{success:false,error:e.toString()};}",
    "};",
    "",
    "handlers.purchaseCosmetic=function(args,context){",
    "  var playerId=args.playerId,cosmeticId=args.cosmeticId;",
    "  if(!cosmeticId)return{success:false,error:'No cosmeticId'};",
    "  try{",
    "    var inv=server.GetUserInventory({PlayFabId:playerId});",
    "    var already=inv.Inventory.filter(function(i){return i.ItemId===cosmeticId;});",
    "    if(already.length)return{success:false,error:'Already owned'};",
    "    var catalog=server.GetCatalogItems({CatalogVersion:CATALOG_VERSION});",
    "    var item=catalog.Catalog.filter(function(i){return i.ItemId===cosmeticId;})[0];",
    "    if(!item)return{success:false,error:'Item not found'};",
    "    var cd=JSON.parse(item.CustomData||'{}');",
    "    if(cd.ownerOnly)return{success:false,error:'Owner only item'};",
    "    var price=item.VirtualCurrencyPrices[COIN_CURRENCY]||0;",
    "    if((inv.VirtualCurrency[COIN_CURRENCY]||0)<price)return{success:false,error:'Insufficient coins'};",
    "    server.SubtractUserVirtualCurrency({PlayFabId:playerId,VirtualCurrency:COIN_CURRENCY,Amount:price});",
    "    server.GrantItemsToUser({PlayFabId:playerId,CatalogVersion:CATALOG_VERSION,ItemIds:[cosmeticId]});",
    "    var newInv=server.GetUserInventory({PlayFabId:playerId});",
    "    return{success:true,newBalance:newInv.VirtualCurrency[COIN_CURRENCY]||0,",
    "      unlockedCosmetics:newInv.Inventory.map(function(i){return i.ItemId;})};",
    "  }catch(e){return{success:false,error:e.toString()};}",
    "};",
    "",
    "handlers.ownerGrantCosmetic=function(args,context){",
    "  var td=server.GetTitleData({});",
    "  if(args.ownerPassword!==td.Data['OwnerPassword'])return{success:false,error:'Unauthorized'};",
    "  try{",
    "    var inv=server.GetUserInventory({PlayFabId:args.targetId});",
    "    var has=inv.Inventory.filter(function(i){return i.ItemId===args.cosmeticId;});",
    "    if(!has.length)server.GrantItemsToUser({PlayFabId:args.targetId,CatalogVersion:CATALOG_VERSION,ItemIds:[args.cosmeticId]});",
    "    var newInv=server.GetUserInventory({PlayFabId:args.targetId});",
    "    return{success:true,unlockedCosmetics:newInv.Inventory.map(function(i){return i.ItemId;})};",
    "  }catch(e){return{success:false,error:e.toString()};}",
    "};",
    "",
    "handlers.ownerGrantCoins=function(args,context){",
    "  var td=server.GetTitleData({});",
    "  if(args.ownerPassword!==td.Data['OwnerPassword'])return{success:false,error:'Unauthorized'};",
    "  server.AddUserVirtualCurrency({PlayFabId:args.targetId,VirtualCurrency:COIN_CURRENCY,Amount:args.amount});",
    "  var bal=server.GetUserInventory({PlayFabId:args.targetId});",
    "  return{success:true,newBalance:bal.VirtualCurrency[COIN_CURRENCY]};",
    "};",
    "",
    "handlers.equipCosmetic=function(args,context){",
    "  var playerId=args.playerId,cosmeticId=args.cosmeticId;",
    "  try{",
    "    var inv=server.GetUserInventory({PlayFabId:playerId});",
    "    var has=inv.Inventory.filter(function(i){return i.ItemId===cosmeticId;});",
    "    if(!has.length)return{success:false,error:'Not owned'};",
    "    var catalog=server.GetCatalogItems({CatalogVersion:CATALOG_VERSION});",
    "    var item=catalog.Catalog.filter(function(i){return i.ItemId===cosmeticId;})[0];",
    "    if(!item)return{success:false,error:'Not in catalog'};",
    "    var cd=JSON.parse(item.CustomData||'{}');",
    "    var ud=server.GetUserData({PlayFabId:playerId,Keys:['equippedCosmetics']});",
    "    var eq={};try{eq=JSON.parse((ud.Data.equippedCosmetics&&ud.Data.equippedCosmetics.Value)||'{}');}catch(e2){}",
    "    eq[cd.type]=cosmeticId;",
    "    server.UpdateUserData({PlayFabId:playerId,Data:{equippedCosmetics:JSON.stringify(eq)}});",
    "    return{success:true,equipped:eq};",
    "  }catch(e){return{success:false,error:e.toString()};}",
    "};",
    "",
    "handlers.unequipCosmetic=function(args,context){",
    "  try{",
    "    var ud=server.GetUserData({PlayFabId:args.playerId,Keys:['equippedCosmetics']});",
    "    var eq={};try{eq=JSON.parse((ud.Data.equippedCosmetics&&ud.Data.equippedCosmetics.Value)||'{}');}catch(e2){}",
    "    delete eq[args.slot];",
    "    server.UpdateUserData({PlayFabId:args.playerId,Data:{equippedCosmetics:JSON.stringify(eq)}});",
    "    return{success:true,equipped:eq};",
    "  }catch(e){return{success:false,error:e.toString()};}",
    "};",
    "",
    "handlers.getPlayerProfile=function(args,context){",
    "  var playerId=args.playerId||context.playerId;",
    "  try{",
    "    var inv=server.GetUserInventory({PlayFabId:playerId});",
    "    var ud=server.GetUserData({PlayFabId:playerId,Keys:['equippedCosmetics']});",
    "    var eq={};try{eq=JSON.parse((ud.Data.equippedCosmetics&&ud.Data.equippedCosmetics.Value)||'{}');}catch(e2){}",
    "    return{success:true,coins:inv.VirtualCurrency[COIN_CURRENCY]||0,",
    "      unlockedCosmetics:inv.Inventory.map(function(i){return i.ItemId;}),",
    "      equippedTrail:eq.trail||null,equippedTitle:eq.title||null,equippedBadge:eq.badge||null};",
    "  }catch(e){return{success:false,error:e.toString()};}",
    "};",
    "",
    "handlers.saveHighScore=function(args,context){",
    "  try{",
    "    server.UpdatePlayerStatistics({PlayFabId:args.playerId||context.playerId,",
    "      Statistics:[{StatisticName:'HighScore',Value:args.score||0}]});",
    "    return{success:true};",
    "  }catch(e){return{success:false,error:e.toString()};}",
    "};"
  ];
  const el=hel('cloudScriptOutput');if(el)el.value=lines.join('\n');
  showOwnerAlert('CloudScript generated! Copy into PlayFab Automation.','success');
}
function copyCloudScript(){
  const el=hel('cloudScriptOutput');
  if(!el||!el.value){showOwnerAlert('Generate CloudScript first!','error');return;}
  navigator.clipboard.writeText(el.value).then(()=>showOwnerAlert('CloudScript copied!','success')).catch(()=>showOwnerAlert('Select all text then Ctrl+C.','error'));
}

// ‚îÄ‚îÄ MENU STATS + HOW TO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(()=>{
  fetch('/api/stats').then(r=>r.json()).then(d=>{
    const s=(id,v)=>{const e=hel(id);if(e)e.textContent=v;};
    s('statPlayers',d.players);s('statBots',d.bots||0);s('statOrbs',d.orbs);
    const ev=hel('statEvent');if(ev)ev.style.display=d.activeEvent?'inline':'none';
  }).catch(()=>{});
},5000);

hel('howToBtn').onclick=()=>{
  const bk=boostKey==='shift'?'Shift':boostKey==='space'?'Space':'Shift/Space';
  alert(`üêç Z3N0 SNAKE REALM\n\nControls: ${controlScheme.toUpperCase()}\n${controlScheme==='mouse'?'Move mouse to steer':'Use '+controlScheme+' keys to steer'}\nHold click or ${bk} to BOOST\n\nüìñ TIPS:\n‚Ä¢ Eat glowing orbs to grow & earn coins\n‚Ä¢ Make enemies crash INTO your body\n‚Ä¢ Encircle smaller snakes to trap them\n‚Ä¢ Avoid the flashing red border\n‚Ä¢ Boosting costs size but gives speed\n‚Ä¢ Press [T] to chat\n‚Ä¢ Press [F1] for Owner Panel (owners only)\n\nüí∞ Buy cosmetics in the shop!\nüèÜ Your best score: ${highScore}`);
};

// ‚îÄ‚îÄ MENU PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  const c=hel('bgParticles'); if(!c)return;
  for(let i=0;i<28;i++){
    const p=document.createElement('div'); p.className='mp';
    p.style.cssText='left:'+Math.random()*100+'%;animation-duration:'+(4+Math.random()*10)+'s;animation-delay:'+Math.random()*8+'s;width:'+(Math.random()<0.3?3:2)+'px;height:'+(Math.random()<0.3?3:2)+'px;';
    c.appendChild(p);
  }
})();

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setupCanvas();
updateBoostLabel();
hel('nameInput').focus();
</script>
</body>
</html>
