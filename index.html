<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Z3N0'S SERPENT REALM ‚Äî SNAKE GAME</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
:root {
  --void: #000008;
  --deep: #05050f;
  --panel: rgba(0,255,140,0.04);
  --border: rgba(0,255,140,0.2);
  --glow: #00ff8c;
  --glow2: #ff2244;
  --glow3: #aa44ff;
  --gold: #ffd700;
  --text: #c8ffd4;
  --dim: rgba(200,255,212,0.5);
  --owner: #ffd700;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--void);}
body{font-family:'Rajdhani',sans-serif;color:var(--text);}
body::before{
  content:'';position:fixed;inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,140,0.012) 2px,rgba(0,255,140,0.012) 4px);
  pointer-events:none;z-index:9999;
}
#gameCanvas{position:fixed;inset:0;display:none;cursor:none;}
#cursor{
  position:fixed;width:18px;height:18px;
  border:2px solid var(--glow);border-radius:50%;
  pointer-events:none;z-index:10000;
  transform:translate(-50%,-50%);
  transition:width 0.08s,height 0.08s;
  box-shadow:0 0 12px var(--glow),inset 0 0 5px rgba(0,255,140,0.2);
}
#cursor::after{content:'';position:absolute;top:50%;left:50%;width:3px;height:3px;background:var(--glow);border-radius:50%;transform:translate(-50%,-50%);}
.screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;}
.screen.hidden{display:none!important;}

/* ===== MENU ===== */
#menuScreen{
  background:radial-gradient(ellipse at 50% 30%,rgba(0,255,140,0.08) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 70%,rgba(170,68,255,0.06) 0%,transparent 50%),var(--void);
  flex-direction:column;gap:0;
}
.menu-bg-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.menu-particle{position:absolute;width:2px;height:2px;background:var(--glow);border-radius:50%;animation:float-up linear infinite;opacity:0;}
@keyframes float-up{0%{opacity:0;transform:translateY(100vh) scale(1);}10%{opacity:1;}90%{opacity:0.5;}100%{opacity:0;transform:translateY(-20px) scale(0);}}
.logo-wrap{position:relative;text-align:center;margin-bottom:24px;}
.logo-z3n0{
  font-family:'Orbitron',monospace;font-size:clamp(60px,10vw,120px);font-weight:900;
  background:linear-gradient(135deg,#00ff8c,#aa44ff,#ff2244,#ffd700,#00ff8c);
  background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:gradientShift 3s ease infinite;letter-spacing:-2px;line-height:1;
  filter:drop-shadow(0 0 30px rgba(0,255,140,0.5));
}
@keyframes gradientShift{0%,100%{background-position:0% 50%;}50%{background-position:100% 50%;}}
.logo-sub{font-family:'Orbitron',monospace;font-size:clamp(11px,1.8vw,16px);letter-spacing:8px;color:var(--dim);margin-top:4px;animation:pulse 2s ease infinite;}
.logo-owner-tag{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:4px;color:var(--gold);margin-top:6px;animation:pulse 1.5s ease infinite;}
@keyframes pulse{0%,100%{opacity:0.5;}50%{opacity:1;}}
.owner-crown{position:absolute;top:-30px;left:50%;transform:translateX(-50%);font-size:28px;animation:crown-bounce 1.5s ease infinite;}
@keyframes crown-bounce{0%,100%{transform:translateX(-50%) translateY(0);}50%{transform:translateX(-50%) translateY(-8px);}}
.z3n0-watermark{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:10px;letter-spacing:6px;color:rgba(255,215,0,0.12);pointer-events:none;white-space:nowrap;}
.menu-panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:24px;width:min(480px,92vw);backdrop-filter:blur(20px);box-shadow:0 0 60px rgba(0,255,140,0.05),inset 0 0 60px rgba(0,255,140,0.02);position:relative;}
.menu-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--glow),transparent);border-radius:6px 6px 0 0;}
.menu-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px;}
.menu-tab-btn{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;padding:6px 12px;border-radius:2px;border:1px solid transparent;cursor:pointer;background:none;color:var(--dim);transition:all 0.2s;}
.menu-tab-btn:hover{color:var(--glow);border-color:rgba(0,255,140,0.2);}
.menu-tab-btn.active{color:var(--glow);border-color:var(--glow);background:rgba(0,255,140,0.05);}
.menu-tab-content{display:none;}
.menu-tab-content.active{display:block;}
.input-group{display:flex;flex-direction:column;gap:6px;margin-bottom:16px;}
.input-label{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;}
.game-input{background:rgba(0,255,140,0.04);border:1px solid rgba(0,255,140,0.15);border-radius:3px;padding:12px 16px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:500;outline:none;transition:border-color 0.2s,box-shadow 0.2s;width:100%;}
.game-input:focus{border-color:var(--glow);box-shadow:0 0 20px rgba(0,255,140,0.1);}
.skin-selector{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px;}
.skin-opt{aspect-ratio:1;border-radius:4px;border:2px solid rgba(255,255,255,0.1);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.2s;position:relative;overflow:hidden;}
.skin-opt:hover{transform:scale(1.1);border-color:white;}
.skin-opt.selected{border-color:var(--glow);box-shadow:0 0 15px rgba(0,255,140,0.4);transform:scale(1.15);}
.skin-opt.owner-only{border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,0.3);}
.skin-opt.owner-only::after{content:'üëë';position:absolute;bottom:1px;right:1px;font-size:9px;}
.skin-opt.locked{opacity:0.3;filter:grayscale(1);cursor:not-allowed;}
.btn{font-family:'Orbitron',monospace;font-size:12px;letter-spacing:2px;padding:14px 28px;border-radius:3px;border:none;cursor:pointer;text-transform:uppercase;transition:all 0.2s;position:relative;overflow:hidden;width:100%;}
.btn::before{content:'';position:absolute;inset:0;background:white;opacity:0;transition:opacity 0.2s;}
.btn:hover::before{opacity:0.05;}
.btn:active{transform:scale(0.98);}
.btn-primary{background:linear-gradient(135deg,rgba(0,255,140,0.2),rgba(0,255,140,0.1));color:var(--glow);border:1px solid var(--glow);box-shadow:0 0 20px rgba(0,255,140,0.15);}
.btn-primary:hover{box-shadow:0 0 40px rgba(0,255,140,0.3);transform:translateY(-1px);}
.btn-danger{background:linear-gradient(135deg,rgba(255,34,68,0.2),rgba(255,34,68,0.1));color:var(--glow2);border:1px solid var(--glow2);}
.btn-gold{background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,215,0,0.1));color:var(--gold);border:1px solid var(--gold);}
.btn-sm{padding:8px 16px;font-size:10px;width:auto;}
.btn-row{display:flex;gap:8px;margin-top:8px;}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(0,255,140,0.08);}
.setting-label{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;color:var(--dim);}
.setting-desc{font-size:12px;color:rgba(200,255,212,0.3);margin-top:2px;}
.control-radio-group{display:flex;gap:6px;flex-wrap:wrap;}
.control-radio{padding:6px 12px;border-radius:2px;border:1px solid rgba(0,255,140,0.2);cursor:pointer;font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;color:var(--dim);background:none;transition:all 0.2s;}
.control-radio:hover{border-color:var(--glow);color:var(--glow);}
.control-radio.active{border-color:var(--glow);color:var(--glow);background:rgba(0,255,140,0.08);}
.coin-balance{display:flex;align-items:center;gap:8px;background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.2);border-radius:3px;padding:8px 16px;margin-bottom:16px;}
.coin-amount{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:var(--gold);}
.coin-label{font-size:11px;letter-spacing:2px;color:rgba(255,215,0,0.5);}
.cosmetic-section-label{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:var(--dim);margin:12px 0 8px;}
.cosmetic-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px;}
.cosmetic-card{border-radius:4px;border:1px solid rgba(0,255,140,0.1);padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;position:relative;background:rgba(0,255,140,0.02);}
.cosmetic-card:hover{border-color:var(--glow);background:rgba(0,255,140,0.06);transform:translateY(-2px);}
.cosmetic-card.owned{border-color:rgba(0,255,140,0.3);}
.cosmetic-card.equipped{border-color:var(--glow);background:rgba(0,255,140,0.1);box-shadow:0 0 14px rgba(0,255,140,0.25);}
.cosmetic-card.owner-only{border-color:rgba(255,215,0,0.3);background:rgba(255,215,0,0.03);}
.cosmetic-card.owner-only.owned{border-color:var(--gold);box-shadow:0 0 12px rgba(255,215,0,0.2);}
.cosmetic-card.locked-shop{opacity:0.55;}
.cosmetic-icon{font-size:24px;display:block;margin-bottom:5px;}
.cosmetic-name{font-size:10px;font-weight:600;color:var(--text);line-height:1.2;}
.cosmetic-price{font-family:'Orbitron',monospace;font-size:9px;color:var(--gold);margin-top:3px;}
.cosmetic-badge{position:absolute;top:3px;right:3px;font-size:9px;}
.equipped-label{position:absolute;bottom:3px;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:7px;letter-spacing:1px;color:var(--glow);white-space:nowrap;}

/* ===== HUD ===== */
#hud{position:fixed;inset:0;pointer-events:none;z-index:200;display:none;}
#hud-score{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,8,0.85);border:1px solid var(--border);border-radius:3px;padding:8px 24px;text-align:center;backdrop-filter:blur(10px);}
#hud-score .val{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--glow);text-shadow:0 0 20px var(--glow);}
#hud-score .label{font-size:10px;letter-spacing:3px;color:var(--dim);}
#hud-coins{position:absolute;top:90px;left:50%;transform:translateX(-50%);background:rgba(0,0,8,0.85);border:1px solid rgba(255,215,0,0.2);border-radius:3px;padding:4px 16px;text-align:center;font-family:'Orbitron',monospace;font-size:13px;color:var(--gold);white-space:nowrap;}
#minimap{position:absolute;bottom:20px;right:20px;width:160px;height:160px;background:rgba(0,0,8,0.9);border:1px solid var(--border);border-radius:3px;overflow:hidden;}
#leaderboard{position:absolute;top:20px;right:20px;background:rgba(0,0,8,0.85);border:1px solid var(--border);border-radius:3px;padding:12px;min-width:180px;backdrop-filter:blur(10px);}
#leaderboard h3{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;color:var(--glow);margin-bottom:8px;text-align:center;}
.lb-entry{display:flex;gap:8px;align-items:center;font-size:13px;padding:3px 0;border-bottom:1px solid rgba(0,255,140,0.05);}
.lb-rank{font-family:'Orbitron',monospace;font-size:11px;min-width:22px;}
.lb-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lb-name.is-owner{color:var(--gold);}
.lb-len{font-family:'Space Mono',monospace;font-size:11px;color:var(--dim);}
.lb-rank.top1{color:#ffd700;}
.lb-rank.top2{color:#c0c0c0;}
.lb-rank.top3{color:#cd7f32;}
#killfeed{position:absolute;top:20px;left:20px;display:flex;flex-direction:column;gap:4px;pointer-events:none;}
.kf-entry{background:rgba(0,0,8,0.8);border:1px solid rgba(255,34,68,0.2);border-radius:3px;padding:4px 10px;font-size:13px;animation:kfSlide 0.2s ease;opacity:1;transition:opacity 0.3s;}
@keyframes kfSlide{from{opacity:0;transform:translateX(-20px);}to{opacity:1;transform:translateX(0);}}
#boostbar{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);text-align:center;pointer-events:none;}
.boost-label{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;color:var(--dim);margin-bottom:4px;}
.boost-track{width:180px;height:6px;background:rgba(0,255,140,0.1);border:1px solid rgba(0,255,140,0.2);border-radius:3px;overflow:hidden;}
.boost-fill{height:100%;background:linear-gradient(90deg,var(--glow),#44ffaa);transition:width 0.1s;width:100%;border-radius:3px;}
#owner-tag-hud{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(255,215,0,0.12),rgba(255,215,0,0.06));border:1px solid rgba(255,215,0,0.3);border-radius:3px;padding:6px 20px;font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--gold);white-space:nowrap;pointer-events:auto;cursor:pointer;display:none;animation:owner-pulse 2s ease infinite;}
@keyframes owner-pulse{0%,100%{box-shadow:0 0 10px rgba(255,215,0,0.2);}50%{box-shadow:0 0 30px rgba(255,215,0,0.6),0 0 60px rgba(255,215,0,0.2);}}
#eventBanner{position:absolute;top:160px;left:50%;transform:translateX(-50%);display:none;}
.event-title{background:linear-gradient(135deg,rgba(170,68,255,0.3),rgba(0,255,140,0.2));border:1px solid var(--glow3);border-radius:3px;padding:8px 24px;font-family:'Orbitron',monospace;font-size:14px;letter-spacing:3px;color:var(--glow3);animation:pulse 1s ease infinite;box-shadow:0 0 20px rgba(170,68,255,0.3);}
#sysmsg{position:absolute;top:200px;left:50%;transform:translateX(-50%);background:rgba(0,0,8,0.9);border:1px solid var(--glow3);border-radius:3px;padding:8px 20px;font-size:14px;letter-spacing:2px;color:var(--glow3);display:none;white-space:nowrap;}
#z3n0-watermark-game{position:absolute;bottom:16px;left:16px;font-family:'Orbitron',monospace;font-size:13px;letter-spacing:6px;color:rgba(255,215,0,0.08);pointer-events:none;font-weight:900;}
#inGameCosmeticsBtn{position:absolute;top:20px;left:200px;pointer-events:auto;display:none;}

/* ===== DEATH SCREEN ===== */
#deathScreen{background:radial-gradient(ellipse at 50% 50%,rgba(255,34,68,0.08) 0%,transparent 60%),var(--void);flex-direction:column;align-items:center;gap:16px;}
.death-title{font-family:'Orbitron',monospace;font-size:clamp(40px,8vw,80px);font-weight:900;color:var(--glow2);text-shadow:0 0 40px var(--glow2),0 0 80px rgba(255,34,68,0.3);animation:deathPulse 1s ease infinite;}
@keyframes deathPulse{0%,100%{opacity:1;}50%{opacity:0.7;}}
.death-info{font-family:'Orbitron',monospace;font-size:16px;letter-spacing:3px;color:var(--dim);}
.death-coins-earned{font-family:'Orbitron',monospace;font-size:14px;color:var(--gold);letter-spacing:2px;min-height:20px;}
.death-stats{display:flex;gap:40px;}
.death-stat .val{font-family:'Orbitron',monospace;font-size:32px;font-weight:900;color:var(--glow);}
.death-stat .lbl{font-size:11px;letter-spacing:3px;color:var(--dim);}
.death-buttons{display:flex;gap:12px;}

/* ===== TOAST ===== */
#toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9998;display:flex;flex-direction:column;align-items:center;gap:6px;pointer-events:none;}
.toast{background:rgba(0,0,8,0.95);border:1px solid var(--border);border-radius:3px;padding:8px 20px;font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--glow);white-space:nowrap;}
.toast.gold{border-color:var(--gold);color:var(--gold);}
.toast.error{border-color:var(--glow2);color:var(--glow2);}

/* ===== MUSIC ===== */
#musicControls{position:fixed;bottom:20px;left:20px;z-index:300;display:none;align-items:center;gap:8px;background:rgba(0,0,8,0.8);border:1px solid var(--border);border-radius:3px;padding:8px 12px;}
.music-btn{background:none;border:none;cursor:pointer;font-size:16px;transition:transform 0.2s;}
.music-btn:hover{transform:scale(1.2);}
.music-vis{display:flex;gap:3px;align-items:flex-end;height:16px;}
.music-bar{width:3px;background:var(--glow);border-radius:1px;animation:musicVis 0.5s ease infinite;}
.music-bar:nth-child(2){animation-delay:0.1s;}
.music-bar:nth-child(3){animation-delay:0.2s;}
.music-bar:nth-child(4){animation-delay:0.3s;}
.music-bar:nth-child(5){animation-delay:0.4s;}
@keyframes musicVis{0%,100%{height:3px;}50%{height:14px;}}
.music-vis.music-paused .music-bar{animation:none;height:4px;}

/* ===== BROADCAST BANNER ===== */
#broadcastBanner{position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,rgba(255,215,0,0.15),rgba(255,215,0,0.08),rgba(255,215,0,0.15));border-bottom:1px solid rgba(255,215,0,0.3);padding:10px 24px;font-family:'Orbitron',monospace;font-size:12px;letter-spacing:2px;color:var(--gold);z-index:9000;display:none;text-align:center;}

/* ===== OWNER PANEL ===== */
#ownerPanel{position:fixed;inset:0;z-index:600;display:flex;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);}
#ownerPanel.hidden{display:none!important;}
.owner-sidebar{width:230px;background:rgba(0,0,0,0.95);border-right:1px solid rgba(255,215,0,0.15);display:flex;flex-direction:column;padding:0;flex-shrink:0;}
.owner-sidebar-header{padding:24px 16px;border-bottom:1px solid rgba(255,215,0,0.15);text-align:center;background:radial-gradient(ellipse at 50% 50%,rgba(255,215,0,0.05),transparent);}
.owner-sidebar-header .crown-big{font-size:40px;display:block;margin-bottom:8px;filter:drop-shadow(0 0 10px rgba(255,215,0,0.5));}
.owner-sidebar-header h2{font-family:'Orbitron',monospace;font-size:16px;letter-spacing:2px;color:var(--gold);}
.owner-sidebar-header p{font-size:11px;color:rgba(255,215,0,0.4);}
.owner-nav{display:flex;flex-direction:column;padding:12px 0;flex:1;}
.owner-nav-btn{display:flex;align-items:center;gap:12px;padding:12px 20px;background:none;border:none;border-left:3px solid transparent;cursor:pointer;color:rgba(255,215,0,0.5);font-family:'Orbitron',monospace;font-size:11px;letter-spacing:1px;transition:all 0.2s;text-align:left;}
.owner-nav-btn:hover{background:rgba(255,215,0,0.04);color:var(--gold);border-left-color:rgba(255,215,0,0.3);}
.owner-nav-btn.active{background:rgba(255,215,0,0.08);color:var(--gold);border-left-color:var(--gold);}
.owner-nav-icon{font-size:16px;width:22px;flex-shrink:0;}
.owner-main{flex:1;background:rgba(0,0,8,0.97);display:flex;flex-direction:column;overflow:hidden;}
.owner-topbar{padding:16px 24px;border-bottom:1px solid rgba(255,215,0,0.1);display:flex;align-items:center;justify-content:space-between;}
.owner-topbar h1{font-family:'Orbitron',monospace;font-size:15px;letter-spacing:3px;color:var(--gold);}
.owner-content{flex:1;overflow-y:auto;padding:24px;}
.owner-content::-webkit-scrollbar{width:4px;}
.owner-content::-webkit-scrollbar-track{background:transparent;}
.owner-content::-webkit-scrollbar-thumb{background:rgba(255,215,0,0.2);border-radius:2px;}
.owner-tab{display:none;}
.owner-tab.active{display:block;}
.o-card{background:rgba(255,215,0,0.03);border:1px solid rgba(255,215,0,0.12);border-radius:4px;padding:16px;margin-bottom:16px;}
.o-card h3{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--gold);margin-bottom:12px;}
.o-alert{display:none;padding:10px 16px;border-radius:3px;font-size:13px;margin-bottom:16px;}
.o-alert.success{background:rgba(0,255,140,0.1);border:1px solid var(--glow);color:var(--glow);}
.o-alert.error{background:rgba(255,34,68,0.1);border:1px solid var(--glow2);color:var(--glow2);}
.o-input{width:100%;background:rgba(255,215,0,0.04);border:1px solid rgba(255,215,0,0.15);border-radius:3px;padding:10px 14px;color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:16px;outline:none;margin-bottom:8px;transition:border-color 0.2s;}
.o-input:focus{border-color:var(--gold);}
.o-select{width:100%;background:rgba(0,0,8,0.8);border:1px solid rgba(255,215,0,0.2);border-radius:3px;padding:8px 14px;color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;margin-bottom:8px;cursor:pointer;}
.o-select option{background:#000;}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;}
.stat-card{background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.15);border-radius:4px;padding:12px;text-align:center;}
.stat-card .sv{font-family:'Orbitron',monospace;font-size:24px;font-weight:900;color:var(--gold);}
.stat-card .sl{font-size:10px;letter-spacing:2px;color:rgba(255,215,0,0.4);}
.player-table{width:100%;border-collapse:collapse;font-size:13px;}
.player-table th{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;color:var(--gold);padding:8px;border-bottom:1px solid rgba(255,215,0,0.15);text-align:left;}
.player-table td{padding:8px;border-bottom:1px solid rgba(255,215,0,0.06);color:rgba(255,215,0,0.7);vertical-align:middle;}
.event-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.event-card{background:rgba(255,215,0,0.04);border:1px solid rgba(255,215,0,0.15);border-radius:4px;padding:14px;text-align:center;cursor:pointer;transition:all 0.2s;}
.event-card:hover{background:rgba(255,215,0,0.1);border-color:var(--gold);transform:translateY(-2px);}
.event-icon{font-size:26px;display:block;margin-bottom:6px;}
.event-name{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;color:var(--gold);}

/* ===== IN-GAME COSMETICS PANEL ===== */
#ingameCosmeticsPanel{position:fixed;inset:0;z-index:550;display:none;background:rgba(0,0,8,0.94);backdrop-filter:blur(12px);overflow-y:auto;}

/* ===== OWNER COSMETICS VISUAL EFFECTS ===== */
.owner-halo{position:absolute;inset:-10px;border-radius:50%;border:2px solid rgba(255,215,0,0.5);animation:halo-spin 3s linear infinite;pointer-events:none;}
@keyframes halo-spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

@media(max-width:600px){
  .owner-sidebar{width:60px;}
  .owner-nav-btn span:last-child{display:none;}
  .owner-sidebar-header h2,.owner-sidebar-header p,.crown-text{display:none;}
}
</style>
</head>
<body>
<div id="cursor"></div>

<!-- ==================== MENU SCREEN ==================== -->
<div class="screen" id="menuScreen">
  <div class="menu-bg-particles" id="bgParticles"></div>
  <div class="z3n0-watermark">Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0</div>

  <div style="display:flex;flex-direction:column;align-items:center;gap:24px;width:100%;max-width:520px;padding:20px;z-index:1;">
    <div class="logo-wrap">
      <span class="owner-crown">üëë</span>
      <div class="logo-z3n0">Z3N0</div>
      <div class="logo-sub">SNAKE REALM ¬∑ EST. 2026</div>
      <div class="logo-owner-tag">CREATED & OWNED BY Z3N0</div>
    </div>

    <div class="menu-panel">
      <div class="menu-tabs">
        <button class="menu-tab-btn active" data-mtab="play">‚ñ∂ PLAY</button>
        <button class="menu-tab-btn" data-mtab="cosmetics">üé® COSMETICS</button>
        <button class="menu-tab-btn" data-mtab="settings">‚öôÔ∏è SETTINGS</button>
      </div>

      <!-- PLAY TAB -->
      <div class="menu-tab-content active" id="mtab-play">
        <div class="input-group">
          <span class="input-label">Your Name</span>
          <input class="game-input" id="nameInput" type="text" placeholder="Enter your name..." maxlength="20" autocomplete="off">
          <div id="savedNameHint" style="display:none;font-size:11px;color:rgba(0,255,140,0.4);font-family:Orbitron,monospace;letter-spacing:1px;">‚ñ∂ NAME SAVED AUTOMATICALLY</div>
        </div>
        <div class="input-group">
          <span class="input-label">Choose Skin</span>
          <div class="skin-selector" id="skinSelector"></div>
        </div>
        <div class="input-group" id="ownerPassGroup" style="display:none;">
          <span class="input-label">üîê Owner Code</span>
          <input class="game-input" id="ownerPass" type="password" placeholder="Enter owner password..." autocomplete="off">
        </div>
        <button class="btn btn-primary" id="playBtn" style="margin-bottom:8px;">‚ñ∂ ENTER THE REALM</button>
        <div class="btn-row">
          <button class="btn btn-gold btn-sm" id="ownerToggleBtn">üëë OWNER</button>
          <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);" id="howToBtn">? HOW TO PLAY</button>
        </div>
      </div>

      <!-- COSMETICS TAB -->
      <div class="menu-tab-content" id="mtab-cosmetics">
        <div class="coin-balance">
          <span style="font-size:20px;">üí∞</span>
          <div>
            <div class="coin-amount" id="menuCoinBalance">0</div>
            <div class="coin-label">COINS ¬∑ ENTER GAME TO EARN</div>
          </div>
        </div>
        <p style="font-size:12px;color:var(--dim);margin-bottom:12px;">Join the game to buy & equip cosmetics. Coins persist across sessions!</p>
        <div id="menuCosmeticPreview" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
          <div style="grid-column:1/-1;text-align:center;font-size:12px;color:var(--dim);padding:16px;">Enter the game to access your cosmetics shop</div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div class="menu-tab-content" id="mtab-settings">
        <div class="setting-row">
          <div>
            <div class="setting-label">CONTROL SCHEME</div>
            <div class="setting-desc">How you steer your snake</div>
          </div>
          <div class="control-radio-group" id="controlSchemeGroup">
            <button class="control-radio" data-scheme="mouse">üñ±Ô∏è MOUSE</button>
            <button class="control-radio" data-scheme="wasd">WASD</button>
            <button class="control-radio" data-scheme="arrows">ARROWS</button>
            <button class="control-radio" data-scheme="both">BOTH</button>
          </div>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">BOOST KEY</div>
            <div class="setting-desc">Keyboard boost (hold click also works)</div>
          </div>
          <div class="control-radio-group" id="boostKeyGroup">
            <button class="control-radio" data-boost="shift">SHIFT</button>
            <button class="control-radio" data-boost="space">SPACE</button>
            <button class="control-radio" data-boost="both_boost">BOTH</button>
          </div>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">MOUSE STEERING</div>
            <div class="setting-desc">Always active even with keyboard</div>
          </div>
          <div class="control-radio-group" id="mouseAlwaysGroup">
            <button class="control-radio" data-mouse="on">ON</button>
            <button class="control-radio" data-mouse="off">OFF</button>
          </div>
        </div>
        <div style="margin-top:16px;padding:10px;background:rgba(0,255,140,0.03);border:1px solid rgba(0,255,140,0.1);border-radius:3px;font-size:12px;color:var(--dim);line-height:1.6;">
          All settings are saved automatically.<br>
          Owner panel: <span style="color:var(--gold);">F1</span> key (in-game, owner only)
        </div>
      </div>
    </div>

    <div id="menuStats" style="display:flex;gap:24px;font-size:13px;color:var(--dim);">
      <span>üêç <span id="statPlayers">0</span> online</span>
      <span>üåü <span id="statOrbs">0</span> orbs</span>
      <span id="statEvent" style="display:none;color:var(--glow3);">‚ö° EVENT ACTIVE</span>
    </div>

    <div style="font-family:'Orbitron',monospace;font-size:9px;letter-spacing:4px;color:rgba(255,215,0,0.25);">
      üëë Z3N0'S SERPENT REALM ‚Äî ALL RIGHTS RESERVED
    </div>
  </div>
</div>

<!-- ==================== GAME CANVAS ==================== -->
<canvas id="gameCanvas"></canvas>

<!-- ==================== HUD ==================== -->
<div id="hud">
  <div id="hud-score">
    <div class="val" id="scoreVal">0</div>
    <div class="label">SCORE ¬∑ <span id="lengthVal">0</span> SEGMENTS</div>
  </div>
  <div id="hud-coins">üí∞ <span id="hudCoins">0</span></div>
  <div id="killfeed"></div>
  <div id="leaderboard">
    <h3>üëë LEADERBOARD</h3>
    <div id="lbList"></div>
  </div>
  <div id="minimap"><canvas id="minimapCanvas" width="160" height="160"></canvas></div>
  <div id="boostbar">
    <div class="boost-label" id="boostLabel">BOOST [HOLD CLICK]</div>
    <div class="boost-track"><div class="boost-fill" id="boostFill"></div></div>
  </div>
  <div id="owner-tag-hud">üëë Z3N0 ¬∑ SUPREME OWNER ¬∑ CREATOR OF THIS GAME</div>
  <div id="eventBanner"><div class="event-title" id="eventTitle">EVENT ACTIVE</div></div>
  <div id="sysmsg"></div>
  <div id="z3n0-watermark-game">Z3N0</div>
  <div id="inGameCosmeticsBtn">
    <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);padding:6px 14px;font-size:9px;" onclick="openIngameCosmetics()">üé® SHOP</button>
  </div>
</div>

<!-- ==================== IN-GAME COSMETICS PANEL ==================== -->
<div id="ingameCosmeticsPanel">
  <div style="max-width:640px;margin:0 auto;padding:32px 20px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
      <div>
        <h2 style="font-family:'Orbitron',monospace;font-size:18px;color:var(--glow);">üé® COSMETICS SHOP</h2>
        <div style="font-size:12px;color:var(--dim);">Earn coins by eating orbs & killing players. All purchases are permanent!</div>
      </div>
      <div style="display:flex;align-items:center;gap:16px;">
        <div class="coin-balance" style="margin:0;">
          <span style="font-size:18px;">üí∞</span>
          <div><div class="coin-amount" id="ingameCoinBalance">0</div><div class="coin-label">COINS</div></div>
        </div>
        <button class="btn btn-sm btn-danger" onclick="closeIngameCosmetics()">‚úï CLOSE</button>
      </div>
    </div>
    <div style="background:rgba(0,255,140,0.03);border:1px solid var(--border);border-radius:4px;padding:16px;margin-bottom:20px;">
      <div style="font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);margin-bottom:10px;">CURRENTLY EQUIPPED</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;">
        <div><span style="font-size:11px;color:var(--dim);">TRAIL:</span> <span id="equippedTrailDisplay" style="color:var(--glow);font-size:13px;">None</span></div>
        <div><span style="font-size:11px;color:var(--dim);">TITLE:</span> <span id="equippedTitleDisplay" style="color:var(--gold);font-size:13px;">None</span></div>
        <div><span style="font-size:11px;color:var(--dim);">BADGE:</span> <span id="equippedBadgeDisplay" style="font-size:16px;">‚Äî</span></div>
      </div>
    </div>
    <div id="cosmeticsShopContent"></div>
  </div>
</div>

<!-- ==================== DEATH SCREEN ==================== -->
<div class="screen hidden" id="deathScreen">
  <div class="death-title">ELIMINATED</div>
  <div class="death-info" id="deathKiller">Killed by the void</div>
  <div class="death-coins-earned" id="deathCoinsEarned"></div>
  <div class="death-stats">
    <div class="death-stat"><div class="val" id="deathScore">0</div><div class="lbl">SCORE</div></div>
    <div class="death-stat"><div class="val" id="deathLength">0</div><div class="lbl">MAX LENGTH</div></div>
    <div class="death-stat"><div class="val" id="deathRank">‚Äî</div><div class="lbl">RANK</div></div>
  </div>
  <div class="death-buttons">
    <button class="btn btn-primary" id="respawnBtn">‚Ü∫ RESPAWN</button>
    <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);" id="menuBtn">MENU</button>
  </div>
  <div style="font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:rgba(255,215,0,0.2);margin-top:8px;">Z3N0'S SERPENT REALM</div>
</div>

<!-- ==================== OWNER PANEL ==================== -->
<div id="ownerPanel" class="hidden">
  <div class="owner-sidebar">
    <div class="owner-sidebar-header">
      <span class="crown-big">üëë</span>
      <h2 class="crown-text">Z3N0</h2>
      <p>SUPREME OWNER</p>
    </div>
    <nav class="owner-nav">
      <button class="owner-nav-btn active" data-tab="dashboard"><span class="owner-nav-icon">üìä</span><span>Dashboard</span></button>
      <button class="owner-nav-btn" data-tab="players"><span class="owner-nav-icon">üë•</span><span>Players</span></button>
      <button class="owner-nav-btn" data-tab="actions"><span class="owner-nav-icon">‚ö°</span><span>Actions</span></button>
      <button class="owner-nav-btn" data-tab="events"><span class="owner-nav-icon">üåü</span><span>Events</span></button>
      <button class="owner-nav-btn" data-tab="broadcast"><span class="owner-nav-icon">üì¢</span><span>Broadcast</span></button>
      <button class="owner-nav-btn" data-tab="skins"><span class="owner-nav-icon">üé®</span><span>Give Skins</span></button>
      <button class="owner-nav-btn" data-tab="ownercosmetics"><span class="owner-nav-icon">üíé</span><span>Cosmetics</span></button>
    </nav>
  </div>
  <div class="owner-main">
    <div class="owner-topbar">
      <h1>üëë Z3N0 OWNER CONTROL CENTER</h1>
      <button class="btn btn-sm btn-danger" id="closeOwnerPanel">‚úï CLOSE</button>
    </div>
    <div class="owner-content">
      <div id="ownerAlert" class="o-alert"></div>

      <!-- DASHBOARD -->
      <div class="owner-tab active" id="tab-dashboard">
        <div style="background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,215,0,0.04));border:1px solid rgba(255,215,0,0.2);border-radius:6px;padding:20px;margin-bottom:16px;text-align:center;">
          <div style="font-size:48px;margin-bottom:10px;filter:drop-shadow(0 0 15px rgba(255,215,0,0.8));">üëë</div>
          <div style="font-family:'Orbitron',monospace;font-size:16px;letter-spacing:4px;color:var(--gold);">WELCOME BACK, Z3N0</div>
          <div style="font-size:12px;color:rgba(255,215,0,0.4);margin-top:4px;">Supreme Owner & Creator of the Serpent Realm</div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="sv" id="os-players">0</div><div class="sl">PLAYERS</div></div>
          <div class="stat-card"><div class="sv" id="os-orbs">0</div><div class="sl">ORBS</div></div>
          <div class="stat-card"><div class="sv" id="os-event">NONE</div><div class="sl">EVENT</div></div>
        </div>
        <div class="o-card">
          <h3>‚ö° QUICK ACTIONS</h3>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','speedBoost')">‚ö° Hyperspeed</button>
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','orbFrenzy')">üåü Orb Frenzy</button>
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','growAll')">üêç Titan Rise</button>
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','shrinkAll')">üíÄ Death Shrink</button>
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','coinRain')">üí∞ Coin Rain</button>
            <button class="btn btn-danger btn-sm" onclick="ownerAction('endEvent')">‚úï End Event</button>
          </div>
        </div>
      </div>

      <!-- PLAYERS -->
      <div class="owner-tab" id="tab-players">
        <div class="o-card">
          <h3>LIVE PLAYERS</h3>
          <button class="btn btn-gold btn-sm" onclick="refreshPlayers()" style="margin-bottom:12px;">‚Ü∫ REFRESH LIST</button>
          <div style="overflow-x:auto;">
            <table class="player-table">
              <thead><tr><th>NAME</th><th>LEN</th><th>SCORE</th><th>COINS</th><th>COSMETICS</th><th>ACTIONS</th></tr></thead>
              <tbody id="playerTableBody"><tr><td colspan="6" style="text-align:center;color:var(--dim);padding:20px;">Click refresh to load players</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="owner-tab" id="tab-actions">
        <div class="o-card">
          <h3>üìè GIVE SIZE</h3>
          <select class="o-select" id="sizeTarget"></select>
          <input class="o-input" id="sizeAmount" type="number" placeholder="Size amount" value="50">
          <button class="btn btn-gold" onclick="doGiveSize()">üìè GRANT SIZE</button>
        </div>
        <div class="o-card">
          <h3>üí∞ GIVE COINS</h3>
          <select class="o-select" id="coinsTarget"></select>
          <input class="o-input" id="coinsAmount" type="number" placeholder="Coins amount" value="500">
          <button class="btn btn-gold" onclick="doGiveCoins()">üí∞ GRANT COINS</button>
        </div>
        <div class="o-card">
          <h3>üîÑ SWAP SIZE</h3>
          <select class="o-select" id="swapP1"></select>
          <select class="o-select" id="swapP2"></select>
          <button class="btn btn-gold" onclick="doSwapSize()">üîÑ SWAP</button>
        </div>
        <div class="o-card">
          <h3>üö´ KICK PLAYER</h3>
          <select class="o-select" id="kickTarget"></select>
          <input class="o-input" id="kickReason" placeholder="Kick reason (optional)">
          <button class="btn btn-danger" onclick="doKick()">üö´ KICK</button>
        </div>
        <div class="o-card">
          <h3>‚ò†Ô∏è INSTA-KILL</h3>
          <select class="o-select" id="killTarget"></select>
          <button class="btn btn-danger" onclick="doInstaKill()">‚ò†Ô∏è EXECUTE</button>
        </div>
      </div>

      <!-- EVENTS -->
      <div class="owner-tab" id="tab-events">
        <div class="o-card">
          <h3>üåü LIVE EVENTS (60 seconds each)</h3>
          <div class="event-grid">
            <div class="event-card" onclick="ownerAction('startEvent','speedBoost')"><span class="event-icon">‚ö°</span><div class="event-name">HYPERSPEED FRENZY</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','orbFrenzy')"><span class="event-icon">üåü</span><div class="event-name">ORB OVERLOAD</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','shrinkAll')"><span class="event-icon">üíÄ</span><div class="event-name">DEATH SHRINK</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','growAll')"><span class="event-icon">üêç</span><div class="event-name">TITAN RISE</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','rainbow')"><span class="event-icon">üåà</span><div class="event-name">RAINBOW CHAOS</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','coinRain')"><span class="event-icon">üí∞</span><div class="event-name">COIN RAIN</div></div>
          </div>
          <button class="btn btn-danger" style="margin-top:16px;" onclick="ownerAction('endEvent')">‚úï END CURRENT EVENT</button>
        </div>
      </div>

      <!-- BROADCAST -->
      <div class="owner-tab" id="tab-broadcast">
        <div class="o-card">
          <h3>üì¢ SERVER BROADCAST</h3>
          <textarea class="o-input" id="broadcastMsg" placeholder="Message to all players in the realm..." rows="3" style="resize:vertical;"></textarea>
          <button class="btn btn-gold" onclick="doBroadcast()">üì¢ BROADCAST TO ALL</button>
        </div>
      </div>

      <!-- SKINS -->
      <div class="owner-tab" id="tab-skins">
        <div class="o-card">
          <h3>üé® GRANT SKIN TO PLAYER</h3>
          <select class="o-select" id="skinTarget"></select>
          <select class="o-select" id="skinToGive">
            <option value="rainbow_god">üåà Rainbow God (Owner Only)</option>
            <option value="void_lord">üåë Void Lord (Owner Only)</option>
            <option value="galaxy_emperor">üåå Galaxy Emperor (Owner Only)</option>
            <option value="neon_death">‚ö° Neon Death (Owner Only)</option>
            <option value="chrome_divine">‚ú® Chrome Divine (Owner Only)</option>
            <option value="fire">üî• Fire</option>
            <option value="ice">‚ùÑÔ∏è Ice</option>
            <option value="gold">‚≠ê Gold</option>
            <option value="toxic">‚ò£Ô∏è Toxic</option>
            <option value="midnight">üåô Midnight</option>
            <option value="lava">üåã Lava</option>
            <option value="ocean">üåä Ocean</option>
          </select>
          <button class="btn btn-gold" onclick="doGiveSkin()">üé® GRANT SKIN</button>
        </div>
      </div>

      <!-- OWNER COSMETICS -->
      <div class="owner-tab" id="tab-ownercosmetics">
        <div class="o-card">
          <h3>üíé GRANT COSMETIC TO PLAYER</h3>
          <select class="o-select" id="ownerCosmeticTarget"></select>
          <select class="o-select" id="ownerCosmeticToGive">
            <option value="owner_aura">‚ú® Z3N0 Aura (Owner Exclusive)</option>
            <option value="owner_trail">üëë Z3N0 Trail (Owner Exclusive)</option>
            <option value="owner_title">üëë [Z3N0] Title (Owner Exclusive)</option>
            <option value="owner_explode">üí• Death Explosion (Owner Exclusive)</option>
            <option value="owner_god_trail">üåü God Trail (Owner Exclusive)</option>
            <option value="owner_supreme">üî± [SUPREME] Title (Owner Exclusive)</option>
            <option value="owner_creator">üåå [CREATOR] Title (Owner Exclusive)</option>
            <option value="owner_galaxy_trail">üåå Galaxy God Trail (Owner Exclusive)</option>
            <option value="owner_rainbow_aura">üåà Rainbow Aura (Owner Exclusive)</option>
            <option value="owner_divine_badge">üî± Divine Badge (Owner Exclusive)</option>
            <option value="owner_death_badge">‚ò†Ô∏è Death God Badge (Owner Exclusive)</option>
            <option value="trail_rainbow">üåà Rainbow Trail</option>
            <option value="trail_gold">‚≠ê Gold Trail</option>
            <option value="title_god">‚ö° [GOD] Title</option>
            <option value="title_legend">üèÜ [LEGEND] Title</option>
            <option value="title_king">üëë [KING] Title</option>
            <option value="title_omega">Œ© [OMEGA] Title</option>
            <option value="badge_crown">üëë Crown Badge</option>
            <option value="badge_dragon">üêâ Dragon Badge</option>
            <option value="badge_diamond">üíé Diamond Badge</option>
            <option value="badge_infinity">‚ôæÔ∏è Infinity Badge</option>
          </select>
          <button class="btn btn-gold" onclick="doGiveCosmetic()">üé® GRANT COSMETIC</button>
        </div>
        <div class="o-card">
          <h3>YOUR OWNER COSMETICS (ALL UNLOCKED)</h3>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:3px;font-size:11px;color:var(--gold);">‚ú® Z3N0 Aura</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:3px;font-size:11px;color:var(--gold);">üëë Z3N0 Trail</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:3px;font-size:11px;color:var(--gold);">[Z3N0] Title</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:3px;font-size:11px;color:var(--gold);">üåü God Trail</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:3px;font-size:11px;color:var(--gold);">üî± Divine Badge</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:3px;font-size:11px;color:var(--gold);">üåà Rainbow Aura</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:3px;font-size:11px;color:var(--gold);">+ ALL COSMETICS</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<div id="musicControls">
  <button class="music-btn" id="musicToggle">üéµ</button>
  <div class="music-vis" id="musicVis">
    <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
    <div class="music-bar"></div><div class="music-bar"></div>
  </div>
  <span style="font-size:10px;color:var(--dim);font-family:Orbitron,monospace;letter-spacing:1px;">MUSIC</span>
</div>
<div id="broadcastBanner"><span>üëë Z3N0: </span><span id="broadcastText"></span></div>

<script>
// ================================================================
//  SKIN DEFINITIONS
// ================================================================
const SKINS = {
  classic:         { name:'Classic',      emoji:'üêç', colors:['#00ff8c','#00cc70'],   glow:'#00ff8c' },
  fire:            { name:'Fire',         emoji:'üî•', colors:['#ff4400','#ff8800'],   glow:'#ff6600' },
  ice:             { name:'Ice',          emoji:'‚ùÑÔ∏è', colors:['#00ccff','#0066ff'],   glow:'#00ccff' },
  toxic:           { name:'Toxic',        emoji:'‚ò£Ô∏è', colors:['#88ff00','#44aa00'],   glow:'#88ff00' },
  gold:            { name:'Gold',         emoji:'‚≠ê', colors:['#ffd700','#ffaa00'],   glow:'#ffd700' },
  midnight:        { name:'Midnight',     emoji:'üåô', colors:['#4400ff','#8800ff'],   glow:'#6600ff' },
  sunset:          { name:'Sunset',       emoji:'üåÖ', colors:['#ff0066','#ff8800'],   glow:'#ff4488' },
  ocean:           { name:'Ocean',        emoji:'üåä', colors:['#0044ff','#00ffcc'],   glow:'#00aaff' },
  lava:            { name:'Lava',         emoji:'üåã', colors:['#ff2200','#ffdd00'],   glow:'#ff4400' },
  forest:          { name:'Forest',       emoji:'üå≤', colors:['#006600','#88cc00'],   glow:'#44aa00' },
  rainbow_god:     { name:'Rainbow God',  emoji:'üåà', colors:['rainbow'],             glow:'#ffffff', ownerOnly:true },
  void_lord:       { name:'Void Lord',    emoji:'üåë', colors:['#110011','#440044'],   glow:'#aa00ff', ownerOnly:true },
  galaxy_emperor:  { name:'Galaxy',       emoji:'üåå', colors:['#000033','#0000aa'],   glow:'#4488ff', ownerOnly:true },
  neon_death:      { name:'Neon Death',   emoji:'‚ö°', colors:['#ff0000','#00ffff'],   glow:'#ffffff', ownerOnly:true },
  chrome_divine:   { name:'Chrome',       emoji:'‚ú®', colors:['#888888','#ffffff'],   glow:'#ffffff', ownerOnly:true },
};

// ================================================================
//  SAVED NAME ‚Äî auto-save & restore
// ================================================================
const savedName = localStorage.getItem('z3n0_playerName') || '';
if (savedName) {
  document.getElementById('nameInput').value = savedName;
  document.getElementById('savedNameHint').style.display = 'block';
}
document.getElementById('nameInput').addEventListener('input', (e) => {
  const val = e.target.value.trim();
  if (val.length > 0) {
    localStorage.setItem('z3n0_playerName', val);
    document.getElementById('savedNameHint').style.display = 'block';
  } else {
    localStorage.removeItem('z3n0_playerName');
    document.getElementById('savedNameHint').style.display = 'none';
  }
});

// ================================================================
//  SETTINGS STATE
// ================================================================
let controlScheme = localStorage.getItem('controlScheme') || 'mouse';
let boostKey      = localStorage.getItem('boostKey')      || 'shift';
let mouseAlways   = localStorage.getItem('mouseAlways')   !== 'off';

function saveSettings() {
  localStorage.setItem('controlScheme', controlScheme);
  localStorage.setItem('boostKey', boostKey);
  localStorage.setItem('mouseAlways', mouseAlways ? 'on' : 'off');
  updateBoostLabel();
}

function updateBoostLabel() {
  const labels = { shift:'BOOST [SHIFT/CLICK]', space:'BOOST [SPACE/CLICK]', both_boost:'BOOST [SHIFT/SPACE/CLICK]' };
  const el = document.getElementById('boostLabel');
  if (el) el.textContent = labels[boostKey] || 'BOOST [HOLD CLICK]';
}

// Init setting radios
document.querySelectorAll('#controlSchemeGroup .control-radio').forEach(btn => {
  if (btn.dataset.scheme === controlScheme) btn.classList.add('active');
  btn.onclick = () => {
    controlScheme = btn.dataset.scheme;
    document.querySelectorAll('#controlSchemeGroup .control-radio').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    saveSettings();
  };
});
document.querySelectorAll('#boostKeyGroup .control-radio').forEach(btn => {
  if (btn.dataset.boost === boostKey) btn.classList.add('active');
  btn.onclick = () => {
    boostKey = btn.dataset.boost;
    document.querySelectorAll('#boostKeyGroup .control-radio').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    saveSettings();
  };
});
document.querySelectorAll('#mouseAlwaysGroup .control-radio').forEach(btn => {
  if ((btn.dataset.mouse === 'on') === mouseAlways) btn.classList.add('active');
  btn.onclick = () => {
    mouseAlways = btn.dataset.mouse === 'on';
    document.querySelectorAll('#mouseAlwaysGroup .control-radio').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    saveSettings();
  };
});

// Menu tab switching
document.querySelectorAll('.menu-tab-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.menu-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.menu-tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('mtab-' + btn.dataset.mtab).classList.add('active');
  };
});

// ================================================================
//  GAME STATE
// ================================================================
let socket = null;
let myPlayerId = null;
let isOwner = false;
let gameState = { players:{}, leaderboard:[], activeEvent:null };
let myAngle = 0;
let boosting = false;
let boostEnergy = 100;
let selectedSkin = localStorage.getItem('z3n0_skin') || 'classic';
let ownerPass = '';
let currentPlayerList = [];
let gameActive = false;
let myDeathScore = 0;
let myDeathLength = 0;
let cameraX = 0, cameraY = 0;
let MAP_SIZE = 6000;
let orbsLocal = {};
let rainbowT = 0;
let musicPlaying = false;
let audioCtx = null;
let musicInterval = null;
let myName = '';
let myProfile = { coins:0, unlockedCosmetics:[], equippedTrail:null, equippedTitle:null, equippedBadge:null };
let cosmeticsCatalog = {};
let sessionCoinsDisplay = 0;

// ================================================================
//  CURSOR
// ================================================================
const cursor = document.getElementById('cursor');
let mouseX = 0, mouseY = 0;
document.addEventListener('mousemove', e => {
  mouseX = e.clientX; mouseY = e.clientY;
  cursor.style.left = mouseX + 'px';
  cursor.style.top  = mouseY + 'px';
});

// ================================================================
//  PARTICLES
// ================================================================
function spawnMenuParticles() {
  const container = document.getElementById('bgParticles');
  for (let i = 0; i < 60; i++) {
    const p = document.createElement('div');
    p.className = 'menu-particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDuration = (Math.random() * 6 + 4) + 's';
    p.style.animationDelay = (Math.random() * 8) + 's';
    p.style.width = p.style.height = (Math.random() * 3 + 1) + 'px';
    const colors = ['#00ff8c','#aa44ff','#ff2244','#ffd700','#00ccff'];
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    container.appendChild(p);
  }
}
spawnMenuParticles();

// ================================================================
//  SKIN SELECTOR
// ================================================================
function buildSkinSelector() {
  const container = document.getElementById('skinSelector');
  container.innerHTML = '';
  Object.keys(SKINS).forEach(key => {
    const skin = SKINS[key];
    const div = document.createElement('div');
    div.className = 'skin-opt'
      + (skin.ownerOnly ? ' owner-only' : '')
      + (key === selectedSkin ? ' selected' : '');
    if (skin.ownerOnly && !isOwner) div.classList.add('locked');
    div.title = skin.name + (skin.ownerOnly ? ' (Owner Only)' : '');
    div.style.background = skin.ownerOnly
      ? 'linear-gradient(135deg,rgba(255,215,0,0.2),rgba(170,68,255,0.2))'
      : `linear-gradient(135deg,${skin.colors[0]||'#333'},${skin.colors[1]||skin.colors[0]||'#333'})`;
    div.innerHTML = `<span style="font-size:18px;text-shadow:0 0 10px ${skin.glow}">${skin.emoji}</span>`;
    div.onclick = () => {
      if (skin.ownerOnly && !isOwner) { showToast('Owner only skin! üëë', 'error'); return; }
      selectedSkin = key;
      localStorage.setItem('z3n0_skin', key);
      document.querySelectorAll('.skin-opt').forEach(s => s.classList.remove('selected'));
      div.classList.add('selected');
    };
    container.appendChild(div);
  });
}
buildSkinSelector();

// ================================================================
//  OWNER TOGGLE
// ================================================================
document.getElementById('ownerToggleBtn').onclick = () => {
  const g = document.getElementById('ownerPassGroup');
  g.style.display = g.style.display === 'none' ? '' : 'none';
};

// ================================================================
//  MUSIC
// ================================================================
function initMusic() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  playMusic();
}
function playMusic() {
  if (!audioCtx) return;
  musicPlaying = true;
  document.getElementById('musicVis').classList.remove('music-paused');
  document.getElementById('musicToggle').textContent = 'üéµ';
  scheduleMusicNotes();
}
function pauseMusic() {
  musicPlaying = false;
  document.getElementById('musicVis').classList.add('music-paused');
  document.getElementById('musicToggle').textContent = '‚è∏';
  if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
}
let noteIndex = 0;
const melody = [261,293,329,349,392,440,493,523,493,440,392,349,329,293,261,293,329,392,440,493,523,587,523,493,440,392,349,329];
const bassline = [65,73,82,87,98,110,65,73];
function playNote(freq, type, duration, gain, time) {
  if (!audioCtx || !musicPlaying) return;
  const osc = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();
  filter.type = 'lowpass'; filter.frequency.value = 2000;
  osc.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, time);
  gainNode.gain.setValueAtTime(0, time);
  gainNode.gain.linearRampToValueAtTime(gain, time + 0.02);
  gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration);
  osc.start(time); osc.stop(time + duration + 0.05);
}
function scheduleMusicNotes() {
  if (musicInterval) clearInterval(musicInterval);
  const tempo = 0.18; let beat = 0;
  musicInterval = setInterval(() => {
    if (!musicPlaying || !audioCtx) return;
    const now = audioCtx.currentTime;
    const mNote = melody[noteIndex % melody.length];
    const bNote = bassline[beat % bassline.length];
    playNote(mNote, 'triangle', tempo * 1.5, 0.07, now);
    playNote(mNote * 2, 'sine', tempo, 0.025, now + 0.05);
    if (beat % 2 === 0) playNote(bNote, 'sawtooth', tempo * 2, 0.05, now);
    if (beat % 4 === 0) {
      const k = audioCtx.createOscillator(), kg = audioCtx.createGain();
      k.connect(kg); kg.connect(audioCtx.destination);
      k.frequency.setValueAtTime(150, now);
      k.frequency.exponentialRampToValueAtTime(0.001, now + 0.3);
      kg.gain.setValueAtTime(0.25, now);
      kg.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
      k.start(now); k.stop(now + 0.35);
    }
    noteIndex++; beat++;
  }, tempo * 1000);
}
document.getElementById('musicToggle').onclick = () => {
  if (!audioCtx) { initMusic(); return; }
  if (musicPlaying) pauseMusic(); else playMusic();
};

// ================================================================
//  PLAY BUTTON
// ================================================================
document.getElementById('playBtn').onclick = () => {
  const nameVal = document.getElementById('nameInput').value.trim() || 'Snake';
  const pass    = document.getElementById('ownerPass').value;
  myName = nameVal;
  ownerPass = pass;
  // Save name
  localStorage.setItem('z3n0_playerName', nameVal);
  document.getElementById('savedNameHint').style.display = 'block';
  connectAndJoin(nameVal, selectedSkin, pass);
};
document.getElementById('nameInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('playBtn').click();
});

// ================================================================
//  SOCKET CONNECTION
// ================================================================
function connectAndJoin(name, skin, password) {
  if (socket) { socket.off(); socket.disconnect(); }
  socket = io({ reconnection: false });

  socket.on('connect', () => {
    socket.emit('joinGame', { name, skin, password });
  });

  socket.on('connect_error', () => {
    showToast('‚ö†Ô∏è Cannot connect to server', 'error');
  });

  socket.on('joined', (data) => {
    myPlayerId = data.playerId;
    isOwner = data.isOwner;
    MAP_SIZE = data.mapSize;
    orbsLocal = {};
    data.orbs.forEach(o => orbsLocal[o.id] = o);
    myProfile = data.profile || myProfile;
    cosmeticsCatalog = data.cosmeticsCatalog || {};
    startGame();
    if (isOwner) {
      document.getElementById('owner-tag-hud').style.display = 'block';
      buildSkinSelector();
      showToast('üëë Welcome back, Z3N0 ‚Äî the Realm is yours', 'gold');
    }
    initMusic();
    updateCoinDisplays();
  });

  socket.on('gameState', (data) => { gameState = data; });

  socket.on('orbEaten', ({ oid, newOrb }) => {
    delete orbsLocal[oid];
    orbsLocal[newOrb.id] = newOrb;
  });
  socket.on('orbSpawned', (orb) => { orbsLocal[orb.id] = orb; });
  socket.on('orbFrenzy', (orbs) => { orbs.forEach(o => orbsLocal[o.id] = o); });

  socket.on('playerDied', ({ id, killerName, droppedOrbs }) => {
    if (droppedOrbs) droppedOrbs.forEach(o => orbsLocal[o.id] = o);
    if (id !== myPlayerId) addKillFeed(id, killerName);
  });

  socket.on('youDied', ({ killerName, coinsEarned }) => {
    myProfile.coins += (coinsEarned || 0);
    handleDeath(killerName, coinsEarned || 0);
  });

  socket.on('kicked', ({ reason }) => {
    socket.disconnect();
    showScreen('menuScreen');
    showToast('üö´ ' + (reason || 'Kicked by owner.'), 'error');
    gameActive = false;
    document.getElementById('hud').style.display = 'none';
    document.getElementById('gameCanvas').style.display = 'none';
    document.getElementById('musicControls').style.display = 'none';
  });

  socket.on('systemMessage', (data) => {
    const msg = typeof data === 'string' ? data : (data.message || '');
    showSystemMsg(msg);
  });

  socket.on('skinGranted', ({ skin: newSkin }) => {
    selectedSkin = newSkin;
    showToast(`üé® Skin granted: ${SKINS[newSkin]?.name || newSkin}`, 'gold');
  });

  socket.on('killConfirmed', ({ victimName }) => showToast(`üíÄ You eliminated ${victimName}`));

  socket.on('liveEvent', (event) => {
    document.getElementById('eventBanner').style.display = 'block';
    document.getElementById('eventTitle').textContent = event.name;
    document.getElementById('statEvent').style.display = 'inline';
    showToast('‚ö° ' + event.name + ' STARTED!', 'gold');
  });

  socket.on('eventEnded', () => {
    document.getElementById('eventBanner').style.display = 'none';
    document.getElementById('statEvent').style.display = 'none';
    showToast('Event ended.');
  });

  socket.on('ownerBroadcast', ({ message }) => {
    document.getElementById('broadcastText').textContent = message;
    document.getElementById('broadcastBanner').style.display = 'block';
    setTimeout(() => document.getElementById('broadcastBanner').style.display = 'none', 8000);
  });

  socket.on('ownerSuccess', (msg) => { showOwnerAlert(msg, 'success'); refreshPlayers(); });
  socket.on('ownerError', (msg) => showOwnerAlert(msg, 'error'));
  socket.on('playerList', (list) => { currentPlayerList = list; renderPlayerTable(list); populateSelects(list); });

  socket.on('coinsGranted', ({ amount, newBalance }) => {
    myProfile.coins = newBalance;
    updateCoinDisplays();
    showToast(`üí∞ +${amount} coins!`, 'gold');
  });

  socket.on('cosmeticBought', ({ cosmeticId, newCoinBalance, unlockedCosmetics }) => {
    myProfile.coins = newCoinBalance;
    myProfile.unlockedCosmetics = unlockedCosmetics;
    updateCoinDisplays();
    renderCosmeticsShop();
    showToast(`üé® Bought: ${cosmeticsCatalog[cosmeticId]?.name || cosmeticId}`, 'gold');
  });

  socket.on('cosmeticGranted', ({ cosmeticId, unlockedCosmetics }) => {
    myProfile.unlockedCosmetics = unlockedCosmetics;
    renderCosmeticsShop();
    showToast('üé® Cosmetic granted!', 'gold');
  });

  socket.on('cosmeticEquipped', ({ equippedTrail, equippedTitle, equippedBadge }) => {
    myProfile.equippedTrail = equippedTrail;
    myProfile.equippedTitle = equippedTitle;
    myProfile.equippedBadge = equippedBadge;
    updateEquippedDisplay();
    renderCosmeticsShop();
  });

  socket.on('cosmeticError', (msg) => showToast(msg, 'error'));

  socket.on('playerLeft', (id) => { delete gameState.players[id]; });

  socket.on('disconnect', () => {
    if (gameActive) {
      showToast('‚ö†Ô∏è Disconnected from server', 'error');
      gameActive = false;
    }
  });
}

// ================================================================
//  GAME START / STOP
// ================================================================
function startGame() {
  gameActive = true;
  cameraX = 0; cameraY = 0;
  showScreen('game');
  document.getElementById('gameCanvas').style.display = 'block';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('musicControls').style.display = 'flex';
  document.getElementById('deathScreen').classList.add('hidden');
  document.getElementById('inGameCosmeticsBtn').style.display = 'block';
  setupCanvas();
  requestAnimationFrame(gameLoop);
}

function handleDeath(killerName, coinsEarned) {
  gameActive = false;
  const myP = gameState.players[myPlayerId];
  myDeathScore  = myP ? (myP.score || 0) : 0;
  myDeathLength = myP ? (myP.segments || []).length : 0;
  document.getElementById('deathKiller').textContent   = `Eliminated by ${killerName || 'the void'}`;
  document.getElementById('deathScore').textContent   = myDeathScore;
  document.getElementById('deathLength').textContent  = myDeathLength;
  document.getElementById('deathCoinsEarned').textContent = coinsEarned > 0 ? `üí∞ +${coinsEarned} coins earned` : '';
  const rank = gameState.leaderboard.findIndex(e => e.id === myPlayerId);
  document.getElementById('deathRank').textContent = rank >= 0 ? '#' + (rank + 1) : '‚Äî';
  document.getElementById('deathScreen').classList.remove('hidden');
  document.getElementById('inGameCosmeticsBtn').style.display = 'none';
}

document.getElementById('respawnBtn').onclick = () => {
  document.getElementById('deathScreen').classList.add('hidden');
  connectAndJoin(myName, selectedSkin, ownerPass);
};
document.getElementById('menuBtn').onclick = () => {
  document.getElementById('deathScreen').classList.add('hidden');
  document.getElementById('hud').style.display = 'none';
  document.getElementById('gameCanvas').style.display = 'none';
  document.getElementById('musicControls').style.display = 'none';
  document.getElementById('inGameCosmeticsBtn').style.display = 'none';
  document.getElementById('owner-tag-hud').style.display = 'none';
  showScreen('menuScreen');
  if (socket) { socket.off(); socket.disconnect(); }
  gameActive = false;
};

// ================================================================
//  CANVAS
// ================================================================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function setupCanvas() {
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', setupCanvas);

// ================================================================
//  INPUT ‚Äî mouse
// ================================================================
canvas.addEventListener('mousemove', (e) => {
  if (!gameActive || !myPlayerId) return;
  if (controlScheme !== 'mouse' && !mouseAlways) return;
  const me = gameState.players[myPlayerId];
  if (!me || !me.segments || !me.segments.length) return;
  const head = me.segments[0];
  myAngle = Math.atan2(e.clientY - (head.y - cameraY), e.clientX - (head.x - cameraX));
  socket.emit('input', { angle: myAngle, boosting });
});

canvas.addEventListener('mousedown', (e) => {
  if (e.button === 0 || e.button === 2) {
    boosting = true;
    if (socket) socket.emit('input', { angle: myAngle, boosting: true });
  }
});
canvas.addEventListener('mouseup', () => {
  boosting = false;
  if (socket) socket.emit('input', { angle: myAngle, boosting: false });
});
canvas.addEventListener('contextmenu', e => e.preventDefault());

canvas.addEventListener('touchmove', (e) => {
  e.preventDefault();
  const touch = e.touches[0];
  const me = gameState.players[myPlayerId];
  if (!me || !me.segments || !me.segments.length) return;
  const head = me.segments[0];
  myAngle = Math.atan2(touch.clientY - (head.y - cameraY), touch.clientX - (head.x - cameraX));
  if (socket) socket.emit('input', { angle: myAngle, boosting });
}, { passive: false });
canvas.addEventListener('touchstart', () => {
  boosting = true;
  if (socket) socket.emit('input', { angle: myAngle, boosting: true });
});
canvas.addEventListener('touchend', () => {
  boosting = false;
  if (socket) socket.emit('input', { angle: myAngle, boosting: false });
});

// ================================================================
//  INPUT ‚Äî keyboard
// ================================================================
const keys = {};
document.addEventListener('keydown', (e) => {
  keys[e.key] = true;
  if (e.key === 'F1' || (e.ctrlKey && e.key === 'o')) {
    e.preventDefault();
    if (isOwner) openOwnerPanel();
    return;
  }
  if (e.key === 'Escape') {
    document.getElementById('ownerPanel').classList.add('hidden');
    document.getElementById('ingameCosmeticsPanel').style.display = 'none';
    return;
  }
  if (!gameActive || !socket) return;
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
  const shiftBoost = e.key === 'Shift' && (boostKey === 'shift' || boostKey === 'both_boost');
  const spaceBoost = e.key === ' '     && (boostKey === 'space' || boostKey === 'both_boost');
  if (shiftBoost || spaceBoost) {
    boosting = true;
    socket.emit('input', { angle: myAngle, boosting: true });
  }
});
document.addEventListener('keyup', (e) => {
  keys[e.key] = false;
  if (!gameActive || !socket) return;
  const shiftBoost = e.key === 'Shift' && (boostKey === 'shift' || boostKey === 'both_boost');
  const spaceBoost = e.key === ' '     && (boostKey === 'space' || boostKey === 'both_boost');
  if (shiftBoost || spaceBoost) {
    boosting = false;
    socket.emit('input', { angle: myAngle, boosting: false });
  }
});

function handleKeyboardSteering() {
  if (!gameActive || !socket || controlScheme === 'mouse') return;
  const useWASD   = controlScheme === 'wasd'   || controlScheme === 'both';
  const useArrows = controlScheme === 'arrows' || controlScheme === 'both';
  const left  = (useWASD && (keys['a'] || keys['A'])) || (useArrows && keys['ArrowLeft']);
  const right = (useWASD && (keys['d'] || keys['D'])) || (useArrows && keys['ArrowRight']);
  const up    = (useWASD && (keys['w'] || keys['W'])) || (useArrows && keys['ArrowUp']);
  const down  = (useWASD && (keys['s'] || keys['S'])) || (useArrows && keys['ArrowDown']);
  if (!left && !right && !up && !down) return;
  let dx = 0, dy = 0;
  if (left)  dx -= 1;
  if (right) dx += 1;
  if (up)    dy -= 1;
  if (down)  dy += 1;
  if (dx !== 0 || dy !== 0) {
    const targetAngle = Math.atan2(dy, dx);
    let diff = targetAngle - myAngle;
    while (diff > Math.PI)  diff -= Math.PI * 2;
    while (diff < -Math.PI) diff += Math.PI * 2;
    myAngle += Math.sign(diff) * Math.min(Math.abs(diff), 0.21);
    socket.emit('input', { angle: myAngle, boosting });
  }
}

// ================================================================
//  RENDER ‚Äî performance-optimised game loop
// ================================================================
let frameCount = 0;
let lastFrameTime = 0;

function gameLoop(timestamp) {
  if (!gameActive) return;
  requestAnimationFrame(gameLoop);

  // 60 fps cap (skip frames faster than 14ms)
  const dt = timestamp - lastFrameTime;
  if (dt < 14) return;
  lastFrameTime = timestamp;

  frameCount++;
  rainbowT += 0.022;
  handleKeyboardSteering();

  // Smooth camera
  const me = gameState.players[myPlayerId];
  if (me && me.segments && me.segments.length) {
    const head = me.segments[0];
    const tx = head.x - canvas.width / 2;
    const ty = head.y - canvas.height / 2;
    cameraX += (tx - cameraX) * 0.12;
    cameraY += (ty - cameraY) * 0.12;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBackground();
  drawGrid();
  drawOrbs();
  for (const pid in gameState.players) drawSnake(gameState.players[pid], pid === myPlayerId);
  drawBorder();
  updateHUD();
}

function drawBackground() {
  ctx.fillStyle = '#04040e';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  // Subtle radial vignette
  const vg = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, Math.max(canvas.width, canvas.height)*0.7);
  vg.addColorStop(0, 'transparent');
  vg.addColorStop(1, 'rgba(0,0,0,0.4)');
  ctx.fillStyle = vg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function drawGrid() {
  const gs  = 80;
  const offX = ((-cameraX) % gs + gs) % gs;
  const offY = ((-cameraY) % gs + gs) % gs;
  ctx.strokeStyle = 'rgba(0,255,140,0.035)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let x = offX; x < canvas.width; x += gs)  { ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); }
  for (let y = offY; y < canvas.height; y += gs) { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); }
  ctx.stroke();
}

function drawOrbs() {
  for (const oid in orbsLocal) {
    const orb = orbsLocal[oid];
    const sx = orb.x - cameraX, sy = orb.y - cameraY;
    if (sx < -30 || sx > canvas.width + 30 || sy < -30 || sy > canvas.height + 30) continue;
    const pulse = Math.sin(frameCount * 0.09 + orb.x * 0.01) * 0.25 + 0.75;
    const r = orb.size * pulse;
    // Core
    ctx.beginPath();
    ctx.arc(sx, sy, r, 0, Math.PI * 2);
    ctx.fillStyle = orb.color;
    ctx.fill();
    // Glow ring
    ctx.beginPath();
    ctx.arc(sx, sy, r * 2, 0, Math.PI * 2);
    ctx.fillStyle = orb.color + '22';
    ctx.fill();
  }
}

function getSkinColors(player) {
  const activeSkin = player.grantedSkin || player.skin;
  const skin = SKINS[activeSkin] || SKINS.classic;
  if (skin.colors[0] === 'rainbow') {
    const h = (rainbowT * 60) % 360;
    return [`hsl(${h},100%,55%)`, `hsl(${(h+60)%360},100%,65%)`];
  }
  return skin.colors;
}

function getSkinGlow(player) {
  const s = SKINS[player.grantedSkin || player.skin] || SKINS.classic;
  if (s.colors[0] === 'rainbow') return `hsl(${(rainbowT*60)%360},100%,65%)`;
  return s.glow;
}

// Trail color map (owner cosmetics get premium effects)
const TRAIL_COLORS = {
  trail_fire:       '#ff4400',
  trail_ice:        '#00ccff',
  trail_gold:       '#ffd700',
  trail_void:       '#aa00ff',
  trail_electric:   '#00ffff',
  trail_toxic:      '#88ff00',
  trail_blood:      '#cc0000',
  trail_galaxy:     '#4488ff',
  trail_sakura:     '#ff88cc',
  trail_shadow:     '#440077',
  trail_crystal:    '#88eeff',
  trail_lava:       '#ff4400',
  trail_neon:       '#ff00ff',
  trail_ocean:      '#0088ff',
  trail_storm:      '#aaaaff',
  trail_dark_matter:'#220033',
  trail_hologram:   '#44ffff',
  trail_supernova:  '#ffff00',
  owner_trail:      null, // rainbow gold handled below
  owner_god_trail:  '#ffffff',
  owner_galaxy_trail:'#6655ff',
  owner_rainbow_aura:null, // rainbow
  owner_black_hole: '#000011',
};

function getTrailColor(trailId, index) {
  if (!trailId) return null;
  if (trailId === 'trail_rainbow' || trailId === 'owner_rainbow_aura') {
    return `hsl(${(rainbowT*60 + index*20)%360},100%,60%)`;
  }
  if (trailId === 'owner_trail') {
    return `hsl(${(rainbowT*40 + index*15)%360},90%,55%)`;
  }
  return TRAIL_COLORS[trailId] || '#ffffff';
}

function drawSnake(player, isMe) {
  if (!player.segments || player.segments.length < 2) return;
  const segs      = player.segments;
  const colors    = getSkinColors(player);
  const glowColor = getSkinGlow(player);
  const w         = player.width || 8;
  const isOwnerP  = player.isOwner;

  ctx.save();

  // Owner gets an outer glow ring on head
  if (isOwnerP) {
    const head = segs[0];
    const hx = head.x - cameraX, hy = head.y - cameraY;
    const ring = ctx.createRadialGradient(hx, hy, w, hx, hy, w*4);
    ring.addColorStop(0, 'rgba(255,215,0,0.25)');
    ring.addColorStop(1, 'transparent');
    ctx.beginPath();
    ctx.arc(hx, hy, w * 4, 0, Math.PI * 2);
    ctx.fillStyle = ring;
    ctx.fill();
  }

  for (let i = segs.length - 1; i >= 0; i--) {
    const seg = segs[i];
    const sx = seg.x - cameraX, sy = seg.y - cameraY;
    if (sx < -w-20 || sx > canvas.width+w+20 || sy < -w-20 || sy > canvas.height+w+20) continue;

    const t     = i / segs.length;
    const segW  = w * (1 - t * 0.3);
    const alpha = 0.45 + 0.55 * (1 - t * 0.5);

    if (i === 0) {
      // HEAD
      if (isMe || isOwnerP) {
        ctx.shadowColor = glowColor;
        ctx.shadowBlur  = isOwnerP ? 30 : 18;
      }
      ctx.beginPath();
      ctx.arc(sx, sy, segW + 2.5, 0, Math.PI * 2);
      ctx.fillStyle = colors[1] || colors[0];
      ctx.fill();
      ctx.shadowBlur = 0;

      // Eyes
      const ea = player.angle || 0, ed = segW * 0.5;
      const ex1 = sx + Math.cos(ea - 0.5) * ed, ey1 = sy + Math.sin(ea - 0.5) * ed;
      const ex2 = sx + Math.cos(ea + 0.5) * ed, ey2 = sy + Math.sin(ea + 0.5) * ed;
      ctx.fillStyle = 'white';
      ctx.beginPath(); ctx.arc(ex1, ey1, 2.5, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(ex2, ey2, 2.5, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#000';
      ctx.beginPath(); ctx.arc(ex1 + Math.cos(ea), ey1 + Math.sin(ea), 1.2, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(ex2 + Math.cos(ea), ey2 + Math.sin(ea), 1.2, 0, Math.PI*2); ctx.fill();

      // Owner crown above head (animated scale)
      if (isOwnerP) {
        const crownScale = 1 + Math.sin(frameCount * 0.08) * 0.15;
        ctx.font = `${(segW*2)*crownScale}px serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
        ctx.shadowColor = '#ffd700'; ctx.shadowBlur = 15;
        ctx.fillText('üëë', sx, sy - segW - 4);
        ctx.shadowBlur = 0;
      }

    } else {
      // BODY
      const baseColor = colors[i % 2 === 0 ? 0 : 1] || colors[0];
      ctx.beginPath();
      ctx.arc(sx, sy, segW, 0, Math.PI * 2);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = baseColor;
      ctx.fill();
      ctx.globalAlpha = 1;

      // Trail cosmetic particles
      if (player.equippedTrail && i < 12 && i % 2 === 0) {
        const tc = getTrailColor(player.equippedTrail, i);
        if (tc) {
          const spread = isOwnerP ? 12 : 8;
          ctx.beginPath();
          ctx.arc(sx + (Math.random()-0.5)*spread, sy + (Math.random()-0.5)*spread, isOwnerP ? 4.5 : 3, 0, Math.PI*2);
          if (isOwnerP) { ctx.shadowColor = tc; ctx.shadowBlur = 8; }
          ctx.fillStyle = tc + (isOwnerP ? 'cc' : '88');
          ctx.fill();
          ctx.shadowBlur = 0;
        }
      }

      // Owner aura ‚Äî extra particles on body
      if (isOwnerP && i < 20 && i % 3 === 0) {
        const h = (rainbowT * 80 + i * 18) % 360;
        ctx.beginPath();
        ctx.arc(sx + (Math.random()-0.5)*16, sy + (Math.random()-0.5)*16, 2, 0, Math.PI*2);
        ctx.fillStyle = `hsla(${h},100%,65%,0.6)`;
        ctx.fill();
      }

      // Boost particles
      if (player.boosting && i < 6 && Math.random() < 0.4) {
        ctx.beginPath();
        ctx.arc(sx + (Math.random()-0.5)*12, sy + (Math.random()-0.5)*12, 3, 0, Math.PI*2);
        ctx.fillStyle = glowColor + '77';
        ctx.fill();
      }
    }
  }
  ctx.restore();

  // Name tag + title + badge
  const head = segs[0];
  const hsx = head.x - cameraX, hsy = head.y - cameraY;
  if (hsx > -120 && hsx < canvas.width+120 && hsy > -60 && hsy < canvas.height+60) {
    const badge   = player.equippedBadge ? player.equippedBadge + ' ' : '';
    const prefix  = isOwnerP ? 'üëë ' : '';
    const nameText = badge + prefix + (player.name || 'Snake');
    const nameY   = hsy - w - 10;

    // Title line
    if (player.equippedTitle) {
      ctx.font = 'bold 10px Orbitron,monospace';
      ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
      const tw2 = ctx.measureText(player.equippedTitle).width;
      ctx.fillStyle = 'rgba(0,0,0,0.65)';
      ctx.fillRect(hsx - tw2/2 - 5, nameY - 32, tw2 + 10, 15);
      ctx.fillStyle = isOwnerP ? '#ffd700' : '#aa44ff';
      if (isOwnerP) { ctx.shadowColor='#ffd700'; ctx.shadowBlur=6; }
      ctx.fillText(player.equippedTitle, hsx, nameY - 19);
      ctx.shadowBlur = 0;
    }

    // Name line
    const nameSize = Math.max(11, w + 4);
    ctx.font = `bold ${nameSize}px Rajdhani,sans-serif`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
    const tw = ctx.measureText(nameText).width;
    ctx.fillStyle = 'rgba(0,0,0,0.65)';
    ctx.fillRect(hsx - tw/2 - 5, nameY - 15, tw + 10, 17);
    if (isOwnerP) { ctx.shadowColor='#ffd700'; ctx.shadowBlur=8; }
    ctx.fillStyle = isOwnerP ? '#ffd700' : (isMe ? '#ffffff' : '#ccffdd');
    ctx.fillText(nameText, hsx, nameY);
    ctx.shadowBlur = 0;
    ctx.textBaseline = 'alphabetic';
  }
}

function drawBorder() {
  const bx = -cameraX, by = -cameraY;
  // Red warning border
  ctx.setLineDash([20, 10]);
  ctx.strokeStyle = 'rgba(255,34,68,0.7)';
  ctx.lineWidth = 4;
  ctx.strokeRect(bx, by, MAP_SIZE, MAP_SIZE);
  ctx.setLineDash([]);
  // Glow
  ctx.shadowColor = '#ff2244'; ctx.shadowBlur = 20;
  ctx.strokeStyle = 'rgba(255,34,68,0.35)';
  ctx.lineWidth = 10;
  ctx.strokeRect(bx, by, MAP_SIZE, MAP_SIZE);
  ctx.shadowBlur = 0;
}

// ================================================================
//  HUD
// ================================================================
function updateHUD() {
  const me = gameState.players[myPlayerId];
  if (me) {
    document.getElementById('scoreVal').textContent = me.score || 0;
    document.getElementById('lengthVal').textContent = (me.segments || []).length;
    sessionCoinsDisplay = me.sessionCoins || 0;
    document.getElementById('hudCoins').textContent = myProfile.coins + sessionCoinsDisplay;
    boosting ? (boostEnergy = Math.max(0, boostEnergy - 0.6)) : (boostEnergy = Math.min(100, boostEnergy + 0.35));
    document.getElementById('boostFill').style.width = boostEnergy + '%';
  }

  const lb = gameState.leaderboard || [];
  document.getElementById('lbList').innerHTML = lb.map((e, i) => {
    const rs  = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
    const sym = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '#' + (i+1);
    const badge = e.equippedBadge ? e.equippedBadge + ' ' : '';
    const title = e.equippedTitle ? `<span style="font-size:9px;color:#aa44ff;">${e.equippedTitle} </span>` : '';
    return `<div class="lb-entry">
      <div class="lb-rank ${rs}">${sym}</div>
      <div class="lb-name ${e.isOwner ? 'is-owner' : ''}">${title}${e.isOwner ? 'üëë ' : ''}${badge}${e.name}</div>
      <div class="lb-len">${e.length}</div>
    </div>`;
  }).join('');

  drawMinimap();
}

function drawMinimap() {
  const mmc  = document.getElementById('minimapCanvas');
  const mCtx = mmc.getContext('2d');
  const W = mmc.width, H = mmc.height, scale = W / MAP_SIZE;
  mCtx.fillStyle = 'rgba(0,0,8,0.95)';
  mCtx.fillRect(0, 0, W, H);
  for (const oid in orbsLocal) {
    const o = orbsLocal[oid];
    mCtx.fillStyle = o.color + '55';
    mCtx.fillRect(o.x * scale - 0.5, o.y * scale - 0.5, 1.5, 1.5);
  }
  for (const pid in gameState.players) {
    const p = gameState.players[pid];
    if (!p.segments || !p.segments.length) continue;
    const h = p.segments[0];
    mCtx.beginPath();
    mCtx.arc(h.x * scale, h.y * scale, pid === myPlayerId ? 4.5 : 2.5, 0, Math.PI * 2);
    mCtx.fillStyle = pid === myPlayerId ? '#00ff8c' : p.isOwner ? '#ffd700' : '#ffffff99';
    mCtx.fill();
  }
  mCtx.strokeStyle = 'rgba(0,255,140,0.3)'; mCtx.lineWidth = 1;
  mCtx.strokeRect(0.5, 0.5, W - 1, H - 1);
}

// ================================================================
//  KILL FEED
// ================================================================
function addKillFeed(killedId, killerName) {
  const killedName = gameState.players[killedId]?.name || 'Someone';
  const kf    = document.getElementById('killfeed');
  const entry = document.createElement('div');
  entry.className = 'kf-entry';
  entry.innerHTML = `<span style="color:#aaa;">${killedName}</span> <span style="color:#ff2244;">‚úï</span> <span style="color:#00ff8c;">${killerName}</span>`;
  kf.appendChild(entry);
  setTimeout(() => { entry.style.opacity = '0'; setTimeout(() => entry.remove(), 300); }, 4700);
}

// ================================================================
//  SYSTEM MSG / TOAST
// ================================================================
function showSystemMsg(msg) {
  const el = document.getElementById('sysmsg');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}
function showToast(msg, type) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast' + (type ? ' ' + type : '');
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  if (name === 'menuScreen') document.getElementById('menuScreen').classList.remove('hidden');
}

// ================================================================
//  COSMETICS SYSTEM
// ================================================================
function updateCoinDisplays() {
  const total = myProfile.coins + sessionCoinsDisplay;
  document.getElementById('menuCoinBalance').textContent    = myProfile.coins;
  document.getElementById('ingameCoinBalance').textContent = total;
  updateEquippedDisplay();
}

function updateEquippedDisplay() {
  const cat = cosmeticsCatalog;
  document.getElementById('equippedTrailDisplay').textContent = myProfile.equippedTrail ? (cat[myProfile.equippedTrail]?.name || myProfile.equippedTrail) : 'None';
  document.getElementById('equippedTitleDisplay').textContent = myProfile.equippedTitle || 'None';
  document.getElementById('equippedBadgeDisplay').textContent = myProfile.equippedBadge || '‚Äî';
}

function openIngameCosmetics() {
  document.getElementById('ingameCosmeticsPanel').style.display = 'block';
  updateCoinDisplays();
  renderCosmeticsShop();
}
function closeIngameCosmetics() {
  document.getElementById('ingameCosmeticsPanel').style.display = 'none';
}

function renderCosmeticsShop() {
  const container = document.getElementById('cosmeticsShopContent');
  const catalog   = cosmeticsCatalog;
  if (!Object.keys(catalog).length) {
    container.innerHTML = '<p style="color:var(--dim);text-align:center;padding:20px;">Connect to a game to load cosmetics.</p>';
    return;
  }

  const sections = {
    trail: 'üî• TRAILS',
    title: 'üìõ TITLES',
    badge: 'üèÖ BADGES',
    owner: 'üëë OWNER EXCLUSIVES'
  };

  let html = '';
  for (const [type, label] of Object.entries(sections)) {
    const items = Object.values(catalog).filter(c => c.type === type);
    if (!items.length) continue;

    html += `<div style="font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:${type==='owner'?'var(--gold)':'var(--dim)'};margin:18px 0 8px;">${label}</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px;">`;

    for (const cosmetic of items) {
      const owned = isOwner || myProfile.unlockedCosmetics.includes(cosmetic.id);
      const equipped =
        (cosmetic.type === 'trail' && myProfile.equippedTrail === cosmetic.id) ||
        ((cosmetic.type === 'owner') && (myProfile.equippedTrail === cosmetic.id || myProfile.equippedTitle === cosmetic.text || myProfile.equippedBadge === cosmetic.emoji)) ||
        (cosmetic.type === 'title' && myProfile.equippedTitle === cosmetic.text) ||
        (cosmetic.type === 'badge' && myProfile.equippedBadge === cosmetic.emoji);

      const ownerOnly = cosmetic.ownerOnly;
      const totalCoins = myProfile.coins + sessionCoinsDisplay;

      let cardClass = 'cosmetic-card';
      if (equipped) cardClass += ' equipped';
      else if (owned) cardClass += ' owned';
      else if (ownerOnly) cardClass += ' owner-only locked-shop';
      else cardClass += ' locked-shop';

      let actionBtn = '';
      if (equipped) {
        if (!isOwner) {
          actionBtn = `<button onclick="doUnequip('${cosmetic.type}')" style="margin-top:6px;width:100%;padding:4px;background:rgba(255,34,68,0.1);border:1px solid rgba(255,34,68,0.3);border-radius:2px;color:#ff4466;font-size:9px;cursor:pointer;font-family:Orbitron,monospace;">UNEQUIP</button>`;
        } else {
          actionBtn = `<div style="margin-top:5px;font-size:9px;color:var(--glow);">‚úì ACTIVE</div>`;
        }
      } else if (owned) {
        actionBtn = `<button onclick="doEquip('${cosmetic.id}')" style="margin-top:6px;width:100%;padding:4px;background:rgba(0,255,140,0.08);border:1px solid rgba(0,255,140,0.3);border-radius:2px;color:var(--glow);font-size:9px;cursor:pointer;font-family:Orbitron,monospace;">EQUIP</button>`;
      } else if (ownerOnly) {
        actionBtn = `<div style="margin-top:5px;font-size:9px;color:rgba(255,215,0,0.35);text-align:center;">OWNER ONLY</div>`;
      } else {
        const canAfford = totalCoins >= cosmetic.price;
        actionBtn = `<button onclick="doBuy('${cosmetic.id}')" style="margin-top:6px;width:100%;padding:4px;background:${canAfford?'rgba(255,215,0,0.1)':'rgba(255,255,255,0.03)'};border:1px solid ${canAfford?'rgba(255,215,0,0.35)':'rgba(255,255,255,0.08)'};border-radius:2px;color:${canAfford?'var(--gold)':'rgba(255,255,255,0.2)'};font-size:9px;cursor:${canAfford?'pointer':'not-allowed'};font-family:Orbitron,monospace;">${cosmetic.price} üí∞</button>`;
      }

      html += `<div class="${cardClass}">
        ${equipped ? '<div class="equipped-label">‚úì EQUIPPED</div>' : ''}
        ${ownerOnly ? '<div class="cosmetic-badge">üëë</div>' : ''}
        <span class="cosmetic-icon">${cosmetic.emoji}</span>
        <div class="cosmetic-name">${cosmetic.name}</div>
        ${actionBtn}
      </div>`;
    }
    html += '</div>';
  }
  container.innerHTML = html;
}

function doBuy(cosmeticId)     { if (!socket) return; socket.emit('buyCosmetic',   { cosmeticId }); }
function doEquip(cosmeticId)   { if (!socket) return; socket.emit('equipCosmetic', { cosmeticId }); }
function doUnequip(slot)       { if (!socket) return; socket.emit('unequipCosmetic',{ slot }); }

// ================================================================
//  OWNER PANEL
// ================================================================
document.getElementById('closeOwnerPanel').onclick = () => document.getElementById('ownerPanel').classList.add('hidden');

document.querySelectorAll('.owner-nav-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.owner-nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.owner-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    const tab = document.getElementById('tab-' + btn.dataset.tab);
    if (tab) tab.classList.add('active');
    if (['players','actions','skins','ownercosmetics'].includes(btn.dataset.tab)) refreshPlayers();
    updateOwnerStats();
  };
});

function openOwnerPanel() {
  document.getElementById('ownerPanel').classList.remove('hidden');
  updateOwnerStats();
  refreshPlayers();
}

// Owner tag is also a clickable shortcut to the panel
document.getElementById('owner-tag-hud').onclick = openOwnerPanel;

// Double-click owner button to enter panel directly (dev shortcut)
document.getElementById('ownerToggleBtn').addEventListener('dblclick', () => {
  const pass = document.getElementById('ownerPass').value;
  if (pass === 'Z3N0ISKING') {
    isOwner = true;
    buildSkinSelector();
    openOwnerPanel();
  }
});

function updateOwnerStats() {
  fetch('/api/stats').then(r => r.json()).then(d => {
    document.getElementById('os-players').textContent = d.players;
    document.getElementById('os-orbs').textContent    = d.orbs;
    document.getElementById('os-event').textContent   = d.activeEvent || 'NONE';
  }).catch(() => {});
}

function refreshPlayers() {
  if (!socket) return;
  socket.emit('ownerAction', { action:'getPlayers', password: ownerPass || 'Z3N0ISKING' });
}

function renderPlayerTable(list) {
  const tbody = document.getElementById('playerTableBody');
  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:rgba(255,215,0,0.3);padding:20px;">No players online</td></tr>';
    return;
  }
  tbody.innerHTML = list.map(p => `
    <tr>
      <td><span style="color:${p.isOwner?'#ffd700':'rgba(255,215,0,0.8)'}">${p.isOwner?'üëë ':''}${p.name}</span></td>
      <td style="font-family:Space Mono,monospace;font-size:12px;color:rgba(255,215,0,0.6);">${p.length}</td>
      <td style="font-family:Space Mono,monospace;font-size:12px;color:rgba(255,215,0,0.6);">${p.score}</td>
      <td style="font-family:Space Mono,monospace;font-size:12px;color:var(--gold);">üí∞${p.coins||0}</td>
      <td style="font-size:11px;color:rgba(255,215,0,0.5);">${p.equippedBadge||''} ${p.equippedTitle||''} ${p.equippedTrail?'üé®':''}</td>
      <td><div style="display:flex;gap:4px;flex-wrap:wrap;">
        <button class="btn btn-danger btn-sm" onclick="quickKill('${p.id}','${escHtml(p.name)}')">‚ò†Ô∏è</button>
        <button class="btn btn-sm" style="border:1px solid rgba(255,34,68,0.3);color:rgba(255,34,68,0.6);padding:6px 8px;font-size:9px;" onclick="quickKick('${p.id}','${escHtml(p.name)}')">üö´</button>
        <button class="btn btn-gold btn-sm" onclick="quickSize('${p.id}','${escHtml(p.name)}')">üìè</button>
        <button class="btn btn-gold btn-sm" onclick="quickCoins('${p.id}','${escHtml(p.name)}')">üí∞</button>
      </div></td>
    </tr>`).join('');
}

function escHtml(str) { return String(str).replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

function populateSelects(list) {
  const ids = ['sizeTarget','coinsTarget','swapP1','swapP2','kickTarget','killTarget','skinTarget','ownerCosmeticTarget'];
  ids.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.innerHTML = list.map(p =>
      `<option value="${p.id}">${p.isOwner?'üëë ':''}${p.name} (len:${p.length})</option>`
    ).join('');
  });
}

function showOwnerAlert(msg, type) {
  const el = document.getElementById('ownerAlert');
  el.textContent = msg;
  el.className = 'o-alert ' + type;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}

function ownerAction(action, value, targetId) {
  if (!socket) { showToast('Not connected', 'error'); return; }
  socket.emit('ownerAction', { action, value, targetId, password: ownerPass || 'Z3N0ISKING' });
}

function doGiveSize()    { ownerAction('giveSize',    document.getElementById('sizeAmount').value,  document.getElementById('sizeTarget').value); }
function doGiveCoins()   { ownerAction('giveCoins',   document.getElementById('coinsAmount').value, document.getElementById('coinsTarget').value); }
function doSwapSize()    { ownerAction('swapSize',    document.getElementById('swapP2').value,      document.getElementById('swapP1').value); }
function doKick()        { ownerAction('kick',        document.getElementById('kickReason').value || 'Kicked by Z3N0.', document.getElementById('kickTarget').value); }
function doInstaKill()   { ownerAction('instaKill',   null, document.getElementById('killTarget').value); }
function doGiveSkin()    { ownerAction('giveSkin',    document.getElementById('skinToGive').value,  document.getElementById('skinTarget').value); }
function doGiveCosmetic(){ ownerAction('giveCosmetic',document.getElementById('ownerCosmeticToGive').value, document.getElementById('ownerCosmeticTarget').value); }
function doBroadcast()   { const m = document.getElementById('broadcastMsg').value.trim(); if (!m) return; ownerAction('broadcast', m); document.getElementById('broadcastMsg').value=''; }

function quickKill(id, name)  { if (!confirm(`‚ò†Ô∏è Insta-kill ${name}?`)) return; ownerAction('instaKill', null, id); }
function quickKick(id, name)  { const r = prompt(`Kick reason for ${name}:`, 'Kicked by Z3N0'); if (r === null) return; ownerAction('kick', r, id); }
function quickSize(id, name)  { const a = prompt(`Give size to ${name}:`, '50'); if (!a) return; ownerAction('giveSize', a, id); }
function quickCoins(id, name) { const a = prompt(`Give coins to ${name}:`, '500'); if (!a) return; ownerAction('giveCoins', a, id); }

// ================================================================
//  MENU STATS REFRESH
// ================================================================
setInterval(() => {
  fetch('/api/stats').then(r => r.json()).then(d => {
    document.getElementById('statPlayers').textContent = d.players;
    document.getElementById('statOrbs').textContent    = d.orbs;
    document.getElementById('statEvent').style.display = d.activeEvent ? 'inline' : 'none';
  }).catch(() => {});
}, 3000);

// How to play
document.getElementById('howToBtn').onclick = () => {
  const boostInfo = boostKey === 'shift' ? 'Shift' : boostKey === 'space' ? 'Space' : 'Shift or Space';
  alert(`üêç HOW TO PLAY ‚Äî Z3N0'S SERPENT REALM\n\nControls: ${controlScheme.toUpperCase()}\n${controlScheme==='mouse'?'Move mouse to steer':'Use '+controlScheme.toUpperCase()+' keys to steer'}\nHold click or ${boostInfo} to BOOST\n\nEat glowing orbs to grow & earn coins üí∞\nKill others by making them hit your body\nAvoid the red border ‚Äî instant death!\n\nüí∞ COINS persist across ALL sessions!\nüé® Buy cosmetics in the shop ‚Äî they're permanent!\nüëë Z3N0 is the supreme owner of this realm.\n\nOwner panel: F1 key (owner only)`);
};

// ================================================================
//  INIT
// ================================================================
updateBoostLabel();
document.getElementById('nameInput').focus();
</script>
</body>
</html>
