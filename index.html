<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Z3N0 ¬∑ Snake Realm ULTRA</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --red:#e8384f;--green:#2edd8e;--gold:#f5c842;--blue:#3b9eff;
  --purple:#9b5de5;--pink:#f15bb5;--orange:#f77f00;--cyan:#00c9c8;
  --bg:#08091a;--surface:rgba(255,255,255,.035);--border:rgba(255,255,255,.07);
  --text:#dde2f0;--muted:rgba(200,210,235,.38);
  --card-bg:#0e0f22;--accent-soft:rgba(46,221,142,.08);
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'DM Sans',sans-serif;color:var(--text)}
/* Subtle noise texture */
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");opacity:.4;pointer-events:none;z-index:1;mix-blend-mode:overlay}
/* Canvas ‚Äî pointer-events:none so it NEVER blocks clicks */
#gc{position:fixed;inset:0;cursor:none;pointer-events:none;z-index:0}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:1000;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.03) 3px,rgba(0,0,0,.03) 4px);opacity:.25}
#cur{position:fixed;width:9px;height:9px;border:1.5px solid var(--green);border-radius:50%;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:transform .08s ease;mix-blend-mode:screen}
#cur::after{content:'';position:absolute;inset:-8px;border-radius:50%;border:1px solid rgba(46,221,142,.15);transition:all .15s}
#cur.b{transform:translate(-50%,-50%) scale(1.6);border-color:#fff}
#flash{position:fixed;inset:0;pointer-events:none;z-index:500;opacity:0}
#vign{position:fixed;inset:0;pointer-events:none;z-index:201;opacity:0}

/* ‚îÄ‚îÄ SCREENS ‚Äî z-index 800 so always above canvas ‚îÄ‚îÄ */
.scr{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:800}
.scr.hide{display:none!important}

/* ‚ïê‚ïê MENU ‚ïê‚ïê */
#S_menu{background:var(--bg);overflow:hidden}
#S_menu::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(46,221,142,.022) 1px,transparent 1px),linear-gradient(90deg,rgba(46,221,142,.022) 1px,transparent 1px);background-size:52px 52px;animation:gridmove 24s linear infinite;z-index:0}
@keyframes gridmove{from{background-position:0 0}to{background-position:52px 52px}}
.menu-wrap{position:relative;z-index:1;display:flex;width:100%;height:100%;max-width:1200px;margin:0 auto}
.menu-left{flex:1;display:flex;flex-direction:column;justify-content:center;padding:60px 56px;position:relative;overflow:hidden}
.ml-tag{font-family:'DM Sans',sans-serif;font-size:10px;font-weight:700;color:var(--green);letter-spacing:.2em;text-transform:uppercase;margin-bottom:22px;display:flex;align-items:center;gap:10px;opacity:.85}
.ml-tag::before{content:'';width:18px;height:1.5px;background:var(--green)}
.ml-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(68px,7.5vw,116px);line-height:.88;letter-spacing:.025em;color:#fff;margin-bottom:10px}
.ml-title-accent{color:var(--red);display:block;text-shadow:0 0 50px rgba(232,56,79,.3),0 2px 0 rgba(0,0,0,.35)}
.ml-sub{font-size:13.5px;color:var(--muted);line-height:1.75;max-width:380px;margin-bottom:38px;font-weight:400}
.ml-badges{display:flex;flex-direction:column;gap:12px}
.ml-badge{display:inline-flex;align-items:center;gap:11px;font-size:12px;font-weight:500;color:var(--muted);letter-spacing:.02em}
.ml-badge-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.ml-badge-dot.g{background:var(--green);box-shadow:0 0 6px var(--green)}
.ml-badge-dot.r{background:var(--red);box-shadow:0 0 6px var(--red)}
.ml-badge-dot.y{background:var(--gold);box-shadow:0 0 6px var(--gold)}
.ml-badge-dot.p{background:var(--purple);box-shadow:0 0 6px var(--purple)}
.ml-badge-dot.b{background:var(--blue);box-shadow:0 0 6px var(--blue)}
.ml-deco{position:absolute;right:-20px;top:50%;transform:translateY(-50%);font-family:'Bebas Neue',sans-serif;font-size:260px;color:rgba(255,255,255,.01);line-height:1;pointer-events:none;user-select:none}
.live-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);margin-right:4px;animation:pulse-dot 1.6s ease infinite}
@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.65)}}
.menu-right{width:390px;flex-shrink:0;background:rgba(14,15,34,.88);border-left:1px solid rgba(255,255,255,.05);display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden;position:relative;backdrop-filter:blur(20px)}
.menu-right::before{content:'';position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,var(--red) 30%,transparent)}
.mr-top{padding:22px 22px 0}
.mr-tabs{display:flex;gap:0;margin-bottom:18px;border-bottom:1px solid var(--border)}
.mr-tab{flex:1;padding:10px 4px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;letter-spacing:.04em;color:var(--muted);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .18s;text-transform:uppercase}
.mr-tab:hover{color:var(--text)}
.mr-tab.on{color:#fff;border-bottom-color:var(--red)}
.mr-tc{display:none}.mr-tc.on{display:block}
.mr-bot{padding:0 22px 22px}
.f-label{display:block;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin-bottom:5px}
.f-input{width:100%;background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:11px 14px;color:#fff;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .18s,background .18s;margin-bottom:13px}
.f-input:focus{border-color:rgba(46,221,142,.35);background:rgba(46,221,142,.03);box-shadow:0 0 0 3px rgba(46,221,142,.04)}
.f-input::placeholder{color:rgba(200,210,235,.12)}
.f-input.err{border-color:rgba(232,56,79,.45)!important}
.skin-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-bottom:14px}
.skin-cell{aspect-ratio:1;border-radius:8px;border:1.5px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:all .15s;position:relative}
.skin-cell:hover{border-color:rgba(255,255,255,.3);transform:scale(1.06);background:rgba(255,255,255,.04)}
.skin-cell.on{border-color:var(--green);box-shadow:0 0 0 2px rgba(46,221,142,.15);background:rgba(46,221,142,.05)}
.skin-cell-tip{display:none;position:absolute;bottom:calc(100%+5px);left:50%;transform:translateX(-50%);background:#1a1b30;border:1px solid var(--border);border-radius:5px;padding:3px 8px;font-family:'DM Sans',sans-serif;font-size:10px;color:#94a3b8;white-space:nowrap;pointer-events:none;z-index:10}
.skin-cell:hover .skin-cell-tip{display:block}
.btn-play{display:block;width:100%;padding:13px 20px;background:var(--red);border:none;border-radius:9px;color:#fff;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .18s;text-align:center;letter-spacing:.04em}
.btn-play:hover{background:#f04560;box-shadow:0 6px 24px rgba(232,56,79,.28);transform:translateY(-1px)}
.btn-play:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-sec{display:block;width:100%;padding:10px 20px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:9px;color:var(--muted);font-size:12px;font-weight:500;cursor:pointer;transition:all .18s;text-align:center;text-transform:uppercase;letter-spacing:.06em;margin-top:7px}
.btn-sec:hover{background:rgba(255,255,255,.06);color:#fff;border-color:rgba(255,255,255,.12)}
.btn-gold-sm{padding:8px 13px;background:rgba(245,200,66,.06);border:1px solid rgba(245,200,66,.22);border-radius:7px;color:var(--gold);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:.06em;transition:all .15s;white-space:nowrap}
.btn-gold-sm:hover{background:rgba(245,200,66,.12);border-color:rgba(245,200,66,.35)}
.btn-green{display:block;width:100%;padding:13px 20px;background:rgba(46,221,142,.1);border:1px solid rgba(46,221,142,.28);border-radius:9px;color:var(--green);font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .18s;text-align:center;letter-spacing:.04em;margin-top:7px}
.btn-green:hover{background:rgba(46,221,142,.16);box-shadow:0 6px 24px rgba(46,221,142,.12);border-color:rgba(46,221,142,.4)}
.divider{display:flex;align-items:center;gap:10px;margin:14px 0;color:var(--muted);font-size:10px;font-family:'DM Sans',sans-serif;letter-spacing:.08em}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border)}
.toggle-label{font-size:12px;color:var(--muted);font-weight:500}
.toggle-btns{display:flex;gap:3px}
.tgl{padding:4px 12px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;letter-spacing:.04em}
.tgl.on{background:rgba(46,221,142,.07);border-color:rgba(46,221,142,.3);color:var(--green)}
.auth-banner{display:flex;align-items:center;gap:8px;background:rgba(46,221,142,.05);border:1px solid rgba(46,221,142,.15);border-radius:8px;padding:9px 12px;margin-bottom:14px;font-size:11px;font-weight:600;color:var(--green)}
.auth-banner-name{color:#fff;font-weight:600;font-size:12px;font-family:'DM Sans',sans-serif;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.auth-banner-coins{color:var(--gold);font-size:11px}
.auth-logout{background:none;border:1px solid rgba(232,56,79,.25);border-radius:5px;color:rgba(232,56,79,.6);font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;padding:3px 8px;cursor:pointer;text-transform:uppercase;transition:all .15s}
.auth-logout:hover{border-color:var(--red);color:var(--red)}
.auth-msg{font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;letter-spacing:.03em;padding:9px 12px;border-radius:7px;margin-bottom:12px;display:none}
.auth-msg.err{display:block;background:rgba(232,56,79,.07);border:1px solid rgba(232,56,79,.25);color:#fca5a5}
.auth-msg.ok{display:block;background:rgba(46,221,142,.05);border:1px solid rgba(46,221,142,.18);color:var(--green)}
.check-row{display:flex;align-items:center;gap:8px;margin-bottom:14px;cursor:pointer}
.check-row input[type=checkbox]{width:14px;height:14px;accent-color:var(--green);cursor:pointer}
.check-row span{font-family:'DM Sans',sans-serif;font-size:11px;color:var(--muted)}

/* ‚ïê‚ïê HUD ‚ïê‚ïê */
#hud{position:fixed;inset:0;pointer-events:none;z-index:200;display:none}
#H_score{position:absolute;top:14px;left:50%;transform:translateX(-50%);background:rgba(8,9,26,.9);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:7px 22px;text-align:center;backdrop-filter:blur(12px)}
#H_score .v{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:.06em;color:#fff;line-height:1}
#H_score .l{font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;letter-spacing:.14em;color:var(--muted);text-transform:uppercase;margin-top:1px}
#H_score.bump{animation:bump .18s ease}
@keyframes bump{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.1)}}
#H_coins{position:absolute;top:14px;left:14px;background:rgba(8,9,26,.9);border:1px solid rgba(245,200,66,.12);border-radius:10px;padding:8px 14px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;color:var(--gold);backdrop-filter:blur(12px);display:flex;align-items:center;gap:6px}
#H_len{position:absolute;top:14px;right:14px;background:rgba(8,9,26,.9);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:7px 14px;text-align:center;backdrop-filter:blur(12px)}
#H_len .v{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.05em}
#H_len .l{font-family:'DM Sans',sans-serif;font-size:8px;letter-spacing:.1em;color:var(--muted);text-transform:uppercase}
#lb{position:absolute;right:14px;top:76px;width:168px;background:rgba(8,9,26,.9);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:11px;backdrop-filter:blur(12px)}
#lb-hd{font-family:'DM Sans',sans-serif;font-size:9px;font-weight:700;letter-spacing:.14em;color:var(--muted);text-transform:uppercase;margin-bottom:8px;text-align:center}
.lbr{display:flex;align-items:center;gap:5px;padding:3px 0}
.lbr+.lbr{border-top:1px solid rgba(255,255,255,.03)}
.lbrank{font-family:'DM Sans',sans-serif;font-size:10px;color:var(--muted);width:22px;text-align:center;flex-shrink:0}
.lbrank.g1{color:var(--gold)}.lbrank.g2{color:#94a3b8}.lbrank.g3{color:#b45309}
.lbn{font-size:11px;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#cbd5e1}
.lbn.me{color:var(--green);font-weight:700}
.lbn.bot{color:var(--muted)}
.lbs{font-family:'DM Sans',sans-serif;font-size:9px;color:var(--muted);width:28px;text-align:right}
.lb-streak{font-size:9px;margin-left:2px}
#bbar{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);width:190px;text-align:center}
.b-label{font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin-bottom:5px;display:flex;justify-content:space-between}
.b-track{height:3px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden}
#bfill{height:100%;background:var(--green);border-radius:2px;transition:width .05s linear;box-shadow:0 0 5px rgba(46,221,142,.4)}
#bfill.low{background:var(--red)}
#mm{position:absolute;bottom:18px;right:14px;border-radius:9px;overflow:hidden;border:1px solid rgba(255,255,255,.07)}
#kf{position:absolute;left:14px;bottom:88px;width:230px;display:flex;flex-direction:column;gap:3px}
.kfe{background:rgba(8,9,26,.92);border-left:2px solid var(--red);padding:5px 10px;border-radius:0 6px 6px 0;font-size:11px;animation:kfin .18s ease;line-height:1.4;display:flex;align-items:center;gap:6px}
@keyframes kfin{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.kfe-icon{font-size:13px;flex-shrink:0}
#fps{position:absolute;top:5px;right:5px;font-family:'DM Sans',sans-serif;font-size:9px;color:rgba(200,210,235,.18)}
#pcount{position:absolute;top:76px;left:14px;background:rgba(8,9,26,.9);border:1px solid rgba(46,221,142,.1);border-radius:8px;padding:5px 10px;font-family:'DM Sans',sans-serif;font-size:10px;color:var(--green);backdrop-filter:blur(12px)}
#H_powerups{position:absolute;top:72px;left:50%;transform:translateX(-50%);display:flex;gap:6px;pointer-events:none}
.pu-indicator{background:rgba(8,9,26,.9);border:1px solid rgba(255,255,255,.07);border-radius:8px;padding:6px 9px;font-size:14px;line-height:1;position:relative;backdrop-filter:blur(12px);animation:pu-in .2s ease}
@keyframes pu-in{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}
.pu-timer{position:absolute;bottom:-4px;left:50%;transform:translateX(-50%);width:80%;height:2px;background:var(--border);border-radius:1px;overflow:hidden}
.pu-timer-fill{height:100%;width:100%;transition:width .1s linear}
#streak-banner{position:fixed;top:36%;left:50%;transform:translate(-50%,-50%);font-family:'Bebas Neue',sans-serif;font-size:clamp(28px,5vw,52px);letter-spacing:.04em;color:var(--red);pointer-events:none;z-index:400;opacity:0;text-shadow:0 0 30px rgba(232,56,79,.5);transition:opacity .2s}
#streak-banner.on{opacity:1}
#combo{position:absolute;top:72px;left:50%;transform:translateX(-50%);font-family:'Bebas Neue',sans-serif;font-size:clamp(18px,3vw,28px);letter-spacing:.06em;color:var(--gold);pointer-events:none;opacity:0;transition:opacity .2s;text-shadow:0 0 20px rgba(245,200,66,.5)}
#combo.on{opacity:1}
#event-notif{position:fixed;top:0;left:50%;transform:translateX(-50%) translateY(-100%);background:linear-gradient(135deg,rgba(155,93,229,.88),rgba(155,93,229,.6));border:1px solid rgba(155,93,229,.5);border-top:none;border-radius:0 0 12px 12px;padding:10px 24px;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.08em;color:#fff;text-align:center;z-index:600;pointer-events:none;opacity:0;transition:opacity .4s,transform .4s}
#event-notif.on{opacity:1;transform:translateX(-50%) translateY(0)}
#sys-msg{position:fixed;top:28%;left:50%;transform:translate(-50%,-50%);background:rgba(8,9,26,.95);border:1px solid rgba(59,158,255,.35);border-radius:10px;padding:12px 22px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;color:#7dd3fc;letter-spacing:.06em;text-align:center;z-index:600;pointer-events:none;opacity:0;transition:opacity .3s}
#sys-msg.on{opacity:1}
#taunt-bubble{position:fixed;bottom:32%;left:50%;transform:translateX(-50%);background:rgba(8,9,26,.92);border:1px solid rgba(232,56,79,.25);border-radius:8px;padding:8px 16px;font-size:12px;color:var(--muted);z-index:600;pointer-events:none;opacity:0;transition:opacity .2s;font-style:italic}
#taunt-bubble.on{opacity:1}
#portal-notif{position:absolute;top:120px;left:50%;transform:translateX(-50%);background:rgba(155,93,229,.1);border:1px solid rgba(155,93,229,.35);border-radius:8px;padding:7px 16px;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:700;color:#c4b5fd;letter-spacing:.08em;pointer-events:none;opacity:0;transition:opacity .3s;text-align:center}
#portal-notif.on{opacity:1}
.sp{position:fixed;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:.06em;pointer-events:none;z-index:300;animation:spop 1.1s ease forwards}
@keyframes spop{0%{opacity:0;transform:translateY(0) scale(.7)}15%{opacity:1;transform:translateY(-14px) scale(1.1)}80%{opacity:.85;transform:translateY(-52px) scale(1)}100%{opacity:0;transform:translateY(-72px) scale(.9)}}
.kill-flash{position:fixed;inset:0;pointer-events:none;z-index:450;animation:kflash .4s ease forwards}
@keyframes kflash{0%{background:rgba(232,56,79,.18)}100%{background:transparent}}

/* ‚ïê‚ïê DEATH SCREEN ‚ïê‚ïê */
#S_death{background:rgba(8,9,26,.97);flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(16px)}
.d-tag{font-family:'DM Sans',sans-serif;font-size:10px;font-weight:700;letter-spacing:.22em;color:var(--red);text-transform:uppercase;margin-bottom:10px;opacity:.7}
.d-eliminated{font-family:'Bebas Neue',sans-serif;font-size:clamp(44px,7vw,80px);letter-spacing:.02em;color:#fff;margin-bottom:4px}
.d-by{font-family:'DM Sans',sans-serif;font-size:12px;color:var(--muted);margin-bottom:24px;letter-spacing:.08em}
.d-by span{color:var(--red)}
.d-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:22px;margin-bottom:24px;text-align:center}
.d-stat .v{font-family:'Bebas Neue',sans-serif;font-size:38px;letter-spacing:.04em;color:#fff;line-height:1}
.d-stat .l{font-family:'DM Sans',sans-serif;font-size:8px;font-weight:600;letter-spacing:.14em;color:var(--muted);text-transform:uppercase;margin-top:3px}
.d-coins-earned{font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;color:var(--gold);letter-spacing:.08em;margin-bottom:8px}
.d-hs{font-family:'DM Sans',sans-serif;font-size:11px;font-weight:700;color:var(--gold);letter-spacing:.08em;margin-bottom:22px;min-height:16px}
.d-btns{display:flex;gap:9px}
.d-play{font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;letter-spacing:.04em;padding:12px 30px;background:var(--red);border:none;border-radius:9px;color:#fff;cursor:pointer;transition:all .18s}
.d-play:hover{background:#f04560;box-shadow:0 8px 24px rgba(232,56,79,.32);transform:translateY(-1px)}
.d-menu{padding:12px 22px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:9px;color:var(--muted);font-size:12px;font-weight:500;cursor:pointer;transition:all .18s}
.d-menu:hover{background:rgba(255,255,255,.07);color:#fff}

/* ‚ïê‚ïê TOAST ‚ïê‚ïê */
#toasts{position:fixed;top:68px;left:50%;transform:translateX(-50%);z-index:900;display:flex;flex-direction:column;gap:5px;align-items:center;pointer-events:none}
.toast{font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;letter-spacing:.06em;padding:7px 15px;border-radius:20px;background:rgba(10,11,28,.94);border:1px solid var(--border);color:var(--text);animation:tin .22s ease,tout .28s ease 2.7s forwards;text-transform:uppercase}
.toast.ok{border-color:rgba(46,221,142,.22);color:#4ade80}
.toast.red{border-color:rgba(232,56,79,.22);color:#fca5a5}
.toast.gold{border-color:rgba(245,200,66,.22);color:var(--gold)}
.toast.blue{border-color:rgba(59,158,255,.22);color:#7dd3fc}
.toast.purple{border-color:rgba(155,93,229,.22);color:#c4b5fd}
@keyframes tin{from{opacity:0;transform:translateY(-7px)}to{opacity:1;transform:translateY(0)}}
@keyframes tout{from{opacity:1}to{opacity:0}}

/* ‚ïê‚ïê SHOP MODAL ‚ïê‚ïê */
#M_shop{position:fixed;inset:0;background:rgba(8,9,26,.94);z-index:1200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(18px);opacity:0;pointer-events:none;transition:opacity .2s}
#M_shop.on{opacity:1;pointer-events:all}
.shop-box{background:#0c0d20;border:1px solid rgba(255,255,255,.07);border-radius:14px;width:min(720px,96vw);max-height:90vh;display:flex;flex-direction:column;box-shadow:0 28px 80px rgba(0,0,0,.85);position:relative;overflow:hidden}
.shop-box::before{content:'';position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,var(--gold),rgba(245,200,66,.08))}
.shop-hdr{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.shop-title{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.05em;color:#fff}
.shop-bal{display:flex;align-items:center;gap:6px;background:rgba(245,200,66,.06);border:1px solid rgba(245,200,66,.15);border-radius:20px;padding:4px 12px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;color:var(--gold)}
.shop-tabs{display:flex;gap:0;padding:0 22px;border-bottom:1px solid var(--border);flex-shrink:0}
.shop-tab{padding:11px 16px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .18s;text-transform:uppercase;letter-spacing:.05em}
.shop-tab:hover{color:var(--text)}
.shop-tab.on{color:var(--gold);border-bottom-color:var(--gold)}
.shop-filters{padding:12px 22px 0;display:flex;gap:5px;flex-wrap:wrap;flex-shrink:0}
.shop-filter{padding:5px 13px;border-radius:20px;border:1px solid var(--border);background:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;letter-spacing:.04em;text-transform:uppercase}
.shop-filter:hover{border-color:rgba(255,255,255,.2);color:var(--text)}
.shop-filter.on{background:rgba(245,200,66,.09);border-color:rgba(245,200,66,.35);color:var(--gold)}
.shop-grid{padding:14px 22px 22px;display:grid;grid-template-columns:repeat(auto-fill,minmax(128px,1fr));gap:9px;overflow-y:auto;flex:1}
.shop-item{background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:14px 12px;display:flex;flex-direction:column;align-items:center;gap:7px;cursor:pointer;transition:all .2s;position:relative}
.shop-item:hover{background:rgba(255,255,255,.045);border-color:rgba(255,255,255,.15);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.shop-item.owned{border-color:rgba(46,221,142,.25)}
.shop-item.owned::after{content:'OWNED';position:absolute;top:6px;right:6px;font-family:'DM Sans',sans-serif;font-size:7px;font-weight:700;letter-spacing:.1em;color:var(--green);background:rgba(46,221,142,.07);border:1px solid rgba(46,221,142,.18);border-radius:3px;padding:2px 5px}
.shop-item.equipped{border-color:rgba(46,221,142,.4);background:rgba(46,221,142,.04)}
.shop-item.equipped::after{content:'ON';position:absolute;top:6px;right:6px;font-family:'DM Sans',sans-serif;font-size:7px;font-weight:700;color:var(--green);background:rgba(46,221,142,.1);border:1px solid rgba(46,221,142,.3);border-radius:3px;padding:2px 5px}
.shop-item-icon{font-size:26px}
.shop-item-name{font-size:11px;font-weight:600;color:var(--text);text-align:center;line-height:1.3}
.shop-buy-btn{width:100%;padding:6px;background:rgba(245,200,66,.07);border:1px solid rgba(245,200,66,.22);border-radius:6px;color:var(--gold);font-family:'DM Sans',sans-serif;font-size:10px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase}
.shop-buy-btn:hover:not(:disabled){background:rgba(245,200,66,.16)}
.shop-buy-btn:disabled{opacity:.3;cursor:not-allowed}
.shop-equip-btn{width:100%;padding:6px;background:rgba(46,221,142,.06);border:1px solid rgba(46,221,142,.22);border-radius:6px;color:var(--green);font-family:'DM Sans',sans-serif;font-size:10px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase}
.shop-equip-btn:hover{background:rgba(46,221,142,.12)}
.modal-close{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.07);background:rgba(255,255,255,.03);color:var(--muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.modal-close:hover{background:rgba(255,255,255,.07);color:#fff}
.owned-empty{grid-column:1/-1;padding:32px;text-align:center;color:var(--muted);font-size:13px}
.owned-empty span{font-size:32px;display:block;margin-bottom:10px}

/* Mobile */
@media(max-width:680px){
  .menu-left{display:none}
  .menu-right{width:100%;max-width:400px;border-left:none}
  .d-stats{grid-template-columns:repeat(2,1fr)}
  #H_len{display:none}
}

/* ‚ïê‚ïê MUSIC PLAYER ‚ïê‚ïê */
#music-player{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:700;display:flex;align-items:center;gap:10px;background:rgba(8,9,26,.92);border:1px solid rgba(255,255,255,.07);border-radius:30px;padding:8px 16px;backdrop-filter:blur(16px);transition:opacity .3s}
#music-player:hover{border-color:rgba(255,255,255,.12)}
#mp-playbtn{width:30px;height:30px;border-radius:50%;background:rgba(46,221,142,.1);border:1px solid rgba(46,221,142,.3);color:var(--green);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .18s;flex-shrink:0}
#mp-playbtn:hover{background:rgba(46,221,142,.2)}
#music-info{display:flex;flex-direction:column;gap:1px}
#music-title{font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;color:var(--text);white-space:nowrap}
#music-artist{font-family:'DM Sans',sans-serif;font-size:9px;color:var(--muted)}
#music-vol{width:60px;height:3px;accent-color:var(--green);cursor:pointer;opacity:.6}
#music-vol:hover{opacity:1}
.music-bar{display:flex;align-items:center;gap:3px}
.music-bar span{width:2px;border-radius:1px;background:var(--green);animation:musicbar .6s ease infinite alternate}
.music-bar span:nth-child(2){animation-delay:.1s;height:8px}
.music-bar span:nth-child(3){animation-delay:.2s;height:12px}
.music-bar span:nth-child(4){animation-delay:.3s;height:6px}
.music-bar span:nth-child(1){height:10px}
.music-bar.paused span{animation:none;height:3px}
@keyframes musicbar{from{transform:scaleY(.4)}to{transform:scaleY(1)}}
</style>
</head>
<body>
<div id="cur"></div>
<div id="flash"></div>
<div id="vign"></div>
<div id="toasts"></div>
<div id="streak-banner"></div>
<div id="taunt-bubble"></div>
<!-- ‚ïê‚ïê MUSIC PLAYER ‚ïê‚ïê -->
<div id="music-player">
  <button id="mp-playbtn" onclick="toggleMusic()" title="Play/Pause">‚ñ∂</button>
  <div class="music-bar" id="music-eq-bars">
    <span style="height:10px"></span>
    <span style="height:14px"></span>
    <span style="height:8px"></span>
    <span style="height:12px"></span>
  </div>
  <div>
    <div style="font-size:11px;font-weight:600;color:#fff;white-space:nowrap">Virginia Beach</div>
    <div style="font-size:9px;color:var(--muted);margin-top:1px">Background Music</div>
  </div>
  <input type="range" id="mp-vol" min="0" max="1" step="0.05" value="0.4" oninput="setBGVol(this.value)" title="Volume" style="-webkit-appearance:none;appearance:none;width:52px;height:3px;background:rgba(255,255,255,.1);border-radius:2px;outline:none;cursor:pointer;flex-shrink:0">
</div>
<audio id="bg-audio" loop preload="auto" src="Virginia_Beach.mp3"></audio>
<canvas id="gc"></canvas>

<!-- ‚ïê‚ïê MENU ‚ïê‚ïê -->
<div class="scr" id="S_menu">
  <div class="menu-wrap">
    <div class="menu-left">
      <p class="ml-tag">Z3N0 ¬∑ ULTRA ¬∑ Real Multiplayer</p>
      <h1 class="ml-title">Snake<span class="ml-title-accent">Realm Ultra</span></h1>
      <p class="ml-sub">Real multiplayer. Real chaos. Power-ups, portals, kill streaks, events, full cosmetics. Built different.</p>
      <div class="ml-badges">
        <div class="ml-badge"><div class="ml-badge-dot g"></div><span class="live-dot"></span>Real Multiplayer ‚Äî Socket.IO</div>
        <div class="ml-badge"><div class="ml-badge-dot r"></div>10 Power-ups: Rage üî•, Shrink ‚úÇÔ∏è, Shield, Ghost, Bomb + more</div>
        <div class="ml-badge"><div class="ml-badge-dot y"></div>Mega orbs üíé, golden orbs ‚≠ê, portal pairs, kill streaks</div>
        <div class="ml-badge"><div class="ml-badge-dot p"></div>Spawn protection ¬∑ Head-on collision skill ¬∑ Boost costs size</div>
        <div class="ml-badge"><div class="ml-badge-dot b"></div>5 unique bot personalities that actively hunt you</div>
      </div>
      <div id="srv-stats" style="margin-top:22px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:.08em"></div>
      <div class="ml-deco">ZU</div>
    </div>
    <div class="menu-right">
      <div class="mr-top">
        <div class="mr-tabs">
          <button class="mr-tab on" data-t="play">Play</button>
          <button class="mr-tab" data-t="login">Login</button>
          <button class="mr-tab" data-t="register">Register</button>
          <button class="mr-tab" data-t="settings">Settings</button>
        </div>
      </div>
      <div class="mr-bot">
        <!-- PLAY TAB -->
        <div class="mr-tc on" id="T_play">
          <div id="auth-banner" class="auth-banner" style="display:none">
            <span>üë§</span>
            <span class="auth-banner-name" id="auth-banner-name">Player</span>
            <span class="auth-banner-coins" id="auth-banner-coins">üí∞ 0</span>
            <button class="auth-logout" onclick="logOut()">Log out</button>
          </div>
          <div id="guest-name-wrap">
            <label class="f-label">Display name</label>
            <input class="f-input" id="ni" type="text" placeholder="Enter name‚Ä¶" maxlength="20" autocomplete="off">
          </div>
          <label class="f-label">Skin</label>
          <div class="skin-grid" id="sk_grid"></div>
          <button class="btn-play" id="playBtn">Enter the Realm</button>
          <div style="display:flex;gap:7px;margin-top:7px">
            <button class="btn-gold-sm" id="ownerBtn">üëë Owner</button>
            <button class="btn-sec" style="margin:0;flex:1;padding:9px;font-size:11px" id="shopBtn">üíé Cosmetics</button>
          </div>
          <div id="ownerWrap" style="display:none;margin-top:9px">
            <input class="f-input" id="ownerInp" type="password" placeholder="Owner code‚Ä¶" style="margin-bottom:0">
          </div>
        </div>
        <!-- LOGIN TAB -->
        <div class="mr-tc" id="T_login">
          <div class="auth-msg" id="login-msg"></div>
          <label class="f-label">Username</label>
          <input class="f-input" id="login-user" type="text" placeholder="your_username" autocomplete="username" maxlength="20">
          <label class="f-label">Password</label>
          <input class="f-input" id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          <label class="check-row"><input type="checkbox" id="login-remember" checked><span>Remember me</span></label>
          <button class="btn-play" id="loginBtn">Log In</button>
          <div class="divider">or</div>
          <button class="btn-sec" onclick="switchTab('register')">Create an Account ‚Üí</button>
        </div>
        <!-- REGISTER TAB -->
        <div class="mr-tc" id="T_register">
          <div class="auth-msg" id="reg-msg"></div>
          <label class="f-label">Username</label>
          <input class="f-input" id="reg-user" type="text" placeholder="cool_username" autocomplete="username" maxlength="20">
          <label class="f-label">Display Name</label>
          <input class="f-input" id="reg-display" type="text" placeholder="How you appear in-game" maxlength="20">
          <label class="f-label">Password</label>
          <input class="f-input" id="reg-pass" type="password" placeholder="Min 6 characters" autocomplete="new-password">
          <label class="f-label">Confirm Password</label>
          <input class="f-input" id="reg-pass2" type="password" placeholder="Confirm password" autocomplete="new-password">
          <button class="btn-green" id="regBtn">Create Account</button>
          <div class="divider">already have one?</div>
          <button class="btn-sec" onclick="switchTab('login')">Log In ‚Üí</button>
        </div>
        <!-- SETTINGS TAB -->
        <div class="mr-tc" id="T_settings">
          <div class="toggle-row">
            <span class="toggle-label">Movement</span>
            <div class="toggle-btns">
              <button class="tgl on" id="mv_mouse" onclick="setMv('mouse',this)">Mouse</button>
              <button class="tgl" id="mv_wasd" onclick="setMv('wasd',this)">WASD</button>
            </div>
          </div>
          <div class="toggle-row">
            <span class="toggle-label">Boost key</span>
            <div class="toggle-btns">
              <button class="tgl on" id="bk_shift" onclick="setBK('shift',this)">Shift</button>
              <button class="tgl" id="bk_space" onclick="setBK('space',this)">Space</button>
            </div>
          </div>
          <div class="toggle-row">
            <span class="toggle-label">Show FPS</span>
            <div class="toggle-btns">
              <button class="tgl on" id="fps_on" onclick="setFPS(true,this)">On</button>
              <button class="tgl" id="fps_off" onclick="setFPS(false,this)">Off</button>
            </div>
          </div>
          <div class="toggle-row">
            <span class="toggle-label">Quality</span>
            <div class="toggle-btns">
              <button class="tgl on" id="q_high" onclick="setQ('high',this)">High</button>
              <button class="tgl" id="q_low" onclick="setQ('low',this)">Low</button>
            </div>
          </div>
          <div class="toggle-row">
            <span class="toggle-label">Particles</span>
            <div class="toggle-btns">
              <button class="tgl on" id="pt_on" onclick="setParticles(true,this)">On</button>
              <button class="tgl" id="pt_off" onclick="setParticles(false,this)">Off</button>
            </div>
          </div>
          <div class="toggle-row">
            <span class="toggle-label">Screen shake</span>
            <div class="toggle-btns">
              <button class="tgl on" id="sh_on" onclick="setShake(true,this)">On</button>
              <button class="tgl" id="sh_off" onclick="setShake(false,this)">Off</button>
            </div>
          </div>
          <div id="wasd-hint" style="display:none;margin-top:10px;padding:8px 10px;background:rgba(0,255,136,.05);border:1px solid rgba(0,255,136,.2);border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--green);line-height:1.7;letter-spacing:.06em">
            W/‚Üë ‚Äî Up &nbsp; S/‚Üì ‚Äî Down<br>A/‚Üê ‚Äî Left &nbsp; D/‚Üí ‚Äî Right<br>Shift/Space ‚Äî Boost
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SHOP ‚ïê‚ïê -->
<div id="M_shop">
  <div class="shop-box">
    <div class="shop-hdr">
      <div style="display:flex;align-items:center;gap:14px">
        <div class="shop-title">üíé Cosmetics</div>
        <div class="shop-bal">üí∞ <span id="shop_bal">0</span></div>
      </div>
      <button class="modal-close" id="shopClose">‚úï</button>
    </div>
    <div class="shop-tabs">
      <button class="shop-tab on" id="smt_store" onclick="setShopMainTab('store')">Shop</button>
      <button class="shop-tab" id="smt_owned" onclick="setShopMainTab('owned')">Owned</button>
    </div>
    <!-- store view -->
    <div id="shop_store_view" style="display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0">
      <div class="shop-filters" id="shop_filters"></div>
      <div class="shop-grid" id="shop_grid"></div>
    </div>
    <!-- owned view -->
    <div id="shop_owned_view" style="display:none;flex-direction:column;flex:1;overflow:hidden;min-height:0">
      <div style="padding:14px 22px 0;flex-shrink:0">
        <div style="font-family:'DM Sans',sans-serif;font-size:12px;color:var(--muted);margin-bottom:4px">Your collection ‚Äî equip your cosmetics to flex on other players</div>
      </div>
      <div class="shop-grid" id="owned_grid" style="padding-top:10px"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê HUD ‚ïê‚ïê -->
<div id="hud">
  <div id="H_coins">üí∞ <span id="H_coinv">0</span></div>
  <div id="H_score"><div class="v" id="H_sv">0</div><div class="l">Score</div></div>
  <div id="H_len"><div class="v" id="H_lv">10</div><div class="l">Length</div></div>
  <div id="H_powerups"></div>
  <div id="lb"><div id="lb-hd">Leaderboard</div><div id="lb_list"></div></div>
  <div id="mm"><canvas id="mmc" width="142" height="142"></canvas></div>
  <div id="bbar"><div class="b-label"><span>Boost</span><span id="bpct">100%</span></div><div class="b-track"><div id="bfill" style="width:100%"></div></div></div>
  <div id="pcount"></div>
  <div id="combo"></div>
  <div id="kf"></div>
  <div id="fps"></div>
  <div id="portal-notif"></div>
  <button style="position:absolute;top:14px;left:106px;background:rgba(255,204,0,.08);border:1px solid rgba(255,204,0,.22);border-radius:8px;padding:8px 11px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:var(--gold);cursor:pointer;pointer-events:all;letter-spacing:.08em;text-transform:uppercase;backdrop-filter:blur(10px)" id="hudShopBtn">Shop</button>
  <button style="position:absolute;top:14px;left:188px;background:rgba(255,68,255,.08);border:1px solid rgba(255,68,255,.25);border-radius:8px;padding:8px 11px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:#ff88ff;cursor:pointer;pointer-events:all;letter-spacing:.08em;text-transform:uppercase;backdrop-filter:blur(10px);display:none" id="ownerPanelBtn">üëë Panel</button>
</div>

<!-- ‚ïê‚ïê OWNER PANEL ‚ïê‚ïê -->
<div id="M_owner" style="position:fixed;inset:0;background:rgba(8,9,26,.94);z-index:1300;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(18px);opacity:0;pointer-events:none;transition:opacity .2s">
  <div style="background:#0c0d20;border:1px solid rgba(255,68,255,.2);border-radius:14px;width:min(560px,96vw);max-height:88vh;display:flex;flex-direction:column;box-shadow:0 28px 80px rgba(0,0,0,.85);position:relative;overflow:hidden">
    <div style="position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,#ff44ff,rgba(255,68,255,.08))"></div>
    <div style="padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.05em;color:#ff88ff">üëë Owner Panel</div>
      <button class="modal-close" id="ownerPanelClose">‚úï</button>
    </div>
    <div style="padding:18px 22px;overflow-y:auto;display:flex;flex-direction:column;gap:14px">
      <!-- Player list -->
      <div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:rgba(255,68,255,.7);letter-spacing:.14em;text-transform:uppercase;margin-bottom:8px">Live Players</div>
        <div id="op_players" style="display:flex;flex-direction:column;gap:4px;max-height:160px;overflow-y:auto"></div>
        <button onclick="ownerRefreshPlayers()" style="margin-top:8px;padding:6px 14px;background:rgba(255,68,255,.06);border:1px solid rgba(255,68,255,.2);border-radius:6px;color:#ff88ff;font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">‚Ü∫ Refresh</button>
      </div>

      <!-- Give Coins -->
      <div style="border-top:1px solid rgba(255,255,255,.05);padding-top:14px">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:rgba(255,68,255,.7);letter-spacing:.14em;text-transform:uppercase;margin-bottom:8px">Give Coins</div>
        <div style="display:flex;gap:7px">
          <input id="op_coins_target" placeholder="Player ID" style="flex:1;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:7px;padding:8px 11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:12px;outline:none">
          <input id="op_coins_amount" placeholder="Amount" type="number" style="width:90px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:7px;padding:8px 11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:12px;outline:none">
          <button onclick="ownerGiveCoins()" style="padding:8px 16px;background:rgba(245,200,66,.07);border:1px solid rgba(245,200,66,.25);border-radius:7px;color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;cursor:pointer">Give üí∞</button>
        </div>
      </div>
      <!-- Kick / Kill -->
      <div style="border-top:1px solid rgba(255,255,255,.05);padding-top:14px">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:rgba(255,68,255,.7);letter-spacing:.14em;text-transform:uppercase;margin-bottom:8px">Actions</div>
        <div style="display:flex;gap:7px;flex-wrap:wrap">
          <input id="op_action_target" placeholder="Player ID" style="flex:1;min-width:130px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:7px;padding:8px 11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:12px;outline:none">
          <button onclick="ownerKick()" style="padding:8px 14px;background:rgba(232,56,79,.08);border:1px solid rgba(232,56,79,.25);border-radius:7px;color:#fca5a5;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;cursor:pointer">Kick</button>
          <button onclick="ownerKill()" style="padding:8px 14px;background:rgba(232,56,79,.12);border:1px solid rgba(232,56,79,.35);border-radius:7px;color:#fca5a5;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;cursor:pointer">Kill ‚ò†Ô∏è</button>
        </div>
      </div>
      <!-- Broadcast -->
      <div style="border-top:1px solid rgba(255,255,255,.05);padding-top:14px">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:rgba(255,68,255,.7);letter-spacing:.14em;text-transform:uppercase;margin-bottom:8px">Broadcast Message</div>
        <div style="display:flex;gap:7px">
          <input id="op_broadcast" placeholder="Message to all players‚Ä¶" style="flex:1;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:7px;padding:8px 11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:12px;outline:none">
          <button onclick="ownerBroadcast()" style="padding:8px 14px;background:rgba(155,93,229,.08);border:1px solid rgba(155,93,229,.25);border-radius:7px;color:#c4b5fd;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;cursor:pointer">Send</button>
        </div>
      </div>
      <!-- Status -->
      <div id="op_status" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--green);min-height:16px;text-align:center"></div>
    </div>
  </div>
</div>

<div id="event-notif"></div>
<div id="sys-msg"></div>

<!-- ‚ïê‚ïê DEATH ‚ïê‚ïê -->
<div class="scr hide" id="S_death">
  <div class="d-tag">// ELIMINATED</div>
  <div class="d-eliminated">Game Over</div>
  <div class="d-by">killed by <span id="d_killer">‚Äî</span></div>
  <div class="d-stats">
    <div class="d-stat"><div class="v" id="d_sc">0</div><div class="l">Score</div></div>
    <div class="d-stat"><div class="v" id="d_ln">0</div><div class="l">Length</div></div>
    <div class="d-stat"><div class="v" id="d_kl">0</div><div class="l">Kills</div></div>
    <div class="d-stat"><div class="v" id="d_tm">0s</div><div class="l">Survived</div></div>
  </div>
  <div class="d-coins-earned" id="d_ce"></div>
  <div class="d-hs" id="d_hs"></div>
  <div class="d-btns">
    <button class="d-play" id="respBtn">Play Again</button>
    <button class="d-menu" id="menuBtn">Menu</button>
  </div>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Z3N0 Snake Realm ULTRA ‚Äî Client
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ CONSTANTS (all at top to avoid TDZ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TAU = Math.PI * 2;
const CATALOG_TYPES = ['trail', 'title', 'badge'];
const TYPE_LABELS   = { trail:'Trails', title:'Titles', badge:'Badges' };
const RARITY_COLORS = { common:'#94a3b8', rare:'#00aaff', epic:'#a855f7', legendary:'#ffd700', mythic:'#ff44ff' };

// Trail configs ‚Äî drives rendering for ALL players (not just self)
const TRAIL_CONFIGS = {
  trail_fire:        {glow:'#ff4400',colors:['#ff2200','#ff6600','#ffaa00'],particles:true},
  trail_ice:         {glow:'#00ccff',colors:['#00ccff','#66eeff','#aaffff']},
  trail_gold:        {glow:'#ffd700',colors:['#ffd700','#ffaa00','#ff8800'],particles:true},
  trail_rainbow:     {glow:'rainbow',colors:null},
  trail_void:        {glow:'#6600aa',colors:['#220033','#440066','#aa00ff']},
  trail_electric:    {glow:'#00ffff',colors:['#00ffff','#0088ff','#ffffff'],flicker:true},
  trail_toxic:       {glow:'#88ff00',colors:['#44aa00','#88ff00','#ccff00']},
  trail_blood:       {glow:'#cc0000',colors:['#440000','#880000','#cc0000']},
  trail_cosmic:      {glow:'#4488ff',colors:['#001166','#0033aa','#4488ff']},
  trail_nature:      {glow:'#44ff44',colors:['#22aa22','#44ff44','#88ff88']},
  trail_ocean:       {glow:'#00aaff',colors:['#003366','#0066aa','#00aaff']},
  trail_rose:        {glow:'#ff66aa',colors:['#aa2255','#ff4488','#ff99cc']},
  trail_copper:      {glow:'#ff8822',colors:['#883300','#cc5500','#ff8822']},
  trail_plasma:      {glow:'#ff00ff',colors:['#660066','#aa00aa','#ff00ff'],flicker:true},
  trail_neon:        {glow:'#ff00aa',colors:['#660044','#cc0077','#ff00aa'],flicker:true},
  trail_lava:        {glow:'#ff2200',colors:['#660000','#cc2200','#ff6600'],particles:true},
  trail_storm:       {glow:'#aaccff',colors:['#445577','#6688bb','#aaccff'],flicker:true},
  trail_shadow:      {glow:'#8888ff',colors:['#222244','#4444aa','#8888ff']},
  trail_thunder:     {glow:'#ffff00',colors:['#888800','#cccc00','#ffff00'],flicker:true},
  trail_angel:       {glow:'#ffffff',colors:['#ccddff','#eeeeff','#ffffff']},
  trail_emerald:     {glow:'#00ff88',colors:['#006633','#00aa55','#00ff88']},
  // Owner legendary
  owner_trail_divine:     {glow:'#ffd700',colors:['#aa8800','#ffd700','#fff4aa'],owner:true},
  owner_trail_void:       {glow:'#aa00ff',colors:['#220044','#6600aa','#aa00ff'],owner:true},
  owner_trail_inferno:    {glow:'#ff2200',colors:['#660000','#ff2200','#ff8800'],particles:true,owner:true},
  owner_trail_aurora:     {glow:'#00ffcc',aurora:true,owner:true},
  owner_trail_lightning:  {glow:'#ffffff',colors:['#aaaaff','#ffffff','#aaffff'],flicker:true,owner:true},
  owner_trail_galaxy:     {glow:'#4488ff',galaxy:true,owner:true},
  owner_trail_blood:      {glow:'#ff0000',colors:['#440000','#cc0000','#ff0000'],particles:true,owner:true},
  owner_trail_antimatter: {glow:'#cc00ff',colors:['#440055','#8800cc','#cc00ff'],owner:true},
  owner_trail_matrix:     {glow:'#00ff00',matrix:true,owner:true},
  owner_trail_angelic:    {glow:'#ffffff',colors:['#ddeeff','#ffffff','#ffeedd'],owner:true},
  owner_trail_phoenix:    {glow:'#ff8800',colors:['#ff2200','#ff8800','#ffee00'],particles:true,owner:true},
  owner_trail_tsunami:    {glow:'#00ccff',colors:['#003388','#0066cc','#00ccff'],owner:true},
  owner_trail_prismatic:  {glow:'rainbow',prismatic:true,owner:true},
  owner_trail_singularity:{glow:'#880088',singularity:true,owner:true},
  // Owner mythic
  owner_trail_genesis:     {glow:'#00ffff',genesis:true,mythic:true,owner:true},
  owner_trail_void_rift:   {glow:'#4400cc',voidrift:true,mythic:true,owner:true},
  owner_trail_divine_wrath:{glow:'#ffff00',divinewrath:true,mythic:true,owner:true},
  owner_trail_cosmos:      {glow:'#ff00ff',cosmos:true,mythic:true,owner:true},
  owner_trail_sovereign:   {glow:'#ffd700',sovereign:true,mythic:true,owner:true},
  owner_trail_nebula:      {glow:'#ff44cc',nebula:true,mythic:true,owner:true},
  owner_trail_quantum:     {glow:'#44ffff',quantum:true,mythic:true,owner:true},
  owner_trail_solar_flare: {glow:'#ffcc00',solarflare:true,mythic:true,owner:true},
  owner_trail_dark_matter: {glow:'#220055',darkmatter:true,mythic:true,owner:true},
  owner_trail_omega:       {glow:'#ffffff',omega:true,mythic:true,owner:true},
  owner_trail_prism:       {glow:'#00ffff',prism:true,mythic:true,owner:true},
  owner_trail_hellfire:    {glow:'#ff1100',hellfire:true,mythic:true,owner:true},
  owner_trail_abyss_wave:  {glow:'#cc00ff',abysswave:true,mythic:true,owner:true},
  owner_trail_supernova:   {glow:'#ffaa00',supernova:true,mythic:true,owner:true},
  owner_trail_time_rift:   {glow:'#88ffff',timerift:true,mythic:true,owner:true},
  owner_trail_black_hole:  {glow:'#000000',blackhole:true,mythic:true,owner:true},
  owner_trail_dragon_flame:{glow:'#ff6600',dragonflame:true,mythic:true,owner:true},
  owner_trail_spirit:      {glow:'#aaffee',spirit:true,mythic:true,owner:true},
  owner_trail_crimson_god: {glow:'#990000',crimsongod:true,mythic:true,owner:true},
  owner_trail_astral:      {glow:'#ccaaff',astral:true,mythic:true,owner:true},
};

const SKIN_COLS = {
  classic:'#00ff88',fire:'#ff4422',ice:'#44ccff',toxic:'#aaff00',gold:'#ffd700',
  midnight:'#8855ff',sunset:'#ff8833',ocean:'#00aadd',lava:'#ff3300',electric:'#00ffff',
  rainbow:'#ff44ff',void:'#aa00ff',blood:'#cc2200',forest:'#44bb44',
};

// ‚îÄ‚îÄ CANVAS SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const gc = document.getElementById('gc');
const ctx = gc.getContext('2d');
const mmc = document.getElementById('mmc');
const mm = mmc.getContext('2d');
function resize() { gc.width = innerWidth; gc.height = innerHeight; }
resize();
window.addEventListener('resize', resize, { passive: true });

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let myId=null, myName='Player', myScore=0, myLength=0, myKills=0, myCoins=0, myStartTime=0;
let serverPlayers={}, serverOrbs={}, serverPowerUps={}, serverPortals={};
let leaderboard=[], activeEvent=null;
let alive=false, dead=false;
let camX=0, camY=0;
let mX=innerWidth/2, mY=innerHeight/2;
let boosting=false;
let parts=[], frame=0, lastTs=0, rafId=null;
let selSkin='classic', ownerPass='';
let showFPS=true, boostKey='shift', quality='high', particlesOn=true, shakeOn=true;
let moveMode='mouse'; // 'mouse' or 'wasd'
let wasdAngle=0; // current angle from WASD keys
let wasdKeys={up:false,down:false,left:false,right:false};
let shakeX=0, shakeY=0, shakeMag=0;
let profileCoins=0, sessionCoins=0;
let equippedTrail=null, equippedTitle=null, equippedBadge=null, equippedBadgeId=null;
let ownedCosmetics=[];
let cosmeticsCatalog={};
let comboCount=0, comboTm=null;
let activePowerUps={};
let killFeed=[];
let portalNotifTm=null, sysNotifTm=null, tauntTm=null;
let shopFilter='all';
let fpsArr=[], fpsLast=0;
const highScoreKey='z3n0_hs_v2';
let highScore=parseInt(localStorage.getItem(highScoreKey)||'0')||0;
let mapSz=6000;
let loggedInAccount=null;

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadAuthLocal(){try{const s=localStorage.getItem('z3n0_auth');return s?JSON.parse(s):null;}catch{return null;}}
function saveAuthLocal(d){try{localStorage.setItem('z3n0_auth',JSON.stringify(d));}catch{}}
function clearAuthLocal(){try{localStorage.removeItem('z3n0_auth');}catch{}}
function setLoggedIn(data){
  loggedInAccount=data;
  document.getElementById('auth-banner').style.display='flex';
  document.getElementById('auth-banner-name').textContent=data.displayName;
  document.getElementById('auth-banner-coins').textContent='üí∞ '+(data.profile?.coins||0);
  document.getElementById('guest-name-wrap').style.display='none';
}
function logOut(){
  loggedInAccount=null; clearAuthLocal();
  document.getElementById('auth-banner').style.display='none';
  document.getElementById('guest-name-wrap').style.display='block';
  toast('Logged out','blue');
}
function showAuthMsg(elId,msg,type){
  const el=document.getElementById(elId);
  el.textContent=msg; el.className='auth-msg '+type;
}
async function doLogin(){
  const u=document.getElementById('login-user').value.trim();
  const p=document.getElementById('login-pass').value;
  if(!u||!p){showAuthMsg('login-msg','Fill all fields.','err');return;}
  try{
    const r=await fetch('/api/account/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
    const d=await r.json();
    if(!r.ok){showAuthMsg('login-msg',d.error||'Login failed.','err');return;}
    showAuthMsg('login-msg','Logged in!','ok');
    if(document.getElementById('login-remember').checked) saveAuthLocal(d);
    setLoggedIn(d); profileCoins=d.profile?.coins||0;
    // Update ownedCosmetics from PlayFab profile
    if(d.profile?.unlockedCosmetics) ownedCosmetics=d.profile.unlockedCosmetics;
    toast('Welcome, '+d.displayName+'!','ok'); switchTab('play');
  }catch(e){showAuthMsg('login-msg','Server error.','err');}
}
async function doRegister(){
  const u=document.getElementById('reg-user').value.trim();
  const dn=document.getElementById('reg-display').value.trim();
  const p=document.getElementById('reg-pass').value;
  const p2=document.getElementById('reg-pass2').value;
  if(!u||!dn||!p||!p2){showAuthMsg('reg-msg','Fill all fields.','err');return;}
  if(p!==p2){showAuthMsg('reg-msg','Passwords do not match.','err');return;}
  try{
    const r=await fetch('/api/account/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,displayName:dn,password:p})});
    const d=await r.json();
    if(!r.ok){showAuthMsg('reg-msg',d.error||'Registration failed.','err');return;}
    showAuthMsg('reg-msg','Account created!','ok');
    saveAuthLocal(d); setLoggedIn(d); profileCoins=d.profile?.coins||0;
    if(d.profile?.unlockedCosmetics) ownedCosmetics=d.profile.unlockedCosmetics;
    toast('Welcome, '+d.displayName+'!','ok'); switchTab('play');
  }catch(e){showAuthMsg('reg-msg','Server error.','err');}
}

// ‚îÄ‚îÄ SOCKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let socket;
try{
  if(typeof io==='undefined') throw new Error('no io');
  socket=io({transports:['websocket'],upgrade:false});
}catch(e){
  console.warn('Socket.IO not available:',e.message);
  socket={on:()=>{},emit:()=>{},connected:false};
  window.addEventListener('load',()=>setTimeout(()=>toast('Open via your server URL ‚Äî not file://','red'),400));
}

socket.on('connect',()=>{toast('Connected','ok');fetchServerStats();});
socket.on('connect_error',err=>toast('Connection error: '+err.message,'red'));
socket.on('disconnect',()=>toast('Disconnected','red'));
socket.on('serverFull',({message})=>{toast(message,'red');showSysMsg(message);});

socket.on('joined',({playerId,isOwner,mapSize,orbs,powerUps,portals,killFeed:kf,profile,cosmeticsCatalog:cat,graceMs})=>{
  myId=playerId; mapSz=mapSize||5000;
  serverOrbs={}; (orbs||[]).forEach(o=>serverOrbs[o.id]=o);
  serverPowerUps={}; (powerUps||[]).forEach(p=>serverPowerUps[p.id]=p);
  serverPortals={}; (portals||[]).forEach(p=>serverPortals[p.id]=p);
  killFeed=kf||[];
  cosmeticsCatalog=cat||{};
  profileCoins=profile.coins||0; sessionCoins=0;
  ownedCosmetics=profile.unlockedCosmetics||[];
  equippedTrail=profile.equippedTrail||null;
  equippedTitle=profile.equippedTitle||null;
  equippedBadge=profile.equippedBadge||null;       // emoji for rendering
  equippedBadgeId=profile.equippedBadgeId||null;   // ID for shop isEquipped check
  if(loggedInAccount) document.getElementById('auth-banner-coins').textContent='üí∞ '+profileCoins;
  myStartTime=Date.now();
  alive=true; dead=false;
  myKills=0; myScore=0; myLength=10; myCoins=0;
  comboCount=0; activePowerUps={};
  startInputLoop();
  document.getElementById('S_menu').classList.add('hide');
  document.getElementById('S_death').classList.add('hide');
  document.getElementById('hud').style.display='block';
  document.getElementById('fps').style.display=showFPS?'block':'none';
  const mpEl=document.getElementById('music-player');
  if(mpEl) mpEl.classList.add('game-mode');
  updateHUDCoins();
  if(isOwner){
    isOwnerClient=true;
    const ob=document.getElementById('ownerPanelBtn');
    if(ob) ob.style.display='block';
  }
  if(rafId) cancelAnimationFrame(rafId);
  rafId=requestAnimationFrame(loop);
  const kfEl=document.getElementById('kf');
  kfEl.innerHTML='';
  killFeed.forEach(k=>addKF(k.victim,k.killer,k.isBot));
  renderShop();
  if(graceMs) setTimeout(()=>toast('‚öîÔ∏è Spawn protection ended!','blue'), graceMs);
  toast('üõ°Ô∏è Spawn protection: '+Math.ceil((graceMs||3000)/1000)+'s','ok');
});

socket.on('gameState',({players,leaderboard:lb,activeEvent:ae,powerUps:pus,portals:pts,myCoins:mc})=>{
  serverPlayers=players||{};
  leaderboard=lb||[];
  activeEvent=ae;
  if(pus){serverPowerUps={};pus.forEach(p=>serverPowerUps[p.id]=p);}
  if(pts){serverPortals={};pts.forEach(p=>serverPortals[p.id]=p);}
  if(mc!==undefined){sessionCoins=mc;updateHUDCoins();}
  const me=serverPlayers[myId];
  if(me){
    myScore=me.score||0;
    myLength=me.segments?me.segments.length:myLength;
    activePowerUps=me.activePowerUps||{};
    // Camera and HUD updates are handled in the render loop (loop()) for smooth 60fps motion
  }
});

socket.on('orbEaten',({oid,newOrb,eaterId,golden,mega})=>{
  delete serverOrbs[oid];
  if(newOrb) serverOrbs[newOrb.id]=newOrb;
  if(eaterId===myId){
    sfxEat();
    if(mega){sfxPU();doShake(4);doFlash('rgba(255,0,255,.15)');showSP('üíé MEGA ORB!','#ff00ff',gc.width/2,gc.height*.4);}
    else if(golden){showSP('‚≠ê x8','#ffdd00',gc.width/2+(Math.random()-.5)*80,gc.height*.42);}
    comboCount++;
    clearTimeout(comboTm);
    comboTm=setTimeout(()=>{comboCount=0;document.getElementById('combo').classList.remove('on');},2000);
    if(comboCount>=5){
      document.getElementById('combo').textContent='x'+comboCount+' COMBO!';
      document.getElementById('combo').classList.add('on');
    }
  }
});
socket.on('killConfirmed',({victimName,coinsGained,streak,victimLength})=>{
  myKills++; sfxKill();
  doFlash('rgba(255,34,51,.22)'); doShake(7);
  showSP('üíÄ '+(coinsGained||10)+' coins','#ffcc00',gc.width/2+(Math.random()-.5)*120,gc.height*.32);
  if(victimLength>40) showSP('+'+Math.floor(victimLength*0.35)+' pts','#00ff88',gc.width/2+(Math.random()-.5)*120,gc.height*.4);
  if(streak>=5) showStreakBanner('üî• x'+streak+' KILLING SPREE!');
  else if(streak>=3) showStreakBanner('‚ö° x'+streak+' STREAK!');
  else if(streak===2) showStreakBanner('üí• DOUBLE KILL!');
});
socket.on('killFeedUpdate',entry=>{
  killFeed.unshift(entry); killFeed=killFeed.slice(0,8);
  addKF(entry.victim,entry.killer,entry.isBot,entry.killerId===myId);
});
socket.on('playerDied',({id,killerName,droppedOrbs,position,length})=>{
  (droppedOrbs||[]).forEach(o=>{if(o&&o.id)serverOrbs[o.id]=o;});
  if(particlesOn&&position){
    const n=Math.min(30,10+Math.floor((length||10)/5));
    spawnFX(position.x,position.y,'#ef4444',n);
    spawnFX(position.x,position.y,'#ffaa33',Math.floor(n/2));
  }
});
socket.on('playerLeft',id=>{delete serverPlayers[id];});
socket.on('playerJoined',({name,isOwner})=>{if(name!==myName)toast((isOwner?'üëë ':'')+esc(name)+' joined','blue');});
socket.on('youDied',({killerName,coinsEarned,score,length,kills})=>{
  alive=false; dead=true;
  stopInputLoop();
  sfxDie(); doFlash('rgba(255,34,51,.55)'); doShake(18);
  const survived=Math.round((Date.now()-myStartTime)/1000);
  document.getElementById('d_killer').textContent=esc(killerName);
  document.getElementById('d_sc').textContent=score||myScore;
  document.getElementById('d_ln').textContent=length||myLength;
  document.getElementById('d_kl').textContent=kills||myKills;
  document.getElementById('d_tm').textContent=survived+'s';
  document.getElementById('d_ce').textContent=coinsEarned?'üí∞ +'+coinsEarned+' coins earned':'';
  const hs=score||myScore;
  if(hs>highScore){
    highScore=hs;
    localStorage.setItem(highScoreKey,highScore);
    document.getElementById('d_hs').textContent='üèÜ NEW PERSONAL BEST: '+highScore;
    document.getElementById('d_hs').style.color='var(--gold)';
  }else if(highScore>0){
    document.getElementById('d_hs').textContent='Personal best: '+highScore;
    document.getElementById('d_hs').style.color='';
  }else{document.getElementById('d_hs').textContent='';}
  setTimeout(()=>{
    document.getElementById('hud').style.display='none';
    document.getElementById('S_death').classList.remove('hide');
    if(rafId){cancelAnimationFrame(rafId);rafId=null;}
    const mpEl=document.getElementById('music-player');
    if(mpEl) mpEl.classList.remove('game-mode');
  },700);
});
socket.on('powerUpSpawned',pu=>{if(pu&&pu.id)serverPowerUps[pu.id]=pu;});
socket.on('powerUpCollected',({puId,playerId,type})=>{
  delete serverPowerUps[puId];
  if(playerId===myId){sfxPU();toast(getPUEmoji(type)+' '+type.toUpperCase()+'!','gold');}
});
socket.on('powerUpActivated',({type,duration,emoji})=>{
  const col=getPUColor(type);
  toast(emoji+' '+type.toUpperCase()+' activated!','purple');
  activePowerUps[type]={start:Date.now(),end:Date.now()+duration};
  updatePowerUpHUD();
  if(type==='bomb'){doFlash('rgba(255,68,0,.3)');doShake(12);}
  if(type==='rage'){doFlash('rgba(255,0,85,.28)');doShake(8);sfxRage();}
  if(type==='freeze'){doFlash('rgba(6,182,212,.2)');}
  if(type==='shrink'){doFlash('rgba(255,136,204,.2)');sfxShrink();}
});
socket.on('shieldPopped',()=>{doFlash('rgba(0,170,255,.35)');toast('Shield absorbed the hit!','blue');});
socket.on('bombExploded',({x,y,killed})=>{
  if(particlesOn) spawnFX(x,y,'#ff4400',30);
  doShake(12); doFlash('rgba(255,68,0,.25)');
  if(killed>0) toast('BOMB: '+killed+' snakes destroyed!','red');
});
socket.on('freezeActivated',({playerId})=>{if(playerId!==myId)toast('‚ùÑÔ∏è Frozen!','blue');});
socket.on('portalsSpawned',ports=>{if(ports)ports.forEach(p=>{if(p&&p.id)serverPortals[p.id]=p;});toast('üåÄ Portals spawned!','purple');});
socket.on('portalsRemoved',ids=>{if(ids)ids.forEach(id=>delete serverPortals[id]);});
socket.on('portalUsed',({playerId})=>{if(playerId===myId){sfxPortal();showPortalNotif('Teleported!');doFlash('rgba(168,85,247,.3)');}});
socket.on('teleported',()=>{sfxPortal();showPortalNotif('Teleported via portal!');});
socket.on('liveEvent',ev=>{activeEvent=ev;showEventNotif(ev.name);toast('üéâ '+ev.name+' started!','purple');doFlash('rgba(155,93,229,.2)');});
socket.on('eventEnded',()=>{activeEvent=null;hideEventNotif();toast('Event ended','blue');});
socket.on('ownerBroadcast',({message})=>{showSysMsg('Z3N0: '+message);toast('Z3N0: '+message,'gold');});
socket.on('systemMessage',msg=>{showSysMsg(msg);toast(msg,'blue');});
socket.on('skinGranted',({skin})=>{selSkin=skin;toast('Skin granted: '+skin,'gold');});
socket.on('coinsGranted',({amount,newBalance})=>{
  profileCoins=newBalance; updateHUDCoins();
  if(loggedInAccount) document.getElementById('auth-banner-coins').textContent='üí∞ '+newBalance;
  toast('+'+amount+' coins granted!','gold');
});
socket.on('cosmeticBought',({cosmeticId,newCoinBalance,unlockedCosmetics})=>{
  ownedCosmetics=unlockedCosmetics; profileCoins=newCoinBalance;
  updateHUDCoins(); renderShop();
  const c=cosmeticsCatalog[cosmeticId];
  if(c) toast('Got '+c.emoji+' '+(c.name||cosmeticId)+'!','gold');
});
socket.on('cosmeticEquipped',({equippedTrail:et,equippedTitle:ett,equippedBadge:eb,equippedBadgeId:ebid})=>{
  if(et!==undefined) equippedTrail=et;
  if(ett!==undefined) equippedTitle=ett;
  if(eb!==undefined) equippedBadge=eb;         // emoji for rendering
  if(ebid!==undefined) equippedBadgeId=ebid;   // ID for shop logic
  renderShop();
});
socket.on('cosmeticError',msg=>toast(msg,'red'));
socket.on('killStreakBonus',({streak,bonusCoins})=>{toast('üî• x'+streak+' streak! +'+bonusCoins+' bonus coins','gold');});
socket.on('botTaunt',({name,message})=>showTaunt(name+': '+message));
socket.on('kicked',({reason})=>{toast('Kicked: '+reason,'red');showSysMsg('You were kicked: '+reason);});
socket.on('orbFrenzy',allOrbs=>{serverOrbs={};if(allOrbs)allOrbs.forEach(o=>{if(o&&o.id)serverOrbs[o.id]=o;});});

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const cur=document.getElementById('cur');
document.addEventListener('mousemove',e=>{
  cur.style.left=e.clientX+'px'; cur.style.top=e.clientY+'px';
  mX=e.clientX; mY=e.clientY;
},{passive:true});
document.addEventListener('mousedown',e=>{if(e.button===0){initAudio();boosting=true;cur.classList.add('b');}});
document.addEventListener('mouseup',e=>{if(e.button===0){boosting=false;cur.classList.remove('b');}});

// WASD / keyboard input
const WASD_IGNORE = ['INPUT','TEXTAREA','BUTTON'];
document.addEventListener('keydown',e=>{
  if(WASD_IGNORE.includes(e.target.tagName)) return;
  // Boost keys always work
  if((boostKey==='shift'&&e.key==='Shift')||(boostKey==='space'&&e.code==='Space')){
    e.preventDefault(); initAudio(); boosting=true; cur.classList.add('b'); return;
  }
  if(moveMode==='wasd'){
    if(e.code==='KeyW'||e.code==='ArrowUp')    {wasdKeys.up=true;   e.preventDefault();}
    if(e.code==='KeyS'||e.code==='ArrowDown')  {wasdKeys.down=true; e.preventDefault();}
    if(e.code==='KeyA'||e.code==='ArrowLeft')  {wasdKeys.left=true; e.preventDefault();}
    if(e.code==='KeyD'||e.code==='ArrowRight') {wasdKeys.right=true;e.preventDefault();}
  }
},{passive:false});
document.addEventListener('keyup',e=>{
  if((boostKey==='shift'&&e.key==='Shift')||(boostKey==='space'&&e.code==='Space')){
    boosting=false; cur.classList.remove('b');
  }
  if(moveMode==='wasd'){
    if(e.code==='KeyW'||e.code==='ArrowUp')    wasdKeys.up=false;
    if(e.code==='KeyS'||e.code==='ArrowDown')  wasdKeys.down=false;
    if(e.code==='KeyA'||e.code==='ArrowLeft')  wasdKeys.left=false;
    if(e.code==='KeyD'||e.code==='ArrowRight') wasdKeys.right=false;
  }
});

function getWASDAngle(){
  const dx=(wasdKeys.right?1:0)-(wasdKeys.left?1:0);
  const dy=(wasdKeys.down?1:0)-(wasdKeys.up?1:0);
  if(dx===0&&dy===0) return null; // no key pressed ‚Äî keep current angle
  return Math.atan2(dy,dx);
}

// Touch input
let touchId=null, touchBoostId=null;
document.addEventListener('touchstart',e=>{
  initAudio();
  for(const t of e.changedTouches){
    if(touchId===null){touchId=t.identifier;mX=t.clientX;mY=t.clientY;}
    else if(touchBoostId===null){touchBoostId=t.identifier;boosting=true;}
  }
},{passive:true});
document.addEventListener('touchmove',e=>{
  for(const t of e.changedTouches) if(t.identifier===touchId){mX=t.clientX;mY=t.clientY;}
},{passive:true});
document.addEventListener('touchend',e=>{
  for(const t of e.changedTouches){
    if(t.identifier===touchId) touchId=null;
    if(t.identifier===touchBoostId){touchBoostId=null;boosting=false;}
  }
},{passive:true});

let _lastSentAngle = null, _lastSentBoosting = false;
function sendInput(){
  if(!alive||!myId) return;
  const me=serverPlayers[myId];
  let angle=0;
  if(moveMode==='wasd'){
    const wa=getWASDAngle();
    if(wa!==null) wasdAngle=wa;
    angle=wasdAngle;
  } else {
    if(me&&me.segments&&me.segments.length){
      const h=me.segments[0];
      angle=Math.atan2(mY+camY-h.y,mX+camX-h.x);
    } else {
      angle=Math.atan2(mY-gc.height/2,mX-gc.width/2);
    }
  }
  // Only send if angle changed meaningfully or boost state changed
  if(_lastSentAngle!==null && Math.abs(angle-_lastSentAngle)<0.015 && boosting===_lastSentBoosting) return;
  _lastSentAngle=angle; _lastSentBoosting=boosting;
  socket.emit('input',{angle,boosting});
}
let _inputInterval=null;
function startInputLoop(){
  if(_inputInterval) clearInterval(_inputInterval);
  _inputInterval=setInterval(sendInput,33);
}
function stopInputLoop(){
  if(_inputInterval){clearInterval(_inputInterval);_inputInterval=null;}
}
startInputLoop();

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnFX(wx,wy,col,n){
  if(!particlesOn) return;
  // Cap total particles to prevent lag
  if(parts.length>300) return;
  for(let i=0;i<n;i++){
    const a=Math.random()*TAU,sp=60+Math.random()*220;
    parts.push({x:wx,y:wy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,col,r:2+Math.random()*3.5});
  }
}
function updateParts(dt){
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];
    p.x+=p.vx*dt; p.y+=p.vy*dt;
    p.vx*=1-3*dt; p.vy*=1-3*dt;
    p.life-=1.8*dt;
    if(p.life<=0) parts.splice(i,1);
  }
}

// ‚îÄ‚îÄ SCREEN SHAKE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doShake(mag){if(!shakeOn)return;shakeMag=Math.max(shakeMag,mag);}
function updateShake(dt){
  if(shakeMag<0.1){shakeX=0;shakeY=0;return;}
  shakeX=(Math.random()-.5)*shakeMag;
  shakeY=(Math.random()-.5)*shakeMag;
  shakeMag*=Math.pow(0.06,dt);
  if(shakeMag<0.1)shakeMag=0;
}

// ‚îÄ‚îÄ BACKGROUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STARS=[];
for(let i=0;i<120;i++) STARS.push({x:Math.random()*14000-2000,y:Math.random()*14000-2000,r:.2+Math.random()*1.1,b:Math.random()});

function drawBG(t){
  ctx.fillStyle='#060610'; ctx.fillRect(0,0,gc.width,gc.height);
  if(quality==='high'){
    const mx=mapSz/2-camX,my2=mapSz/2-camY;
    const g=ctx.createRadialGradient(mx,my2,0,mx,my2,mapSz*.6);
    g.addColorStop(0,'rgba(0,60,30,.08)'); g.addColorStop(.4,'rgba(0,15,50,.05)'); g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g; ctx.fillRect(0,0,gc.width,gc.height);
  }
  ctx.fillStyle='rgba(200,220,255,.4)'; ctx.beginPath();
  for(const s of STARS){
    const px=((s.x-camX*.08)%gc.width+gc.width)%gc.width;
    const py=((s.y-camY*.08)%gc.height+gc.height)%gc.height;
    const tw=s.r*(.5+Math.sin(t*.8+s.b*8)*.5);
    ctx.moveTo(px+tw,py); ctx.arc(px,py,Math.max(0.1,tw),0,TAU);
  }
  ctx.fill();
}

function drawGrid(){
  const gs=88;
  const ox=((-camX%gs)+gs)%gs|0, oy=((-camY%gs)+gs)%gs|0;
  if(quality==='high'){
    ctx.strokeStyle='rgba(0,255,136,.007)'; ctx.lineWidth=1; ctx.beginPath();
    for(let x=ox;x<gc.width;x+=gs){ctx.moveTo(x,0);ctx.lineTo(x,gc.height);}
    for(let y=oy;y<gc.height;y+=gs){ctx.moveTo(0,y);ctx.lineTo(gc.width,y);}
    ctx.stroke();
  }
  // Only draw dots in high quality
  if(quality==='high'){
    ctx.fillStyle='rgba(0,255,136,.022)'; ctx.beginPath();
    for(let x=ox;x<gc.width;x+=gs) for(let y=oy;y<gc.height;y+=gs){ctx.moveTo(x+1,y);ctx.arc(x,y,1,0,TAU);}
    ctx.fill();
  }
}

function drawBorder(){
  const bx=-camX,by=-camY;
  const pulse=.28+Math.abs(Math.sin(frame*.04))*.32;
  ctx.save(); ctx.setLineDash([20,10]);
  ctx.strokeStyle=`rgba(255,34,51,${pulse})`; ctx.lineWidth=2.5;
  ctx.strokeRect(bx,by,mapSz,mapSz); ctx.setLineDash([]);
  ctx.strokeStyle=`rgba(255,34,51,${pulse*.25})`; ctx.lineWidth=20;
  ctx.strokeRect(bx,by,mapSz,mapSz); ctx.restore();
}

function drawOrbs(t){
  const W=gc.width,H=gc.height,hl=quality==='high';
  for(const oid in serverOrbs){
    const o=serverOrbs[oid]; if(!o) continue;
    const sx=o.x-camX,sy=o.y-camY;
    if(sx<-50||sx>W+50||sy<-50||sy>H+50) continue;
    o._ph=(o._ph||Math.random()*TAU)+(o.mega?.12:o.golden?.08:.05);
    const r=o.size*(.84+Math.sin(o._ph)*.16);
    if(o.mega){
      // Mega orb ‚Äî big pulsing purple
      if(hl){
        ctx.shadowColor='#ff00ff'; ctx.shadowBlur=35+Math.sin(o._ph)*10;
        ctx.fillStyle='rgba(255,0,255,.18)'; ctx.globalAlpha=1;
        ctx.beginPath(); ctx.arc(sx,sy,r*4.5,0,TAU); ctx.fill();
        ctx.shadowBlur=0;
      }
      ctx.globalAlpha=.4+Math.sin(o._ph)*.2; ctx.fillStyle='rgba(255,100,255,.35)';
      ctx.beginPath(); ctx.arc(sx,sy,r*3,0,TAU); ctx.fill();
      // Rotating ring
      ctx.globalAlpha=.7; ctx.strokeStyle='rgba(255,0,255,.8)'; ctx.lineWidth=2;
      ctx.setLineDash([6,4]); ctx.lineDashOffset=frame*2;
      ctx.beginPath(); ctx.arc(sx,sy,r*2.5,0,TAU); ctx.stroke(); ctx.setLineDash([]);
      ctx.globalAlpha=1; ctx.fillStyle='#ff00ff';
      if(hl){ctx.shadowColor='#ff00ff';ctx.shadowBlur=20;}
      ctx.beginPath(); ctx.arc(sx,sy,Math.max(.5,r),0,TAU); ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.7)'; ctx.beginPath(); ctx.arc(sx-r*.28,sy-r*.3,Math.max(.2,r*.35),0,TAU); ctx.fill();
      ctx.shadowBlur=0;
      // MEGA label
      if(hl){ctx.font='bold 8px "JetBrains Mono",monospace';ctx.textAlign='center';ctx.fillStyle='rgba(255,200,255,.9)';ctx.fillText('MEGA',sx,sy+r+10);}
    } else {
      if(hl){
        ctx.shadowColor=o.color; ctx.shadowBlur=o.golden?22:10;
        ctx.fillStyle=o.color; ctx.globalAlpha=o.golden?.28:.14;
        ctx.beginPath(); ctx.arc(sx,sy,r*(o.golden?3.5:2.8),0,TAU); ctx.fill();
        ctx.shadowBlur=0;
      }
      ctx.globalAlpha=1; ctx.fillStyle=o.color; ctx.beginPath(); ctx.arc(sx,sy,Math.max(.5,r),0,TAU); ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.55)'; ctx.beginPath(); ctx.arc(sx-r*.28,sy-r*.3,Math.max(.2,r*.28),0,TAU); ctx.fill();
    }
  }
  ctx.globalAlpha=1; ctx.shadowBlur=0; ctx.textAlign='left';
}

function drawPowerUps(){
  const W=gc.width,H=gc.height;
  for(const pid in serverPowerUps){
    const pu=serverPowerUps[pid]; if(!pu) continue;
    const sx=pu.x-camX,sy=pu.y-camY;
    if(sx<-60||sx>W+60||sy<-60||sy>H+60) continue;
    pu._ph=(pu._ph||0)+.06;
    const bob=Math.sin(pu._ph)*5,pulse=.5+Math.sin(pu._ph*1.3)*.5;
    const col=getPUColor(pu.type);
    if(quality==='high'){ctx.shadowColor=col;ctx.shadowBlur=18+pulse*10;}
    ctx.globalAlpha=.15+pulse*.08; ctx.fillStyle=col;
    ctx.beginPath(); ctx.arc(sx,sy+bob,18,0,TAU); ctx.fill();
    ctx.globalAlpha=.25+pulse*.2; ctx.strokeStyle=col; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(sx,sy+bob,22,0,TAU); ctx.stroke();
    ctx.globalAlpha=1; ctx.font='22px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(getPUEmoji(pu.type),sx,sy+bob);
    ctx.shadowBlur=0; ctx.textBaseline='alphabetic';
  }
  ctx.globalAlpha=1; ctx.shadowBlur=0;
}

function drawPortals(){
  const W=gc.width,H=gc.height,hl=quality==='high';
  for(const pid in serverPortals){
    const p=serverPortals[pid]; if(!p) continue;
    const sx=p.x-camX,sy=p.y-camY;
    if(sx<-80||sx>W+80||sy<-80||sy>H+80) continue;
    p._ph=(p._ph||0)+.04;
    const pulse=.5+Math.sin(p._ph)*.5,r=30+Math.sin(p._ph*.7)*4;
    if(hl){ctx.shadowColor='#a855f7';ctx.shadowBlur=25+pulse*15;}
    const g=ctx.createRadialGradient(sx,sy,0,sx,sy,r*2);
    g.addColorStop(0,'rgba(168,85,247,.18)'); g.addColorStop(1,'rgba(168,85,247,0)');
    ctx.fillStyle=g; ctx.globalAlpha=.5+pulse*.3;
    ctx.beginPath(); ctx.arc(sx,sy,r*2,0,TAU); ctx.fill();
    ctx.globalAlpha=.7+pulse*.2; ctx.strokeStyle='#a855f7'; ctx.lineWidth=3;
    ctx.setLineDash([12,6]);
    ctx.beginPath(); ctx.arc(sx,sy,r,p._ph*2,p._ph*2+TAU*.7); ctx.stroke();
    ctx.setLineDash([]);
    ctx.strokeStyle='rgba(200,140,255,.5)'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.arc(sx,sy,r-8,-p._ph*2,-p._ph*2+TAU*.6); ctx.stroke();
    ctx.globalAlpha=1; ctx.shadowBlur=0;
    ctx.font='bold 10px "JetBrains Mono",monospace'; ctx.textAlign='center'; ctx.fillStyle='rgba(200,140,255,.7)';
    ctx.fillText('PORTAL',sx,sy+r+16);
  }
  ctx.globalAlpha=1; ctx.shadowBlur=0; ctx.textAlign='left';
}

// ‚îÄ‚îÄ SNAKE RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getSnakeColor(player){
  if(!player) return '#00ff88';
  return SKIN_COLS[player.skin]||SKIN_COLS[player.grantedSkin]||'#00ff88';
}
function getTrailCfg(player,isMe){
  const tid=isMe?equippedTrail:player.equippedTrail;
  if(!tid) return null;
  return TRAIL_CONFIGS[tid]||null;
}
function getMythicColor(cfg,f,i){
  if(cfg.genesis)     return `hsl(${(f*1.5+i*3)%360},100%,70%)`;
  if(cfg.voidrift)    return `hsl(${270+Math.sin(f*.04+i*.1)*30},90%,${30+Math.sin(f*.03)*15}%)`;
  if(cfg.divinewrath) return `hsl(${55+Math.sin(f*.05)*20},100%,${60+Math.sin(f*.07+i*.05)*20}%)`;
  if(cfg.cosmos)      return `hsl(${(f*2+i*5)%360},80%,65%)`;
  if(cfg.sovereign)   return `hsl(${45+Math.sin(f*.04)*15},100%,${50+Math.sin(f*.06)*20}%)`;
  if(cfg.nebula)      return `hsl(${300+Math.sin(f*.03+i*.08)*60},90%,60%)`;
  if(cfg.quantum)     return `hsl(${180+Math.sin(f*.05)*40},100%,${55+Math.sin(f*.08)*20}%)`;
  if(cfg.solarflare)  return `hsl(${40+Math.random()*20},100%,${55+Math.random()*20}%)`;
  if(cfg.darkmatter)  return `hsl(${270+Math.sin(f*.02)*20},${60+Math.sin(f*.04)*30}%,${15+Math.sin(f*.03)*10}%)`;
  if(cfg.omega)       return `hsl(${(f*3+i*2)%360},10%,${80+Math.sin(f*.05)*15}%)`;
  if(cfg.prism)       return `hsl(${(f*2+i*6)%360},100%,65%)`;
  if(cfg.hellfire)    return `hsl(${Math.random()*30},100%,${40+Math.random()*30}%)`;
  if(cfg.abysswave)   return `hsl(${280+Math.sin(f*.04)*40},100%,${40+Math.sin(f*.06)*20}%)`;
  if(cfg.supernova)   return `hsl(${30+Math.sin(f*.05)*30},100%,${55+Math.sin(f*.07)*20}%)`;
  if(cfg.timerift)    return `hsl(${185+Math.sin(f*.03+i*.1)*30},${60+Math.sin(f*.05)*30}%,60%)`;
  if(cfg.blackhole)   return `hsl(${270+Math.sin(f*.02)*30},${40+Math.sin(f*.04)*20}%,${5+Math.sin(f*.03)*8}%)`;
  if(cfg.dragonflame) return `hsl(${15+Math.random()*25},100%,${40+Math.random()*25}%)`;
  if(cfg.spirit)      return `hsl(${165+Math.sin(f*.04)*25},${40+Math.sin(f*.06)*30}%,${70+Math.sin(f*.05)*15}%)`;
  if(cfg.crimsongod)  return `hsl(${Math.random()*15},100%,${25+Math.random()*20}%)`;
  if(cfg.astral)      return `hsl(${260+Math.sin(f*.03+i*.06)*40},${50+Math.sin(f*.05)*30}%,${60+Math.sin(f*.04)*20}%)`;
  if(cfg.aurora)      return `hsl(${150+Math.sin(f*.02+i*.04)*60},80%,60%)`;
  if(cfg.galaxy)      return `hsl(${220+Math.sin(f*.025+i*.05)*40},70%,${40+Math.sin(f*.04)*20}%)`;
  if(cfg.matrix)      return `hsl(120,${60+Math.sin(f*.06)*30}%,${30+Math.sin(f*.05+i*.03)*25}%)`;
  if(cfg.singularity) return `hsl(${280+Math.sin(f*.03)*40},${70+Math.sin(f*.05)*20}%,${20+Math.sin(f*.04)*15}%)`;
  if(cfg.prismatic)   return `hsl(${(f*2.5+i*4)%360},100%,62%)`;
  return cfg.glow||'#fff';
}

function drawSnake(player,isMe){
  const pts=player.segments;
  if(!pts||pts.length<2) return;
  const W=gc.width,H=gc.height,hl=quality==='high';
  // Early cull: skip if head is far off screen
  const hx0=pts[0].x-camX, hy0=pts[0].y-camY;
  if(hx0<-200||hx0>W+200||hy0<-200||hy0>H+200) return;
  const len=pts.length;
  const isGhost=player.ghostUntil&&Date.now()<player.ghostUntil;
  const hasStar=player.activePowerUps&&player.activePowerUps.star&&Date.now()<(player.activePowerUps.star.end||player.activePowerUps.star.until||0);
  const hasShield=player.shieldActive;
  const isRaging=player.raging||!!(player.activePowerUps?.rage&&Date.now()<(player.activePowerUps.rage?.until||0));
  const inGrace=player.inGrace;
  const trailCfg=getTrailCfg(player,isMe);
  const baseCol=getSnakeColor(player);
  const isRainbow=trailCfg&&(trailCfg.glow==='rainbow'||trailCfg.prismatic);
  const isMythic=trailCfg&&trailCfg.mythic;
  const hasSpecial=trailCfg&&(trailCfg.aurora||trailCfg.galaxy||trailCfg.matrix||trailCfg.singularity||isMythic);

  if(isRaging&&hl){ctx.shadowColor='#ff0055';ctx.shadowBlur=32+Math.sin(frame*.15)*10;}
  if(isGhost) ctx.globalAlpha=.4;
  if(hasStar&&hl){ctx.shadowColor='#fbbf24';ctx.shadowBlur=22;}
  ctx.lineCap='round'; ctx.lineJoin='round';

  for(let i=len-1;i>=1;i--){
    const a=pts[i],b=pts[i-1]; if(!a||!b) continue;
    const ax=a.x-camX,ay=a.y-camY,bx=b.x-camX,by=b.y-camY;
    if((ax<-60&&bx<-60)||(ax>W+60&&bx>W+60)||(ay<-60&&by<-60)||(ay>H+60&&by>H+60)) continue;
    const tv=1-i/len;
    const w=Math.max(2.5,(player.width||8)*(0.3+tv*0.7));
    let segCol=baseCol;
    if(isRaging) segCol=`hsl(${(frame*4+i*2)%30},100%,${50+Math.sin(frame*.1+i*.05)*15}%)`;
    else if(isRainbow) segCol=`hsl(${(frame*2+i*4)%360},70%,58%)`;
    else if(hasSpecial) segCol=getMythicColor(trailCfg,frame,i);
    else if(trailCfg&&trailCfg.colors) segCol=trailCfg.colors[i%trailCfg.colors.length];
    else if(hasStar) segCol=`hsl(${(frame*3+i*2)%60+40},90%,65%)`;
    if(isMythic&&hl&&i%3===0){ctx.shadowColor=trailCfg.glow||segCol;ctx.shadowBlur=18+Math.sin(frame*.08)*8;}
    ctx.strokeStyle=segCol; ctx.globalAlpha=(isGhost?.18:.34)+tv*.66; ctx.lineWidth=w;
    ctx.beginPath(); ctx.moveTo(bx,by); ctx.lineTo(ax,ay); ctx.stroke();
    if(isMythic&&hl) ctx.shadowBlur=0;
  }
  ctx.shadowBlur=0; ctx.globalAlpha=1;

  // Trail outer glow
  if(trailCfg&&hl&&!isGhost){
    const gc2=isRainbow?`hsl(${frame*3%360},70%,58%)`:(isMythic?getMythicColor(trailCfg,frame,0):(trailCfg.glow||'#fff'));
    const blur=isMythic?22+Math.sin(frame*.08)*10:14;
    ctx.shadowColor=gc2; ctx.shadowBlur=blur;
    for(let i=Math.min(len-1,40);i>=2;i-=2){
      const a=pts[i],b=pts[i-1]; if(!a||!b) continue;
      const tv=1-i/len; if(tv<.1) continue;
      ctx.strokeStyle=gc2; ctx.globalAlpha=tv*(isMythic?.28:.18);
      ctx.lineWidth=(player.width||8)*(.3+tv*.5);
      ctx.beginPath(); ctx.moveTo(b.x-camX,b.y-camY); ctx.lineTo(a.x-camX,a.y-camY); ctx.stroke();
    }
    ctx.shadowBlur=0; ctx.globalAlpha=1;
  }

  // Head
  const h=pts[0]; const hx=h.x-camX,hy=h.y-camY;
  let hcol=isRaging?`hsl(${(frame*5)%30},100%,55%)`:isRainbow?`hsl(${frame*2%360},70%,58%)`:hasStar?`hsl(${(frame*3)%60+40},90%,65%)`:(isMythic?getMythicColor(trailCfg,frame,0):baseCol);
  if(isGhost) ctx.globalAlpha=.5;
  if(hl){ctx.shadowColor=hcol;ctx.shadowBlur=20;}
  ctx.fillStyle=hcol; ctx.beginPath(); ctx.arc(hx,hy,player.width||8,0,TAU); ctx.fill();
  ctx.shadowBlur=0;

  if(hasShield){
    ctx.strokeStyle='rgba(0,170,255,.7)'; ctx.lineWidth=2.5; ctx.globalAlpha=.5+Math.sin(frame*.12)*.3;
    ctx.beginPath(); ctx.arc(hx,hy,(player.width||8)+7,0,TAU); ctx.stroke(); ctx.globalAlpha=1;
  }
  if(isRaging){
    // Pulsing red fire aura
    ctx.strokeStyle=`rgba(255,0,85,${0.5+Math.sin(frame*.2)*.3})`; ctx.lineWidth=3; ctx.globalAlpha=0.7;
    if(hl){ctx.shadowColor='#ff0055';ctx.shadowBlur=15;}
    ctx.beginPath(); ctx.arc(hx,hy,(player.width||8)+10+Math.sin(frame*.15)*3,0,TAU); ctx.stroke();
    ctx.globalAlpha=0.3; ctx.strokeStyle='rgba(255,100,0,.6)'; ctx.lineWidth=6;
    ctx.beginPath(); ctx.arc(hx,hy,(player.width||8)+16,0,TAU); ctx.stroke();
    ctx.shadowBlur=0; ctx.globalAlpha=1;
  }
  if(inGrace){
    // Spawning grace ring ‚Äî shows they're protected
    const pct=(frame%60)/60;
    ctx.strokeStyle='rgba(0,255,136,.6)'; ctx.lineWidth=2; ctx.globalAlpha=0.6+Math.sin(frame*.18)*.3;
    ctx.setLineDash([8,6]); ctx.lineDashOffset=-frame;
    ctx.beginPath(); ctx.arc(hx,hy,(player.width||8)+14,0,TAU); ctx.stroke();
    ctx.setLineDash([]); ctx.globalAlpha=1;
  }
  if(isGhost){
    ctx.strokeStyle='rgba(148,163,184,.5)'; ctx.lineWidth=2; ctx.globalAlpha=.4+Math.sin(frame*.1)*.2;
    ctx.beginPath(); ctx.arc(hx,hy,(player.width||8)+5,0,TAU); ctx.stroke(); ctx.globalAlpha=1;
  }
  if(hasStar&&hl){
    ctx.strokeStyle='rgba(251,191,36,.6)'; ctx.lineWidth=3; ctx.globalAlpha=.5+Math.sin(frame*.15)*.3;
    ctx.beginPath(); ctx.arc(hx,hy,(player.width||8)+9,0,TAU); ctx.stroke(); ctx.globalAlpha=1;
  }

  // Head shine
  ctx.fillStyle='rgba(255,255,255,.18)'; ctx.globalAlpha=1;
  ctx.beginPath(); ctx.arc(hx-(player.width||8)*.27,hy-(player.width||8)*.28,(player.width||8)*.48,0,TAU); ctx.fill();

  // Eyes
  const ang=player.angle||0;
  const epx=Math.sin(ang),epy=-Math.cos(ang);
  const hw=player.width||8;
  const ef=hw*.45,es=hw*.43,er=hw*.27;
  for(const side of[-1,1]){
    const ex=hx+Math.cos(ang)*ef+epx*es*side;
    const ey=hy+Math.sin(ang)*ef+epy*es*side;
    ctx.fillStyle='#fff'; ctx.globalAlpha=1; ctx.beginPath(); ctx.arc(ex,ey,er,0,TAU); ctx.fill();
    ctx.fillStyle=isMe?'#001a10':'#0d0d0d';
    ctx.beginPath(); ctx.arc(ex+Math.cos(ang)*er*.3,ey+Math.sin(ang)*er*.3,er*.58,0,TAU); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.8)'; ctx.beginPath(); ctx.arc(ex+Math.cos(ang)*er*.12,ey+Math.sin(ang)*er*.12,er*.2,0,TAU); ctx.fill();
  }

  // Tongue
  const tOf=frame%28;
  if(tOf<14){
    const tx=hx+Math.cos(ang)*(hw+7),ty=hy+Math.sin(ang)*(hw+7);
    ctx.strokeStyle='#f43f5e'; ctx.lineWidth=1.5; ctx.lineCap='round'; ctx.globalAlpha=1;
    ctx.beginPath(); ctx.moveTo(hx+Math.cos(ang)*hw,hy+Math.sin(ang)*hw); ctx.lineTo(tx,ty); ctx.stroke();
    const fl=5+tOf*.28;
    ctx.beginPath();
    ctx.moveTo(tx,ty); ctx.lineTo(tx+Math.cos(ang+.42)*fl,ty+Math.sin(ang+.42)*fl);
    ctx.moveTo(tx,ty); ctx.lineTo(tx+Math.cos(ang-.42)*fl,ty+Math.sin(ang-.42)*fl);
    ctx.stroke();
  }
  ctx.globalAlpha=1;

  // ‚îÄ‚îÄ LABELS (only if on screen) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(hx>-80&&hx<W+80&&hy>-80&&hy<H+80){
    const badge=isMe?equippedBadge:player.equippedBadge;
    const title=isMe?equippedTitle:player.equippedTitle;
    const isOwner=player.isOwner;

    // ‚îÄ‚îÄ OWNER EFFECTS: animated aura rings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(isOwner&&hl){
      const cr=hw+16+Math.sin(frame*.06)*3;
      ctx.save();
      // Outer spinning dashes
      ctx.globalAlpha=0.55+Math.sin(frame*.07)*.2;
      ctx.strokeStyle=`hsl(${45+Math.sin(frame*.04)*20},100%,${60+Math.sin(frame*.06)*15}%)`;
      ctx.lineWidth=2.5; ctx.shadowColor='#ffd700'; ctx.shadowBlur=18+Math.sin(frame*.05)*8;
      ctx.setLineDash([8,6]);
      ctx.lineDashOffset=-frame*.8;
      ctx.beginPath(); ctx.arc(hx,hy,cr,0,TAU); ctx.stroke();
      ctx.setLineDash([]);
      // Inner solid ring
      ctx.globalAlpha=0.4+Math.sin(frame*.08)*.15;
      ctx.strokeStyle=`rgba(255,215,80,${0.5+Math.sin(frame*.06)*.2})`;
      ctx.lineWidth=1.5; ctx.shadowBlur=10;
      ctx.beginPath(); ctx.arc(hx,hy,cr+6,0,TAU); ctx.stroke();
      ctx.shadowBlur=0; ctx.restore();
    }

    // Badge emoji
    if(badge&&badge!=='ü§ñ'){
      ctx.globalAlpha=1; ctx.font=(isOwner?'16px':'13px')+' serif';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      if(isOwner&&hl){ctx.shadowColor='#ffd700';ctx.shadowBlur=12;}
      ctx.fillText(badge,hx,hy-hw-(isOwner?20:14));
      ctx.shadowBlur=0;
    }

    ctx.globalAlpha=1; ctx.textAlign='center';

    if(isOwner){
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  MASSIVE OWNER TAG ‚Äî animated gold pill
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const nameText=player.name||'';
      ctx.font='700 14px "DM Sans",sans-serif';
      const nw=ctx.measureText(nameText).width;

      // Layout: [ üëë [OWNER] NAME ] all in one pill
      // Pill dimensions ‚Äî deliberately large
      const pillH=28, pillW=Math.max(nw+90,130);
      const pillX=hx-pillW/2, pillY=hy-hw-pillH-10;

      ctx.save();
      // Outer glow
      ctx.shadowColor='#ffd700'; ctx.shadowBlur=28+Math.sin(frame*.05)*10;

      // Pill background ‚Äî dark gold shimmer
      const bg=ctx.createLinearGradient(pillX,pillY,pillX,pillY+pillH);
      bg.addColorStop(0,'rgba(50,38,0,.98)');
      bg.addColorStop(.5,'rgba(30,22,0,.98)');
      bg.addColorStop(1,'rgba(50,38,0,.98)');
      ctx.fillStyle=bg;
      ctx.beginPath();
      if(ctx.roundRect) ctx.roundRect(pillX,pillY,pillW,pillH,7);
      else{ctx.moveTo(pillX+7,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillH,7);ctx.arcTo(pillX+pillW,pillY+pillH,pillX,pillY+pillH,7);ctx.arcTo(pillX,pillY+pillH,pillX,pillY,7);ctx.arcTo(pillX,pillY,pillX+pillW,pillY,7);}
      ctx.closePath(); ctx.fill();

      // Animated gold border
      const bc=`hsl(${45+Math.sin(frame*.06)*12},100%,${58+Math.sin(frame*.08)*14}%)`;
      ctx.strokeStyle=bc; ctx.lineWidth=2;
      ctx.beginPath();
      if(ctx.roundRect) ctx.roundRect(pillX,pillY,pillW,pillH,7);
      else ctx.rect(pillX,pillY,pillW,pillH);
      ctx.closePath(); ctx.stroke();
      ctx.shadowBlur=0;

      // Top shimmer line
      ctx.globalAlpha=0.4+Math.sin(frame*.07)*.2;
      const shim=ctx.createLinearGradient(pillX,pillY,pillX+pillW,pillY);
      shim.addColorStop(0,'rgba(255,255,200,0)');
      shim.addColorStop(.5,'rgba(255,255,200,.6)');
      shim.addColorStop(1,'rgba(255,255,200,0)');
      ctx.fillStyle=shim; ctx.fillRect(pillX,pillY,pillW,2);
      ctx.globalAlpha=1;

      const cy=pillY+pillH/2;

      // Crown icon
      ctx.font='14px serif'; ctx.textBaseline='middle';
      ctx.shadowColor='#ffd700'; ctx.shadowBlur=8;
      ctx.fillText('üëë',pillX+12,cy);
      ctx.shadowBlur=0;

      // [OWNER] badge in gold
      ctx.font='700 9px "JetBrains Mono",monospace';
      const owC=`hsl(${45+Math.sin(frame*.05)*15},100%,${72+Math.sin(frame*.07)*12}%)`;
      ctx.fillStyle=owC;
      ctx.shadowColor=owC; ctx.shadowBlur=6;
      ctx.fillText('[OWNER]',pillX+30,cy-5);
      ctx.shadowBlur=0;

      // Player name in animated gradient
      const ng=ctx.createLinearGradient(pillX+30,cy,pillX+pillW,cy);
      ng.addColorStop(0,'#ffd700');
      ng.addColorStop(.4,'#fffaaa');
      ng.addColorStop(.7,'#ffcc44');
      ng.addColorStop(1,'#ffd700');
      ctx.font='700 14px "DM Sans",sans-serif';
      ctx.fillStyle=ng;
      ctx.shadowColor='rgba(255,215,0,.5)'; ctx.shadowBlur=6;
      ctx.fillText(nameText,pillX+30+(pillW-30-nw)/2+nw/2+20,cy+6);
      ctx.shadowBlur=0;

      ctx.restore();

      // ‚îÄ‚îÄ Z3N0 tag ‚Äî ALWAYS show for owner above the pill ‚îÄ‚îÄ
      drawZ3N0Tag(hx,pillY-14);

      // Title tag below pill (if not Z3N0 title)
      if(title&&!title.toUpperCase().includes('Z3N0')){
        ctx.globalAlpha=1; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.font='700 10px "JetBrains Mono",monospace';
        const titW=ctx.measureText(title).width;
        ctx.fillStyle='rgba(6,6,16,.88)'; ctx.fillRect(hx-titW/2-6,pillY+pillH+4,titW+12,16);
        ctx.fillStyle=`hsl(${45+Math.sin(frame*.04)*15},100%,${70+Math.sin(frame*.06)*12}%)`;
        ctx.fillText(title,hx,pillY+pillH+12);
      }

    } else {
      // Normal player label
      ctx.textBaseline='bottom';
      const tit=isMe?equippedTitle:title;
      const displayName=(tit?tit+' ':'')+(player.name||'');
      ctx.font='600 11px "DM Sans",sans-serif';
      const nw=ctx.measureText(displayName).width;
      ctx.fillStyle='rgba(6,6,16,.78)'; ctx.fillRect(hx-nw/2-5,hy-hw-21,nw+10,14);
      ctx.fillStyle=hcol;
      ctx.fillText(displayName,hx,hy-hw-8);
    }

    // Kill streak badge
    if((player.killStreak||0)>=3){
      ctx.textAlign='center'; ctx.textBaseline='bottom';
      ctx.font='bold 9px "JetBrains Mono",monospace';
      const ks='üî•x'+player.killStreak;
      const ksW=ctx.measureText(ks).width;
      ctx.fillStyle='rgba(200,20,20,.9)'; ctx.fillRect(hx-ksW/2-5,hy-hw-(isOwner?70:34),ksW+10,13);
      ctx.fillStyle='#fff'; ctx.fillText(ks,hx,hy-hw-(isOwner?58:24));
    }
    ctx.textBaseline='alphabetic'; ctx.textAlign='left';
  }
}

// ‚îÄ‚îÄ Z3N0 TAG ‚Äî elite animated tag ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawZ3N0Tag(cx,cy){
  ctx.save();
  const t=frame;
  const tagW=90,tagH=24;
  const tx=cx-tagW/2,ty=cy-tagH/2;

  // Outer glow halo
  ctx.shadowColor=`hsl(${270+Math.sin(t*.04)*30},100%,70%)`;
  ctx.shadowBlur=20+Math.sin(t*.05)*8;

  // Background
  const bg=ctx.createLinearGradient(tx,ty,tx+tagW,ty+tagH);
  bg.addColorStop(0,`hsl(${268+Math.sin(t*.025)*12},60%,10%)`);
  bg.addColorStop(.5,`hsl(${278+Math.sin(t*.03)*10},70%,7%)`);
  bg.addColorStop(1,`hsl(${262+Math.sin(t*.025)*12},60%,10%)`);
  ctx.fillStyle=bg;
  ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(tx,ty,tagW,tagH,5);
  else ctx.rect(tx,ty,tagW,tagH);
  ctx.closePath(); ctx.fill();

  // Animated border
  const bc=`hsl(${270+Math.sin(t*.04)*30},100%,${68+Math.sin(t*.06)*14}%)`;
  ctx.strokeStyle=bc; ctx.lineWidth=1.8; ctx.shadowBlur=10;
  ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(tx,ty,tagW,tagH,5);
  else ctx.rect(tx,ty,tagW,tagH);
  ctx.closePath(); ctx.stroke();
  ctx.shadowBlur=0;

  // Shimmer sweep
  const swp=(t*.02)%1;
  ctx.globalAlpha=0.15+Math.sin(t*.04)*.08;
  const swg=ctx.createLinearGradient(tx+swp*tagW-20,ty,tx+swp*tagW+20,ty+tagH);
  swg.addColorStop(0,'rgba(200,150,255,0)');
  swg.addColorStop(.5,'rgba(200,150,255,.8)');
  swg.addColorStop(1,'rgba(200,150,255,0)');
  ctx.fillStyle=swg;
  ctx.beginPath(); if(ctx.roundRect) ctx.roundRect(tx,ty,tagW,tagH,5); else ctx.rect(tx,ty,tagW,tagH);
  ctx.closePath(); ctx.fill();
  ctx.globalAlpha=1;

  // Text gradient
  const tg=ctx.createLinearGradient(tx,ty,tx+tagW,ty);
  tg.addColorStop(0,`hsl(${280+Math.sin(t*.03)*20},100%,80%)`);
  tg.addColorStop(.35,'#ffffff');
  tg.addColorStop(.65,`hsl(${260+Math.sin(t*.035)*20},100%,78%)`);
  tg.addColorStop(1,`hsl(${280+Math.sin(t*.025)*20},100%,75%)`);

  ctx.font='700 13px "JetBrains Mono",monospace';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillStyle=tg;
  ctx.shadowColor=`hsl(${270+Math.sin(t*.04)*30},100%,72%)`;
  ctx.shadowBlur=12;
  ctx.fillText('‚ö° Z3N0 ‚ö°',cx,cy+1);
  ctx.shadowBlur=0;
  ctx.restore();
}

function drawParts(){
  for(const p of parts){
    ctx.globalAlpha=p.life*p.life; ctx.fillStyle=p.col;
    ctx.beginPath(); ctx.arc(p.x-camX,p.y-camY,Math.max(.1,p.r*p.life),0,TAU); ctx.fill();
  }
  ctx.globalAlpha=1;
}

// ‚îÄ‚îÄ MINIMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawMM(){
  const W=142,H=142,sc=W/mapSz;
  mm.fillStyle='rgba(6,6,16,.96)'; mm.fillRect(0,0,W,H);
  for(const pid in serverPortals){
    const p=serverPortals[pid]; if(!p) continue;
    mm.globalAlpha=.6; mm.fillStyle='#a855f7';
    mm.beginPath(); mm.arc(p.x*sc,p.y*sc,4,0,TAU); mm.fill();
  }
  for(const pid in serverPowerUps){
    const pu=serverPowerUps[pid]; if(!pu) continue;
    mm.globalAlpha=.7; mm.fillStyle=getPUColor(pu.type);
    mm.fillRect(pu.x*sc-2,pu.y*sc-2,4,4);
  }
  for(const oid in serverOrbs){
    const o=serverOrbs[oid]; if(!o) continue;
    mm.fillStyle=o.color; mm.globalAlpha=o.golden?1:.5;
    mm.fillRect(o.x*sc-.5,o.y*sc-.5,o.golden?2:1,o.golden?2:1);
  }
  mm.globalAlpha=1;
  for(const pid in serverPlayers){
    const p=serverPlayers[pid];
    if(!p||!p.segments||!p.segments.length) continue;
    const hd=p.segments[0],isMe=pid===myId;
    mm.fillStyle=isMe?'#00ff88':getSnakeColor(p);
    mm.globalAlpha=isMe?1:.55;
    mm.beginPath(); mm.arc(hd.x*sc,hd.y*sc,isMe?3.5:2,0,TAU); mm.fill();
  }
  mm.globalAlpha=1;
  mm.strokeStyle='rgba(0,255,136,.2)'; mm.lineWidth=1;
  mm.strokeRect(camX*sc,camY*sc,gc.width*sc,gc.height*sc);
  mm.strokeStyle='rgba(255,34,51,.5)'; mm.lineWidth=1.5; mm.strokeRect(0,0,W,H);
  mm.fillStyle='rgba(0,255,136,.25)'; mm.font='6px "JetBrains Mono",monospace';
  mm.textAlign='left'; mm.textBaseline='bottom';
  mm.fillText(Object.keys(serverPlayers).length+' players',3,H-3);
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _sc=-1,_ln=-1,_co=-1;
function updateHUD(){
  if(myScore!==_sc){document.getElementById('H_sv').textContent=myScore;_sc=myScore;bumpScore();}
  if(myLength!==_ln){document.getElementById('H_lv').textContent=myLength;_ln=myLength;}
  let lb='';
  leaderboard.forEach((p,i)=>{
    const rc=i===0?'g1':i===1?'g2':i===2?'g3':'';
    const sym=i===0?'1.':i===1?'2.':i===2?'3.':(i+1)+'.';
    const isMe=p.id===myId;
    const strk=(p.killStreak||0)>=3?`<span class="lb-streak">üî•</span>`:'';
    const ownerTag=p.isOwner?'<span style="color:#ffd700;font-size:8px"> üëë</span>':'';
    lb+=`<div class="lbr"><div class="lbrank ${rc}">${sym}</div><div class="lbn${isMe?' me':''}${p.isBot?' bot':''}">${esc(p.name)}${ownerTag}</div>${strk}<div class="lbs">${p.length}</div></div>`;
  });
  document.getElementById('lb_list').innerHTML=lb;
  const humans=Object.values(serverPlayers).filter(p=>!p.isBot).length;
  const bots=Object.values(serverPlayers).filter(p=>p.isBot).length;
  document.getElementById('pcount').textContent=humans+' players ¬∑ '+bots+' bots';
}
function updateHUDCoins(){
  const total=profileCoins+sessionCoins;
  if(total!==_co){
    document.getElementById('H_coinv').textContent=total; _co=total;
    const sb=document.getElementById('shop_bal');
    if(sb) sb.textContent=total;
  }
}
function updatePowerUpHUD(){
  const c=document.getElementById('H_powerups'); if(!c) return;
  const now=Date.now(); let html='';
  for(const[type,data] of Object.entries(activePowerUps)){
    const end=data?.end||data?.until||0;
    const start=data?.start||end-8000;
    if(!end||now>=end) continue;
    const pct=((end-now)/(end-start)*100).toFixed(1);
    html+=`<div class="pu-indicator">${getPUEmoji(type)}<div class="pu-timer"><div class="pu-timer-fill" style="width:${pct}%;background:${getPUColor(type)}"></div></div></div>`;
  }
  c.innerHTML=html;
}
function bumpScore(){
  const e=document.getElementById('H_score');
  e.classList.remove('bump'); void e.offsetWidth; e.classList.add('bump');
  setTimeout(()=>e.classList.remove('bump'),220);
}
function getPUColor(type){return{speed:'#ffcc00',shield:'#00aaff',ghost:'#94a3b8',magnet:'#c084fc',bomb:'#ff4400',freeze:'#06b6d4',grow:'#00ff88',star:'#fbbf24',rage:'#ff0055',shrink:'#ff88cc'}[type]||'#ffffff';}
function getPUEmoji(type){return{speed:'‚ö°',shield:'üõ°Ô∏è',ghost:'üëª',magnet:'üß≤',bomb:'üí•',freeze:'‚ùÑÔ∏è',grow:'üçÑ',star:'‚≠ê',rage:'üî•',shrink:'‚úÇÔ∏è'}[type]||'?';}

// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSP(txt,col,sx,sy){
  const el=document.createElement('div'); el.className='sp';
  el.style.cssText=`left:${sx}px;top:${sy}px;color:${col}`;
  el.textContent=txt; document.body.appendChild(el);
  setTimeout(()=>{if(el.parentNode)el.remove();},1200);
}
function addKF(victim,killer,isBot,isMeKiller){
  const kf=document.getElementById('kf');
  const el=document.createElement('div'); el.className='kfe';
  el.innerHTML=`<span class="kfe-icon">üíÄ</span><span style="color:#94a3b8">${esc(victim)}</span> <span style="color:var(--red);font-weight:700">√ó</span> <span style="color:${isMeKiller?'var(--green)':'#4ade80'}">${esc(killer)}</span>`;
  kf.appendChild(el);
  while(kf.children.length>5) kf.removeChild(kf.firstChild);
  setTimeout(()=>{if(el.parentNode)el.remove();},5000);
}
function toast(msg,type){
  const el=document.createElement('div'); el.className='toast'+(type?' '+type:'');
  el.textContent=msg; document.getElementById('toasts').appendChild(el);
  setTimeout(()=>{if(el.parentNode)el.remove();},3000);
}
function doFlash(col){
  const f=document.getElementById('flash');
  f.style.background=col; f.style.transition='none'; f.style.opacity='1';
  requestAnimationFrame(()=>requestAnimationFrame(()=>{f.style.transition='opacity .5s';f.style.opacity='0';}));
}
let strkTm=null;
function showStreakBanner(txt){
  const e=document.getElementById('streak-banner'); e.textContent=txt; e.classList.add('on');
  clearTimeout(strkTm); strkTm=setTimeout(()=>e.classList.remove('on'),2500);
}
let evNotifTm=null;
function showEventNotif(txt){
  const e=document.getElementById('event-notif'); e.textContent=txt; e.classList.add('on');
  clearTimeout(evNotifTm); evNotifTm=setTimeout(()=>e.classList.remove('on'),12000);
}
function hideEventNotif(){document.getElementById('event-notif').classList.remove('on');}
function showSysMsg(msg){
  const e=document.getElementById('sys-msg'); e.textContent=msg; e.classList.add('on');
  clearTimeout(sysNotifTm); sysNotifTm=setTimeout(()=>e.classList.remove('on'),4500);
}
function showPortalNotif(msg){
  const e=document.getElementById('portal-notif'); e.textContent=msg; e.classList.add('on');
  clearTimeout(portalNotifTm); portalNotifTm=setTimeout(()=>e.classList.remove('on'),2500);
}
function showTaunt(msg){
  const e=document.getElementById('taunt-bubble'); e.textContent=msg; e.classList.add('on');
  clearTimeout(tauntTm); tauntTm=setTimeout(()=>e.classList.remove('on'),3000);
}
let fpsD=null;
function calcFPS(ts){
  if(!fpsD) fpsD=document.getElementById('fps');
  fpsArr.push(ts); fpsArr=fpsArr.filter(t=>ts-t<1000);
  if(showFPS&&ts-fpsLast>600){if(fpsD)fpsD.textContent=fpsArr.length+' fps';fpsLast=ts;}
}

// ‚îÄ‚îÄ COSMETIC HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isEquipped(item){
  if(!item) return false;
  if(item.type==='trail') return equippedTrail===item.id;
  if(item.type==='badge') return equippedBadgeId===item.id;
  if(item.type==='title') return equippedTitle===item.text||equippedTitle===item.name;
  return false;
}

// ‚îÄ‚îÄ FALLBACK COSMETICS CATALOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Used when server catalog is empty (no JSON file present)
const FALLBACK_CATALOG = {
  // Trails ‚Äî IDs match PlayFab catalog
  trail_fire:     {id:'trail_fire',     type:'trail', name:'Fire Trail',      price:300,  emoji:'üî•', rarity:'rare',      ownerOnly:false, glow:'#ff4400'},
  trail_ice:      {id:'trail_ice',      type:'trail', name:'Ice Trail',       price:300,  emoji:'‚ùÑÔ∏è', rarity:'rare',      ownerOnly:false, glow:'#00ccff'},
  trail_electric: {id:'trail_electric', type:'trail', name:'Electric Trail',  price:400,  emoji:'‚ö°', rarity:'rare',      ownerOnly:false, glow:'#00ffff'},
  trail_toxic:    {id:'trail_toxic',    type:'trail', name:'Toxic Trail',     price:350,  emoji:'‚ò£Ô∏è', rarity:'rare',      ownerOnly:false, glow:'#88ff00'},
  trail_gold:     {id:'trail_gold',     type:'trail', name:'Gold Trail',      price:500,  emoji:'‚ú®', rarity:'epic',      ownerOnly:false, glow:'#ffd700'},
  trail_rainbow:  {id:'trail_rainbow',  type:'trail', name:'Rainbow Trail',   price:600,  emoji:'üåà', rarity:'epic',      ownerOnly:false, glow:'rainbow'},
  trail_void:     {id:'trail_void',     type:'trail', name:'Void Trail',      price:500,  emoji:'üåë', rarity:'epic',      ownerOnly:false, glow:'#6600aa'},
  trail_blood:    {id:'trail_blood',    type:'trail', name:'Blood Trail',     price:400,  emoji:'ü©∏', rarity:'rare',      ownerOnly:false, glow:'#cc0000'},
  trail_cosmic:   {id:'trail_cosmic',   type:'trail', name:'Cosmic Trail',    price:700,  emoji:'üåå', rarity:'legendary', ownerOnly:false, glow:'#4488ff'},
  trail_plasma:   {id:'trail_plasma',   type:'trail', name:'Plasma Trail',    price:500,  emoji:'üíú', rarity:'epic',      ownerOnly:false, glow:'#ff00ff'},
  trail_neon:     {id:'trail_neon',     type:'trail', name:'Neon Trail',      price:350,  emoji:'üíó', rarity:'rare',      ownerOnly:false, glow:'#ff00aa'},
  trail_lava:     {id:'trail_lava',     type:'trail', name:'Lava Trail',      price:450,  emoji:'üåã', rarity:'epic',      ownerOnly:false, glow:'#ff2200'},
  trail_emerald:  {id:'trail_emerald',  type:'trail', name:'Emerald Trail',   price:400,  emoji:'üíö', rarity:'rare',      ownerOnly:false, glow:'#00ff88'},
  trail_angel:    {id:'trail_angel',    type:'trail', name:'Angel Trail',     price:900,  emoji:'üëº', rarity:'legendary', ownerOnly:false, glow:'#ffffff'},
  trail_nature:   {id:'trail_nature',   type:'trail', name:'Nature Trail',    price:300,  emoji:'üåø', rarity:'rare',      ownerOnly:false, glow:'#44ff44'},
  trail_ocean:    {id:'trail_ocean',    type:'trail', name:'Ocean Trail',     price:350,  emoji:'üåä', rarity:'rare',      ownerOnly:false, glow:'#00aaff'},
  trail_shadow:   {id:'trail_shadow',   type:'trail', name:'Shadow Trail',    price:400,  emoji:'üåë', rarity:'epic',      ownerOnly:false, glow:'#8888ff'},
  trail_storm:    {id:'trail_storm',    type:'trail', name:'Storm Trail',     price:450,  emoji:'‚õàÔ∏è', rarity:'epic',      ownerOnly:false, glow:'#aaccff'},
  trail_thunder:  {id:'trail_thunder',  type:'trail', name:'Thunder Trail',   price:500,  emoji:'‚ö°', rarity:'epic',      ownerOnly:false, glow:'#ffff00'},
  trail_rose:     {id:'trail_rose',     type:'trail', name:'Rose Trail',      price:350,  emoji:'üåπ', rarity:'rare',      ownerOnly:false, glow:'#ff66aa'},
  trail_copper:   {id:'trail_copper',   type:'trail', name:'Copper Trail',    price:300,  emoji:'üü§', rarity:'rare',      ownerOnly:false, glow:'#ff8822'},
  // Titles ‚Äî IDs match PlayFab catalog
  title_rookie:   {id:'title_rookie',   type:'title', name:'[ROOKIE]',        price:0,    emoji:'üêç', text:'[ROOKIE]',        rarity:'common',    ownerOnly:false},
  title_snake:    {id:'title_snake',    type:'title', name:'[SNAKE]',         price:100,  emoji:'üêç', text:'[SNAKE]',         rarity:'common',    ownerOnly:false},
  title_hunter:   {id:'title_hunter',  type:'title', name:'[HUNTER]',        price:150,  emoji:'üéØ', text:'[HUNTER]',        rarity:'common',    ownerOnly:false},
  title_phantom:  {id:'title_phantom', type:'title', name:'[PHANTOM]',       price:200,  emoji:'üëª', text:'[PHANTOM]',       rarity:'common',    ownerOnly:false},
  title_viper:    {id:'title_viper',   type:'title', name:'[VIPER]',         price:200,  emoji:'üêç', text:'[VIPER]',         rarity:'common',    ownerOnly:false},
  title_killer:   {id:'title_killer',  type:'title', name:'[KILLER]',        price:300,  emoji:'üíÄ', text:'[KILLER]',        rarity:'rare',      ownerOnly:false},
  title_beast:    {id:'title_beast',   type:'title', name:'[BEAST]',         price:300,  emoji:'üî•', text:'[BEAST]',         rarity:'rare',      ownerOnly:false},
  title_titan:    {id:'title_titan',   type:'title', name:'[TITAN]',         price:400,  emoji:'üí™', text:'[TITAN]',         rarity:'rare',      ownerOnly:false},
  title_shadow:   {id:'title_shadow',  type:'title', name:'[SHADOW]',        price:400,  emoji:'üåë', text:'[SHADOW]',        rarity:'rare',      ownerOnly:false},
  title_reaper:   {id:'title_reaper',  type:'title', name:'[REAPER]',        price:500,  emoji:'‚öîÔ∏è', text:'[REAPER]',        rarity:'epic',      ownerOnly:false},
  title_elite:    {id:'title_elite',   type:'title', name:'[ELITE]',         price:500,  emoji:'üíé', text:'[ELITE]',         rarity:'epic',      ownerOnly:false},
  title_legend:   {id:'title_legend',  type:'title', name:'[LEGEND]',        price:700,  emoji:'‚≠ê', text:'[LEGEND]',        rarity:'epic',      ownerOnly:false},
  title_destroyer:{id:'title_destroyer',type:'title',name:'[DESTROYER]',     price:800,  emoji:'üí•', text:'[DESTROYER]',     rarity:'legendary', ownerOnly:false},
  title_warlord:  {id:'title_warlord', type:'title', name:'[WARLORD]',       price:900,  emoji:'‚öîÔ∏è', text:'[WARLORD]',       rarity:'legendary', ownerOnly:false},
  title_galaxy:   {id:'title_galaxy',  type:'title', name:'[GALAXY]',        price:1000, emoji:'üåå', text:'[GALAXY]',        rarity:'legendary', ownerOnly:false},
  title_overlord: {id:'title_overlord',type:'title', name:'[OVERLORD]',      price:1200, emoji:'üëë', text:'[OVERLORD]',      rarity:'legendary', ownerOnly:false},
  // Badges ‚Äî IDs match PlayFab catalog
  badge_snake:    {id:'badge_snake',    type:'badge', name:'Snake',           price:100,  emoji:'üêç', rarity:'common',    ownerOnly:false},
  badge_heart:    {id:'badge_heart',    type:'badge', name:'Heart',           price:100,  emoji:'‚ù§Ô∏è', rarity:'common',    ownerOnly:false},
  badge_fire:     {id:'badge_fire',     type:'badge', name:'Fire',            price:120,  emoji:'üî•', rarity:'common',    ownerOnly:false},
  badge_ice:      {id:'badge_ice',      type:'badge', name:'Ice',             price:120,  emoji:'‚ùÑÔ∏è', rarity:'common',    ownerOnly:false},
  badge_ghost:    {id:'badge_ghost',    type:'badge', name:'Ghost',           price:150,  emoji:'üëª', rarity:'common',    ownerOnly:false},
  badge_toxic:    {id:'badge_toxic',    type:'badge', name:'Toxic',           price:150,  emoji:'‚ò£Ô∏è', rarity:'common',    ownerOnly:false},
  badge_sword:    {id:'badge_sword',    type:'badge', name:'Sword',           price:180,  emoji:'‚öîÔ∏è', rarity:'common',    ownerOnly:false},
  badge_skull:    {id:'badge_skull',    type:'badge', name:'Skull',           price:200,  emoji:'üíÄ', rarity:'rare',      ownerOnly:false},
  badge_spider:   {id:'badge_spider',   type:'badge', name:'Spider',          price:200,  emoji:'üï∑Ô∏è', rarity:'rare',      ownerOnly:false},
  badge_robot:    {id:'badge_robot',    type:'badge', name:'Robot',           price:200,  emoji:'ü§ñ', rarity:'rare',      ownerOnly:false},
  badge_thunder:  {id:'badge_thunder',  type:'badge', name:'Thunder',         price:250,  emoji:'‚ö°', rarity:'rare',      ownerOnly:false},
  badge_demon:    {id:'badge_demon',    type:'badge', name:'Demon',           price:280,  emoji:'üòà', rarity:'rare',      ownerOnly:false},
  badge_rocket:   {id:'badge_rocket',   type:'badge', name:'Rocket',          price:280,  emoji:'üöÄ', rarity:'rare',      ownerOnly:false},
  badge_alien:    {id:'badge_alien',    type:'badge', name:'Alien',           price:300,  emoji:'üëΩ', rarity:'rare',      ownerOnly:false},
  badge_star:     {id:'badge_star',     type:'badge', name:'Star',            price:300,  emoji:'‚≠ê', rarity:'rare',      ownerOnly:false},
  badge_nuclear:  {id:'badge_nuclear',  type:'badge', name:'Nuclear',         price:350,  emoji:'‚ò¢Ô∏è', rarity:'epic',      ownerOnly:false},
  badge_diamond:  {id:'badge_diamond',  type:'badge', name:'Diamond',         price:400,  emoji:'üíé', rarity:'epic',      ownerOnly:false},
  badge_dragon:   {id:'badge_dragon',   type:'badge', name:'Dragon',          price:500,  emoji:'üêâ', rarity:'epic',      ownerOnly:false},
  badge_lightning:{id:'badge_lightning',type:'badge', name:'Lightning',       price:350,  emoji:'üå©Ô∏è', rarity:'rare',      ownerOnly:false},
  badge_infinity: {id:'badge_infinity', type:'badge', name:'Infinity',        price:600,  emoji:'‚ôæÔ∏è', rarity:'epic',      ownerOnly:false},
  badge_crystal:  {id:'badge_crystal',  type:'badge', name:'Crystal',         price:500,  emoji:'üí†', rarity:'epic',      ownerOnly:false},
  badge_crown:    {id:'badge_crown',    type:'badge', name:'Crown',           price:700,  emoji:'üëë', rarity:'legendary', ownerOnly:false},
};

// ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let shopMainTab = 'store'; // 'store' or 'owned'

function getActiveCatalog(){
  // If server sent cosmetics, use those; otherwise use fallback
  if(cosmeticsCatalog && Object.keys(cosmeticsCatalog).length > 0) return cosmeticsCatalog;
  return FALLBACK_CATALOG;
}

function setShopMainTab(tab){
  shopMainTab=tab;
  document.getElementById('smt_store').classList.toggle('on',tab==='store');
  document.getElementById('smt_owned').classList.toggle('on',tab==='owned');
  const sv=document.getElementById('shop_store_view');
  const ov=document.getElementById('shop_owned_view');
  if(tab==='store'){sv.style.display='';ov.style.display='none';}
  else{sv.style.display='none';ov.style.display='flex';renderOwnedTab();}
}

function renderOwnedTab(){
  const grid=document.getElementById('owned_grid'); if(!grid) return;
  const cat=getActiveCatalog();

  // Build a complete set of owned items:
  // 1. Items from the catalog that are in ownedCosmetics
  // 2. Items from the catalog that are free (price===0)
  // 3. Owner-exclusive items that are in ownedCosmetics (even if ownerOnly)
  // 4. Synthesize entries for owned IDs not found in catalog but found in TRAIL_CONFIGS
  const catItems = Object.values(cat);
  const ownedSet = new Set(ownedCosmetics);
  const itemsById = {};
  for(const i of catItems) itemsById[i.id]=i;

  // Add synthetic entries for owner trail IDs in ownedCosmetics that aren't in catalog
  for(const id of ownedCosmetics){
    if(!itemsById[id]){
      const tcfg=TRAIL_CONFIGS[id];
      if(tcfg){
        // Synthesize a display item from TRAIL_CONFIGS
        const isOwnerTrail=tcfg.owner===true||id.startsWith('owner_trail_');
        const isMythic=tcfg.mythic===true;
        itemsById[id]={
          id, type:'trail',
          name: id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()),
          price:0, emoji:'‚ú®',
          rarity: isMythic?'mythic':isOwnerTrail?'legendary':'epic',
          ownerOnly: isOwnerTrail, glow: tcfg.glow||'#ffffff',
          text: null,
        };
      } else if(id.startsWith('owner_')||id.startsWith('title_')||id.startsWith('badge_')){
        // Generic fallback for unknown owned IDs
        const type=id.startsWith('title_')?'title':id.startsWith('badge_')?'badge':'trail';
        itemsById[id]={
          id, type,
          name: id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()),
          price:0, emoji: type==='title'?'üëë':type==='badge'?'‚≠ê':'‚ú®',
          rarity:'legendary', ownerOnly:id.startsWith('owner_'), text:'['+id.toUpperCase()+']',
        };
      }
    }
  }

  // Filter to owned items (include ownerOnly items if in ownedCosmetics)
  const owned=Object.values(itemsById).filter(i=>ownedSet.has(i.id)||i.price===0);

  if(!owned.length){
    grid.innerHTML=`<div style="grid-column:1/-1;padding:28px;text-align:center;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:.08em">you don't own any cosmetics yet üòî<br><br><span style="font-size:10px">head to the Store tab to grab some!</span></div>`;
    return;
  }
  // Sort: equipped first, then owner items, then by rarity
  const RARITY_ORDER = {mythic:0,legendary:1,epic:2,rare:3,common:4};
  owned.sort((a,b)=>{
    const ae=isEquipped(a);
    const be=isEquipped(b);
    if(ae&&!be)return -1; if(be&&!ae)return 1;
    // Owner items float above normal items
    if(a.ownerOnly&&!b.ownerOnly)return -1; if(b.ownerOnly&&!a.ownerOnly)return 1;
    return (RARITY_ORDER[a.rarity]||4)-(RARITY_ORDER[b.rarity]||4);
  });
  grid.innerHTML=owned.map(i=>{
    const equipped=isEquipped(i);
    const rc=RARITY_COLORS[i.rarity]||'#94a3b8';
    const ownerTag=i.ownerOnly?'<span style="font-size:7px;color:#ff88ff"> üëë</span>':'';
    let btn=equipped
      ?`<button class="shop-equip-btn" style="background:rgba(0,255,136,.12);border-color:rgba(0,255,136,.5)" onclick="unequipItem('${i.id}','${i.type}')">‚úì Equipped</button>`
      :`<button class="shop-equip-btn" onclick="equipItem('${i.id}')">Equip</button>`;
    let cls='shop-item'; if(equipped)cls+=' equipped'; else cls+=' owned';
    const bs=i.ownerOnly?'border-color:rgba(255,68,255,.35);background:rgba(255,68,255,.04)':'';
    return `<div class="${cls}" style="${bs}">
      <div style="font-family:'JetBrains Mono',monospace;font-size:7px;font-weight:700;color:${rc};letter-spacing:.08em;text-transform:uppercase;margin-bottom:2px">${i.rarity||'common'}${i.ownerOnly?' ¬∑ OWNER':''}</div>
      <div class="shop-item-icon">${i.emoji}${ownerTag}</div>
      <div class="shop-item-name">${((i.name||'').replace(/^[\p{Emoji}\s]+/u,'').replace(/\s*\[OWNER\]|\s*\[MYTHIC OWNER\]/g,'').trim()||i.id)}</div>
      ${btn}
    </div>`;
  }).join('');
}

function renderShop(){
  const fEl=document.getElementById('shop_filters'); if(!fEl) return;
  const cat=getActiveCatalog();
  fEl.innerHTML=['all',...CATALOG_TYPES].map(t=>`<button class="shop-filter${shopFilter===t?' on':''}" onclick="setShopFilter('${t}')">${t==='all'?'All':TYPE_LABELS[t]||t}</button>`).join('');
  const grid=document.getElementById('shop_grid'); if(!grid) return;
  const total=profileCoins+sessionCoins;
  const all=Object.values(cat);
  const regular=all.filter(i=>!i.ownerOnly&&(shopFilter==='all'||i.type===shopFilter)).sort((a,b)=>a.price-b.price);
  const owner=all.filter(i=>i.ownerOnly&&(shopFilter==='all'||i.type===shopFilter)).sort((a,b)=>(a.rarity||'').localeCompare(b.rarity||''));

  function item(i,isO){
    const owned=ownedCosmetics.includes(i.id)||i.price===0;
    const equipped=isEquipped(i);
    const rc=RARITY_COLORS[i.rarity]||'#94a3b8';
    let cls='shop-item'; if(equipped)cls+=' equipped'; else if(owned)cls+=' owned';
    const rar=`<div style="font-family:'JetBrains Mono',monospace;font-size:7px;font-weight:700;color:${rc};letter-spacing:.08em;text-transform:uppercase;margin-bottom:2px">${i.rarity||'common'}${isO?' ¬∑ OWNER':''}</div>`;
    let btn='';
    if(isO&&!owned){
      btn=`<div style="width:100%;padding:4px;background:rgba(255,68,255,.06);border:1px solid rgba(255,68,255,.25);border-radius:4px;color:#ff88ff;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;text-align:center">üëë OWNER ONLY</div>`;
    }else if(equipped){
      btn=`<button class="shop-equip-btn" style="background:rgba(0,255,136,.12);border-color:rgba(0,255,136,.5)" onclick="unequipItem('${i.id}','${i.type}')">‚úì On</button>`;
    }else if(owned){
      btn=`<button class="shop-equip-btn" onclick="equipItem('${i.id}')">Equip</button>`;
    }else{
      btn=`<button class="shop-buy-btn" onclick="buyItem('${i.id}')"${total>=i.price?'':' disabled'}>üí∞ ${i.price}</button>`;
    }
    const bs=isO?'border-color:rgba(255,68,255,.35);background:rgba(255,68,255,.04)':'';
    const nm=(i.name||'').replace(/^[\p{Emoji}\s]+/u,'').replace(/\s*\[OWNER\]|\s*\[MYTHIC OWNER\]/g,'').trim()||i.name||i.id;
    return `<div class="${cls}" style="${bs}">${rar}<div class="shop-item-icon">${i.emoji}</div><div class="shop-item-name">${nm}</div>${btn}</div>`;
  }

  let html=regular.map(i=>item(i,false)).join('');
  if(owner.length){
    html+=`<div style="grid-column:1/-1;padding:8px 0 4px;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:#ff88ff;letter-spacing:.15em;text-transform:uppercase;border-top:1px solid rgba(255,68,255,.2);margin-top:4px">üëë Owner Exclusives</div>`;
    html+=owner.map(i=>item(i,true)).join('');
  }
  if(!html) html=`<div style="grid-column:1/-1;padding:28px;text-align:center;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:.08em">no items here yet üëÄ</div>`;
  grid.innerHTML=html;
  const sb=document.getElementById('shop_bal');
  if(sb) sb.textContent=total;
  // Also refresh owned tab if visible
  if(shopMainTab==='owned') renderOwnedTab();
}
function setShopFilter(f){shopFilter=f;renderShop();}
function buyItem(id){
  socket.emit('buyCosmetic',{cosmeticId:id});
  // Fallback for when server catalog JSON is missing - do local purchase
  const cat=getActiveCatalog();
  if(cat===FALLBACK_CATALOG){
    const item=FALLBACK_CATALOG[id]; if(!item) return;
    const total=profileCoins+sessionCoins;
    if(total<item.price){toast('Not enough coins!','red');return;}
    if(ownedCosmetics.includes(id)){toast('Already owned!','blue');return;}
    profileCoins-=item.price;
    ownedCosmetics.push(id);
    updateHUDCoins();
    renderShop();
    toast('Got '+item.emoji+' '+item.name+'!','gold');
  }
}
function equipItem(id){
  socket.emit('equipCosmetic',{cosmeticId:id});
  // Optimistic local update
  const cat=getActiveCatalog();
  const item=cat[id];
  if(item){
    if(item.type==='trail') equippedTrail=id;
    else if(item.type==='badge'){ equippedBadgeId=id; equippedBadge=item.emoji; }
    else if(item.type==='title') equippedTitle=item.text||item.name;
  } else if(TRAIL_CONFIGS[id]){
    equippedTrail=id;
  }
  renderShop();
}
function unequipItem(id,type){
  socket.emit('unequipCosmetic',{slot:type});
  if(type==='trail') equippedTrail=null;
  else if(type==='badge'){ equippedBadge=null; equippedBadgeId=null; }
  else if(type==='title') equippedTitle=null;
  renderShop();
}
function openShop(){
  shopMainTab='store';
  setShopMainTab('store');
  renderShop();
  document.getElementById('M_shop').classList.add('on');
}
function closeShop(){document.getElementById('M_shop').classList.remove('on');}

// ‚îÄ‚îÄ OWNER PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let isOwnerClient = false;
let ownerPanelOpen = false;
let livePlayers = [];

socket.on('playerList', (players) => {
  livePlayers = players || [];
  renderOwnerPlayerList();
});

socket.on('ownerSuccess', (msg) => {
  const s = document.getElementById('op_status');
  if(s){ s.textContent = '‚úì ' + msg; s.style.color = 'var(--green)'; setTimeout(() => { if(s) s.textContent = ''; }, 3000); }
  toast(msg, 'ok');
});
socket.on('ownerError', (msg) => {
  const s = document.getElementById('op_status');
  if(s){ s.textContent = '‚úó ' + msg; s.style.color = '#fca5a5'; setTimeout(() => { if(s) s.textContent = ''; }, 3000); }
  toast(msg, 'red');
});

function openOwnerPanel(){
  document.getElementById('M_owner').style.opacity = '1';
  document.getElementById('M_owner').style.pointerEvents = 'all';
  ownerPanelOpen = true;
  ownerRefreshPlayers();
}
function closeOwnerPanel(){
  document.getElementById('M_owner').style.opacity = '0';
  document.getElementById('M_owner').style.pointerEvents = 'none';
  ownerPanelOpen = false;
}
function ownerRefreshPlayers(){
  if(!ownerPass) return;
  socket.emit('ownerAction', { action:'getPlayers', password: ownerPass });
}
function renderOwnerPlayerList(){
  const c = document.getElementById('op_players'); if(!c) return;
  if(!livePlayers.length){ c.innerHTML = '<div style="color:var(--muted);font-size:11px">No players online</div>'; return; }
  c.innerHTML = livePlayers.map(p =>
    `<div style="display:flex;align-items:center;gap:8px;padding:5px 8px;background:rgba(255,255,255,.025);border-radius:6px;cursor:pointer" onclick="fillPlayerId('${p.id}')">
      <span style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted)">${p.id.slice(0,8)}‚Ä¶</span>
      <span style="font-size:11px;font-weight:600;color:${p.isOwner?'#ffd700':'#fff'};flex:1">${esc(p.name)}</span>
      <span style="font-size:9px;color:var(--muted)">len:${p.length} üí∞${p.coins}</span>
    </div>`
  ).join('');
}
function fillPlayerId(id){
  ['op_coins_target','op_action_target'].forEach(k=>{ const el=document.getElementById(k); if(el) el.value=id; });
}

function ownerGiveCoins(){
  const tid=document.getElementById('op_coins_target').value.trim();
  const amt=document.getElementById('op_coins_amount').value.trim();
  if(!tid||!amt){ toast('Fill in player ID and amount','red'); return; }
  socket.emit('ownerAction',{action:'giveCoins',targetId:tid,value:amt,password:ownerPass});
}
function ownerKick(){
  const tid=document.getElementById('op_action_target').value.trim();
  if(!tid){ toast('Enter player ID','red'); return; }
  if(!confirm('Kick this player?')) return;
  socket.emit('ownerAction',{action:'kick',targetId:tid,value:'Kicked by owner.',password:ownerPass});
}
function ownerKill(){
  const tid=document.getElementById('op_action_target').value.trim();
  if(!tid){ toast('Enter player ID','red'); return; }
  socket.emit('ownerAction',{action:'instaKill',targetId:tid,password:ownerPass});
}
function ownerBroadcast(){
  const msg=document.getElementById('op_broadcast').value.trim();
  if(!msg){ toast('Enter a message','red'); return; }
  socket.emit('ownerAction',{action:'broadcast',value:msg,password:ownerPass});
  document.getElementById('op_broadcast').value='';
}
let bgAudio=null, bgPlaying=false;
function initBGMusic(){
  if(bgAudio) return;
  bgAudio=document.getElementById('bg-audio');
  if(!bgAudio) return;
  bgAudio.volume=parseFloat(document.getElementById('mp-vol').value)||0.4;
  bgAudio.addEventListener('timeupdate',()=>{
    if(!bgAudio.duration) return;
    const pct=(bgAudio.currentTime/bgAudio.duration*100).toFixed(1);
    const prog=document.getElementById('mp-prog');
    if(prog) prog.style.width=pct+'%';
  });
}
function toggleMusic(){
  initBGMusic();
  if(!bgAudio) return;
  if(bgPlaying){
    bgAudio.pause(); bgPlaying=false;
    document.getElementById('mp-playbtn').textContent='‚ñ∂';
  } else {
    bgAudio.play().then(()=>{bgPlaying=true;document.getElementById('mp-playbtn').textContent='‚è∏';}).catch(()=>{});
  }
}
function setBGVol(v){
  initBGMusic();
  if(bgAudio) bgAudio.volume=parseFloat(v);
}
// Auto-start music on first user interaction
document.addEventListener('click',function startOnce(){
  initBGMusic();
  if(bgAudio&&!bgPlaying){
    bgAudio.play().then(()=>{bgPlaying=true;document.getElementById('mp-playbtn').textContent='‚è∏';}).catch(()=>{});
  }
  document.removeEventListener('click',startOnce);
},{once:true});

// ‚îÄ‚îÄ MENU WIRING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SKINS=[
  {id:'classic',e:'üü¢',n:'Classic'},{id:'fire',e:'üî¥',n:'Fire'},
  {id:'ice',e:'üîµ',n:'Frost'},{id:'toxic',e:'üü°',n:'Toxic'},
  {id:'gold',e:'‚≠ê',n:'Gold'},{id:'midnight',e:'üü£',n:'Midnight'},
  {id:'sunset',e:'üü†',n:'Sunset'},{id:'ocean',e:'ü©µ',n:'Ocean'},
  {id:'lava',e:'‚ô®Ô∏è',n:'Lava'},{id:'electric',e:'‚ö°',n:'Electric'},
];
(function(){
  const g=document.getElementById('sk_grid'); if(!g) return;
  SKINS.forEach((s,i)=>{
    const d=document.createElement('div'); d.className='skin-cell'+(i===0?' on':'');
    d.innerHTML=`${s.e}<span class="skin-cell-tip">${s.n}</span>`;
    d.onclick=()=>{document.querySelectorAll('.skin-cell').forEach(x=>x.classList.remove('on'));d.classList.add('on');selSkin=s.id;};
    g.appendChild(d);
  });
})();

function switchTab(name){
  document.querySelectorAll('.mr-tab').forEach(b=>b.classList.toggle('on',b.dataset.t===name));
  document.querySelectorAll('.mr-tc').forEach(c=>c.classList.toggle('on',c.id==='T_'+name));
}
document.querySelectorAll('.mr-tab').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.t)));

// ‚îÄ‚îÄ BUTTON WIRING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Script runs at end of body so DOM is already ready ‚Äî wire directly
(function wireButtons(){
  // Play button
  document.getElementById('playBtn').onclick=startGame;
  // Shop buttons
  document.getElementById('shopBtn').onclick=openShop;
  document.getElementById('shopClose').onclick=closeShop;
  document.getElementById('hudShopBtn').onclick=openShop;
  const opBtn=document.getElementById('ownerPanelBtn');
  if(opBtn) opBtn.onclick=openOwnerPanel;
  const opClose=document.getElementById('ownerPanelClose');
  if(opClose) opClose.onclick=closeOwnerPanel;
  document.getElementById('M_owner').addEventListener('click',e=>{if(e.target===e.currentTarget)closeOwnerPanel();});
  // Shop backdrop click to close
  document.getElementById('M_shop').addEventListener('click',e=>{if(e.target===e.currentTarget)closeShop();});
  // Owner toggle
  document.getElementById('ownerBtn').onclick=()=>{
    const w=document.getElementById('ownerWrap');
    w.style.display=w.style.display==='none'?'block':'none';
  };
  // Death screen
  document.getElementById('respBtn').onclick=()=>{
    document.getElementById('S_death').classList.add('hide');
    startGame();
  };
  document.getElementById('menuBtn').onclick=()=>{
    document.getElementById('S_death').classList.add('hide');
    document.getElementById('hud').style.display='none';
    document.getElementById('S_menu').classList.remove('hide');
    alive=false;
    if(rafId){cancelAnimationFrame(rafId);rafId=null;}
  };
  // Auth buttons
  document.getElementById('loginBtn').onclick=doLogin;
  document.getElementById('regBtn').onclick=doRegister;
  // Enter key shortcuts
  document.getElementById('ni').addEventListener('keydown',e=>{if(e.key==='Enter')startGame();});
  document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
  document.getElementById('reg-pass2').addEventListener('keydown',e=>{if(e.key==='Enter')doRegister();});
  // Restore saved auth
  const saved=loadAuthLocal();
  if(saved&&saved.accountId){setLoggedIn(saved);toast('Welcome back, '+saved.displayName+'!','ok');}
  // Focus name
  document.getElementById('ni').focus();
  fetchServerStats();
})();

// Settings
function setBK(k,btn){boostKey=k;document.querySelectorAll('#bk_shift,#bk_space').forEach(b=>b.classList.toggle('on',b===btn));}
function setFPS(v,btn){showFPS=v;['fps_on','fps_off'].forEach(id=>{const b=document.getElementById(id);if(b)b.classList.toggle('on',b===btn);});if(fpsD)fpsD.style.display=v?'block':'none';}
function setQ(q,btn){quality=q;['q_high','q_low'].forEach(id=>{const b=document.getElementById(id);if(b)b.classList.toggle('on',b===btn);});}
function setParticles(v,btn){particlesOn=v;['pt_on','pt_off'].forEach(id=>{const b=document.getElementById(id);if(b)b.classList.toggle('on',b===btn);});}
function setShake(v,btn){shakeOn=v;['sh_on','sh_off'].forEach(id=>{const b=document.getElementById(id);if(b)b.classList.toggle('on',b===btn);});}
function setMv(m,btn){
  moveMode=m;
  document.getElementById('mv_mouse').classList.toggle('on',m==='mouse');
  document.getElementById('mv_wasd').classList.toggle('on',m==='wasd');
  document.getElementById('wasd-hint').style.display=m==='wasd'?'block':'none';
  if(m==='wasd'){wasdKeys={up:false,down:false,left:false,right:false};}
}

function startGame(){
  if(loggedInAccount){
    myName=loggedInAccount.displayName;
  }else{
    myName=(document.getElementById('ni').value.trim()||'Player').slice(0,18);
  }
  ownerPass=document.getElementById('ownerInp').value||'';
  serverPlayers={}; serverOrbs={}; serverPowerUps={}; serverPortals={};
  parts=[]; frame=0; camX=0; camY=0;
  socket.emit('joinGame',{
    name:myName,
    skin:selSkin,
    password:ownerPass,
    playfabId:loggedInAccount?loggedInAccount.playfabId:null,
    accountId:null,
  });
}

function fetchServerStats(){
  fetch('/api/stats').then(r=>r.json()).then(d=>{
    const el=document.getElementById('srv-stats');
    if(el) el.innerHTML=`<span class="live-dot"></span>${d.players} online ¬∑ ${d.bots} bots ¬∑ ${d.orbs} orbs${d.activeEvent?' ¬∑ '+d.activeEvent:''}`;
  }).catch(()=>{});
}
setInterval(fetchServerStats,8000);

// ‚îÄ‚îÄ AUDIO (minimal, silent fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx=null;
function initAudio(){if(audioCtx)return;try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch{}}
function beep(freq,dur,vol){
  if(!audioCtx)return;
  try{
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.frequency.value=freq; g.gain.value=vol||.06;
    o.start(); o.stop(audioCtx.currentTime+dur);
    g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+dur);
  }catch{}
}
function sfxEat(){beep(880,.06,.04);beep(1100,.04,.025);}
function sfxKill(){
  beep(220,.12,.08);setTimeout(()=>beep(330,.1,.06),70);setTimeout(()=>beep(440,.1,.05),150);
  setTimeout(()=>beep(660,.15,.06),220);
}
function sfxDie(){beep(220,.08,.1);setTimeout(()=>beep(160,.15,.08),100);setTimeout(()=>beep(110,.5,.07),220);}
function sfxPU(){beep(660,.1,.06);setTimeout(()=>beep(880,.08,.05),90);setTimeout(()=>beep(1100,.1,.04),170);}
function sfxPortal(){beep(440,.1,.05);setTimeout(()=>beep(660,.08,.04),100);setTimeout(()=>beep(880,.08,.04),180);}
function sfxRage(){beep(110,.05,.08);setTimeout(()=>beep(165,.05,.07),60);setTimeout(()=>beep(220,.12,.09),110);}
function sfxShrink(){beep(880,.04,.05);setTimeout(()=>beep(440,.1,.06),50);}
function sfxStreak(){beep(660,.06,.06);setTimeout(()=>beep(880,.06,.05),80);setTimeout(()=>beep(1100,.1,.07),150);}


// ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loop(ts){
  if(!alive&&!dead){rafId=null;return;}
  rafId=requestAnimationFrame(loop);
  const dt=Math.min((ts-(lastTs||ts))/1000,.05); // Cap dt at 50ms not 100ms for smoother physics
  lastTs=ts; frame++;
  calcFPS(ts);
  if(particlesOn) updateParts(dt);
  updateShake(dt);
  if(dead) return;
  const now=Date.now();
  for(const type in activePowerUps){
    const end=activePowerUps[type]?.end||activePowerUps[type]?.until||0;
    if(end&&now>=end) delete activePowerUps[type];
  }
  // Smooth camera update every frame (not on network packet) for buttery 60fps movement
  const me=serverPlayers[myId];
  if(me&&me.segments&&me.segments.length){
    const h=me.segments[0];
    camX+=(h.x-gc.width/2-camX)*0.12;
    camY+=(h.y-gc.height/2-camY)*0.12;
    camX=Math.max(-gc.width*.1,Math.min(mapSz-gc.width*.9,camX));
    camY=Math.max(-gc.height*.1,Math.min(mapSz-gc.height*.9,camY));
    // Vignette near borders
    if(frame%4===0){
      const bd=Math.min(h.x,h.y,mapSz-h.x,mapSz-h.y);
      const vig=document.getElementById('vign');
      if(bd<500){
        const iv=Math.min(1,(500-bd)/500);
        vig.style.opacity=iv;
        vig.style.background=`radial-gradient(ellipse at 50% 50%,transparent 45%,rgba(255,34,51,${iv*.5}) 100%)`;
      }else{vig.style.opacity=0;}
    }
  }
  ctx.save();
  ctx.translate(shakeX,shakeY);
  drawBG(ts/1000);
  drawGrid();
  drawBorder();
  drawPortals();
  drawOrbs(ts/1000);
  drawPowerUps();
  for(const pid in serverPlayers){if(pid!==myId)drawSnake(serverPlayers[pid],false);}
  if(me) drawSnake(me,true);
  if(particlesOn) drawParts();
  ctx.restore();
  if(frame%8===0) drawMM();
  if(frame%6===0) updatePowerUpHUD();
  if(frame%4===0) updateHUD();
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
</script>

</body>
</html>
