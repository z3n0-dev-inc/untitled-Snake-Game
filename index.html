<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UNTITLED SNAKE GAME ‚Äî MADE BY Z3N0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
:root {
  --void: #000008;
  --deep: #05050f;
  --panel: rgba(0,255,140,0.04);
  --border: rgba(0,255,140,0.2);
  --glow: #00ff8c;
  --glow2: #ff2244;
  --glow3: #aa44ff;
  --gold: #ffd700;
  --text: #c8ffd4;
  --dim: rgba(200,255,212,0.5);
  --owner: #ffd700;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--void);}
body{font-family:'Rajdhani',sans-serif;color:var(--text);}
body::before{
  content:'';position:fixed;inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,140,0.015) 2px,rgba(0,255,140,0.015) 4px);
  pointer-events:none;z-index:9999;
}
#gameCanvas{position:fixed;inset:0;display:none;cursor:none;}
#cursor{
  position:fixed;width:20px;height:20px;
  border:2px solid var(--glow);border-radius:50%;
  pointer-events:none;z-index:10000;
  transform:translate(-50%,-50%);
  transition:width 0.1s,height 0.1s;
  box-shadow:0 0 10px var(--glow),inset 0 0 6px rgba(0,255,140,0.3);
}
#cursor::after{content:'';position:absolute;top:50%;left:50%;width:4px;height:4px;background:var(--glow);border-radius:50%;transform:translate(-50%,-50%);}
.screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;}
#menuScreen{overflow-y:auto;align-items:flex-start;}
.screen.hidden{display:none!important;}
#menuScreen{
  background:radial-gradient(ellipse at 50% 30%,rgba(0,255,140,0.08) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 70%,rgba(170,68,255,0.06) 0%,transparent 50%),
             var(--void);
  flex-direction:column;gap:0;
}
.menu-bg-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.menu-particle{position:absolute;width:2px;height:2px;background:var(--glow);border-radius:50%;animation:float-up linear infinite;opacity:0;}
@keyframes float-up{0%{opacity:0;transform:translateY(100vh) scale(1);}10%{opacity:1;}90%{opacity:0.5;}100%{opacity:0;transform:translateY(-20px) scale(0);}}
.logo-wrap{position:relative;text-align:center;margin-bottom:24px;}
.logo-z3n0{
  font-family:'Orbitron',monospace;font-size:clamp(60px,10vw,120px);font-weight:900;
  background:linear-gradient(135deg,#00ff8c,#aa44ff,#ff2244,#ffd700,#00ff8c);
  background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:gradientShift 3s ease infinite;letter-spacing:-2px;line-height:1;
  filter:drop-shadow(0 0 30px rgba(0,255,140,0.5));
}
@keyframes gradientShift{0%,100%{background-position:0% 50%;}50%{background-position:100% 50%;}}
.logo-sub{font-family:'Orbitron',monospace;font-size:clamp(12px,2vw,18px);letter-spacing:8px;color:var(--dim);margin-top:4px;animation:pulse 2s ease infinite;}
.logo-owner-tag{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:4px;color:var(--gold);margin-top:6px;animation:pulse 1.5s ease infinite;}
@keyframes pulse{0%,100%{opacity:0.5;}50%{opacity:1;}}
.owner-crown{position:absolute;top:-30px;left:50%;transform:translateX(-50%);font-size:30px;animation:crown-bounce 1.5s ease infinite;}
@keyframes crown-bounce{0%,100%{transform:translateX(-50%) translateY(0);}50%{transform:translateX(-50%) translateY(-8px);}}

/* Z3N0 watermark on menu bg */
.z3n0-watermark{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  font-family:'Orbitron',monospace;font-size:11px;letter-spacing:6px;
  color:rgba(255,215,0,0.15);pointer-events:none;white-space:nowrap;
}

.menu-panel{
  background:var(--panel);border:1px solid var(--border);border-radius:4px;
  padding:24px;width:min(460px,90vw);
  backdrop-filter:blur(20px);
  box-shadow:0 0 60px rgba(0,255,140,0.05),inset 0 0 60px rgba(0,255,140,0.02);
  position:relative;
}
.menu-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--glow),transparent);}

/* MENU TABS */
.menu-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px;}
.menu-tab-btn{
  font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;
  padding:6px 12px;border-radius:2px;border:1px solid transparent;
  cursor:pointer;background:none;color:var(--dim);transition:all 0.2s;
}
.menu-tab-btn:hover{color:var(--glow);border-color:rgba(0,255,140,0.2);}
.menu-tab-btn.active{color:var(--glow);border-color:var(--glow);background:rgba(0,255,140,0.05);}
.menu-tab-content{display:none;}
.menu-tab-content.active{display:block;}

.input-group{display:flex;flex-direction:column;gap:6px;margin-bottom:16px;}
.input-label{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;}
.game-input{
  background:rgba(0,255,140,0.04);border:1px solid rgba(0,255,140,0.15);border-radius:2px;
  padding:12px 16px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:500;
  outline:none;transition:border-color 0.2s,box-shadow 0.2s;width:100%;
}
.game-input:focus{border-color:var(--glow);box-shadow:0 0 20px rgba(0,255,140,0.1);}

.skin-selector{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px;max-height:260px;overflow-y:auto;}
.skin-opt{
  aspect-ratio:1;border-radius:4px;border:2px solid rgba(255,255,255,0.1);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:20px;transition:all 0.2s;position:relative;overflow:hidden;
}
.skin-opt:hover{transform:scale(1.1);border-color:white;}
.skin-opt.selected{border-color:var(--glow);box-shadow:0 0 15px rgba(0,255,140,0.4);transform:scale(1.15);}
.skin-opt.owner-only{border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,0.3);}
.skin-opt.owner-only::after{content:'üëë';position:absolute;bottom:1px;right:1px;font-size:10px;}
.skin-opt.locked{opacity:0.3;filter:grayscale(1);cursor:not-allowed;}

.btn{
  font-family:'Orbitron',monospace;font-size:12px;letter-spacing:2px;
  padding:14px 28px;border-radius:2px;border:none;cursor:pointer;
  text-transform:uppercase;transition:all 0.2s;position:relative;overflow:hidden;width:100%;
}
.btn::before{content:'';position:absolute;inset:0;background:white;opacity:0;transition:opacity 0.2s;}
.btn:hover::before{opacity:0.05;}
.btn:active::before{opacity:0.1;}
.btn-primary{background:linear-gradient(135deg,rgba(0,255,140,0.2),rgba(0,255,140,0.1));color:var(--glow);border:1px solid var(--glow);box-shadow:0 0 20px rgba(0,255,140,0.15);}
.btn-primary:hover{box-shadow:0 0 40px rgba(0,255,140,0.3);transform:translateY(-1px);}
.btn-danger{background:linear-gradient(135deg,rgba(255,34,68,0.2),rgba(255,34,68,0.1));color:var(--glow2);border:1px solid var(--glow2);}
.btn-gold{background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,215,0,0.1));color:var(--gold);border:1px solid var(--gold);}
.btn-sm{padding:8px 16px;font-size:10px;width:auto;}
.btn-row{display:flex;gap:8px;margin-top:8px;}

/* ======================= SETTINGS TAB ======================= */
.setting-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 0;border-bottom:1px solid rgba(0,255,140,0.08);
}
.setting-label{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;color:var(--dim);}
.setting-desc{font-size:12px;color:rgba(200,255,212,0.3);margin-top:2px;}
.control-radio-group{display:flex;gap:6px;flex-wrap:wrap;}
.control-radio{
  padding:6px 12px;border-radius:2px;
  border:1px solid rgba(0,255,140,0.2);
  cursor:pointer;font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;
  color:var(--dim);background:none;transition:all 0.2s;
}
.control-radio:hover{border-color:var(--glow);color:var(--glow);}
.control-radio.active{border-color:var(--glow);color:var(--glow);background:rgba(0,255,140,0.08);}

/* ======================= COSMETICS TAB ======================= */
.coin-balance{
  display:flex;align-items:center;gap:8px;
  background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.2);
  border-radius:2px;padding:8px 16px;margin-bottom:16px;
}
.coin-amount{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:var(--gold);}
.coin-label{font-size:11px;letter-spacing:2px;color:rgba(255,215,0,0.5);}

.cosmetic-section-label{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:var(--dim);margin:12px 0 8px;}
.cosmetic-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px;}
.cosmetic-card{
  border-radius:4px;border:1px solid rgba(0,255,140,0.1);
  padding:10px 8px;text-align:center;cursor:pointer;
  transition:all 0.2s;position:relative;background:rgba(0,255,140,0.02);
}
.cosmetic-card:hover{border-color:var(--glow);background:rgba(0,255,140,0.06);transform:translateY(-1px);}
.cosmetic-card.owned{border-color:rgba(0,255,140,0.3);}
.cosmetic-card.equipped{border-color:var(--glow);background:rgba(0,255,140,0.1);box-shadow:0 0 12px rgba(0,255,140,0.2);}
.cosmetic-card.owner-only{border-color:rgba(255,215,0,0.3);background:rgba(255,215,0,0.03);}
.cosmetic-card.owner-only.owned{border-color:var(--gold);}
.cosmetic-card.locked-shop{opacity:0.6;}
.cosmetic-icon{font-size:22px;display:block;margin-bottom:4px;}
.cosmetic-name{font-size:10px;font-weight:600;color:var(--text);line-height:1.2;}
.cosmetic-price{font-family:'Orbitron',monospace;font-size:9px;color:var(--gold);margin-top:3px;}
.cosmetic-badge{position:absolute;top:3px;right:3px;font-size:8px;}
.equipped-label{
  position:absolute;bottom:3px;left:50%;transform:translateX(-50%);
  font-family:'Orbitron',monospace;font-size:7px;letter-spacing:1px;
  color:var(--glow);white-space:nowrap;
}

/* ======================= HUD ======================= */
#hud{position:fixed;inset:0;pointer-events:none;z-index:200;display:none;}
#hud-score{
  position:absolute;top:20px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,8,0.8);border:1px solid var(--border);
  border-radius:2px;padding:8px 24px;text-align:center;backdrop-filter:blur(10px);
}
#hud-score .val{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--glow);text-shadow:0 0 20px var(--glow);}
#hud-score .label{font-size:10px;letter-spacing:3px;color:var(--dim);}

/* Coin HUD */
#hud-coins{
  position:absolute;top:90px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,8,0.8);border:1px solid rgba(255,215,0,0.2);
  border-radius:2px;padding:4px 16px;text-align:center;
  font-family:'Orbitron',monospace;font-size:13px;color:var(--gold);
  white-space:nowrap;
}

#minimap{position:absolute;bottom:20px;right:20px;width:160px;height:160px;background:rgba(0,0,8,0.85);border:1px solid var(--border);border-radius:2px;overflow:hidden;}
#minimapCanvas{width:100%;height:100%;}

#leaderboard{position:absolute;top:20px;right:20px;width:220px;background:rgba(0,0,8,0.85);border:1px solid var(--border);border-radius:2px;padding:12px;backdrop-filter:blur(10px);}
#leaderboard h3{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--glow);margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px;}
.lb-entry{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:13px;font-weight:500;border-bottom:1px solid rgba(0,255,140,0.05);}
.lb-rank{font-family:'Orbitron',monospace;font-size:10px;color:var(--dim);width:16px;flex-shrink:0;}
.lb-rank.top1{color:var(--gold);}
.lb-rank.top2{color:#c0c0c0;}
.lb-rank.top3{color:#cd7f32;}
.lb-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lb-len{font-family:'Space Mono',monospace;font-size:11px;color:var(--dim);}
.lb-name.is-owner{color:var(--gold);}

#killfeed{position:absolute;top:20px;left:20px;width:280px;display:flex;flex-direction:column;gap:4px;pointer-events:none;}
.kf-entry{background:rgba(0,0,8,0.8);border-left:2px solid var(--glow2);padding:6px 10px;font-size:12px;animation:kf-in 0.3s ease,kf-out 0.3s ease 4.7s forwards;border-radius:0 2px 2px 0;}
@keyframes kf-in{from{opacity:0;transform:translateX(-20px);}to{opacity:1;transform:translateX(0);}}
@keyframes kf-out{to{opacity:0;transform:translateX(-20px);}}

#boostbar{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:200px;background:rgba(0,0,8,0.8);border:1px solid var(--border);border-radius:2px;padding:8px 12px;text-align:center;}
.boost-label{font-size:10px;letter-spacing:2px;color:var(--dim);margin-bottom:4px;}
.boost-track{background:rgba(255,255,255,0.05);border-radius:2px;height:4px;overflow:hidden;}
.boost-fill{height:100%;background:linear-gradient(90deg,var(--glow),#00ffff);border-radius:2px;transition:width 0.1s;width:100%;}

#owner-tag-hud{
  position:absolute;bottom:60px;left:50%;transform:translateX(-50%);
  display:none;
  background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,215,0,0.05));
  border:1px solid var(--gold);border-radius:2px;padding:4px 16px;
  font-family:'Orbitron',monospace;font-size:11px;letter-spacing:3px;color:var(--gold);
  animation:owner-pulse 2s ease infinite;
}
@keyframes owner-pulse{0%,100%{box-shadow:0 0 10px rgba(255,215,0,0.2);}50%{box-shadow:0 0 25px rgba(255,215,0,0.5);}}

#eventBanner{
  position:absolute;top:80px;left:50%;transform:translateX(-50%);
  background:linear-gradient(135deg,rgba(170,68,255,0.3),rgba(255,34,68,0.3));
  border:1px solid var(--glow3);border-radius:2px;padding:10px 24px;text-align:center;display:none;
  animation:event-pulse 1s ease infinite;
}
@keyframes event-pulse{0%,100%{box-shadow:0 0 20px rgba(170,68,255,0.3);}50%{box-shadow:0 0 40px rgba(170,68,255,0.6);}}
.event-title{font-family:'Orbitron',monospace;font-size:14px;letter-spacing:2px;background:linear-gradient(90deg,var(--glow3),var(--glow2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

#sysmsg{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(0,0,8,0.9);border:1px solid var(--glow3);border-radius:2px;
  padding:12px 24px;font-family:'Orbitron',monospace;font-size:14px;letter-spacing:2px;
  color:var(--glow3);display:none;text-align:center;z-index:300;
}

/* Z3N0 is watching banner (always visible in game) */
#z3n0-watermark-game{
  position:absolute;top:50%;right:-60px;transform:translateY(-50%) rotate(90deg);
  font-family:'Orbitron',monospace;font-size:9px;letter-spacing:4px;
  color:rgba(255,215,0,0.06);pointer-events:none;white-space:nowrap;
}

/* ======================= DEATH SCREEN ======================= */
#deathScreen{background:rgba(0,0,8,0.95);flex-direction:column;gap:24px;z-index:500;}
.death-title{font-family:'Orbitron',monospace;font-size:clamp(40px,8vw,80px);font-weight:900;color:var(--glow2);text-shadow:0 0 40px rgba(255,34,68,0.6);animation:glitch 0.5s ease infinite alternate;}
@keyframes glitch{0%{text-shadow:2px 0 var(--glow),‚àí2px 0 var(--glow2),0 0 40px rgba(255,34,68,0.6);}100%{text-shadow:-2px 0 var(--glow),2px 0 var(--glow2),0 0 40px rgba(255,34,68,0.6);}}
.death-info{font-size:18px;color:var(--dim);letter-spacing:2px;text-align:center;}
.death-coins-earned{font-family:'Orbitron',monospace;font-size:14px;color:var(--gold);letter-spacing:2px;text-align:center;}
.death-stats{display:flex;gap:32px;background:var(--panel);border:1px solid var(--border);border-radius:2px;padding:16px 32px;}
.death-stat{text-align:center;}
.death-stat .val{font-family:'Orbitron',monospace;font-size:28px;color:var(--glow);}
.death-stat .lbl{font-size:11px;letter-spacing:2px;color:var(--dim);}
.death-buttons{display:flex;gap:12px;}

/* ======================= OWNER PANEL ======================= */
#ownerPanel{position:fixed;inset:0;z-index:600;display:flex;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);}
#ownerPanel.hidden{display:none!important;}
.owner-sidebar{width:220px;background:rgba(0,0,0,0.9);border-right:1px solid rgba(255,215,0,0.2);display:flex;flex-direction:column;padding:0;flex-shrink:0;}
.owner-sidebar-header{padding:24px 16px;border-bottom:1px solid rgba(255,215,0,0.2);text-align:center;}
.owner-sidebar-header .crown-big{font-size:36px;display:block;margin-bottom:8px;}
.owner-sidebar-header h2{font-family:'Orbitron',monospace;font-size:14px;letter-spacing:2px;color:var(--gold);}
.owner-sidebar-header p{font-size:11px;color:rgba(255,215,0,0.5);}
.owner-nav{display:flex;flex-direction:column;padding:12px 0;flex:1;}
.owner-nav-btn{
  padding:12px 20px;display:flex;align-items:center;gap:10px;cursor:pointer;
  transition:all 0.15s;border-left:3px solid transparent;font-size:13px;font-weight:600;
  color:rgba(255,215,0,0.5);background:none;border-top:none;border-right:none;border-bottom:none;
  text-align:left;font-family:'Rajdhani',sans-serif;
}
.owner-nav-btn:hover{background:rgba(255,215,0,0.05);color:var(--gold);border-left-color:rgba(255,215,0,0.3);}
.owner-nav-btn.active{background:rgba(255,215,0,0.08);color:var(--gold);border-left-color:var(--gold);}
.owner-nav-icon{font-size:16px;width:20px;}
.owner-main{flex:1;background:rgba(0,0,8,0.95);display:flex;flex-direction:column;overflow:hidden;}
.owner-topbar{padding:16px 24px;border-bottom:1px solid rgba(255,215,0,0.1);display:flex;align-items:center;justify-content:space-between;}
.owner-topbar h1{font-family:'Orbitron',monospace;font-size:16px;letter-spacing:3px;color:var(--gold);}
.owner-content{flex:1;overflow-y:auto;padding:24px;}
.owner-content::-webkit-scrollbar{width:4px;}
.owner-content::-webkit-scrollbar-track{background:transparent;}
.owner-content::-webkit-scrollbar-thumb{background:rgba(255,215,0,0.2);border-radius:2px;}
.owner-tab{display:none;}
.owner-tab.active{display:block;}
.o-card{background:rgba(255,215,0,0.03);border:1px solid rgba(255,215,0,0.1);border-radius:4px;padding:20px;margin-bottom:16px;}
.o-card h3{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:3px;color:rgba(255,215,0,0.6);margin-bottom:16px;border-bottom:1px solid rgba(255,215,0,0.1);padding-bottom:8px;}
.player-table{width:100%;border-collapse:collapse;}
.player-table th{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;color:rgba(255,215,0,0.4);padding:6px 8px;text-align:left;border-bottom:1px solid rgba(255,215,0,0.1);}
.player-table td{padding:8px 8px;font-size:13px;border-bottom:1px solid rgba(255,215,0,0.05);vertical-align:middle;}
.player-table tr:hover td{background:rgba(255,215,0,0.03);}
.o-input{background:rgba(255,215,0,0.04);border:1px solid rgba(255,215,0,0.15);border-radius:2px;padding:10px 14px;color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:15px;outline:none;width:100%;margin-bottom:8px;}
.o-input:focus{border-color:var(--gold);box-shadow:0 0 15px rgba(255,215,0,0.1);}
.o-select{background:rgba(0,0,0,0.5);border:1px solid rgba(255,215,0,0.15);border-radius:2px;padding:10px 14px;color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:15px;outline:none;width:100%;margin-bottom:8px;cursor:pointer;}
.event-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;}
.event-card{background:rgba(170,68,255,0.05);border:1px solid rgba(170,68,255,0.2);border-radius:4px;padding:16px;text-align:center;cursor:pointer;transition:all 0.2s;}
.event-card:hover{background:rgba(170,68,255,0.1);border-color:var(--glow3);transform:translateY(-2px);}
.event-card .event-icon{font-size:32px;display:block;margin-bottom:8px;}
.event-card .event-name{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:1px;color:var(--glow3);}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;}
.stat-card{background:rgba(255,215,0,0.03);border:1px solid rgba(255,215,0,0.1);border-radius:4px;padding:16px;text-align:center;}
.stat-card .sv{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--gold);}
.stat-card .sl{font-size:10px;letter-spacing:2px;color:rgba(255,215,0,0.4);}
.o-alert{padding:10px 14px;border-radius:2px;margin-bottom:12px;font-size:13px;display:none;}
.o-alert.success{background:rgba(0,255,140,0.1);border:1px solid var(--glow);color:var(--glow);}
.o-alert.error{background:rgba(255,34,68,0.1);border:1px solid var(--glow2);color:var(--glow2);}

#toast-container{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column;gap:8px;align-items:center;}
.toast{background:rgba(0,0,8,0.95);border:1px solid var(--glow);border-radius:2px;padding:10px 20px;font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--glow);animation:toast-in 0.3s ease;white-space:nowrap;}
.toast.error{border-color:var(--glow2);color:var(--glow2);}
.toast.gold{border-color:var(--gold);color:var(--gold);}
@keyframes toast-in{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

#broadcastBanner{
  position:fixed;bottom:0;left:0;right:0;
  background:linear-gradient(90deg,rgba(255,215,0,0.15),rgba(255,215,0,0.05),rgba(255,215,0,0.15));
  border-top:1px solid rgba(255,215,0,0.3);padding:10px 24px;
  font-family:'Orbitron',monospace;font-size:12px;letter-spacing:2px;color:var(--gold);
  text-align:center;z-index:800;display:none;animation:broadcast-glow 2s ease infinite;
}
@keyframes broadcast-glow{0%,100%{box-shadow:0 -4px 20px rgba(255,215,0,0.1);}50%{box-shadow:0 -4px 40px rgba(255,215,0,0.2);}}

#musicControls{position:fixed;bottom:20px;left:20px;z-index:300;display:flex;align-items:center;gap:8px;background:rgba(0,0,8,0.8);border:1px solid var(--border);border-radius:2px;padding:8px 12px;pointer-events:auto;}
.music-btn{background:none;border:none;cursor:pointer;font-size:16px;padding:2px;opacity:0.6;transition:opacity 0.2s;}
.music-btn:hover{opacity:1;}
.music-vis{display:flex;gap:2px;align-items:center;height:16px;}
.music-bar{width:3px;background:var(--glow);border-radius:2px;animation:music-bounce linear infinite;}
.music-bar:nth-child(1){height:6px;animation-duration:0.4s;}
.music-bar:nth-child(2){height:12px;animation-duration:0.6s;}
.music-bar:nth-child(3){height:8px;animation-duration:0.5s;}
.music-bar:nth-child(4){height:14px;animation-duration:0.7s;}
.music-bar:nth-child(5){height:6px;animation-duration:0.45s;}
@keyframes music-bounce{0%,100%{transform:scaleY(1);}50%{transform:scaleY(0.3);}}
.music-paused .music-bar{animation-play-state:paused;}

@media(max-width:600px){
  .menu-panel{padding:16px;}
  .skin-selector{grid-template-columns:repeat(5,1fr);}
  .owner-sidebar{width:60px;}
  .owner-nav-btn span{display:none;}
  .owner-sidebar-header h2,.owner-sidebar-header p,.crown-text{display:none;}
}
</style>
</head>
<body>
<div id="cursor"></div>

<!-- ==================== MENU SCREEN ==================== -->
<div class="screen" id="menuScreen">
  <div class="menu-bg-particles" id="bgParticles"></div>
  <div class="z3n0-watermark">Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0</div>

  <div style="display:flex;flex-direction:column;align-items:center;gap:24px;width:100%;max-width:500px;padding:20px;z-index:1;margin:auto;">
    <div class="logo-wrap">
      <span class="owner-crown">üëë</span>
      <div class="logo-z3n0">Z3N0</div>
      <div class="logo-sub">SNAKE REALM ¬∑ EST. 2026</div>
      <div class="logo-owner-tag">CREATED & OWNED BY Z3N0</div>
    </div>

    <div class="menu-panel">
      <!-- Menu tab buttons -->
      <div class="menu-tabs">
        <button class="menu-tab-btn active" data-mtab="play">PLAY</button>
        <button class="menu-tab-btn" data-mtab="cosmetics">COSMETICS</button>
        <button class="menu-tab-btn" data-mtab="account">ACCOUNT</button>
        <button class="menu-tab-btn" data-mtab="settings">SETTINGS</button>
      </div>

      <!-- PLAY TAB -->
      <div class="menu-tab-content active" id="mtab-play">
        <div class="input-group">
          <span class="input-label">Your Name</span>
          <input class="game-input" id="nameInput" type="text" placeholder="Enter your name..." maxlength="20" autocomplete="off">
        </div>
        <div class="input-group">
          <span class="input-label">Clan Tag <span style="color:var(--dim);font-size:9px;">(optional, max 8 chars)</span></span>
          <input class="game-input" id="tagInput" type="text" placeholder="e.g. GOON!" maxlength="8" autocomplete="off" style="text-transform:uppercase;">
        </div>
        <div class="input-group">
          <span class="input-label">Choose Skin</span>
          <div class="skin-selector" id="skinSelector"></div>
        </div>
        <div class="input-group" id="ownerPassGroup" style="display:none;">
          <span class="input-label">Owner Code</span>
          <input class="game-input" id="ownerPass" type="password" placeholder="Enter owner password..." autocomplete="off">
        </div>
        <button class="btn btn-primary" id="playBtn" style="margin-bottom:8px;">PLAY</button>
        <div class="btn-row">
          <button class="btn btn-gold btn-sm" id="ownerToggleBtn">OWNER</button>
          <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);" id="howToBtn">? HOW TO PLAY</button>
        </div>
      </div>

      <!-- COSMETICS TAB -->
      <div class="menu-tab-content" id="mtab-cosmetics">
        <div class="coin-balance">
          <span style="font-size:20px;">üí∞</span>
          <div>
            <div class="coin-amount" id="menuCoinBalance">0</div>
            <div class="coin-label">COINS ¬∑ ENTER GAME TO EARN</div>
          </div>
        </div>
        <p style="font-size:12px;color:var(--dim);margin-bottom:12px;">Join the game to buy & equip cosmetics. Earn coins by eating orbs and killing players.</p>
        <div class="cosmetic-section-label">TRAILS</div>
        <div id="menuCosmeticPreview" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
          <!-- populated after join -->
          <div style="grid-column:1/-1;text-align:center;font-size:12px;color:var(--dim);padding:16px;">Enter the game to access your cosmetics</div>
        </div>
      </div>

      <!-- ACCOUNT TAB -->
      <div class="menu-tab-content" id="mtab-account">
        <div style="margin-bottom:16px;">
          <div style="font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);margin-bottom:8px;">PLAYFAB ACCOUNT LINK</div>
          <p style="font-size:12px;color:var(--dim);line-height:1.6;margin-bottom:12px;">Link your account to save progress across devices and earn GD currency rewards.</p>

          <!-- Link status indicator -->
          <div id="pfStatusRow" style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:10px;background:rgba(0,255,140,0.03);border:1px solid var(--border);border-radius:2px;">
            <div id="pfStatusDot" style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.2);flex-shrink:0;"></div>
            <span id="pfStatusText" style="font-size:12px;color:var(--dim);letter-spacing:1px;">NOT LINKED</span>
          </div>

          <!-- Display name input -->
          <div class="input-group">
            <span class="input-label">PLAYFAB DISPLAY NAME</span>
            <input class="game-input" id="pfDisplayName" type="text" placeholder="Enter display name..." maxlength="25" autocomplete="off">
          </div>

          <!-- Link button -->
          <button class="btn btn-primary" id="pfLinkBtn" style="margin-bottom:8px;">üîó LINK TO PLAYFAB</button>
          <div id="pfError" style="display:none;margin-top:8px;padding:8px;background:rgba(255,34,68,0.1);border:1px solid rgba(255,34,68,0.3);border-radius:2px;font-size:12px;color:#ff4455;"></div>
          <div id="pfSuccess" style="display:none;margin-top:8px;padding:8px;background:rgba(0,255,140,0.08);border:1px solid rgba(0,255,140,0.2);border-radius:2px;font-size:12px;color:var(--glow);"></div>
        </div>

        <!-- Stats panel (shown after linking) -->
        <div id="pfStatsPanel" style="display:none;">
          <div style="font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);margin-bottom:8px;">CLOUD STATS</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div style="padding:10px;background:rgba(0,255,140,0.03);border:1px solid var(--border);border-radius:2px;">
              <div style="font-size:10px;color:var(--dim);letter-spacing:1px;">TITLE ID</div>
              <div id="pfTitleId" style="font-size:13px;color:var(--text);margin-top:2px;">‚Äî</div>
            </div>
            <div style="padding:10px;background:rgba(0,255,140,0.03);border:1px solid var(--border);border-radius:2px;">
              <div style="font-size:10px;color:var(--dim);letter-spacing:1px;">PLAYFAB ID</div>
              <div id="pfPlayfabId" style="font-size:11px;color:var(--text);margin-top:2px;word-break:break-all;">‚Äî</div>
            </div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:var(--dim);">GD Currency synced to cloud ‚úì</div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div class="menu-tab-content" id="mtab-settings">
        <div class="setting-row">
          <div>
            <div class="setting-label">CONTROL SCHEME</div>
            <div class="setting-desc">How you steer your snake</div>
          </div>
          <div class="control-radio-group" id="controlSchemeGroup">
            <button class="control-radio active" data-scheme="mouse">üñ±Ô∏è MOUSE</button>
            <button class="control-radio" data-scheme="wasd">WASD</button>
            <button class="control-radio" data-scheme="arrows">ARROWS</button>
            <button class="control-radio" data-scheme="both">WASD+‚Üë</button>
          </div>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">BOOST KEY</div>
            <div class="setting-desc">Keyboard boost (also works: hold click)</div>
          </div>
          <div class="control-radio-group" id="boostKeyGroup">
            <button class="control-radio active" data-boost="shift">SHIFT</button>
            <button class="control-radio" data-boost="space">SPACE</button>
            <button class="control-radio" data-boost="both_boost">BOTH</button>
          </div>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">MOUSE STEERING</div>
            <div class="setting-desc">Even when using keyboard</div>
          </div>
          <div class="control-radio-group" id="mouseAlwaysGroup">
            <button class="control-radio active" data-mouse="on">ON</button>
            <button class="control-radio" data-mouse="off">OFF</button>
          </div>
        </div>
        <div style="margin-top:16px;padding:10px;background:rgba(0,255,140,0.03);border:1px solid rgba(0,255,140,0.1);border-radius:2px;font-size:12px;color:var(--dim);line-height:1.6;">
          Settings are saved automatically.<br>
          Owner panel: <span style="color:var(--gold);">F1</span> key (in-game, owner only)
        </div>
      </div>
    </div>

    <div id="menuStats" style="display:flex;gap:24px;font-size:13px;color:var(--dim);">
      <span>üêç <span id="statPlayers">0</span> online</span>
      <span>üåü <span id="statOrbs">0</span> orbs</span>
      <span id="statEvent" style="display:none;color:var(--glow3);">‚ö° EVENT ACTIVE</span>
    </div>

    <!-- Z3N0 footer -->
    <div style="font-family:'Orbitron',monospace;font-size:9px;letter-spacing:4px;color:rgba(255,215,0,0.3);">
       Z3N0'S SNAKE GAME ‚Äî ALL RIGHTS RESERVED
    </div>
  </div>
</div>

<!-- ==================== GAME CANVAS ==================== -->
<canvas id="gameCanvas"></canvas>

<!-- ==================== HUD ==================== -->
<div id="hud">
  <div id="hud-score">
    <div class="val" id="scoreVal">0</div>
    <div class="label">SCORE ¬∑ <span id="lengthVal">0</span> SEGMENTS</div>
  </div>
  <div id="hud-coins">üí∞ <span id="hudCoins">0</span> coins</div>
  <div id="killfeed"></div>
  <div id="leaderboard">
    <h3>LEADERBOARD</h3>
    <div id="lbList"></div>
  </div>
  <div id="minimap"><canvas id="minimapCanvas" width="160" height="160"></canvas></div>
  <div id="boostbar" style="pointer-events:auto;">
    <div class="boost-label" id="boostLabel">BOOST [HOLD CLICK]</div>
    <div class="boost-track"><div class="boost-fill" id="boostFill"></div></div>
  </div>
  <div id="owner-tag-hud"> Z3N0 ¬∑ Gooner  OWNER ¬∑ CREATOR OF THIS GAME</div>
  <div id="eventBanner"><div class="event-title" id="eventTitle">EVENT ACTIVE</div></div>
  <div id="sysmsg"></div>
  <div id="z3n0-watermark-game">Z3N0</div>

  <!-- In-game cosmetics button -->
  <button id="upgradeBtn" onclick="toggleUpgradePanel()" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:200;font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;padding:6px 16px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.4);color:#ffd700;cursor:pointer;border-radius:2px;display:none;">‚¨Ü UPGRADES</button>

<div id="upgradePanel" style="position:fixed;bottom:80px;left:20px;z-index:300;background:rgba(0,0,8,0.95);border:1px solid rgba(255,215,0,0.3);border-radius:4px;padding:16px;width:260px;display:none;backdrop-filter:blur(10px);">
  <div style="font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:#ffd700;margin-bottom:12px;border-bottom:1px solid rgba(255,215,0,0.2);padding-bottom:8px;">‚¨Ü UPGRADES</div>
  <div style="font-size:11px;color:rgba(200,255,212,0.5);margin-bottom:10px;">Coins: <span id="upgradeCoinDisplay" style="color:#ffd700;">0</span></div>
  <div id="upgradeList"></div>
</div>

<div id="inGameCosmeticsBtn" style="position:absolute;top:20px;left:320px;pointer-events:auto;display:none;">
    <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);padding:6px 12px;font-size:9px;" onclick="openIngameCosmetics()">üé® COSMETICS</button>
  </div>
</div>

<!-- ==================== IN-GAME COSMETICS PANEL ==================== -->
<div id="ingameCosmeticsPanel" style="position:fixed;inset:0;z-index:550;display:none;background:rgba(0,0,8,0.92);backdrop-filter:blur(10px);overflow-y:auto;">
  <div style="max-width:600px;margin:0 auto;padding:32px 20px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
      <div>
        <h2 style="font-family:'Orbitron',monospace;font-size:18px;color:var(--glow);">üé® COSMETICS SHOP</h2>
        <div style="font-size:12px;color:var(--dim);">Earn coins by eating orbs & killing players</div>
      </div>
      <div style="display:flex;align-items:center;gap:16px;">
        <div class="coin-balance" style="margin:0;">
          <span style="font-size:18px;">üí∞</span>
          <div><div class="coin-amount" id="ingameCoinBalance">0</div><div class="coin-label">COINS</div></div>
        </div>
        <button class="btn btn-sm btn-danger" onclick="closeIngameCosmetics()">‚úï CLOSE</button>
      </div>
    </div>

    <!-- Equipped display -->
    <div style="background:rgba(0,255,140,0.03);border:1px solid var(--border);border-radius:4px;padding:16px;margin-bottom:20px;">
      <div style="font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);margin-bottom:10px;">CURRENTLY EQUIPPED</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;">
        <div><span style="font-size:11px;color:var(--dim);">TRAIL:</span> <span id="equippedTrailDisplay" style="color:var(--glow);font-size:13px;">None</span></div>
        <div><span style="font-size:11px;color:var(--dim);">TITLE:</span> <span id="equippedTitleDisplay" style="color:var(--gold);font-size:13px;">None</span></div>
        <div><span style="font-size:11px;color:var(--dim);">BADGE:</span> <span id="equippedBadgeDisplay" style="font-size:16px;">‚Äî</span></div>
      </div>
    </div>

    <div id="cosmeticsShopContent"></div>
  </div>
</div>

<!-- ==================== DEATH SCREEN ==================== -->
<div class="screen hidden" id="deathScreen">
  <div class="death-title">ELIMINATED</div>
  <div class="death-info" id="deathKiller">Killed by the void</div>
  <div class="death-coins-earned" id="deathCoinsEarned"></div>
  <div class="death-stats">
    <div class="death-stat"><div class="val" id="deathScore">0</div><div class="lbl">SCORE</div></div>
    <div class="death-stat"><div class="val" id="deathLength">0</div><div class="lbl">MAX LENGTH</div></div>
    <div class="death-stat"><div class="val" id="deathRank">‚Äî</div><div class="lbl">RANK</div></div>
  </div>
  <div class="death-buttons">
    <button class="btn btn-primary" id="respawnBtn">‚Ü∫ RESPAWN</button>
    <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);" id="menuBtn">MENU</button>
  </div>
  <div style="font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:rgba(255,215,0,0.2);margin-top:8px;">Z3N0'S SERPENT REALM</div>
</div>

<!-- ==================== OWNER PANEL ==================== -->
<div id="ownerPanel" class="hidden">
  <div class="owner-sidebar">
    <div class="owner-sidebar-header">
      <span class="crown-big">üëë</span>
      <h2 class="crown-text">Z3N0</h2>
      <p>OWNER</p>
    </div>
    <nav class="owner-nav">
      <button class="owner-nav-btn active" data-tab="dashboard"><span class="owner-nav-icon">üìä</span><span>Dashboard</span></button>
      <button class="owner-nav-btn" data-tab="players"><span class="owner-nav-icon">üë•</span><span>Players</span></button>
      <button class="owner-nav-btn" data-tab="actions"><span class="owner-nav-icon">‚ö°</span><span>Actions</span></button>
      <button class="owner-nav-btn" data-tab="events"><span class="owner-nav-icon">üåü</span><span>Events</span></button>
      <button class="owner-nav-btn" data-tab="broadcast"><span class="owner-nav-icon">üì¢</span><span>Broadcast</span></button>
      <button class="owner-nav-btn" data-tab="skins"><span class="owner-nav-icon">üé®</span><span>Give Skins</span></button>
      <button class="owner-nav-btn" data-tab="ownercosmetics"><span class="owner-nav-icon">üíé</span><span>Cosmetics</span></button>
    </nav>
  </div>
  <div class="owner-main">
    <div class="owner-topbar">
      <h1>üëë Z3N0 OWNER CONTROL CENTER</h1>
      <button class="btn btn-sm btn-danger" id="closeOwnerPanel">‚úï CLOSE</button>
    </div>
    <div class="owner-content">
      <div id="ownerAlert" class="o-alert"></div>

      <!-- DASHBOARD -->
      <div class="owner-tab active" id="tab-dashboard">
        <div style="background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,215,0,0.03));border:1px solid rgba(255,215,0,0.2);border-radius:4px;padding:16px;margin-bottom:16px;text-align:center;">
          <div style="font-size:32px;margin-bottom:8px;">üëë</div>
          <div style="font-family:'Orbitron',monospace;font-size:14px;letter-spacing:4px;color:var(--gold);">WELCOME BACK, Z3N0</div>
          <div style="font-size:12px;color:rgba(255,215,0,0.4);margin-top:4px;">Supreme Owner & Creator of the Serpent Realm</div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="sv" id="os-players">0</div><div class="sl">PLAYERS</div></div>
          <div class="stat-card"><div class="sv" id="os-orbs">0</div><div class="sl">ORBS</div></div>
          <div class="stat-card"><div class="sv" id="os-event">NONE</div><div class="sl">EVENT</div></div>
        </div>
        <div class="o-card">
          <h3>QUICK ACTIONS</h3>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','speedBoost')">‚ö° Hyperspeed</button>
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','orbFrenzy')">üåü Orb Frenzy</button>
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','growAll')">üêç Titan Rise</button>
            <button class="btn btn-gold btn-sm" onclick="ownerAction('startEvent','shrinkAll')">üíÄ Death Shrink</button>
            <button class="btn btn-danger btn-sm" onclick="ownerAction('endEvent')">‚úï End Event</button>
          </div>
        </div>
      </div>

      <!-- PLAYERS -->
      <div class="owner-tab" id="tab-players">
        <div class="o-card">
          <h3>LIVE PLAYERS</h3>
          <button class="btn btn-gold btn-sm" onclick="refreshPlayers()" style="margin-bottom:12px;">‚Ü∫ REFRESH</button>
          <div style="overflow-x:auto;">
            <table class="player-table">
              <thead><tr><th>NAME</th><th>LEN</th><th>SCORE</th><th>COINS</th><th>COSMETICS</th><th>ACTIONS</th></tr></thead>
              <tbody id="playerTableBody"><tr><td colspan="6" style="text-align:center;color:var(--dim);padding:20px;">Click refresh to load players</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="owner-tab" id="tab-actions">
        <div class="o-card">
          <h3>GIVE SIZE</h3>
          <select class="o-select" id="sizeTarget"></select>
          <input class="o-input" id="sizeAmount" type="number" placeholder="Size amount" value="50">
          <button class="btn btn-gold" onclick="doGiveSize()">üìè GRANT SIZE</button>
        </div>
        <div class="o-card">
          <h3>GIVE COINS</h3>
          <select class="o-select" id="coinsTarget"></select>
          <input class="o-input" id="coinsAmount" type="number" placeholder="Coins amount" value="500">
          <button class="btn btn-gold" onclick="doGiveCoins()">üí∞ GRANT COINS</button>
        </div>
        <div class="o-card">
          <h3>SWAP SIZE</h3>
          <select class="o-select" id="swapP1"></select>
          <select class="o-select" id="swapP2"></select>
          <button class="btn btn-gold" onclick="doSwapSize()">üîÑ SWAP</button>
        </div>
        <div class="o-card">
          <h3>KICK PLAYER</h3>
          <select class="o-select" id="kickTarget"></select>
          <input class="o-input" id="kickReason" placeholder="Kick reason (optional)">
          <button class="btn btn-danger" onclick="doKick()">üö´ KICK</button>
        </div>
        <div class="o-card">
          <h3>INSTA-KILL</h3>
          <select class="o-select" id="killTarget"></select>
          <button class="btn btn-danger" onclick="doInstaKill()">‚ò†Ô∏è EXECUTE</button>
        </div>
      </div>

      <!-- EVENTS -->
      <div class="owner-tab" id="tab-events">
        <div class="o-card">
          <h3>LIVE EVENTS</h3>
          <p style="font-size:13px;color:rgba(255,215,0,0.4);margin-bottom:16px;">Events last 60 seconds and affect all players.</p>
          <div class="event-grid">
            <div class="event-card" onclick="ownerAction('startEvent','speedBoost')"><span class="event-icon">‚ö°</span><div class="event-name">HYPERSPEED FRENZY</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','orbFrenzy')"><span class="event-icon">üåü</span><div class="event-name">ORB OVERLOAD</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','shrinkAll')"><span class="event-icon">üíÄ</span><div class="event-name">DEATH SHRINK</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','growAll')"><span class="event-icon">üêç</span><div class="event-name">TITAN RISE</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','rainbow')"><span class="event-icon">üåà</span><div class="event-name">RAINBOW CHAOS</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','darkness')"><span class="event-icon">üåë</span><div class="event-name">BLACKOUT</div></div>
          </div>
          <button class="btn btn-danger" style="margin-top:16px;" onclick="ownerAction('endEvent')">‚úï END CURRENT EVENT</button>
        </div>
      </div>

      <!-- BROADCAST -->
      <div class="owner-tab" id="tab-broadcast">
        <div class="o-card">
          <h3>SERVER BROADCAST</h3>
          <textarea class="o-input" id="broadcastMsg" placeholder="Message to all players..." rows="3" style="resize:vertical;"></textarea>
          <button class="btn btn-gold" onclick="doBroadcast()">üì¢ BROADCAST TO ALL</button>
        </div>
      </div>

      <!-- SKINS -->
      <div class="owner-tab" id="tab-skins">
        <div class="o-card">
          <h3>GRANT SKIN</h3>
          <select class="o-select" id="skinTarget"></select>
          <select class="o-select" id="skinToGive">
            <option value="rainbow_god">üåà Rainbow God (Owner Only)</option>
            <option value="void_lord">üåë Void Lord (Owner Only)</option>
            <option value="galaxy_emperor">üåå Galaxy Emperor (Owner Only)</option>
            <option value="neon_death">‚ö° Neon Death (Owner Only)</option>
            <option value="chrome_divine">‚ú® Chrome Divine (Owner Only)</option>
            <option value="fire">üî• Fire</option>
            <option value="ice">‚ùÑÔ∏è Ice</option>
            <option value="gold">üíõ Gold</option>
            <option value="toxic">‚ò£Ô∏è Toxic</option>
          </select>
          <button class="btn btn-gold" onclick="doGiveSkin()">üé® GRANT SKIN</button>
        </div>
      </div>

      <!-- OWNER COSMETICS -->
      <div class="owner-tab" id="tab-ownercosmetics">
        <div class="o-card">
          <h3>GRANT COSMETIC TO PLAYER</h3>
          <select class="o-select" id="ownerCosmeticTarget"></select>
          <select class="o-select" id="ownerCosmeticToGive">
            <option value="owner_aura">‚ú® Z3N0 Aura (Owner Exclusive)</option>
            <option value="owner_trail">üëë Z3N0 Trail (Owner Exclusive)</option>
            <option value="owner_title">üëë [Z3N0] Title (Owner Exclusive)</option>
            <option value="owner_explode">üí• Death Explosion (Owner Exclusive)</option>
            <option value="trail_rainbow">üåà Rainbow Trail</option>
            <option value="trail_gold">‚≠ê Gold Trail</option>
            <option value="title_god">‚ö° [GOD] Title</option>
            <option value="title_legend">üèÜ [LEGEND] Title</option>
            <option value="badge_crown">üëë Crown Badge</option>
            <option value="badge_dragon">üêâ Dragon Badge</option>
          </select>
          <button class="btn btn-gold" onclick="doGiveCosmetic()">üé® GRANT COSMETIC</button>
        </div>
        <div class="o-card">
          <h3>YOUR OWNER COSMETICS</h3>
          <p style="font-size:13px;color:rgba(255,215,0,0.4);margin-bottom:12px;">As Z3N0, you have all cosmetics unlocked.</p>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:2px;font-size:11px;color:var(--gold);">‚ú® Z3N0 Aura</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:2px;font-size:11px;color:var(--gold);">üëë Z3N0 Trail</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:2px;font-size:11px;color:var(--gold);">[Z3N0] Title</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:2px;font-size:11px;color:var(--gold);">üí• Death Explosion</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:2px;font-size:11px;color:var(--gold);">üåà Rainbow Trail</span>
            <span style="padding:4px 10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:2px;font-size:11px;color:var(--gold);">+ ALL PUBLIC COSMETICS</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="toast-container"></div>
<div id="musicControls" style="display:none;">
  <button class="music-btn" id="musicToggle">üéµ</button>
  <div class="music-vis" id="musicVis">
    <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
    <div class="music-bar"></div><div class="music-bar"></div>
  </div>
  <span style="font-size:10px;color:var(--dim);font-family:Orbitron,monospace;letter-spacing:1px;">MUSIC</span>
</div>
<div id="broadcastBanner"><span>üëë Z3N0: </span><span id="broadcastText"></span></div>

<script>
// ================================================================
//  SKIN DEFINITIONS
// ================================================================
const SKINS = {
  classic:         { name:'Classic',      emoji:'üêç', colors:['#00ff8c','#00cc70'],   glow:'#00ff8c' },
  fire:            { name:'Fire',         emoji:'üî•', colors:['#ff4400','#ff8800'],   glow:'#ff6600' },
  ice:             { name:'Ice',          emoji:'‚ùÑÔ∏è', colors:['#00ccff','#0066ff'],   glow:'#00ccff' },
  toxic:           { name:'Toxic',        emoji:'‚ò£Ô∏è', colors:['#88ff00','#44aa00'],   glow:'#88ff00' },
  gold:            { name:'Gold',         emoji:'‚≠ê', colors:['#ffd700','#ffaa00'],   glow:'#ffd700' },
  midnight:        { name:'Midnight',     emoji:'üåô', colors:['#4400ff','#8800ff'],   glow:'#6600ff' },
  sunset:          { name:'Sunset',       emoji:'üåÖ', colors:['#ff0066','#ff8800'],   glow:'#ff4488' },
  ocean:           { name:'Ocean',        emoji:'üåä', colors:['#0044ff','#00ffcc'],   glow:'#00aaff' },
  lava:            { name:'Lava',         emoji:'üåã', colors:['#ff2200','#ffdd00'],   glow:'#ff4400' },
  forest:          { name:'Forest',       emoji:'üå≤', colors:['#006600','#88cc00'],   glow:'#44aa00' },
  rainbow_god:     { name:'Rainbow God',  emoji:'üåà', colors:['rainbow'],             glow:'#ffffff', ownerOnly:true },
  void_lord:       { name:'Void Lord',    emoji:'üåë', colors:['#110011','#440044'],   glow:'#aa00ff', ownerOnly:true },
  galaxy_emperor:  { name:'Galaxy',       emoji:'üåå', colors:['#000033','#0000aa'],   glow:'#4488ff', ownerOnly:true },
  neon_death:      { name:'Neon Death',   emoji:'‚ö°', colors:['#ff0000','#00ffff'],   glow:'#ffffff', ownerOnly:true },
  chrome_divine:   { name:'Chrome',       emoji:'‚ú®', colors:['#888888','#ffffff'],   glow:'#ffffff', ownerOnly:true },
};

// ================================================================
//  SETTINGS STATE
// ================================================================
let controlScheme = localStorage.getItem('controlScheme') || 'both';
let boostKey = localStorage.getItem('boostKey') || 'shift';
let mouseAlways = localStorage.getItem('mouseAlways') !== 'off';

function saveSettings() {
  localStorage.setItem('controlScheme', controlScheme);
  localStorage.setItem('boostKey', boostKey);
  localStorage.setItem('mouseAlways', mouseAlways ? 'on' : 'off');
  updateBoostLabel();
}

function updateBoostLabel() {
  const labels = { shift:'BOOST [SHIFT/CLICK]', space:'BOOST [SPACE/CLICK]', both_boost:'BOOST [SHIFT/SPACE/CLICK]' };
  const el = document.getElementById('boostLabel');
  if (el) el.textContent = labels[boostKey] || 'BOOST [HOLD CLICK]';
}

// Init setting UI
document.querySelectorAll('#controlSchemeGroup .control-radio').forEach(btn => {
  if (btn.dataset.scheme === controlScheme) btn.classList.add('active');
  else btn.classList.remove('active');
  btn.onclick = () => {
    controlScheme = btn.dataset.scheme;
    document.querySelectorAll('#controlSchemeGroup .control-radio').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    saveSettings();
  };
});
document.querySelectorAll('#boostKeyGroup .control-radio').forEach(btn => {
  if (btn.dataset.boost === boostKey) btn.classList.add('active');
  else btn.classList.remove('active');
  btn.onclick = () => {
    boostKey = btn.dataset.boost;
    document.querySelectorAll('#boostKeyGroup .control-radio').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    saveSettings();
  };
});
document.querySelectorAll('#mouseAlwaysGroup .control-radio').forEach(btn => {
  if ((btn.dataset.mouse === 'on') === mouseAlways) btn.classList.add('active');
  else btn.classList.remove('active');
  btn.onclick = () => {
    mouseAlways = btn.dataset.mouse === 'on';
    document.querySelectorAll('#mouseAlwaysGroup .control-radio').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    saveSettings();
  };
});

// Menu tab switching
document.querySelectorAll('.menu-tab-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.menu-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.menu-tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('mtab-' + btn.dataset.mtab).classList.add('active');
  };
});

// ================================================================
//  GAME STATE
// ================================================================
let socket = null;
let myPlayerId = null;
let isOwner = false;
let gameState = { players:{}, leaderboard:[], activeEvent:null };
let myAngle = 0;
let boosting = false;
let boostEnergy = 100;
let selectedSkin = 'classic';
let ownerPass = '';
let currentPlayerList = [];
let gameActive = false;
let myDeathScore = 0;
let myDeathLength = 0;
let cameraX = 0, cameraY = 0;
let MAP_SIZE = 6000;
let orbsLocal = {};
let rainbowT = 0;
let musicPlaying = false;
let audioCtx = null;
let musicInterval = null;
let myName = '';
let myProfile = { coins: 0, unlockedCosmetics: [], equippedTrail: null, equippedTitle: null, equippedBadge: null };
let cosmeticsCatalog = {};
let sessionCoinsDisplay = 0;
let predictedState = null;       // our locally-predicted snake position
let predictedAngle = 0;
let playerMetaCache = {};        // static player data cached by id
let lastInputSent = 0;           // for input throttling
let myTag = '';
let myUpgrades = { speed:0, boost:0, magnet:0, armor:0, growth:0 };
let upgradesCatalog = {};
let upgradePanelOpen = false;

// ================================================================
//  CURSOR
// ================================================================
const cursor = document.getElementById('cursor');
let mouseX = 0, mouseY = 0;
document.addEventListener('mousemove', e => {
  mouseX = e.clientX; mouseY = e.clientY;
  cursor.style.left = mouseX + 'px';
  cursor.style.top = mouseY + 'px';
});

// ================================================================
//  PARTICLES
// ================================================================
function spawnMenuParticles() {
  const container = document.getElementById('bgParticles');
  for (let i = 0; i < 50; i++) {
    const p = document.createElement('div');
    p.className = 'menu-particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDuration = (Math.random() * 6 + 4) + 's';
    p.style.animationDelay = (Math.random() * 6) + 's';
    p.style.width = p.style.height = (Math.random() * 3 + 1) + 'px';
    const colors = ['#00ff8c','#aa44ff','#ff2244','#ffd700','#00ccff'];
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    container.appendChild(p);
  }
}
spawnMenuParticles();

// ================================================================
//  SKIN SELECTOR
// ================================================================
function buildSkinSelector() {
  const container = document.getElementById('skinSelector');
  container.innerHTML = '';
  Object.keys(SKINS).forEach(key => {
    const skin = SKINS[key];
    const div = document.createElement('div');
    div.className = 'skin-opt' + (skin.ownerOnly?' owner-only':'') + (key===selectedSkin?' selected':'');
    if (skin.ownerOnly && !isOwner) div.classList.add('locked');
    div.title = skin.name + (skin.ownerOnly?' (Owner Only)':'');
    div.style.background = skin.ownerOnly
      ? 'linear-gradient(135deg,rgba(255,215,0,0.2),rgba(170,68,255,0.2))'
      : `linear-gradient(135deg,${skin.colors[0]||'#333'},${skin.colors[1]||skin.colors[0]||'#333'})`;
    div.innerHTML = `<span style="font-size:18px;text-shadow:0 0 10px ${skin.glow}">${skin.emoji}</span>`;
    div.onclick = () => {
      if (skin.ownerOnly && !isOwner) { showToast('Owner only skin!','error'); return; }
      selectedSkin = key;
      document.querySelectorAll('.skin-opt').forEach(s=>s.classList.remove('selected'));
      div.classList.add('selected');
    };
    container.appendChild(div);
  });
}
buildSkinSelector();

// ================================================================
//  OWNER TOGGLE
// ================================================================
document.getElementById('ownerToggleBtn').onclick = () => {
  const g = document.getElementById('ownerPassGroup');
  g.style.display = g.style.display==='none'?'':'none';
};

// ================================================================
//  MUSIC
// ================================================================
function initMusic() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  playMusic();
}
function playMusic() {
  if (!audioCtx) return;
  musicPlaying = true;
  document.getElementById('musicVis').classList.remove('music-paused');
  document.getElementById('musicToggle').textContent = 'üéµ';
  scheduleMusicNotes();
}
function pauseMusic() {
  musicPlaying = false;
  document.getElementById('musicVis').classList.add('music-paused');
  document.getElementById('musicToggle').textContent = '‚è∏';
  if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
}
let noteIndex = 0;
const melody = [261,293,329,349,392,440,493,523,493,440,392,349,329,293,261,293,329,392,440,493,523,587,523,493,440,392,349,329];
const bassline = [65,73,82,87,98,110,65,73];
function playNote(freq, type, duration, gain, time) {
  if (!audioCtx || !musicPlaying) return;
  const osc = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();
  filter.type = 'lowpass'; filter.frequency.value = 2000;
  osc.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, time);
  gainNode.gain.setValueAtTime(0, time);
  gainNode.gain.linearRampToValueAtTime(gain, time+0.02);
  gainNode.gain.exponentialRampToValueAtTime(0.001, time+duration);
  osc.start(time); osc.stop(time+duration+0.05);
}
function scheduleMusicNotes() {
  if (musicInterval) clearInterval(musicInterval);
  const tempo = 0.18; let beat = 0;
  musicInterval = setInterval(() => {
    if (!musicPlaying || !audioCtx) return;
    const now = audioCtx.currentTime;
    const mNote = melody[noteIndex % melody.length];
    const bNote = bassline[beat % bassline.length];
    playNote(mNote,'triangle',tempo*1.5,0.08,now);
    playNote(mNote*2,'sine',tempo,0.03,now+0.05);
    if (beat%2===0) playNote(bNote,'sawtooth',tempo*2,0.06,now);
    if (beat%4===0) {
      const k=audioCtx.createOscillator(),kg=audioCtx.createGain();
      k.connect(kg);kg.connect(audioCtx.destination);
      k.frequency.setValueAtTime(150,now);k.frequency.exponentialRampToValueAtTime(0.001,now+0.3);
      kg.gain.setValueAtTime(0.3,now);kg.gain.exponentialRampToValueAtTime(0.001,now+0.3);
      k.start(now);k.stop(now+0.35);
    }
    noteIndex++;beat++;
  }, tempo*1000);
}
document.getElementById('musicToggle').onclick = () => {
  if (!audioCtx) { initMusic(); return; }
  if (musicPlaying) pauseMusic(); else playMusic();
};

// ================================================================
//  PLAY BUTTON
// ================================================================
document.getElementById('playBtn').onclick = () => {
  const name = document.getElementById('nameInput').value.trim() || 'Snake';
  const pass = document.getElementById('ownerPass').value;
  const tag  = document.getElementById('tagInput').value.trim().replace(/[^a-zA-Z0-9]/g,'').substring(0,8).toUpperCase();
  myName = name; ownerPass = pass; myTag = tag;
  connectAndJoin(name, selectedSkin, pass, tag);
};
document.getElementById('nameInput').addEventListener('keydown', e => { if (e.key==='Enter') document.getElementById('playBtn').click(); });

// ================================================================
//  SOCKET CONNECTION
// ================================================================
function connectAndJoin(name, skin, password, tag) {
  if (socket) socket.disconnect();
  socket = io({ transports: ['websocket'], upgrade: false });

  socket.on('connect', () => {
    socket.emit('joinGame', { name, skin, password });
    if (tag) setTimeout(() => socket.emit('setTag', { tag }), 500);
  });

  socket.on('joined', (data) => {
    myPlayerId = data.playerId;
    isOwner = data.isOwner;
    MAP_SIZE = data.mapSize;
    orbsLocal = {};
    data.orbs.forEach(o => orbsLocal[o.id] = o);
    myProfile = data.profile || myProfile;
    cosmeticsCatalog = data.cosmeticsCatalog || {};
    upgradesCatalog = data.upgradesCatalog || {};
    myUpgrades = data.profile?.upgrades || myUpgrades;
    startGame();
    if (isOwner) {
      document.getElementById('owner-tag-hud').style.display = 'block';
      buildSkinSelector();
      showToast('üëë Welcome back, Z3N0 ‚Äî the Realm is yours','gold');
    }
    initMusic();
    updateCoinDisplays();
  });

  // New compact state format
  socket.on('gs', (data) => {
    // Merge compact state into gameState.players using meta cache
    const newPlayers = {};
    for (const pid in data.s) {
      const d = data.s[pid];
      const meta = playerMetaCache[pid] || {};
      newPlayers[pid] = {
        segments: d.s,
        a: d.a,        // angle
        angle: d.a,
        w: d.w,        // width
        width: d.w,
        b: d.b,        // boosting
        boosting: d.b,
        sessionCoins: d.sc,
        upgrades: d.up,
        // Static fields from meta cache
        skin: meta.skin || 'classic',
        name: meta.name || '?',
        isOwner: meta.isOwner || false,
        grantedSkin: meta.grantedSkin || null,
        effect: meta.effect || null,
        equippedTrail: meta.equippedTrail || null,
        equippedTitle: meta.equippedTitle || null,
        equippedBadge: meta.equippedBadge || null,
        tag: meta.tag || null,
        isBot: meta.isBot || false,
      };
    }
    gameState = { players: newPlayers, leaderboard: data.lb || [], activeEvent: data.ev || null };
  });

  // Cache static player metadata
  socket.on('playerMeta', ({ pid, meta }) => {
    playerMetaCache[pid] = meta;
  });

  // Legacy format fallback (in case server sends old format during transition)
  socket.on('gameState', (data) => { gameState = data; });

  socket.on('orbEaten', ({ oid, newOrb }) => { delete orbsLocal[oid]; orbsLocal[newOrb.id] = newOrb; });
  socket.on('orbSpawned', (orb) => { orbsLocal[orb.id] = orb; });
  socket.on('orbFrenzy', (orbs) => { orbs.forEach(o => orbsLocal[o.id] = o); });

  socket.on('playerDied', ({ id, killerName, droppedOrbs }) => {
    if (droppedOrbs) droppedOrbs.forEach(o => orbsLocal[o.id] = o);
    if (id !== myPlayerId) addKillFeed(id, killerName);
  });

  socket.on('youDied', ({ killerName, coinsEarned }) => {
    myProfile.coins += (coinsEarned || 0);
    handleDeath(killerName, coinsEarned || 0);
  });

  socket.on('kicked', ({ reason }) => {
    socket.disconnect();
    showScreen('menuScreen');
    showToast('üö´ ' + (reason||'Kicked by owner.'), 'error');
    gameActive = false;
    document.getElementById('hud').style.display = 'none';
    document.getElementById('gameCanvas').style.display = 'none';
    document.getElementById('musicControls').style.display = 'none';
  });

  socket.on('systemMessage', (data) => {
    const msg = typeof data === 'string' ? data : (data.message || '');
    showSystemMsg(msg);
  });

  socket.on('skinGranted', ({ skin: newSkin }) => {
    selectedSkin = newSkin;
    showToast(`üé® Skin granted: ${SKINS[newSkin]?.name||newSkin}`, 'gold');
  });

  socket.on('killConfirmed', ({ victimName }) => showToast(`üíÄ You eliminated ${victimName}`));

  socket.on('liveEvent', (event) => {
    document.getElementById('eventBanner').style.display = 'block';
    document.getElementById('eventTitle').textContent = event.name;
    document.getElementById('statEvent').style.display = 'inline';
    showToast('‚ö° ' + event.name + ' STARTED!', 'gold');
  });

  socket.on('eventEnded', () => {
    document.getElementById('eventBanner').style.display = 'none';
    document.getElementById('statEvent').style.display = 'none';
    showToast('Event ended.');
  });

  socket.on('ownerBroadcast', ({ message }) => {
    document.getElementById('broadcastText').textContent = message;
    document.getElementById('broadcastBanner').style.display = 'block';
    setTimeout(() => document.getElementById('broadcastBanner').style.display = 'none', 8000);
  });

  socket.on('ownerSuccess', (msg) => { showOwnerAlert(msg,'success'); refreshPlayers(); });
  socket.on('ownerError', (msg) => showOwnerAlert(msg,'error'));
  socket.on('playerList', (list) => { currentPlayerList = list; renderPlayerTable(list); populateSelects(list); });

  socket.on('coinsGranted', ({ amount, newBalance }) => {
    myProfile.coins = newBalance;
    updateCoinDisplays();
    showToast(`üí∞ +${amount} coins!`, 'gold');
  });

  socket.on('cosmeticBought', ({ cosmeticId, newCoinBalance, unlockedCosmetics }) => {
    myProfile.coins = newCoinBalance;
    myProfile.unlockedCosmetics = unlockedCosmetics;
    updateCoinDisplays();
    renderCosmeticsShop();
    showToast(`üé® Bought: ${cosmeticsCatalog[cosmeticId]?.name||cosmeticId}`, 'gold');
  });

  socket.on('cosmeticGranted', ({ cosmeticId, unlockedCosmetics }) => {
    myProfile.unlockedCosmetics = unlockedCosmetics;
    renderCosmeticsShop();
    showToast(`üé® Cosmetic granted!`, 'gold');
  });

  socket.on('cosmeticEquipped', ({ equippedTrail, equippedTitle, equippedBadge }) => {
    myProfile.equippedTrail = equippedTrail;
    myProfile.equippedTitle = equippedTitle;
    myProfile.equippedBadge = equippedBadge;
    updateEquippedDisplay();
    renderCosmeticsShop();
  });

  socket.on('cosmeticError', (msg) => showToast(msg, 'error'));

  socket.on('upgradeBought', ({ upgradeId, newLevel, upgrades, sessionCoins, profileCoins }) => {
    myUpgrades = upgrades;
    sessionCoinsDisplay = sessionCoins;
    myProfile.coins = profileCoins;
    updateCoinDisplays();
    renderUpgradePanel();
  });

  socket.on('upgradeError', (msg) => showToast(msg, 'error'));
  socket.on('tagSet', ({ tag }) => { myTag = tag; });

  socket.on('disconnect', () => { if (gameActive) showToast('Disconnected from server','error'); });
}

// ================================================================
//  GAME START/STOP
// ================================================================
function startGame() {
  gameActive = true;
  showScreen('game');
  document.getElementById('gameCanvas').style.display = 'block';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('musicControls').style.display = 'flex';
  document.getElementById('deathScreen').classList.add('hidden');
  document.getElementById('inGameCosmeticsBtn').style.display = 'block';
  document.getElementById('upgradeBtn').style.display = 'block';
  renderUpgradePanel();
  setupCanvas();
  requestAnimationFrame(gameLoop);
}

function handleDeath(killerName, coinsEarned) {
  gameActive = false;
  predictedState = null;
  const myP = gameState.players[myPlayerId];
  myDeathScore = myP ? myP.score||0 : 0;
  myDeathLength = myP ? (myP.segments||[]).length : 0;
  document.getElementById('deathKiller').textContent = `Eliminated by ${killerName||'the void'}`;
  document.getElementById('deathScore').textContent = myDeathScore;
  document.getElementById('deathLength').textContent = myDeathLength;
  document.getElementById('deathCoinsEarned').textContent = coinsEarned > 0 ? `üí∞ +${coinsEarned} coins earned` : '';
  const rank = gameState.leaderboard.findIndex(e => e.id === myPlayerId);
  document.getElementById('deathRank').textContent = rank >= 0 ? '#'+(rank+1) : '‚Äî';
  document.getElementById('deathScreen').classList.remove('hidden');
  document.getElementById('inGameCosmeticsBtn').style.display = 'none';
}

document.getElementById('respawnBtn').onclick = () => {
  document.getElementById('deathScreen').classList.add('hidden');
  connectAndJoin(myName, selectedSkin, ownerPass);
};
document.getElementById('menuBtn').onclick = () => {
  document.getElementById('deathScreen').classList.add('hidden');
  document.getElementById('hud').style.display = 'none';
  document.getElementById('gameCanvas').style.display = 'none';
  document.getElementById('musicControls').style.display = 'none';
  document.getElementById('inGameCosmeticsBtn').style.display = 'none';
  document.getElementById('upgradeBtn').style.display = 'none';
  document.getElementById('upgradePanel').style.display = 'none';
  showScreen('menuScreen');
  if (socket) socket.disconnect();
  gameActive = false;
};

// ================================================================
//  CANVAS
// ================================================================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function setupCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', setupCanvas);

// ================================================================
//  INPUT ‚Äî mouse
// ================================================================
canvas.addEventListener('mousemove', (e) => {
  if (!gameActive || !myPlayerId) return;
  const scheme = controlScheme;
  if (scheme !== 'mouse' && !mouseAlways) return;
  // Use predicted position for angle calc so it feels instant
  const me = (predictedState && predictedState.segments.length) ? predictedState : gameState.players[myPlayerId];
  if (!me || !me.segments || !me.segments.length) return;
  const head = me.segments[0];
  myAngle = Math.atan2(e.clientY - (head.y - cameraY), e.clientX - (head.x - cameraX));
  // Throttle: send input at most 20x/sec
  const now = performance.now();
  if (now - lastInputSent > 50) {
    lastInputSent = now;
    socket.emit('input', { angle: myAngle, boosting });
  }
});

canvas.addEventListener('mousedown', (e) => {
  if (e.button===0||e.button===2) { boosting=true; if(socket) socket.emit('input',{angle:myAngle,boosting:true}); }
});
canvas.addEventListener('mouseup', () => {
  boosting=false; if(socket) socket.emit('input',{angle:myAngle,boosting:false});
});
canvas.addEventListener('contextmenu', e => e.preventDefault());

canvas.addEventListener('touchmove', (e) => {
  e.preventDefault();
  const touch = e.touches[0];
  const me = gameState.players[myPlayerId];
  if (!me || !me.segments || !me.segments.length) return;
  const head = me.segments[0];
  myAngle = Math.atan2(touch.clientY-(head.y-cameraY), touch.clientX-(head.x-cameraX));
  if(socket) socket.emit('input',{angle:myAngle,boosting});
}, { passive:false });
canvas.addEventListener('touchstart', () => { boosting=true; if(socket) socket.emit('input',{angle:myAngle,boosting:true}); });
canvas.addEventListener('touchend', () => { boosting=false; if(socket) socket.emit('input',{angle:myAngle,boosting:false}); });

// ================================================================
//  INPUT ‚Äî keyboard
// ================================================================
const keys = {};

document.addEventListener('keydown', (e) => {
  keys[e.key] = true;

  // Owner panel
  if ((e.key==='F1'||(e.ctrlKey&&e.key==='o'))) { e.preventDefault(); if(isOwner) openOwnerPanel(); return; }
  if (e.key==='Escape') { document.getElementById('ownerPanel').classList.add('hidden'); document.getElementById('ingameCosmeticsPanel').style.display='none'; return; }

  // Boost
  if (!gameActive || !socket) return;
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();

  const shiftBoost  = e.key==='Shift' && (boostKey==='shift'||boostKey==='both_boost');
  const spaceBoost  = e.key===' '     && (boostKey==='space'||boostKey==='both_boost');
  if (shiftBoost||spaceBoost) { e.preventDefault(); boosting=true; socket.emit('input',{angle:myAngle,boosting:true}); }
});

document.addEventListener('keyup', (e) => {
  keys[e.key] = false;
  if (!gameActive || !socket) return;
  const shiftBoost = e.key==='Shift' && (boostKey==='shift'||boostKey==='both_boost');
  const spaceBoost = e.key===' '     && (boostKey==='space'||boostKey==='both_boost');
  if (shiftBoost||spaceBoost) { boosting=false; socket.emit('input',{angle:myAngle,boosting:false}); }
});

function handleKeyboardSteering() {
  if (!gameActive || !socket) return;
  const scheme = controlScheme;
  if (scheme === 'mouse') return; // pure mouse mode ‚Äî no keyboard steering

  const useWASD    = scheme==='wasd'   || scheme==='both';
  const useArrows  = scheme==='arrows' || scheme==='both';

  const left  = (useWASD&&(keys['a']||keys['A'])) || (useArrows&&keys['ArrowLeft']);
  const right = (useWASD&&(keys['d']||keys['D'])) || (useArrows&&keys['ArrowRight']);
  const up    = (useWASD&&(keys['w']||keys['W'])) || (useArrows&&keys['ArrowUp']);
  const down  = (useWASD&&(keys['s']||keys['S'])) || (useArrows&&keys['ArrowDown']);

  if (!left&&!right&&!up&&!down) return;

  let dx=0, dy=0;
  if (left)  dx-=1;
  if (right) dx+=1;
  if (up)    dy-=1;
  if (down)  dy+=1;

  if (dx!==0||dy!==0) {
    const targetAngle = Math.atan2(dy, dx);
    let diff = targetAngle - myAngle;
    while (diff > Math.PI)  diff -= Math.PI*2;
    while (diff < -Math.PI) diff += Math.PI*2;
    myAngle += Math.sign(diff) * Math.min(Math.abs(diff), 0.21);
    socket.emit('input', { angle: myAngle, boosting });
  }
}

// ================================================================
//  RENDER ‚Äî performance: use offscreen path batching
// ================================================================
// ================================================================
//  CLIENT-SIDE PREDICTION
// ================================================================
const CLIENT_SPEED = 2.8;       // mirrors server SNAKE_SPEED
const CLIENT_BOOST_SPEED = 5.2; // mirrors server BOOST_SPEED
const CLIENT_SEG_DIST = 12;     // mirrors SEGMENT_DISTANCE

function clientPredict(dt) {
  if (!myPlayerId || !gameActive) return;

  const serverMe = gameState.players[myPlayerId];
  if (!serverMe || !serverMe.segments || !serverMe.segments.length) {
    predictedState = null;
    return;
  }

  // Start from server state if we don't have a prediction yet
  if (!predictedState) {
    predictedState = {
      segments: serverMe.segments.map(s => ({x:s.x, y:s.y})),
      angle: serverMe.a || myAngle,
      width: serverMe.w || 8,
      boosting: serverMe.b || false
    };
  }

  // Reconcile: if server head is far from our prediction, snap back
  const serverHead = serverMe.segments[0];
  const predHead = predictedState.segments[0];
  const snapDist = Math.hypot(serverHead.x - predHead.x, serverHead.y - predHead.y);
  if (snapDist > 60) {
    // Server correction ‚Äî lerp back quickly
    predictedState.segments = serverMe.segments.map(s => ({x:s.x, y:s.y}));
  } else if (snapDist > 8) {
    // Gentle correction
    predictedState.segments[0].x += (serverHead.x - predHead.x) * 0.3;
    predictedState.segments[0].y += (serverHead.y - predHead.y) * 0.3;
  }

  // Advance prediction by dt
  predictedState.angle = myAngle;
  predictedState.boosting = boosting;
  predictedState.width = serverMe.w || 8;

  const speedMult = boosting ? CLIENT_BOOST_SPEED : CLIENT_SPEED;
  const stepsF = speedMult * dt * 60; // how many server ticks worth of movement
  const steps = Math.max(1, Math.round(stepsF));

  for (let s = 0; s < steps; s++) {
    const head = predictedState.segments[0];
    const newHead = {
      x: head.x + Math.cos(myAngle) * speedMult / steps,
      y: head.y + Math.sin(myAngle) * speedMult / steps
    };
    predictedState.segments.unshift(newHead);
    // Keep same length as server
    while (predictedState.segments.length > serverMe.segments.length + 2) {
      predictedState.segments.pop();
    }
  }
}

let frameCount = 0;
let lastFrameTime = 0;

function gameLoop(timestamp) {
  if (!gameActive) return;
  requestAnimationFrame(gameLoop);

  const dt = Math.min((timestamp - lastFrameTime) / 1000, 0.05); // delta time in seconds, capped
  lastFrameTime = timestamp;
  frameCount++;

  rainbowT += dt * 1.2;
  handleKeyboardSteering();

  // Client-side prediction: move our own snake locally so it feels instant
  clientPredict(dt);

  const me = predictedState || gameState.players[myPlayerId];
  if (me && me.segments && me.segments.length) {
    const head = me.segments[0];
    const targetX = head.x - canvas.width/2;
    const targetY = head.y - canvas.height/2;
    // Faster camera follow = less perceived lag
    const camLerp = Math.min(1, dt * 14);
    cameraX += (targetX - cameraX) * camLerp;
    cameraY += (targetY - cameraY) * camLerp;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBackground();
  drawGrid();
  drawOrbs();
  for (const pid in gameState.players) {
    const playerData = (pid === myPlayerId && predictedState)
      ? { ...gameState.players[pid], segments: predictedState.segments, angle: myAngle, width: predictedState.width, boosting }
      : gameState.players[pid];
    drawSnake(playerData, pid === myPlayerId);
  }
  drawBorder();
  updateHUD();
}

function drawBackground() {
  ctx.fillStyle = '#05050f';
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function drawGrid() {
  const gridSize = 80;
  const offX = ((-cameraX) % gridSize + gridSize) % gridSize;
  const offY = ((-cameraY) % gridSize + gridSize) % gridSize;
  ctx.strokeStyle = 'rgba(0,255,140,0.04)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let x=offX; x<canvas.width; x+=gridSize) { ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); }
  for (let y=offY; y<canvas.height; y+=gridSize) { ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); }
  ctx.stroke();
}

function drawOrbs() {
  // Batch similar orbs for performance
  ctx.save();
  for (const oid in orbsLocal) {
    const orb = orbsLocal[oid];
    const sx = orb.x - cameraX, sy = orb.y - cameraY;
    if (sx<-30||sx>canvas.width+30||sy<-30||sy>canvas.height+30) continue;
    const pulse = Math.sin(frameCount*0.08 + orb.x*0.01)*0.3 + 0.7;
    const r = orb.size * pulse;
    ctx.beginPath();
    ctx.arc(sx, sy, r, 0, Math.PI*2);
    ctx.fillStyle = orb.color;
    ctx.fill();
    // Simple outer glow
    ctx.beginPath();
    ctx.arc(sx, sy, r*1.8, 0, Math.PI*2);
    ctx.fillStyle = orb.color + '33';
    ctx.fill();
  }
  ctx.restore();
}

function getSkinColors(player) {
  const activeSkin = player.grantedSkin || player.skin;
  const skin = SKINS[activeSkin] || SKINS.classic;
  if (skin.colors[0]==='rainbow') {
    const h = (rainbowT*60)%360;
    return [`hsl(${h},100%,50%)`,`hsl(${(h+60)%360},100%,60%)`];
  }
  return skin.colors;
}

function getSkinGlow(player) {
  const s = SKINS[player.grantedSkin||player.skin] || SKINS.classic;
  if (s.colors[0]==='rainbow') { return `hsl(${(rainbowT*60)%360},100%,60%)`; }
  return s.glow;
}

function drawSnake(player, isMe) {
  if (!player.segments || player.segments.length < 2) return;
  const segs = player.segments;
  const colors = getSkinColors(player);
  const glowColor = getSkinGlow(player);
  const w = player.width || 8;

  ctx.save();

  for (let i = segs.length-1; i >= 0; i--) {
    const seg = segs[i];
    const sx = seg.x - cameraX, sy = seg.y - cameraY;
    if (sx<-w-20||sx>canvas.width+w+20||sy<-w-20||sy>canvas.height+w+20) continue;

    const t = i / segs.length;
    const segW = w * (1 - t*0.3);
    const alpha = 0.4 + 0.6*(1-t*0.5);

    if (i===0) {
      if (isMe || player.isOwner) { ctx.shadowColor=glowColor; ctx.shadowBlur=20; }
      ctx.beginPath();
      ctx.arc(sx, sy, segW+2, 0, Math.PI*2);
      ctx.fillStyle = colors[1]||colors[0];
      ctx.fill();
      ctx.shadowBlur = 0;

      // Eyes
      const ea = player.angle||0, ed=segW*0.5;
      const ex1=sx+Math.cos(ea-0.5)*ed, ey1=sy+Math.sin(ea-0.5)*ed;
      const ex2=sx+Math.cos(ea+0.5)*ed, ey2=sy+Math.sin(ea+0.5)*ed;
      ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(ex1,ey1,2,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(ex2,ey2,2,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(ex1+Math.cos(ea),ey1+Math.sin(ea),1,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(ex2+Math.cos(ea),ey2+Math.sin(ea),1,0,Math.PI*2); ctx.fill();

      if (player.isOwner) {
        ctx.font = `${segW*1.5}px serif`; ctx.textAlign='center'; ctx.textBaseline='bottom';
        ctx.fillText('üëë', sx, sy-segW-2);
      }
    } else {
      const baseColor = colors[i%2===0?0:1]||colors[0];
      ctx.beginPath();
      ctx.arc(sx, sy, segW, 0, Math.PI*2);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = baseColor;
      ctx.fill();
      ctx.globalAlpha = 1;

      // Trail cosmetic
      if (player.equippedTrail && i < 8 && i%2===0) {
        const trailColors = {
          trail_fire:'#ff4400',trail_ice:'#00ccff',trail_gold:'#ffd700',
          trail_rainbow:`hsl(${(rainbowT*60+i*20)%360},100%,60%)`,
          trail_void:'#aa00ff',trail_electric:'#00ffff',
          owner_trail:'#ffd700'
        };
        const tc = trailColors[player.equippedTrail] || '#ffffff';
        ctx.beginPath();
        ctx.arc(sx+(Math.random()-0.5)*8, sy+(Math.random()-0.5)*8, 3, 0, Math.PI*2);
        ctx.fillStyle = tc + '99';
        ctx.fill();
      }

      if (player.boosting && i<5 && Math.random()<0.3) {
        ctx.beginPath();
        ctx.arc(sx+(Math.random()-0.5)*10, sy+(Math.random()-0.5)*10, 3, 0, Math.PI*2);
        ctx.fillStyle = glowColor+'88'; ctx.fill();
      }
    }
  }

  ctx.restore();

  // Name tag + title + badge
  const head = segs[0];
  const hsx = head.x-cameraX, hsy = head.y-cameraY;
  if (hsx>-100&&hsx<canvas.width+100&&hsy>-100&&hsy<canvas.height+100) {
    const badge = player.equippedBadge || '';
    const title = player.equippedTitle ? player.equippedTitle+' ' : '';
    const tagPrefix = player.tag ? `[${player.tag}] ` : '';
    const nameText = badge + (player.isOwner?'üëë ':'') + (player.isBot?'ü§ñ ':'') + tagPrefix + (player.name||'Snake');
    const titleText = title;

    ctx.font = `bold ${Math.max(10,w+4)}px Rajdhani,sans-serif`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
    const nameY = hsy-w-8;

    if (titleText) {
      ctx.font = `bold 10px Orbitron,monospace`;
      const tw2 = ctx.measureText(titleText).width;
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.fillRect(hsx-tw2/2-4, nameY-30, tw2+8, 14);
      ctx.fillStyle = player.isOwner ? '#ffd700' : '#aa44ff';
      ctx.fillText(titleText, hsx, nameY-18);
    }

    ctx.font = `bold ${Math.max(10,w+4)}px Rajdhani,sans-serif`;
    const tw = ctx.measureText(nameText).width;
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(hsx-tw/2-4, nameY-14, tw+8, 16);
    ctx.fillStyle = player.isOwner ? '#ffd700' : (isMe?'#ffffff':'#ccffdd');
    ctx.fillText(nameText, hsx, nameY);
    ctx.textBaseline = 'alphabetic';
  }
}

function drawBorder() {
  const bx=-cameraX, by=-cameraY;
  ctx.strokeStyle='rgba(255,34,68,0.6)';
  ctx.lineWidth=4; ctx.setLineDash([20,10]);
  ctx.strokeRect(bx,by,MAP_SIZE,MAP_SIZE);
  ctx.setLineDash([]);
  ctx.shadowColor='#ff2244'; ctx.shadowBlur=15;
  ctx.strokeStyle='rgba(255,34,68,0.3)'; ctx.lineWidth=8;
  ctx.strokeRect(bx,by,MAP_SIZE,MAP_SIZE);
  ctx.shadowBlur=0;
}

// ================================================================
//  HUD
// ================================================================
function updateHUD() {
  const meServer = gameState.players[myPlayerId];
  const me = meServer;
  if (me) {
    document.getElementById('scoreVal').textContent = me.score||0;
    document.getElementById('lengthVal').textContent = (me.segments||[]).length;
    sessionCoinsDisplay = me.sessionCoins || 0;
    document.getElementById('hudCoins').textContent = (myProfile.coins + sessionCoinsDisplay);
    boosting ? (boostEnergy=Math.max(0,boostEnergy-0.5)) : (boostEnergy=Math.min(100,boostEnergy+0.3));
    document.getElementById('boostFill').style.width = boostEnergy+'%';
  }

  const lb = gameState.leaderboard||[];
  document.getElementById('lbList').innerHTML = lb.map((e,i) => {
    const rs=i===0?'top1':i===1?'top2':i===2?'top3':'';
    const sym=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'#'+(i+1);
    const badge=e.equippedBadge||'';
    const title=e.equippedTitle?`<span style="font-size:9px;color:#aa44ff;">${e.equippedTitle} </span>`:'';
    return `<div class="lb-entry">
      <div class="lb-rank ${rs}">${sym}</div>
      <div class="lb-name ${e.isOwner?'is-owner':''}">${title}${e.isOwner?'üëë ':''}${badge}${e.name}</div>
      <div class="lb-len">${e.length}</div>
    </div>`;
  }).join('');

  drawMinimap();
  // Refresh upgrade panel periodically
  if (upgradePanelOpen && frameCount % 30 === 0) renderUpgradePanel();
}

function drawMinimap() {
  const mmc = document.getElementById('minimapCanvas');
  const mCtx = mmc.getContext('2d');
  const W=mmc.width, H=mmc.height, scale=W/MAP_SIZE;
  mCtx.fillStyle='rgba(0,0,8,0.9)';
  mCtx.fillRect(0,0,W,H);
  for (const oid in orbsLocal) {
    const o=orbsLocal[oid];
    mCtx.fillStyle=o.color+'66';
    mCtx.fillRect(o.x*scale-0.5,o.y*scale-0.5,1,1);
  }
  for (const pid in gameState.players) {
    const p=gameState.players[pid];
    if (!p.segments||!p.segments.length) continue;
    const head=p.segments[0];
    mCtx.beginPath();
    mCtx.arc(head.x*scale,head.y*scale,pid===myPlayerId?4:2.5,0,Math.PI*2);
    mCtx.fillStyle=pid===myPlayerId?'#00ff8c':p.isOwner?'#ffd700':'#ffffff88';
    mCtx.fill();
  }
  mCtx.strokeStyle='rgba(255,34,68,0.5)';mCtx.lineWidth=1;
  mCtx.strokeRect(0,0,W,H);
}

// ================================================================
//  KILL FEED
// ================================================================
function addKillFeed(killedId, killerName) {
  const killedName = gameState.players[killedId]?.name||'Someone';
  const kf = document.getElementById('killfeed');
  const entry = document.createElement('div');
  entry.className='kf-entry';
  entry.innerHTML=`<span style="color:#aaa;">${killedName}</span> <span style="color:#ff2244;">‚úï</span> <span style="color:#00ff8c;">${killerName}</span>`;
  kf.appendChild(entry);
  setTimeout(()=>entry.remove(),5000);
}

// ================================================================
//  SYSTEM MESSAGE / TOAST
// ================================================================
function showSystemMsg(msg) {
  const el=document.getElementById('sysmsg');
  el.textContent=msg; el.style.display='block';
  setTimeout(()=>el.style.display='none',4000);
}
function showToast(msg,type) {
  const container=document.getElementById('toast-container');
  const toast=document.createElement('div');
  toast.className='toast'+(type?' '+type:'');
  toast.textContent=msg;
  container.appendChild(toast);
  setTimeout(()=>{toast.style.opacity='0';toast.style.transition='opacity 0.3s';setTimeout(()=>toast.remove(),300);},2500);
}
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  if (name==='menuScreen') document.getElementById('menuScreen').classList.remove('hidden');
}

// ================================================================
//  COSMETICS SYSTEM
// ================================================================
function updateCoinDisplays() {
  const total = myProfile.coins + sessionCoinsDisplay;
  document.getElementById('menuCoinBalance').textContent = myProfile.coins;
  document.getElementById('ingameCoinBalance').textContent = total;
  updateEquippedDisplay();
}

function updateEquippedDisplay() {
  const cat = cosmeticsCatalog;
  document.getElementById('equippedTrailDisplay').textContent = myProfile.equippedTrail ? (cat[myProfile.equippedTrail]?.name||myProfile.equippedTrail) : 'None';
  document.getElementById('equippedTitleDisplay').textContent = myProfile.equippedTitle || 'None';
  document.getElementById('equippedBadgeDisplay').textContent = myProfile.equippedBadge || '‚Äî';
}

function openIngameCosmetics() {
  document.getElementById('ingameCosmeticsPanel').style.display = 'block';
  updateCoinDisplays();
  renderCosmeticsShop();
}
function closeIngameCosmetics() {
  document.getElementById('ingameCosmeticsPanel').style.display = 'none';
}

function renderCosmeticsShop() {
  const container = document.getElementById('cosmeticsShopContent');
  const catalog = cosmeticsCatalog;
  if (!Object.keys(catalog).length) {
    container.innerHTML = '<p style="color:var(--dim);text-align:center;">Connect to load cosmetics.</p>';
    return;
  }

  const sections = { trail: 'üî• TRAILS', title: 'üìõ TITLES', badge: 'üèÖ BADGES', owner: 'üëë OWNER EXCLUSIVE' };
  let html = '';

  for (const [type, label] of Object.entries(sections)) {
    const items = Object.values(catalog).filter(c => c.type === type);
    if (!items.length) continue;

    html += `<div style="font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:${type==='owner'?'var(--gold)':'var(--dim)'};margin:16px 0 8px;">${label}</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px;">`;

    for (const cosmetic of items) {
      const owned = isOwner || myProfile.unlockedCosmetics.includes(cosmetic.id);
      const equipped = (cosmetic.type==='trail'&&myProfile.equippedTrail===cosmetic.id)
                    || (cosmetic.type==='title'&&myProfile.equippedTitle===cosmetic.text)
                    || (cosmetic.type==='badge'&&myProfile.equippedBadge===cosmetic.emoji)
                    || (cosmetic.type==='owner'&&(myProfile.equippedTrail===cosmetic.id||myProfile.equippedTitle===cosmetic.text));
      const ownerOnly = cosmetic.ownerOnly;
      const canBuy = !owned && !ownerOnly && cosmetic.price >= 0;
      const totalCoins = myProfile.coins + sessionCoinsDisplay;

      let cardClass = 'cosmetic-card';
      if (equipped) cardClass += ' equipped';
      else if (owned) cardClass += ' owned';
      else if (ownerOnly) cardClass += ' owner-only locked-shop';
      else cardClass += ' locked-shop';

      let actionBtn = '';
      if (equipped) {
        actionBtn = `<button onclick="doUnequip('${cosmetic.type}')" style="margin-top:6px;width:100%;padding:4px;background:rgba(255,34,68,0.15);border:1px solid rgba(255,34,68,0.3);border-radius:2px;color:#ff4466;font-size:9px;cursor:pointer;font-family:Orbitron,monospace;">UNEQUIP</button>`;
      } else if (owned) {
        actionBtn = `<button onclick="doEquip('${cosmetic.id}')" style="margin-top:6px;width:100%;padding:4px;background:rgba(0,255,140,0.08);border:1px solid rgba(0,255,140,0.3);border-radius:2px;color:var(--glow);font-size:9px;cursor:pointer;font-family:Orbitron,monospace;">EQUIP</button>`;
      } else if (ownerOnly) {
        actionBtn = `<div style="margin-top:6px;font-size:9px;color:rgba(255,215,0,0.4);text-align:center;">OWNER ONLY</div>`;
      } else {
        const affordable = totalCoins >= cosmetic.price;
        actionBtn = `<button onclick="doBuy('${cosmetic.id}')" style="margin-top:6px;width:100%;padding:4px;background:${affordable?'rgba(255,215,0,0.1)':'rgba(255,255,255,0.03)'};border:1px solid ${affordable?'rgba(255,215,0,0.3)':'rgba(255,255,255,0.1)'};border-radius:2px;color:${affordable?'var(--gold)':'rgba(255,255,255,0.2)'};font-size:9px;cursor:${affordable?'pointer':'not-allowed'};font-family:Orbitron,monospace;">${cosmetic.price} üí∞</button>`;
      }

      html += `<div class="${cardClass}">
        ${equipped?'<div class="equipped-label">‚úì EQUIPPED</div>':''}
        ${ownerOnly?'<div class="cosmetic-badge">üëë</div>':''}
        <span class="cosmetic-icon">${cosmetic.emoji}</span>
        <div class="cosmetic-name">${cosmetic.name}</div>
        ${actionBtn}
      </div>`;
    }
    html += '</div>';
  }
  container.innerHTML = html;
}

function doBuy(cosmeticId) {
  if (!socket) return;
  socket.emit('buyCosmetic', { cosmeticId });
}
function doEquip(cosmeticId) {
  if (!socket) return;
  socket.emit('equipCosmetic', { cosmeticId });
}
function doUnequip(slot) {
  if (!socket) return;
  socket.emit('unequipCosmetic', { slot });
}

// ================================================================
//  OWNER PANEL
// ================================================================
document.getElementById('closeOwnerPanel').onclick = () => document.getElementById('ownerPanel').classList.add('hidden');

document.querySelectorAll('.owner-nav-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.owner-nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.owner-tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    const tab=document.getElementById('tab-'+btn.dataset.tab);
    if (tab) tab.classList.add('active');
    if (['players','actions','skins','ownercosmetics'].includes(btn.dataset.tab)) refreshPlayers();
    updateOwnerStats();
  };
});

function openOwnerPanel() {
  document.getElementById('ownerPanel').classList.remove('hidden');
  updateOwnerStats(); refreshPlayers();
}

document.getElementById('owner-tag-hud').style.pointerEvents = 'auto';
document.getElementById('owner-tag-hud').style.cursor = 'pointer';
document.getElementById('owner-tag-hud').onclick = openOwnerPanel;

document.getElementById('ownerToggleBtn').addEventListener('dblclick', () => {
  const pass = document.getElementById('ownerPass').value;
  if (pass==='Z3N0ISKING') { isOwner=true; buildSkinSelector(); openOwnerPanel(); }
});

function updateOwnerStats() {
  fetch('/api/stats').then(r=>r.json()).then(d=>{
    document.getElementById('os-players').textContent=d.players;
    document.getElementById('os-orbs').textContent=d.orbs;
    document.getElementById('os-event').textContent=d.activeEvent||'NONE';
  }).catch(()=>{});
}

function refreshPlayers() {
  if (!socket) return;
  socket.emit('ownerAction', { action:'getPlayers', password:ownerPass||'Z3N0ISKING' });
}

function renderPlayerTable(list) {
  const tbody = document.getElementById('playerTableBody');
  if (!list.length) { tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:rgba(255,215,0,0.3);padding:20px;">No players online</td></tr>'; return; }
  tbody.innerHTML = list.map(p => `
    <tr>
      <td><span style="color:${p.isOwner?'#ffd700':'rgba(255,215,0,0.8)'}">${p.isOwner?'üëë ':''}${p.name}</span></td>
      <td style="font-family:Space Mono,monospace;font-size:12px;color:rgba(255,215,0,0.6);">${p.length}</td>
      <td style="font-family:Space Mono,monospace;font-size:12px;color:rgba(255,215,0,0.6);">${p.score}</td>
      <td style="font-family:Space Mono,monospace;font-size:12px;color:var(--gold);">üí∞${p.coins||0}</td>
      <td style="font-size:11px;color:rgba(255,215,0,0.5);">${(p.equippedBadge||'')} ${(p.equippedTitle||'')} ${p.equippedTrail?'üé®':''}</td>
      <td><div style="display:flex;gap:4px;flex-wrap:wrap;">
        <button class="btn btn-danger btn-sm" onclick="quickKill('${p.id}','${escHtml(p.name)}')">‚ò†Ô∏è</button>
        <button class="btn btn-sm" style="border:1px solid rgba(255,34,68,0.3);color:rgba(255,34,68,0.6);padding:6px 8px;font-size:9px;" onclick="quickKick('${p.id}','${escHtml(p.name)}')">üö´</button>
        <button class="btn btn-gold btn-sm" onclick="quickSize('${p.id}','${escHtml(p.name)}')">üìè</button>
        <button class="btn btn-gold btn-sm" onclick="quickCoins('${p.id}','${escHtml(p.name)}')">üí∞</button>
      </div></td>
    </tr>`).join('');
}

function escHtml(str) { return str.replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

function populateSelects(list) {
  const selects=['sizeTarget','coinsTarget','swapP1','swapP2','kickTarget','killTarget','skinTarget','ownerCosmeticTarget'];
  selects.forEach(id=>{
    const sel=document.getElementById(id);
    if (!sel) return;
    sel.innerHTML=list.map(p=>`<option value="${p.id}">${p.isOwner?'üëë ':''}${p.name} (len:${p.length})</option>`).join('');
  });
}

function showOwnerAlert(msg,type) {
  const el=document.getElementById('ownerAlert');
  el.textContent=msg; el.className='o-alert '+type; el.style.display='block';
  setTimeout(()=>el.style.display='none',4000);
}

function ownerAction(action,value,targetId) {
  if (!socket) { showToast('Not connected','error'); return; }
  socket.emit('ownerAction',{action,value,targetId,password:ownerPass||'Z3N0ISKING'});
}

function doGiveSize()    { ownerAction('giveSize',   document.getElementById('sizeAmount').value,  document.getElementById('sizeTarget').value); }
function doGiveCoins()   { ownerAction('giveCoins',  document.getElementById('coinsAmount').value, document.getElementById('coinsTarget').value); }
function doSwapSize()    { ownerAction('swapSize',   document.getElementById('swapP2').value,      document.getElementById('swapP1').value); }
function doKick()        { ownerAction('kick',       document.getElementById('kickReason').value||'Kicked by owner.', document.getElementById('kickTarget').value); }
function doInstaKill()   { ownerAction('instaKill',  null,                                          document.getElementById('killTarget').value); }
function doGiveSkin()    { ownerAction('giveSkin',   document.getElementById('skinToGive').value,  document.getElementById('skinTarget').value); }
function doGiveCosmetic(){ ownerAction('giveCosmetic', document.getElementById('ownerCosmeticToGive').value, document.getElementById('ownerCosmeticTarget').value); }
function doBroadcast()   { const msg=document.getElementById('broadcastMsg').value.trim(); if(!msg) return; ownerAction('broadcast',msg); document.getElementById('broadcastMsg').value=''; }

function quickKill(id,name)  { if(!confirm(`Insta-kill ${name}?`)) return; ownerAction('instaKill',null,id); }
function quickKick(id,name)  { const r=prompt(`Kick reason for ${name}:`,'Kicked by Z3N0'); if(r===null) return; ownerAction('kick',r,id); }
function quickSize(id,name)  { const a=prompt(`Give size to ${name}:`,'50'); if(!a) return; ownerAction('giveSize',a,id); }
function quickCoins(id,name) { const a=prompt(`Give coins to ${name}:`,'500'); if(!a) return; ownerAction('giveCoins',a,id); }


// ================================================================
//  UPGRADES PANEL
// ================================================================
function toggleUpgradePanel() {
  const panel = document.getElementById('upgradePanel');
  upgradePanelOpen = !upgradePanelOpen;
  panel.style.display = upgradePanelOpen ? 'block' : 'none';
  if (upgradePanelOpen) renderUpgradePanel();
}

function renderUpgradePanel() {
  const me = gameState.players[myPlayerId];
  const totalCoins = (myProfile.coins || 0) + (me ? me.sessionCoins || 0 : 0);
  document.getElementById('upgradeCoinDisplay').textContent = totalCoins;

  const list = document.getElementById('upgradeList');
  if (!list) return;
  const upgrades = me?.upgrades || myUpgrades;
  const upgradeOrder = ['speed','boost','magnet','growth','armor'];
  const upgradeEmojis = { speed:'‚ö°', boost:'üöÄ', magnet:'üß≤', growth:'üå±', armor:'üõ°Ô∏è' };

  list.innerHTML = upgradeOrder.map(id => {
    const u = upgradesCatalog[id];
    if (!u) return '';
    const level = upgrades[id] || 0;
    const maxLevel = u.maxLevel;
    const cost = level < maxLevel ? Math.floor(u.baseCost * Math.pow(u.costMult, level)) : 0;
    const canAfford = totalCoins >= cost;
    const maxed = level >= maxLevel;
    const bars = Array.from({length: maxLevel}, (_,i) =>
      `<div style="width:12px;height:6px;border-radius:1px;background:${i<level?'#ffd700':'rgba(255,255,255,0.1)'};display:inline-block;margin:0 1px;"></div>`
    ).join('');
    return `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:6px 8px;background:rgba(255,215,0,0.03);border:1px solid rgba(255,215,0,${maxed?'0.3':'0.1'});border-radius:2px;">
      <div>
        <div style="font-size:12px;color:${maxed?'#ffd700':'var(--text)'};">${upgradeEmojis[id]} ${u.name}</div>
        <div style="margin-top:2px;">${bars}</div>
      </div>
      ${maxed
        ? '<span style="font-size:10px;color:#ffd700;letter-spacing:1px;">MAX</span>'
        : `<button onclick="buyUpgrade('${id}')" style="font-family:'Orbitron',monospace;font-size:9px;padding:4px 8px;background:${canAfford?'rgba(255,215,0,0.15)':'rgba(255,255,255,0.05)'};border:1px solid ${canAfford?'rgba(255,215,0,0.5)':'rgba(255,255,255,0.1)'};color:${canAfford?'#ffd700':'var(--dim)'};cursor:${canAfford?'pointer':'default'};border-radius:2px;">üí∞${cost}</button>`
      }
    </div>`;
  }).join('');
}

function buyUpgrade(upgradeId) {
  if (socket) socket.emit('buyUpgrade', { upgradeId });
}

// ================================================================
//  PLAYFAB ACCOUNT LINKING
// ================================================================
let pfLinked = false;
let pfPlayfabId = null;

function pfSetStatus(linked, text) {
  pfLinked = linked;
  document.getElementById('pfStatusDot').style.background = linked ? 'var(--glow)' : 'rgba(255,255,255,0.2)';
  document.getElementById('pfStatusDot').style.boxShadow = linked ? '0 0 6px var(--glow)' : 'none';
  document.getElementById('pfStatusText').textContent = text;
  document.getElementById('pfStatusText').style.color = linked ? 'var(--glow)' : 'var(--dim)';
}

function pfShowError(msg) {
  const el = document.getElementById('pfError');
  el.textContent = msg;
  el.style.display = 'block';
  document.getElementById('pfSuccess').style.display = 'none';
}

function pfShowSuccess(msg) {
  const el = document.getElementById('pfSuccess');
  el.textContent = msg;
  el.style.display = 'block';
  document.getElementById('pfError').style.display = 'none';
}

document.getElementById('pfLinkBtn').onclick = async () => {
  const nameInput = document.getElementById('nameInput').value.trim() || 'Snake';
  const displayName = document.getElementById('pfDisplayName').value.trim() || nameInput;
  const btn = document.getElementById('pfLinkBtn');

  // Clear previous messages
  document.getElementById('pfError').style.display = 'none';
  document.getElementById('pfSuccess').style.display = 'none';

  btn.disabled = true;
  btn.textContent = '‚è≥ LINKING...';

  try {
    const res = await fetch('/api/playfab/link', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playerName: nameInput, displayName })
    });
    const data = await res.json();

    if (!res.ok || data.error) {
      pfShowError(data.error || 'Link failed. Check server config.');
      pfSetStatus(false, 'LINK FAILED');
    } else {
      pfPlayfabId = data.playfabId;
      pfSetStatus(true, 'LINKED ‚úì');
      pfShowSuccess(`‚úÖ ${data.newlyCreated ? 'Account created & linked!' : 'Account linked!'} Display: ${data.displayName}`);
      document.getElementById('pfStatsPanel').style.display = 'block';
      document.getElementById('pfTitleId').textContent = data.playfabId.substring(0, 8) + '...';
      document.getElementById('pfPlayfabId').textContent = data.playfabId;
      btn.textContent = '‚úì LINKED';
    }
  } catch(err) {
    pfShowError('Network error: ' + err.message);
    pfSetStatus(false, 'ERROR');
    btn.textContent = 'üîó LINK TO PLAYFAB';
  } finally {
    btn.disabled = false;
    if (!pfLinked) btn.textContent = 'üîó LINK TO PLAYFAB';
  }
};

// Pre-fill display name when user types their game name
document.getElementById('nameInput').addEventListener('input', () => {
  const pf = document.getElementById('pfDisplayName');
  if (!pf.value || pf.dataset.autofilled === 'true') {
    pf.value = document.getElementById('nameInput').value;
    pf.dataset.autofilled = 'true';
  }
});
document.getElementById('pfDisplayName').addEventListener('input', () => {
  document.getElementById('pfDisplayName').dataset.autofilled = 'false';
});

// ================================================================
//  MENU STATS + HOW TO PLAY
// ================================================================
setInterval(()=>{
  fetch('/api/stats').then(r=>r.json()).then(d=>{
    document.getElementById('statPlayers').textContent=d.players;
    document.getElementById('statOrbs').textContent=d.orbs;
    document.getElementById('statEvent').style.display=d.activeEvent?'inline':'none';
  }).catch(()=>{});
},3000);

document.getElementById('howToBtn').onclick = () => {
  const scheme = controlScheme;
  const boostInfo = boostKey==='shift'?'Shift':boostKey==='space'?'Space':'Shift or Space';
  alert(`üêç HOW TO PLAY ‚Äî Z3N0'S SERPENT REALM\n\nCurrent control scheme: ${scheme.toUpperCase()}\n\n${scheme==='mouse'?'Move mouse to steer':'Use '+scheme.toUpperCase()+' keys to steer'}\nHold click or ${boostInfo} to BOOST\nEat glowing orbs to grow & earn coins\nKill others by making them hit your body\nAvoid the red border ‚Äî instant death\n\nüí∞ COINS: Earned from orbs & kills. Spend in Cosmetics!\nüé® COSMETICS: Trails, titles, badges for your snake\n\nüëë Z3N0 is the supreme owner of this realm.\nOwner panel: F1 key (owner only)`);
};

// ================================================================
//  INIT
// ================================================================
updateBoostLabel();
document.getElementById('nameInput').focus();
</script>
</body>
</html>
