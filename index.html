<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Z3N0 SNAKE REALM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
:root {
  --void:#000008; --deep:#05050f;
  --panel:rgba(0,255,140,0.04); --border:rgba(0,255,140,0.2);
  --glow:#00ff8c; --glow2:#ff2244; --glow3:#aa44ff;
  --gold:#ffd700; --text:#c8ffd4; --dim:rgba(200,255,212,0.5);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--void);}
body{font-family:'Rajdhani',sans-serif;color:var(--text);}
/* CRT scanline overlay */
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,140,0.012) 2px,rgba(0,255,140,0.012) 4px);pointer-events:none;z-index:9999;}

#gameCanvas{position:fixed;inset:0;display:none;cursor:none;}
#cursor{position:fixed;width:18px;height:18px;border:2px solid var(--glow);border-radius:50%;pointer-events:none;z-index:10000;transform:translate(-50%,-50%);box-shadow:0 0 10px var(--glow),inset 0 0 5px rgba(0,255,140,0.3);}
#cursor::after{content:'';position:absolute;top:50%;left:50%;width:4px;height:4px;background:var(--glow);border-radius:50%;transform:translate(-50%,-50%);}

.screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;}
.screen.hidden{display:none!important;}

/* ===== MENU ===== */
#menuScreen{background:radial-gradient(ellipse at 50% 30%,rgba(0,255,140,0.07) 0%,transparent 60%),radial-gradient(ellipse at 80% 70%,rgba(170,68,255,0.05) 0%,transparent 50%),var(--void);flex-direction:column;gap:0;}
.menu-bg-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.mp{position:absolute;width:2px;height:2px;background:var(--glow);border-radius:50%;animation:float-up linear infinite;opacity:0;}
@keyframes float-up{0%{opacity:0;transform:translateY(100vh)}10%{opacity:1}90%{opacity:.4}100%{opacity:0;transform:translateY(-20px)}}

.logo-wrap{text-align:center;margin-bottom:20px;position:relative;}
.logo-z3n0{font-family:'Orbitron',monospace;font-size:clamp(52px,9vw,110px);font-weight:900;background:linear-gradient(135deg,#00ff8c,#aa44ff,#ff2244,#ffd700,#00ff8c);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gshift 3s ease infinite;letter-spacing:-2px;line-height:1;filter:drop-shadow(0 0 25px rgba(0,255,140,.45));}
@keyframes gshift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.logo-sub{font-family:'Orbitron',monospace;font-size:clamp(10px,1.8vw,15px);letter-spacing:7px;color:var(--dim);margin-top:4px;}
.logo-owner{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:4px;color:var(--gold);margin-top:5px;animation:pulse 1.5s ease infinite;}
.owner-crown{position:absolute;top:-28px;left:50%;transform:translateX(-50%);font-size:28px;animation:crown-bob 1.5s ease infinite;}
@keyframes crown-bob{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-7px)}}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}

.z3n0-wm{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:10px;letter-spacing:5px;color:rgba(255,215,0,.12);pointer-events:none;white-space:nowrap;}

.menu-panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:22px;width:min(455px,92vw);backdrop-filter:blur(20px);box-shadow:0 0 60px rgba(0,255,140,.04),inset 0 0 60px rgba(0,255,140,.02);position:relative;}
.menu-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--glow),transparent);}

.menu-tabs{display:flex;gap:4px;margin-bottom:14px;border-bottom:1px solid var(--border);padding-bottom:10px;}
.menu-tab-btn{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;padding:6px 12px;border-radius:2px;border:1px solid transparent;cursor:pointer;background:none;color:var(--dim);transition:all .2s;}
.menu-tab-btn:hover{color:var(--glow);border-color:rgba(0,255,140,.2);}
.menu-tab-btn.active{color:var(--glow);border-color:var(--glow);background:rgba(0,255,140,.05);}
.menu-tab-content{display:none;}.menu-tab-content.active{display:block;}

.input-group{display:flex;flex-direction:column;gap:5px;margin-bottom:14px;}
.input-label{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;}
.game-input{background:rgba(0,255,140,.04);border:1px solid rgba(0,255,140,.15);border-radius:2px;padding:11px 14px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:500;outline:none;transition:border-color .2s,box-shadow .2s;width:100%;}
.game-input:focus{border-color:var(--glow);box-shadow:0 0 18px rgba(0,255,140,.1);}

.skin-selector{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;margin-bottom:18px;}
.skin-opt{aspect-ratio:1;border-radius:4px;border:2px solid rgba(255,255,255,.1);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:19px;transition:all .2s;position:relative;overflow:hidden;}
.skin-opt:hover{transform:scale(1.08);border-color:#fff;}
.skin-opt.selected{border-color:var(--glow);box-shadow:0 0 14px rgba(0,255,140,.4);transform:scale(1.12);}
.skin-opt.owner-only{border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.3);}
.skin-opt.owner-only::after{content:'üëë';position:absolute;bottom:1px;right:1px;font-size:9px;}
.skin-opt.locked{opacity:.3;filter:grayscale(1);cursor:not-allowed;}

.btn{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;padding:13px 24px;border-radius:2px;border:none;cursor:pointer;text-transform:uppercase;transition:all .2s;position:relative;overflow:hidden;width:100%;}
.btn::before{content:'';position:absolute;inset:0;background:#fff;opacity:0;transition:opacity .2s;}
.btn:hover::before{opacity:.05;}.btn:active::before{opacity:.1;}
.btn-primary{background:linear-gradient(135deg,rgba(0,255,140,.18),rgba(0,255,140,.08));color:var(--glow);border:1px solid var(--glow);box-shadow:0 0 18px rgba(0,255,140,.12);}
.btn-primary:hover{box-shadow:0 0 35px rgba(0,255,140,.28);transform:translateY(-1px);}
.btn-danger{background:linear-gradient(135deg,rgba(255,34,68,.18),rgba(255,34,68,.08));color:var(--glow2);border:1px solid var(--glow2);}
.btn-gold{background:linear-gradient(135deg,rgba(255,215,0,.18),rgba(255,215,0,.08));color:var(--gold);border:1px solid var(--gold);}
.btn-blue{background:linear-gradient(135deg,rgba(0,180,255,.18),rgba(0,180,255,.08));color:#00ccff;border:1px solid #00ccff;}
.btn-blue:hover{box-shadow:0 0 28px rgba(0,180,255,.28);transform:translateY(-1px);}
.btn-sm{padding:7px 14px;font-size:9px;}
.btn-row{display:flex;gap:8px;}
.btn-row .btn{flex:1;}

.setting-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(0,255,140,.06);}
.setting-label{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;color:var(--dim);}
.setting-desc{font-size:11px;color:rgba(200,255,212,.3);margin-top:2px;}
.control-radio-group{display:flex;gap:4px;}
.control-radio{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:1px;padding:5px 9px;border-radius:2px;border:1px solid rgba(0,255,140,.15);cursor:pointer;background:none;color:var(--dim);transition:all .15s;}
.control-radio:hover{color:var(--glow);border-color:rgba(0,255,140,.3);}
.control-radio.active{color:var(--glow);border-color:var(--glow);background:rgba(0,255,140,.05);}

/* Account bar */
.account-bar{display:flex;align-items:center;justify-content:space-between;background:rgba(0,200,255,.05);border:1px solid rgba(0,200,255,.18);border-radius:3px;padding:8px 12px;margin-bottom:12px;gap:8px;}
.acct-status{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;}
.acct-status.linked{color:#00ccff;}.acct-status.unlinked{color:rgba(255,120,120,.8);}
.legacy-warn{background:rgba(255,150,0,.07);border:1px solid rgba(255,150,0,.28);border-radius:3px;padding:10px 12px;margin-bottom:12px;font-size:12px;color:rgba(255,200,100,.88);line-height:1.5;}

/* ===== HUD ===== */
#hud{position:fixed;inset:0;pointer-events:none;display:none;z-index:200;}
#hud-score{position:absolute;top:20px;left:50%;transform:translateX(-50%);text-align:center;background:rgba(0,0,8,.7);border:1px solid var(--border);border-radius:3px;padding:8px 18px;backdrop-filter:blur(10px);}
#hud-score .val{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--glow);line-height:1;}
#hud-score .lbl{font-size:9px;letter-spacing:3px;color:var(--dim);}
#hud-coins{position:absolute;top:20px;left:20px;background:rgba(0,0,8,.7);border:1px solid rgba(255,215,0,.2);border-radius:3px;padding:8px 14px;backdrop-filter:blur(10px);font-family:'Orbitron',monospace;font-size:14px;color:var(--gold);}
#hud-len{position:absolute;top:20px;right:20px;background:rgba(0,0,8,.7);border:1px solid var(--border);border-radius:3px;padding:8px 14px;backdrop-filter:blur(10px);text-align:center;}
#hud-len .val{font-family:'Orbitron',monospace;font-size:18px;color:var(--text);}
#hud-len .lbl{font-size:8px;letter-spacing:2px;color:var(--dim);}

/* Leaderboard */
#leaderboard{position:absolute;right:20px;top:90px;width:180px;background:rgba(0,0,8,.75);border:1px solid var(--border);border-radius:3px;padding:10px;backdrop-filter:blur(10px);}
#lb-title{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;color:var(--dim);margin-bottom:8px;text-align:center;}
.lb-entry{display:flex;align-items:center;gap:5px;padding:3px 0;border-bottom:1px solid rgba(0,255,140,.04);}
.lb-rank{font-family:'Space Mono',monospace;font-size:11px;color:var(--dim);width:24px;flex-shrink:0;}
.lb-rank.top1{color:#ffd700;}.lb-rank.top2{color:#c0c0c0;}.lb-rank.top3{color:#cd7f32;}
.lb-name{font-size:12px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lb-name.is-owner{color:var(--gold);}
.lb-len{font-family:'Space Mono',monospace;font-size:10px;color:var(--dim);width:36px;text-align:right;}
.lb-bot{font-size:8px;color:rgba(180,180,200,.4);margin-left:2px;}

/* Boost bar */
#boost-bar{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:200px;}
.boost-track{height:4px;background:rgba(0,255,140,.1);border-radius:2px;overflow:hidden;}
#boost-fill{height:100%;background:var(--glow);border-radius:2px;transition:width .05s linear;box-shadow:0 0 8px var(--glow);}
.boost-lbl{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:2px;color:var(--dim);text-align:center;margin-bottom:4px;}

/* Kill feed */
#killfeed{position:absolute;left:20px;bottom:80px;width:240px;}
.kf-entry{background:rgba(0,0,8,.8);border-left:2px solid var(--glow2);padding:5px 10px;margin-bottom:4px;font-size:12px;animation:kf-in .3s ease;border-radius:0 2px 2px 0;}
@keyframes kf-in{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}

/* Minimap */
#minimap{position:absolute;bottom:20px;right:20px;border:1px solid rgba(0,255,140,.2);border-radius:2px;overflow:hidden;}
#minimapCanvas{display:block;width:120px;height:120px;}

/* Event banner */
#eventBanner{position:absolute;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,8,.9);border:1px solid var(--glow3);border-radius:3px;padding:8px 20px;font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--glow3);display:none;animation:pulse 1.5s ease infinite;white-space:nowrap;}

/* In-game cosmetics */
#inGameCosmeticsBtn{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);margin-left:130px;pointer-events:auto;display:none;}
#ingameCosmeticsPanel{position:fixed;right:0;top:0;height:100%;width:min(340px,90vw);background:rgba(0,0,12,.97);border-left:1px solid var(--border);z-index:500;display:none;overflow-y:auto;padding:20px;}
#ingameCosmeticsPanel::-webkit-scrollbar{width:4px;}
#ingameCosmeticsPanel::-webkit-scrollbar-thumb{background:rgba(0,255,140,.2);border-radius:2px;}
.ingame-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.ingame-panel-title{font-family:'Orbitron',monospace;font-size:12px;letter-spacing:3px;color:var(--glow);}
.coin-hud{display:flex;align-items:center;gap:8px;background:rgba(255,215,0,.06);border:1px solid rgba(255,215,0,.2);border-radius:3px;padding:8px 14px;margin-bottom:14px;}
.coin-amount{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:var(--gold);}
.coin-label{font-size:9px;letter-spacing:2px;color:rgba(255,215,0,.4);}
.equipped-summary{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;font-size:12px;color:var(--dim);}
.cosmetic-section-label{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;color:var(--dim);margin:14px 0 8px;border-bottom:1px solid rgba(0,255,140,.08);padding-bottom:6px;}
.cosmetic-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px;}
.cosmetic-card{background:rgba(0,255,140,.03);border:1px solid rgba(0,255,140,.1);border-radius:3px;padding:10px 6px;text-align:center;position:relative;transition:all .15s;}
.cosmetic-card:hover{border-color:rgba(0,255,140,.25);background:rgba(0,255,140,.06);}
.cosmetic-card.equipped{border-color:var(--glow);background:rgba(0,255,140,.08);}
.cosmetic-card.owned{border-color:rgba(0,255,140,.2);}
.cosmetic-card.locked-shop{opacity:.6;}
.cosmetic-card.owner-only{border-color:rgba(255,215,0,.2);background:rgba(255,215,0,.02);}
.cosmetic-icon{font-size:22px;display:block;margin-bottom:4px;}
.cosmetic-name{font-size:9px;font-family:'Orbitron',monospace;letter-spacing:.5px;color:var(--dim);margin-bottom:4px;}
.equipped-label{position:absolute;top:3px;left:3px;font-size:7px;color:var(--glow);font-family:'Orbitron',monospace;}
.cosmetic-badge{position:absolute;top:3px;right:3px;font-size:11px;}

/* Owner panel */
#owner-tag-hud{position:absolute;top:20px;left:50%;transform:translateX(-50%);margin-top:60px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.3);border-radius:2px;padding:4px 12px;font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:var(--gold);display:none;pointer-events:auto;cursor:pointer;white-space:nowrap;}
#ownerPanel{position:fixed;inset:0;background:rgba(0,0,8,.98);z-index:600;display:flex;}
#ownerPanel.hidden{display:none!important;}
.owner-sidebar{width:200px;background:rgba(255,215,0,.03);border-right:1px solid rgba(255,215,0,.1);display:flex;flex-direction:column;}
.owner-sidebar-header{padding:20px;border-bottom:1px solid rgba(255,215,0,.1);}
.owner-sidebar-header h2{font-family:'Orbitron',monospace;font-size:13px;letter-spacing:2px;color:var(--gold);}
.owner-sidebar-header p{font-size:10px;color:rgba(255,215,0,.4);margin-top:3px;}
.owner-nav{display:flex;flex-direction:column;padding:10px 0;flex:1;}
.owner-nav-btn{padding:11px 18px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .15s;border-left:3px solid transparent;font-size:12px;font-weight:600;color:rgba(255,215,0,.45);background:none;border-top:none;border-right:none;border-bottom:none;text-align:left;font-family:'Rajdhani',sans-serif;}
.owner-nav-btn:hover{background:rgba(255,215,0,.05);color:var(--gold);border-left-color:rgba(255,215,0,.25);}
.owner-nav-btn.active{background:rgba(255,215,0,.07);color:var(--gold);border-left-color:var(--gold);}
.owner-nav-icon{font-size:15px;width:18px;}
.owner-main{flex:1;background:rgba(0,0,8,.98);display:flex;flex-direction:column;overflow:hidden;}
.owner-topbar{padding:14px 22px;border-bottom:1px solid rgba(255,215,0,.1);display:flex;align-items:center;justify-content:space-between;}
.owner-topbar h1{font-family:'Orbitron',monospace;font-size:14px;letter-spacing:3px;color:var(--gold);}
.owner-content{flex:1;overflow-y:auto;padding:22px;}
.owner-content::-webkit-scrollbar{width:4px;}
.owner-content::-webkit-scrollbar-thumb{background:rgba(255,215,0,.18);border-radius:2px;}
.owner-tab{display:none;}.owner-tab.active{display:block;}
.o-card{background:rgba(255,215,0,.025);border:1px solid rgba(255,215,0,.08);border-radius:4px;padding:18px;margin-bottom:14px;}
.o-card h3{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:rgba(255,215,0,.5);margin-bottom:14px;border-bottom:1px solid rgba(255,215,0,.08);padding-bottom:7px;}
.player-table{width:100%;border-collapse:collapse;}
.player-table th{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:rgba(255,215,0,.35);padding:5px 7px;text-align:left;border-bottom:1px solid rgba(255,215,0,.08);}
.player-table td{padding:7px 7px;font-size:12px;border-bottom:1px solid rgba(255,215,0,.04);vertical-align:middle;}
.player-table tr:hover td{background:rgba(255,215,0,.025);}
.o-input{background:rgba(255,215,0,.04);border:1px solid rgba(255,215,0,.15);border-radius:2px;padding:9px 12px;color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;width:100%;margin-bottom:7px;}
.o-input:focus{border-color:var(--gold);box-shadow:0 0 12px rgba(255,215,0,.1);}
.o-select{background:rgba(0,0,0,.5);border:1px solid rgba(255,215,0,.15);border-radius:2px;padding:9px 12px;color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;width:100%;margin-bottom:7px;cursor:pointer;}
.event-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;}
.event-card{background:rgba(170,68,255,.05);border:1px solid rgba(170,68,255,.2);border-radius:4px;padding:14px;text-align:center;cursor:pointer;transition:all .2s;}
.event-card:hover{background:rgba(170,68,255,.1);border-color:var(--glow3);transform:translateY(-2px);}
.event-card .event-icon{font-size:28px;display:block;margin-bottom:6px;}
.event-card .event-name{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;color:var(--glow3);}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
.stat-card{background:rgba(255,215,0,.025);border:1px solid rgba(255,215,0,.08);border-radius:4px;padding:14px;text-align:center;}
.stat-card .sv{font-family:'Orbitron',monospace;font-size:26px;font-weight:900;color:var(--gold);}
.stat-card .sl{font-size:9px;letter-spacing:2px;color:rgba(255,215,0,.35);}
.o-alert{padding:9px 12px;border-radius:2px;margin-bottom:10px;font-size:12px;display:none;}
.o-alert.success{background:rgba(0,255,140,.08);border:1px solid var(--glow);color:var(--glow);}
.o-alert.error{background:rgba(255,34,68,.08);border:1px solid var(--glow2);color:var(--glow2);}

/* Death screen */
#deathScreen{position:fixed;inset:0;background:rgba(0,0,8,.96);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:400;backdrop-filter:blur(6px);}
#deathScreen.hidden{display:none!important;}
.death-title{font-family:'Orbitron',monospace;font-size:clamp(36px,7vw,72px);font-weight:900;color:var(--glow2);animation:death-flash 1.2s ease infinite;margin-bottom:8px;}
@keyframes death-flash{0%,100%{text-shadow:0 0 30px var(--glow2)}50%{text-shadow:0 0 60px var(--glow2),0 0 80px rgba(255,34,68,.5)}}
.death-killer{font-size:14px;color:var(--dim);margin-bottom:20px;letter-spacing:2px;}
.death-stats{display:flex;gap:20px;margin-bottom:28px;}
.ds{text-align:center;}
.ds .dv{font-family:'Orbitron',monospace;font-size:24px;font-weight:900;color:var(--glow);}
.ds .dl{font-size:10px;letter-spacing:3px;color:var(--dim);}
.death-coins{font-family:'Orbitron',monospace;font-size:14px;color:var(--gold);margin-bottom:16px;min-height:20px;}
.death-rank{font-family:'Orbitron',monospace;font-size:12px;color:var(--glow3);margin-bottom:24px;}
.death-btns{display:flex;gap:12px;}
.death-btns .btn{width:160px;}

/* Toasts & messages */
#toast-container{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column;gap:6px;align-items:center;}
.toast{background:rgba(0,0,8,.95);border:1px solid var(--glow);border-radius:2px;padding:8px 18px;font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;color:var(--glow);animation:toast-in .25s ease;white-space:nowrap;}
.toast.error{border-color:var(--glow2);color:var(--glow2);}
.toast.gold{border-color:var(--gold);color:var(--gold);}
@keyframes toast-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
#sysmsg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,8,.9);border:1px solid var(--glow);border-radius:3px;padding:12px 24px;font-family:'Orbitron',monospace;font-size:12px;letter-spacing:2px;color:var(--glow);z-index:1001;display:none;text-align:center;}

#broadcastBanner{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(90deg,rgba(255,215,0,.14),rgba(255,215,0,.04),rgba(255,215,0,.14));border-top:1px solid rgba(255,215,0,.28);padding:9px 22px;font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--gold);text-align:center;z-index:800;display:none;}
#musicControls{position:fixed;bottom:20px;left:20px;z-index:300;display:none;align-items:center;gap:7px;background:rgba(0,0,8,.8);border:1px solid var(--border);border-radius:2px;padding:7px 11px;pointer-events:auto;}
.music-btn{background:none;border:none;cursor:pointer;font-size:14px;padding:2px;opacity:.55;transition:opacity .2s;}
.music-btn:hover{opacity:1;}
.music-vis{display:flex;gap:2px;align-items:center;height:14px;}
.music-bar{width:3px;background:var(--glow);border-radius:2px;animation:music-b linear infinite;}
.music-bar:nth-child(1){height:5px;animation-duration:.4s;}
.music-bar:nth-child(2){height:11px;animation-duration:.6s;}
.music-bar:nth-child(3){height:7px;animation-duration:.5s;}
.music-bar:nth-child(4){height:13px;animation-duration:.7s;}
.music-bar:nth-child(5){height:5px;animation-duration:.45s;}
@keyframes music-b{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.3)}}
.music-paused .music-bar{animation-play-state:paused;}

/* PlayFab modal */
.pf-modal{position:fixed;inset:0;z-index:9000;display:none;background:rgba(0,0,8,.96);backdrop-filter:blur(18px);align-items:center;justify-content:center;}
.pf-modal.open{display:flex;}
.pf-box{background:rgba(0,8,18,.99);border:1px solid rgba(0,200,255,.28);border-radius:6px;padding:30px;width:min(415px,92vw);box-shadow:0 0 55px rgba(0,200,255,.1);position:relative;}
.pf-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#00ccff,transparent);}
.pf-title{font-family:'Orbitron',monospace;font-size:15px;letter-spacing:3px;color:#00ccff;margin-bottom:5px;}
.pf-sub{font-size:11px;color:rgba(0,200,255,.45);margin-bottom:18px;}
.pf-tabs{display:flex;gap:4px;margin-bottom:14px;}
.pf-tab{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;padding:5px 13px;border-radius:2px;border:1px solid transparent;cursor:pointer;background:none;color:rgba(0,200,255,.38);transition:all .2s;}
.pf-tab:hover{color:#00ccff;border-color:rgba(0,200,255,.25);}
.pf-tab.active{color:#00ccff;border-color:#00ccff;background:rgba(0,200,255,.05);}
.pf-content{display:none;}.pf-content.active{display:block;}
.pf-msg{font-size:11px;margin-top:7px;padding:7px;border-radius:2px;display:none;}
.pf-msg.ok{background:rgba(0,255,140,.08);color:var(--glow);border:1px solid rgba(0,255,140,.28);}
.pf-msg.err{background:rgba(255,34,68,.08);color:#ff4466;border:1px solid rgba(255,34,68,.28);}

/* Menu stats */
#menuStats{display:flex;gap:20px;font-size:13px;color:var(--dim);}

@media(max-width:600px){
  .owner-sidebar{width:55px;}
  .owner-nav-btn span{display:none;}
  .owner-sidebar-header h2,.owner-sidebar-header p{display:none;}
}
</style>
</head>
<body>
<div id="cursor"></div>

<!-- ===================== MENU ===================== -->
<div class="screen" id="menuScreen">
  <div class="menu-bg-particles" id="bgParticles"></div>
  <div class="z3n0-wm">Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0 ¬∑ Z3N0</div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:22px;width:100%;max-width:490px;padding:18px;z-index:1;">
    <div class="logo-wrap">
      <span class="owner-crown">üëë</span>
      <div class="logo-z3n0">Z3N0</div>
      <div class="logo-sub">SNAKE REALM ¬∑ EST. 2026</div>
      <div class="logo-owner">CREATED & OWNED BY Z3N0</div>
    </div>

    <div class="menu-panel">
      <div class="menu-tabs">
        <button class="menu-tab-btn active" data-mtab="play">‚ñ∂ PLAY</button>
        <button class="menu-tab-btn" data-mtab="cosmetics">üé® COSMETICS</button>
        <button class="menu-tab-btn" data-mtab="settings">‚öôÔ∏è SETTINGS</button>
      </div>

      <!-- PLAY TAB -->
      <div class="menu-tab-content active" id="mtab-play">
        <div class="account-bar" id="accountBar">
          <div>
            <div class="acct-status unlinked" id="accountStatusText">‚ö†Ô∏è NO ACCOUNT LINKED</div>
            <div style="font-size:10px;color:rgba(255,255,255,.28);margin-top:2px;" id="accountNameText">Progress saves by name only</div>
          </div>
          <button class="btn btn-blue btn-sm" id="openAccountBtn" onclick="openPFModal()">SIGN IN / CREATE</button>
        </div>
        <div class="legacy-warn" id="legacyWarning" style="display:none;">
          ‚ö†Ô∏è <strong>Legacy account detected.</strong> Create a new account to save progress securely.
          <div class="btn-row" style="margin-top:7px;">
            <button class="btn btn-blue btn-sm" onclick="openPFModal('register')">üîó CREATE ACCOUNT</button>
            <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);" onclick="document.getElementById('legacyWarning').style.display='none'">Dismiss</button>
          </div>
        </div>

        <div class="input-group">
          <span class="input-label">Your Name</span>
          <input class="game-input" id="nameInput" type="text" placeholder="Enter your name..." maxlength="20" autocomplete="off">
        </div>
        <div class="input-group">
          <span class="input-label">Choose Skin</span>
          <div class="skin-selector" id="skinSelector"></div>
        </div>
        <div class="input-group" id="ownerPassGroup" style="display:none;">
          <span class="input-label">üîê Owner Code</span>
          <input class="game-input" id="ownerPass" type="password" placeholder="Enter owner password..." autocomplete="off">
        </div>
        <button class="btn btn-primary" id="playBtn" style="margin-bottom:8px;">‚ñ∂ PLAY</button>
        <div class="btn-row">
          <button class="btn btn-gold btn-sm" id="ownerToggleBtn">üëë OWNER</button>
          <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--dim);" id="howToBtn">? HOW TO PLAY</button>
        </div>
      </div>

      <!-- COSMETICS TAB -->
      <div class="menu-tab-content" id="mtab-cosmetics">
        <div class="coin-hud" style="margin-bottom:10px;">
          <span style="font-size:18px;">üí∞</span>
          <div><div class="coin-amount" id="menuCoinBalance">0</div><div class="coin-label">COINS</div></div>
        </div>
        <p style="font-size:11px;color:var(--dim);margin-bottom:10px;">Enter the game to buy & equip cosmetics.</p>
      </div>

      <!-- SETTINGS TAB -->
      <div class="menu-tab-content" id="mtab-settings">
        <div class="setting-row">
          <div><div class="setting-label">CONTROL SCHEME</div><div class="setting-desc">How you steer</div></div>
          <div class="control-radio-group" id="controlSchemeGroup">
            <button class="control-radio" data-scheme="mouse">üñ±Ô∏è MOUSE</button>
            <button class="control-radio" data-scheme="wasd">WASD</button>
            <button class="control-radio" data-scheme="arrows">ARROWS</button>
            <button class="control-radio" data-scheme="both">WASD+‚Üë</button>
          </div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">BOOST KEY</div><div class="setting-desc">Also: hold click</div></div>
          <div class="control-radio-group" id="boostKeyGroup">
            <button class="control-radio" data-boost="shift">SHIFT</button>
            <button class="control-radio" data-boost="space">SPACE</button>
            <button class="control-radio" data-boost="both_boost">BOTH</button>
          </div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">MOUSE STEERING</div><div class="setting-desc">Even w/ keyboard</div></div>
          <div class="control-radio-group" id="mouseAlwaysGroup">
            <button class="control-radio" data-mouse="on">ON</button>
            <button class="control-radio" data-mouse="off">OFF</button>
          </div>
        </div>
        <div style="margin-top:14px;padding:9px;background:rgba(0,255,140,.03);border:1px solid rgba(0,255,140,.08);border-radius:2px;font-size:11px;color:var(--dim);line-height:1.6;">
          Settings auto-save. ¬∑ Owner panel: <span style="color:var(--gold);">F1</span>
        </div>
      </div>
    </div>

    <div id="menuStats">
      <span>üêç <span id="statPlayers">0</span> online</span>
      <span>ü§ñ <span id="statBots">0</span> bots</span>
      <span>üåü <span id="statOrbs">0</span> orbs</span>
      <span id="statEvent" style="display:none;color:var(--glow3);">‚ö° EVENT</span>
    </div>
    <div style="font-family:'Orbitron',monospace;font-size:8px;letter-spacing:4px;color:rgba(255,215,0,.25);">üëë Z3N0'S SNAKE GAME ‚Äî ALL RIGHTS RESERVED</div>
  </div>
</div>

<!-- ===================== CANVAS ===================== -->
<canvas id="gameCanvas"></canvas>

<!-- ===================== HUD ===================== -->
<div id="hud">
  <div id="hud-coins">üí∞ <span id="hudCoins">0</span></div>
  <div id="hud-score"><div class="val" id="scoreVal">0</div><div class="lbl">SCORE</div></div>
  <div id="hud-len"><div class="val" id="lengthVal">0</div><div class="lbl">LENGTH</div></div>

  <div id="leaderboard">
    <div id="lb-title">LEADERBOARD</div>
    <div id="lbList"></div>
  </div>

  <div id="boost-bar">
    <div class="boost-lbl" id="boostLabel">BOOST [SHIFT/CLICK]</div>
    <div class="boost-track"><div id="boost-fill" style="width:100%;"></div></div>
  </div>

  <div id="killfeed"></div>
  <div id="eventBanner" id="eventTitle">‚ö° EVENT</div>
  <div id="minimap"><canvas id="minimapCanvas" width="120" height="120"></canvas></div>
  <div id="sysmsg"></div>

  <!-- In-game cosmetics -->
  <button class="btn btn-primary btn-sm" id="inGameCosmeticsBtn" onclick="openIngameCosmetics()" style="pointer-events:auto;">üé® COSMETICS</button>
  <div id="owner-tag-hud">üëë Z3N0 ‚Äî OWNER PANEL [F1]</div>
</div>

<!-- ===================== IN-GAME COSMETICS ===================== -->
<div id="ingameCosmeticsPanel">
  <div class="ingame-panel-header">
    <div class="ingame-panel-title">üé® COSMETICS</div>
    <button onclick="closeIngameCosmetics()" style="background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;">‚úï</button>
  </div>
  <div class="coin-hud">
    <span style="font-size:18px;">üí∞</span>
    <div><div class="coin-amount" id="ingameCoinBalance">0</div><div class="coin-label">COINS</div></div>
  </div>
  <div class="equipped-summary">
    <span>Trail: <span id="equippedTrailDisplay" style="color:var(--glow);">None</span></span>
    <span> ¬∑ Title: <span id="equippedTitleDisplay" style="color:#aa44ff;">None</span></span>
    <span> ¬∑ Badge: <span id="equippedBadgeDisplay">‚Äî</span></span>
  </div>
  <div id="cosmeticsShopContent"></div>
</div>

<!-- ===================== DEATH SCREEN ===================== -->
<div id="deathScreen" class="hidden">
  <div class="death-title">üíÄ GAME OVER</div>
  <div class="death-killer" id="deathKiller">Eliminated</div>
  <div class="death-stats">
    <div class="ds"><div class="dv" id="deathScore">0</div><div class="dl">SCORE</div></div>
    <div class="ds"><div class="dv" id="deathLength">0</div><div class="dl">LENGTH</div></div>
    <div class="ds"><div class="dv" id="deathRank">‚Äî</div><div class="dl">RANK</div></div>
  </div>
  <div class="death-coins" id="deathCoinsEarned"></div>
  <div class="death-btns">
    <button class="btn btn-primary" id="respawnBtn">‚ñ∂ RESPAWN</button>
    <button class="btn btn-danger" id="menuBtn">‚üµ MENU</button>
  </div>
</div>

<!-- ===================== OWNER PANEL ===================== -->
<div id="ownerPanel" class="hidden">
  <div class="owner-sidebar">
    <div class="owner-sidebar-header">
      <h2>üëë Z3N0</h2>
      <p>Owner Panel</p>
    </div>
    <nav class="owner-nav">
      <button class="owner-nav-btn active" data-tab="stats"><span class="owner-nav-icon">üìä</span><span>Stats</span></button>
      <button class="owner-nav-btn" data-tab="players"><span class="owner-nav-icon">üë•</span><span>Players</span></button>
      <button class="owner-nav-btn" data-tab="actions"><span class="owner-nav-icon">‚ö°</span><span>Actions</span></button>
      <button class="owner-nav-btn" data-tab="events"><span class="owner-nav-icon">üåü</span><span>Events</span></button>
      <button class="owner-nav-btn" data-tab="skins"><span class="owner-nav-icon">üé®</span><span>Skins</span></button>
      <button class="owner-nav-btn" data-tab="ownercosmetics"><span class="owner-nav-icon">üëë</span><span>Cosmetics</span></button>
    </nav>
  </div>
  <div class="owner-main">
    <div class="owner-topbar">
      <h1>‚ö° OWNER CONTROL CENTER</h1>
      <button class="btn btn-sm btn-danger" id="closeOwnerPanel" style="width:auto;">‚úï CLOSE</button>
    </div>
    <div class="owner-content">
      <div class="o-alert" id="ownerAlert"></div>

      <!-- STATS -->
      <div class="owner-tab active" id="tab-stats">
        <div class="stats-grid">
          <div class="stat-card"><div class="sv" id="os-players">0</div><div class="sl">PLAYERS</div></div>
          <div class="stat-card"><div class="sv" id="os-orbs">0</div><div class="sl">ORBS</div></div>
          <div class="stat-card"><div class="sv" id="os-event">NONE</div><div class="sl">EVENT</div></div>
        </div>
        <div class="o-card"><h3>BROADCAST MESSAGE</h3>
          <input class="o-input" id="broadcastMsg" placeholder="Server announcement...">
          <button class="btn btn-gold" onclick="doBroadcast()">üì¢ BROADCAST</button>
        </div>
      </div>

      <!-- PLAYERS -->
      <div class="owner-tab" id="tab-players">
        <div class="o-card">
          <h3>ONLINE PLAYERS</h3>
          <table class="player-table">
            <thead><tr><th>NAME</th><th>LEN</th><th>SCORE</th><th>COINS</th><th>COSMETICS</th><th>ACTIONS</th></tr></thead>
            <tbody id="playerTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="owner-tab" id="tab-actions">
        <div class="o-card"><h3>GIVE SIZE</h3>
          <select class="o-select" id="sizeTarget"></select>
          <input class="o-input" id="sizeAmount" type="number" placeholder="Segments (e.g. 100)">
          <button class="btn btn-gold" onclick="doGiveSize()">üìè GIVE SIZE</button>
        </div>
        <div class="o-card"><h3>GIVE COINS</h3>
          <select class="o-select" id="coinsTarget"></select>
          <input class="o-input" id="coinsAmount" type="number" placeholder="Amount">
          <button class="btn btn-gold" onclick="doGiveCoins()">üí∞ GIVE COINS</button>
        </div>
        <div class="o-card"><h3>SWAP SIZE</h3>
          <select class="o-select" id="swapP1"></select>
          <select class="o-select" id="swapP2"></select>
          <button class="btn btn-gold" onclick="doSwapSize()">üîÑ SWAP</button>
        </div>
        <div class="o-card"><h3>KICK PLAYER</h3>
          <select class="o-select" id="kickTarget"></select>
          <input class="o-input" id="kickReason" placeholder="Reason...">
          <button class="btn btn-danger" onclick="doKick()">üö´ KICK</button>
        </div>
        <div class="o-card"><h3>INSTA-KILL</h3>
          <select class="o-select" id="killTarget"></select>
          <button class="btn btn-danger" onclick="doInstaKill()">‚ò†Ô∏è KILL</button>
        </div>
      </div>

      <!-- EVENTS -->
      <div class="owner-tab" id="tab-events">
        <div class="o-card"><h3>START EVENT</h3>
          <div class="event-grid">
            <div class="event-card" onclick="ownerAction('startEvent','speedBoost')"><span class="event-icon">‚ö°</span><div class="event-name">HYPERSPEED</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','orbFrenzy')"><span class="event-icon">üåü</span><div class="event-name">ORB OVERLOAD</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','shrinkAll')"><span class="event-icon">üíÄ</span><div class="event-name">DEATH SHRINK</div></div>
            <div class="event-card" onclick="ownerAction('startEvent','growAll')"><span class="event-icon">üêç</span><div class="event-name">TITAN RISE</div></div>
            <div class="event-card" onclick="ownerAction('endEvent')"><span class="event-icon">üõë</span><div class="event-name">END EVENT</div></div>
          </div>
        </div>
      </div>

      <!-- SKINS -->
      <div class="owner-tab" id="tab-skins">
        <div class="o-card"><h3>GIVE SKIN</h3>
          <select class="o-select" id="skinTarget"></select>
          <select class="o-select" id="skinToGive">
            <option value="rainbow_god">üåà Rainbow God</option>
            <option value="void_lord">üåë Void Lord</option>
            <option value="galaxy_emperor">üåå Galaxy Emperor</option>
            <option value="neon_death">‚ö° Neon Death</option>
            <option value="chrome_divine">‚ú® Chrome Divine</option>
            <option value="classic">üêç Classic</option>
          </select>
          <button class="btn btn-gold" onclick="doGiveSkin()">üé® GIVE SKIN</button>
        </div>
      </div>

      <!-- OWNER COSMETICS -->
      <div class="owner-tab" id="tab-ownercosmetics">
        <div class="o-card"><h3>GRANT COSMETIC</h3>
          <select class="o-select" id="ownerCosmeticTarget"></select>
          <select class="o-select" id="ownerCosmeticToGive">
            <option value="owner_aura">‚ú® Z3N0 Aura</option>
            <option value="owner_trail">üëë Z3N0 Trail</option>
            <option value="owner_title">üëë [Z3N0] Title</option>
            <option value="owner_explode">üí• Death Explosion</option>
            <option value="trail_rainbow">üåà Rainbow Trail</option>
            <option value="trail_gold">‚≠ê Gold Trail</option>
            <option value="title_god">‚ö° [GOD] Title</option>
            <option value="badge_crown">üëë Crown Badge</option>
          </select>
          <button class="btn btn-gold" onclick="doGiveCosmetic()">üé® GRANT</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<div id="musicControls">
  <button class="music-btn" id="musicToggle">üéµ</button>
  <div class="music-vis" id="musicVis"><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div></div>
</div>
<div id="broadcastBanner"><span>üëë Z3N0: </span><span id="broadcastText"></span></div>

<!-- ===================== PLAYFAB MODAL ===================== -->
<div class="pf-modal" id="playfabModal">
  <div class="pf-box">
    <button onclick="closePFModal()" style="position:absolute;top:10px;right:12px;background:none;border:none;color:rgba(0,200,255,.4);font-size:17px;cursor:pointer;">‚úï</button>
    <div class="pf-title">üîê PLAYER ACCOUNT</div>
    <div class="pf-sub">Link your progress to a secure account</div>
    <div class="pf-tabs">
      <button class="pf-tab active" id="pf-tab-login" onclick="pfTab('login')">SIGN IN</button>
      <button class="pf-tab" id="pf-tab-register" onclick="pfTab('register')">CREATE NEW</button>
    </div>

    <div class="pf-content active" id="pf-login">
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Username or Email</span>
        <input class="game-input" id="pfLoginUser" placeholder="Username or email..." autocomplete="username">
      </div>
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Password</span>
        <input class="game-input" id="pfLoginPass" type="password" placeholder="Password..." autocomplete="current-password">
      </div>
      <button class="btn btn-blue" onclick="pfLogin()" id="pfLoginBtn">SIGN IN</button>
      <div class="pf-msg" id="pfLoginMsg"></div>
    </div>

    <div class="pf-content" id="pf-register">
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Display Name</span>
        <input class="game-input" id="pfRegName" placeholder="Your snake name..." maxlength="20" autocomplete="off">
      </div>
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Username</span>
        <input class="game-input" id="pfRegUser" placeholder="Username..." autocomplete="username">
      </div>
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Email</span>
        <input class="game-input" id="pfRegEmail" type="email" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="input-group">
        <span class="input-label" style="color:rgba(0,200,255,.55);">Password</span>
        <input class="game-input" id="pfRegPass" type="password" placeholder="Min 6 characters..." autocomplete="new-password">
      </div>
      <button class="btn btn-blue" onclick="pfRegister()" id="pfRegBtn">CREATE ACCOUNT</button>
      <div class="pf-msg" id="pfRegMsg"></div>
    </div>

    <div class="pf-content" id="pf-loggedin">
      <div style="text-align:center;padding:12px 0;">
        <div style="font-size:30px;margin-bottom:8px;">‚úÖ</div>
        <div style="font-family:'Orbitron',monospace;font-size:13px;color:#00ccff;letter-spacing:2px;" id="pfLoggedInName">Welcome!</div>
        <div style="font-size:11px;color:rgba(0,200,255,.35);margin-top:4px;">Account linked</div>
      </div>
      <button class="btn btn-blue" onclick="closePFModal()" style="margin-bottom:8px;">‚ñ∂ CONTINUE</button>
      <button class="btn btn-sm btn-danger" onclick="pfLogout()" style="margin-top:4px;">Sign Out</button>
    </div>
  </div>
</div>

<script>
'use strict';
// ================================================================
//  SKIN DEFINITIONS
// ================================================================
const SKINS = {
  classic:        { name:'Classic',     emoji:'üêç', colors:['#00ff8c','#00cc70'],  glow:'#00ff8c' },
  fire:           { name:'Fire',        emoji:'üî•', colors:['#ff4400','#ff8800'],  glow:'#ff6600' },
  ice:            { name:'Ice',         emoji:'‚ùÑÔ∏è', colors:['#00ccff','#0066ff'],  glow:'#00ccff' },
  toxic:          { name:'Toxic',       emoji:'‚ò£Ô∏è', colors:['#88ff00','#44aa00'],  glow:'#88ff00' },
  gold:           { name:'Gold',        emoji:'‚≠ê', colors:['#ffd700','#ffaa00'],  glow:'#ffd700' },
  midnight:       { name:'Midnight',    emoji:'üåô', colors:['#4400ff','#8800ff'],  glow:'#6600ff' },
  sunset:         { name:'Sunset',      emoji:'üåÖ', colors:['#ff0066','#ff8800'],  glow:'#ff4488' },
  ocean:          { name:'Ocean',       emoji:'üåä', colors:['#0044ff','#00ffcc'],  glow:'#00aaff' },
  lava:           { name:'Lava',        emoji:'üåã', colors:['#ff2200','#ffdd00'],  glow:'#ff4400' },
  forest:         { name:'Forest',      emoji:'üå≤', colors:['#006600','#88cc00'],  glow:'#44aa00' },
  rainbow_god:    { name:'Rainbow God', emoji:'üåà', colors:['rainbow'],            glow:'#ffffff', ownerOnly:true },
  void_lord:      { name:'Void Lord',   emoji:'üåë', colors:['#110011','#440044'],  glow:'#aa00ff', ownerOnly:true },
  galaxy_emperor: { name:'Galaxy',      emoji:'üåå', colors:['#000033','#0000aa'],  glow:'#4488ff', ownerOnly:true },
  neon_death:     { name:'Neon Death',  emoji:'‚ö°', colors:['#ff0000','#00ffff'],  glow:'#ffffff', ownerOnly:true },
  chrome_divine:  { name:'Chrome',      emoji:'‚ú®', colors:['#888888','#ffffff'],  glow:'#ffffff', ownerOnly:true },
};

// ================================================================
//  SETTINGS
// ================================================================
let controlScheme = localStorage.getItem('controlScheme') || 'mouse';
let boostKey      = localStorage.getItem('boostKey')      || 'shift';
let mouseAlways   = localStorage.getItem('mouseAlways')   !== 'off';

function saveSettings() {
  localStorage.setItem('controlScheme', controlScheme);
  localStorage.setItem('boostKey',      boostKey);
  localStorage.setItem('mouseAlways',   mouseAlways ? 'on' : 'off');
  updateBoostLabel();
}
function updateBoostLabel() {
  const m = { shift:'BOOST [SHIFT/CLICK]', space:'BOOST [SPACE/CLICK]', both_boost:'BOOST [SHIFT/SPACE/CLICK]' };
  const el = document.getElementById('boostLabel');
  if (el) el.textContent = m[boostKey] || 'BOOST [HOLD CLICK]';
}

// Init settings UI
function initRadioGroup(groupId, attr, current, onPick) {
  document.querySelectorAll(`#${groupId} .control-radio`).forEach(btn => {
    btn.classList.toggle('active', btn.dataset[attr] === current);
    btn.onclick = () => {
      document.querySelectorAll(`#${groupId} .control-radio`).forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      onPick(btn.dataset[attr]);
    };
  });
}
initRadioGroup('controlSchemeGroup','scheme', controlScheme, v => { controlScheme=v; saveSettings(); });
initRadioGroup('boostKeyGroup',     'boost',  boostKey,      v => { boostKey=v; saveSettings(); });
initRadioGroup('mouseAlwaysGroup',  'mouse',  mouseAlways?'on':'off', v => { mouseAlways=(v==='on'); saveSettings(); });

document.querySelectorAll('.menu-tab-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.menu-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.menu-tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('mtab-' + btn.dataset.mtab).classList.add('active');
  };
});

// ================================================================
//  GAME STATE
// ================================================================
let socket = null, myPlayerId = null, isOwner = false;
let gameState = { players:{}, leaderboard:[], activeEvent:null };
let myAngle = 0, boosting = false, boostEnergy = 100;
let selectedSkin = localStorage.getItem('selectedSkin') || 'classic';
let ownerPass = '';
let currentPlayerList = [];
let gameActive = false;
let myDeathScore = 0, myDeathLength = 0;
let camX = 0, camY = 0;
let MAP_SIZE = 6000;
let orbsLocal = {};
let rainbowT = 0;
let musicPlaying = false, audioCtx = null, musicInterval = null;
let myName = '';
let myProfile = { coins:0, unlockedCosmetics:[], equippedTrail:null, equippedTitle:null, equippedBadge:null };
let cosmeticsCatalog = {};
let sessionCoinsDisplay = 0;
let frameCount = 0;
// HUD update throttle ‚Äî only update DOM every 4 frames
let hudDirty = true;
// Cached minimap canvas context
let mmCtx = null;
// Pre-cached background gradient (avoid recreating every frame)
let bgGradient = null;
let bgGradientCX = -1, bgGradientCY = -1;

// ================================================================
//  PLAYFAB
// ================================================================
const PLAYFAB_TITLE_ID = '12F9AF'; // <-- TODO: Replace with your actual PlayFab Title ID (e.g. 'AB12C')
let pfPlayerId = null, pfSessionTicket = null, pfDisplayName = null;

(function loadPFSession() {
  try {
    const d = JSON.parse(localStorage.getItem('z3n0_pf_session') || 'null');
    if (d) {
      pfPlayerId = d.playerId; pfSessionTicket = d.sessionTicket; pfDisplayName = d.displayName;
      updateAccountBar(true, d.displayName);
      if (d.displayName) document.getElementById('nameInput').value = d.displayName;
    }
  } catch(e){}
})();

function updateAccountBar(linked, name) {
  const st = document.getElementById('accountStatusText');
  const nt = document.getElementById('accountNameText');
  const btn = document.getElementById('openAccountBtn');
  if (linked) {
    st.textContent = '‚úÖ ACCOUNT LINKED'; st.className = 'acct-status linked';
    nt.textContent = 'Playing as: ' + (name||'Player');
    btn.textContent = 'ACCOUNT';
  } else {
    st.textContent = '‚ö†Ô∏è NO ACCOUNT LINKED'; st.className = 'acct-status unlinked';
    nt.textContent = 'Progress saves by name only';
    btn.textContent = 'SIGN IN / CREATE';
  }
}

function openPFModal(tab) {
  document.getElementById('playfabModal').classList.add('open');
  pfTab(pfPlayerId ? 'loggedin' : (tab || 'login'));
  if (pfPlayerId) document.getElementById('pfLoggedInName').textContent = pfDisplayName || 'Player';
}
function closePFModal() { document.getElementById('playfabModal').classList.remove('open'); }

function pfTab(tab) {
  ['login','register','loggedin'].forEach(t => {
    const btn = document.getElementById('pf-tab-' + t);
    if (btn) btn.classList.toggle('active', t === tab);
    const el = document.getElementById('pf-' + t);
    if (el) el.classList.toggle('active', t === tab);
  });
}

function pfMsg(id, msg, ok) {
  const el = document.getElementById(id);
  el.textContent = msg; el.className = 'pf-msg ' + (ok ? 'ok' : 'err'); el.style.display = 'block';
}

async function pfCall(endpoint, body) {
  const r = await fetch(`https://${PLAYFAB_TITLE_ID}.playfabapi.com/Client/${endpoint}`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
  });
  return r.json();
}

async function pfLogin() {
  if (!PLAYFAB_TITLE_ID || PLAYFAB_TITLE_ID === 'YOUR_TITLE_ID') {
    pfMsg('pfLoginMsg', '‚ùå PlayFab Title ID not configured. Replace YOUR_TITLE_ID in the code with your actual PlayFab Title ID.', false);
    return;
  }
  const user = document.getElementById('pfLoginUser').value.trim();
  const pass = document.getElementById('pfLoginPass').value;
  if (!user || !pass) { pfMsg('pfLoginMsg','Enter username/email and password.', false); return; }
  document.getElementById('pfLoginBtn').textContent = 'SIGNING IN...';
  try {
    const isEmail = user.includes('@');
    const data = await pfCall(isEmail ? 'LoginWithEmailAddress' : 'LoginWithPlayFab',
      isEmail ? {TitleId:PLAYFAB_TITLE_ID,Email:user,Password:pass,InfoRequestParameters:{GetPlayerProfile:true}}
               : {TitleId:PLAYFAB_TITLE_ID,Username:user,Password:pass,InfoRequestParameters:{GetPlayerProfile:true}});
    if (data.code === 200) {
      pfPlayerId = data.data.PlayFabId;
      pfSessionTicket = data.data.SessionTicket;
      pfDisplayName = data.data.InfoResultPayload?.PlayerProfile?.DisplayName || user;
      localStorage.setItem('z3n0_pf_session', JSON.stringify({playerId:pfPlayerId,sessionTicket:pfSessionTicket,displayName:pfDisplayName}));
      updateAccountBar(true, pfDisplayName);
      document.getElementById('nameInput').value = pfDisplayName;
      pfMsg('pfLoginMsg','‚úÖ Welcome back, ' + pfDisplayName, true);
      setTimeout(() => { pfTab('loggedin'); document.getElementById('pfLoggedInName').textContent = pfDisplayName; }, 700);
    } else {
      pfMsg('pfLoginMsg', data.errorMessage || 'Login failed. Check credentials.', false);
    }
  } catch(e) {
    pfMsg('pfLoginMsg', 'Connection error. Is PLAYFAB_TITLE_ID set correctly?', false);
  }
  document.getElementById('pfLoginBtn').textContent = 'SIGN IN';
}

async function pfRegister() {
  if (!PLAYFAB_TITLE_ID || PLAYFAB_TITLE_ID === 'YOUR_TITLE_ID') {
    pfMsg('pfRegMsg', '‚ùå PlayFab Title ID not configured. Replace YOUR_TITLE_ID in the code with your actual PlayFab Title ID.', false);
    return;
  }
  const name = document.getElementById('pfRegName').value.trim();
  const user = document.getElementById('pfRegUser').value.trim();
  const email = document.getElementById('pfRegEmail').value.trim();
  const pass = document.getElementById('pfRegPass').value;
  if (!name||!user||!email||!pass) { pfMsg('pfRegMsg','All fields required.',false); return; }
  if (pass.length < 6) { pfMsg('pfRegMsg','Password must be ‚â• 6 characters.',false); return; }
  document.getElementById('pfRegBtn').textContent = 'CREATING...';
  try {
    const data = await pfCall('RegisterPlayFabUser', {
      TitleId:PLAYFAB_TITLE_ID, Username:user, Email:email, Password:pass, DisplayName:name, RequireBothUsernameAndEmail:true
    });
    if (data.code === 200) {
      pfPlayerId = data.data.PlayFabId;
      pfSessionTicket = data.data.SessionTicket;
      pfDisplayName = name;
      localStorage.setItem('z3n0_pf_session', JSON.stringify({playerId:pfPlayerId,sessionTicket:pfSessionTicket,displayName:pfDisplayName}));
      updateAccountBar(true, pfDisplayName);
      document.getElementById('nameInput').value = pfDisplayName;
      pfMsg('pfRegMsg','‚úÖ Account created! Welcome, ' + pfDisplayName, true);
      setTimeout(() => { pfTab('loggedin'); document.getElementById('pfLoggedInName').textContent = pfDisplayName; }, 700);
    } else {
      pfMsg('pfRegMsg', data.errorMessage || 'Registration failed.', false);
    }
  } catch(e) {
    pfMsg('pfRegMsg', 'Connection error. Check PLAYFAB_TITLE_ID.', false);
  }
  document.getElementById('pfRegBtn').textContent = 'CREATE ACCOUNT';
}

function pfLogout() {
  pfPlayerId = null; pfSessionTicket = null; pfDisplayName = null;
  localStorage.removeItem('z3n0_pf_session');
  updateAccountBar(false);
  closePFModal();
  showToast('Signed out.', null);
}

// ================================================================
//  SKIN SELECTOR
// ================================================================
function buildSkinSelector() {
  const sel = document.getElementById('skinSelector');
  sel.innerHTML = '';
  for (const [id, skin] of Object.entries(SKINS)) {
    if (skin.ownerOnly && !isOwner) continue;
    const d = document.createElement('div');
    d.className = 'skin-opt' + (skin.ownerOnly ? ' owner-only' : '') + (id === selectedSkin ? ' selected' : '');
    d.title = skin.name;
    d.textContent = skin.emoji;
    d.onclick = () => {
      selectedSkin = id;
      localStorage.setItem('selectedSkin', id);
      document.querySelectorAll('.skin-opt').forEach(s => s.classList.remove('selected'));
      d.classList.add('selected');
    };
    sel.appendChild(d);
  }
}
buildSkinSelector();

// ================================================================
//  MUSIC
// ================================================================
const MELODY = [261,293,329,349,392,440,493,523,493,440,392,349,329,293,261,293,329,392,440,493,523,587,523,493,440,392,349,329];
const BASS   = [65,73,82,87,98,110,65,73];
let noteIdx = 0;

function initMusic() {
  if (audioCtx) return;
  try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
}

function playNote(freq, type, dur, gain, t) {
  if (!audioCtx || !musicPlaying) return;
  const osc = audioCtx.createOscillator();
  const g   = audioCtx.createGain();
  const flt = audioCtx.createBiquadFilter();
  flt.type='lowpass'; flt.frequency.value=2000;
  osc.connect(flt); flt.connect(g); g.connect(audioCtx.destination);
  osc.type = type; osc.frequency.value = freq;
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(gain, t+0.02);
  g.gain.exponentialRampToValueAtTime(0.001, t+dur);
  osc.start(t); osc.stop(t+dur+0.05);
}

function scheduleMusicNotes() {
  if (musicInterval) clearInterval(musicInterval);
  const tempo = 0.18; let beat = 0;
  musicInterval = setInterval(() => {
    if (!musicPlaying || !audioCtx) return;
    const now = audioCtx.currentTime;
    playNote(MELODY[noteIdx % MELODY.length], 'triangle', tempo*1.5, 0.07, now);
    playNote(MELODY[noteIdx % MELODY.length]*2, 'sine', tempo, 0.025, now+0.05);
    if (beat%2===0) playNote(BASS[beat%BASS.length], 'sawtooth', tempo*2, 0.05, now);
    if (beat%4===0) {
      const k = audioCtx.createOscillator(), kg = audioCtx.createGain();
      k.connect(kg); kg.connect(audioCtx.destination);
      k.frequency.setValueAtTime(150,now); k.frequency.exponentialRampToValueAtTime(0.001,now+0.28);
      kg.gain.setValueAtTime(0.25,now); kg.gain.exponentialRampToValueAtTime(0.001,now+0.28);
      k.start(now); k.stop(now+0.32);
    }
    noteIdx++; beat++;
  }, tempo*1000);
}

function playMusic() { musicPlaying=true; document.getElementById('musicVis').classList.remove('music-paused'); document.getElementById('musicToggle').textContent='üéµ'; scheduleMusicNotes(); }
function pauseMusic() { musicPlaying=false; document.getElementById('musicVis').classList.add('music-paused'); document.getElementById('musicToggle').textContent='‚è∏'; if(musicInterval){clearInterval(musicInterval);musicInterval=null;} }

document.getElementById('musicToggle').onclick = () => {
  if (!audioCtx) { initMusic(); if(audioCtx) playMusic(); return; }
  musicPlaying ? pauseMusic() : playMusic();
};

// ================================================================
//  PLAY
// ================================================================
document.getElementById('playBtn').onclick = () => {
  const name = document.getElementById('nameInput').value.trim() || 'Snake';
  myName = name; ownerPass = document.getElementById('ownerPass').value;
  connectAndJoin(name, selectedSkin, ownerPass);
};
document.getElementById('nameInput').addEventListener('keydown', e => { if (e.key==='Enter') document.getElementById('playBtn').click(); });

// Owner toggle
document.getElementById('ownerToggleBtn').addEventListener('dblclick', () => {
  const grp = document.getElementById('ownerPassGroup');
  grp.style.display = grp.style.display==='none' ? 'flex' : 'none';
});

// ================================================================
//  SOCKET
// ================================================================
function connectAndJoin(name, skin, password) {
  if (socket) { socket.disconnect(); socket = null; }
  socket = io({ transports:['websocket'] });

  socket.on('connect', () => {
    socket.emit('joinGame', { name, skin, password, playfabId: pfPlayerId || null });
  });

  socket.on('joined', data => {
    myPlayerId = data.playerId; isOwner = data.isOwner; MAP_SIZE = data.mapSize;
    orbsLocal = {}; data.orbs.forEach(o => orbsLocal[o.id] = o);
    myProfile = data.profile || myProfile;
    cosmeticsCatalog = data.cosmeticsCatalog || {};
    if (data.profile?.isLegacyAccount && !pfPlayerId)
      document.getElementById('legacyWarning').style.display = 'block';
    startGame();
    if (isOwner) {
      document.getElementById('owner-tag-hud').style.display = 'block';
      buildSkinSelector();
      showToast('üëë Welcome back, Z3N0', 'gold');
    }
    initMusic();
    updateCoinDisplays();
  });

  socket.on('gameState', data => { gameState = data; hudDirty = true; });
  socket.on('orbEaten', ({ oid, newOrb }) => { delete orbsLocal[oid]; orbsLocal[newOrb.id] = newOrb; });
  socket.on('orbSpawned', orb => { orbsLocal[orb.id] = orb; });
  socket.on('orbFrenzy', orbs => { orbs.forEach(o => orbsLocal[o.id] = o); });

  socket.on('playerDied', ({ id, killerName, droppedOrbs }) => {
    if (droppedOrbs) droppedOrbs.forEach(o => orbsLocal[o.id] = o);
    if (id !== myPlayerId) addKillFeed(id, killerName);
  });

  socket.on('youDied', ({ killerName, coinsEarned }) => {
    myProfile.coins += (coinsEarned || 0);
    handleDeath(killerName, coinsEarned || 0);
  });

  socket.on('kicked', ({ reason }) => {
    socket.disconnect();
    showScreen('menuScreen');
    showToast('üö´ ' + (reason || 'Kicked.'), 'error');
    gameActive = false;
    document.getElementById('hud').style.display = 'none';
    document.getElementById('gameCanvas').style.display = 'none';
    document.getElementById('musicControls').style.display = 'none';
  });

  socket.on('systemMessage', d => showSystemMsg(typeof d==='string' ? d : d.message || ''));
  socket.on('skinGranted', ({ skin:s }) => { selectedSkin = s; showToast(`üé® Skin: ${SKINS[s]?.name||s}`, 'gold'); });
  socket.on('killConfirmed', ({ victimName }) => showToast(`üíÄ Eliminated ${victimName}`));

  socket.on('liveEvent', ev => {
    document.getElementById('eventBanner').textContent = ev.name;
    document.getElementById('eventBanner').style.display = 'block';
    document.getElementById('statEvent').style.display = 'inline';
    showToast('‚ö° ' + ev.name, 'gold');
  });
  socket.on('eventEnded', () => {
    document.getElementById('eventBanner').style.display = 'none';
    document.getElementById('statEvent').style.display = 'none';
    showToast('Event ended.');
  });

  socket.on('ownerBroadcast', ({ message }) => {
    document.getElementById('broadcastText').textContent = message;
    document.getElementById('broadcastBanner').style.display = 'block';
    setTimeout(() => document.getElementById('broadcastBanner').style.display = 'none', 8000);
  });

  socket.on('ownerSuccess', msg => { showOwnerAlert(msg,'success'); refreshPlayers(); });
  socket.on('ownerError',   msg => showOwnerAlert(msg,'error'));
  socket.on('playerList',   list => { currentPlayerList = list; renderPlayerTable(list); populateSelects(list); });

  socket.on('coinsGranted', ({ amount, newBalance }) => {
    myProfile.coins = newBalance; updateCoinDisplays();
    showToast(`üí∞ +${amount} coins!`, 'gold');
  });
  socket.on('cosmeticBought', ({ cosmeticId, newCoinBalance, unlockedCosmetics }) => {
    myProfile.coins = newCoinBalance; myProfile.unlockedCosmetics = unlockedCosmetics;
    updateCoinDisplays(); renderCosmeticsShop();
    showToast(`üé® Bought: ${cosmeticsCatalog[cosmeticId]?.name||cosmeticId}`, 'gold');
  });
  socket.on('cosmeticGranted', ({ unlockedCosmetics }) => {
    myProfile.unlockedCosmetics = unlockedCosmetics; renderCosmeticsShop(); showToast(`üé® Cosmetic granted!`, 'gold');
  });
  socket.on('cosmeticEquipped', ({ equippedTrail, equippedTitle, equippedBadge }) => {
    myProfile.equippedTrail = equippedTrail; myProfile.equippedTitle = equippedTitle; myProfile.equippedBadge = equippedBadge;
    updateEquippedDisplay(); renderCosmeticsShop();
  });
  socket.on('cosmeticError', msg => showToast(msg, 'error'));
  socket.on('disconnect', () => { if (gameActive) showToast('Disconnected.', 'error'); });
}

// ================================================================
//  GAME START / STOP
// ================================================================
function startGame() {
  gameActive = true;
  showScreen('game');
  document.getElementById('gameCanvas').style.display = 'block';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('musicControls').style.display = 'flex';
  document.getElementById('deathScreen').classList.add('hidden');
  document.getElementById('inGameCosmeticsBtn').style.display = 'block';
  setupCanvas();
  bgGradient = null; bgGradientCX = -1; bgGradientCY = -1; // reset cached gradient
  mmCtx = document.getElementById('minimapCanvas').getContext('2d');
  requestAnimationFrame(gameLoop);
}

function handleDeath(killerName, coinsEarned) {
  gameActive = false;
  const me = gameState.players[myPlayerId];
  myDeathScore  = me ? me.score || 0 : 0;
  myDeathLength = me ? (me.segments || []).length : 0;
  document.getElementById('deathKiller').textContent  = `Eliminated by ${killerName || 'the void'}`;
  document.getElementById('deathScore').textContent   = myDeathScore;
  document.getElementById('deathLength').textContent  = myDeathLength;
  document.getElementById('deathCoinsEarned').textContent = coinsEarned > 0 ? `üí∞ +${coinsEarned} coins earned` : '';
  const rank = (gameState.leaderboard || []).findIndex(e => e.id === myPlayerId);
  document.getElementById('deathRank').textContent = rank >= 0 ? '#'+(rank+1) : '‚Äî';
  document.getElementById('deathScreen').classList.remove('hidden');
  document.getElementById('inGameCosmeticsBtn').style.display = 'none';
}

document.getElementById('respawnBtn').onclick = () => {
  document.getElementById('deathScreen').classList.add('hidden');
  connectAndJoin(myName, selectedSkin, ownerPass);
};
document.getElementById('menuBtn').onclick = () => {
  document.getElementById('deathScreen').classList.add('hidden');
  document.getElementById('hud').style.display = 'none';
  document.getElementById('gameCanvas').style.display = 'none';
  document.getElementById('musicControls').style.display = 'none';
  document.getElementById('inGameCosmeticsBtn').style.display = 'none';
  showScreen('menuScreen');
  if (socket) { socket.disconnect(); socket = null; }
  gameActive = false;
};

// ================================================================
//  CANVAS
// ================================================================
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
function setupCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; bgGradient = null; }
window.addEventListener('resize', setupCanvas);

// Cursor
document.addEventListener('mousemove', e => {
  const c = document.getElementById('cursor');
  c.style.left = e.clientX + 'px'; c.style.top = e.clientY + 'px';
});

// ================================================================
//  INPUT
// ================================================================
let lastInputEmit = 0;
function emitInput() {
  const now = performance.now();
  if (now - lastInputEmit < 14) return;
  lastInputEmit = now;
  if (socket) socket.emit('input', { angle: myAngle, boosting });
}

canvas.addEventListener('mousemove', e => {
  if (!gameActive || !myPlayerId) return;
  if (controlScheme !== 'mouse' && !mouseAlways) return;
  const me = gameState.players[myPlayerId];
  if (!me?.segments?.length) return;
  const h = me.segments[0];
  myAngle = Math.atan2(e.clientY - (h.y - camY), e.clientX - (h.x - camX));
  emitInput();
});
canvas.addEventListener('mousedown', e => { if (e.button===0||e.button===2) { boosting=true; emitInput(); } });
canvas.addEventListener('mouseup', () => { boosting=false; emitInput(); });
canvas.addEventListener('contextmenu', e => e.preventDefault());

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  const t = e.touches[0];
  const me = gameState.players[myPlayerId];
  if (!me?.segments?.length) return;
  const h = me.segments[0];
  myAngle = Math.atan2(t.clientY - (h.y - camY), t.clientX - (h.x - camX));
  emitInput();
}, { passive:false });
canvas.addEventListener('touchstart', () => { boosting=true; emitInput(); });
canvas.addEventListener('touchend',   () => { boosting=false; emitInput(); });

const keys = {};
document.addEventListener('keydown', e => {
  keys[e.key] = true;
  if (e.key==='F1' || (e.ctrlKey&&e.key==='o')) { e.preventDefault(); if(isOwner) openOwnerPanel(); return; }
  if (e.key==='Escape') { document.getElementById('ownerPanel').classList.add('hidden'); document.getElementById('ingameCosmeticsPanel').style.display='none'; return; }
  if (!gameActive || !socket) return;
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
  if ((e.key==='Shift'&&(boostKey==='shift'||boostKey==='both_boost')) ||
      (e.key===' '    &&(boostKey==='space'||boostKey==='both_boost'))) {
    boosting=true; emitInput();
  }
});
document.addEventListener('keyup', e => {
  keys[e.key] = false;
  if (!gameActive || !socket) return;
  if ((e.key==='Shift'&&(boostKey==='shift'||boostKey==='both_boost')) ||
      (e.key===' '    &&(boostKey==='space'||boostKey==='both_boost'))) {
    boosting=false; emitInput();
  }
});

function handleKeyboardSteering() {
  if (!gameActive || controlScheme==='mouse') return;
  const useWASD   = controlScheme==='wasd'   || controlScheme==='both';
  const useArrows = controlScheme==='arrows' || controlScheme==='both';
  const L = (useWASD&&(keys['a']||keys['A'])) || (useArrows&&keys['ArrowLeft']);
  const R = (useWASD&&(keys['d']||keys['D'])) || (useArrows&&keys['ArrowRight']);
  const U = (useWASD&&(keys['w']||keys['W'])) || (useArrows&&keys['ArrowUp']);
  const D = (useWASD&&(keys['s']||keys['S'])) || (useArrows&&keys['ArrowDown']);
  if (!L&&!R&&!U&&!D) return;
  let dx = (R?1:0)-(L?1:0), dy = (D?1:0)-(U?1:0);
  if (dx||dy) {
    const target = Math.atan2(dy, dx);
    let diff = target - myAngle;
    while (diff > Math.PI)  diff -= Math.PI*2;
    while (diff < -Math.PI) diff += Math.PI*2;
    myAngle += Math.sign(diff) * Math.min(Math.abs(diff), 0.2);
    emitInput();
  }
}

// ================================================================
//  RENDERING
// ================================================================
let lastFrame = 0;

function gameLoop(ts) {
  if (!gameActive) return;
  requestAnimationFrame(gameLoop);

  const dt = ts - lastFrame;
  if (dt < 14) return; // cap at ~70fps
  lastFrame = ts;

  frameCount++;
  rainbowT += 0.02;
  handleKeyboardSteering();

  // Smooth camera
  const me = gameState.players[myPlayerId];
  if (me?.segments?.length) {
    const h = me.segments[0];
    const tx = h.x - canvas.width  * 0.5;
    const ty = h.y - canvas.height * 0.5;
    camX += (tx - camX) * 0.12;
    camY += (ty - camY) * 0.12;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBackground();
  drawGrid();
  drawOrbs();

  // Draw other snakes first, then self (self always on top)
  for (const pid in gameState.players) if (pid !== myPlayerId) drawSnake(gameState.players[pid], false);
  if (gameState.players[myPlayerId]) drawSnake(gameState.players[myPlayerId], true);

  drawBorder();

  // HUD DOM updates throttled to every 4 frames
  if (frameCount % 4 === 0 || hudDirty) {
    updateHUD();
    hudDirty = false;
  }
  // Minimap every 6 frames
  if (frameCount % 6 === 0) drawMinimap();
}

// ‚îÄ‚îÄ Background (static gradient, only recalculate if camera moved far) ‚îÄ‚îÄ
function drawBackground() {
  ctx.fillStyle = '#03030d';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const mcx = (MAP_SIZE/2 - camX) | 0;
  const mcy = (MAP_SIZE/2 - camY) | 0;
  const distMoved = Math.abs(mcx - bgGradientCX) + Math.abs(mcy - bgGradientCY);

  if (!bgGradient || distMoved > 80) {
    bgGradient = ctx.createRadialGradient(mcx, mcy, 0, mcx, mcy, MAP_SIZE * 0.55);
    bgGradient.addColorStop(0, 'rgba(0,90,45,0.07)');
    bgGradient.addColorStop(1, 'rgba(0,0,0,0)');
    bgGradientCX = mcx; bgGradientCY = mcy;
  }
  ctx.fillStyle = bgGradient;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

// ‚îÄ‚îÄ Grid ‚îÄ‚îÄ
function drawGrid() {
  const gs = 80;
  const ox = ((-camX % gs) + gs) % gs;
  const oy = ((-camY % gs) + gs) % gs;
  ctx.save();
  ctx.strokeStyle = 'rgba(0,255,140,0.035)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let x = ox; x < canvas.width;  x += gs) { ctx.moveTo(x,0); ctx.lineTo(x, canvas.height); }
  for (let y = oy; y < canvas.height; y += gs) { ctx.moveTo(0,y); ctx.lineTo(canvas.width, y); }
  ctx.stroke();
  ctx.restore();
}

// ‚îÄ‚îÄ Orbs ‚Äî batched by color to minimize state changes ‚îÄ‚îÄ
function drawOrbs() {
  // Group orbs by color for batch rendering
  const byColor = {};
  for (const oid in orbsLocal) {
    const o = orbsLocal[oid];
    const sx = o.x - camX, sy = o.y - camY;
    if (sx < -20 || sx > canvas.width+20 || sy < -20 || sy > canvas.height+20) continue;
    if (!byColor[o.color]) byColor[o.color] = [];
    byColor[o.color].push({ sx, sy, r: o.size * (Math.sin(frameCount*0.07 + o.x*0.007)*0.2 + 0.88) });
  }

  ctx.save();
  for (const [color, items] of Object.entries(byColor)) {
    // Glow pass (all at once per color)
    ctx.globalAlpha = 0.15;
    ctx.fillStyle = color;
    for (const { sx, sy, r } of items) {
      ctx.beginPath(); ctx.arc(sx, sy, r * 2.0, 0, Math.PI*2); ctx.fill();
    }
    // Core pass
    ctx.globalAlpha = 1;
    ctx.fillStyle = color;
    for (const { sx, sy, r } of items) {
      ctx.beginPath(); ctx.arc(sx, sy, r, 0, Math.PI*2); ctx.fill();
    }
    // Highlight (white dot)
    ctx.globalAlpha = 0.55;
    ctx.fillStyle = '#ffffff';
    for (const { sx, sy, r } of items) {
      ctx.beginPath(); ctx.arc(sx - r*0.28, sy - r*0.28, r*0.32, 0, Math.PI*2); ctx.fill();
    }
  }
  ctx.globalAlpha = 1;
  ctx.restore();
}

// ‚îÄ‚îÄ Snake colors ‚îÄ‚îÄ
function skinColors(p) {
  const s = SKINS[p.grantedSkin || p.skin] || SKINS.classic;
  if (s.colors[0] === 'rainbow') {
    const h = (rainbowT * 60) % 360;
    return [`hsl(${h},100%,50%)`, `hsl(${(h+60)%360},100%,58%)`];
  }
  return s.colors;
}
function skinGlow(p) {
  const s = SKINS[p.grantedSkin || p.skin] || SKINS.classic;
  if (s.colors[0]==='rainbow') return `hsl(${(rainbowT*60)%360},100%,58%)`;
  return s.glow;
}

// ‚îÄ‚îÄ Snake drawing ‚îÄ‚îÄ
// KEY FIX: We cannot change lineWidth mid-path. Instead we draw multiple
// sub-paths of uniform width, grouped by width band. Or we draw each
// segment as a circle (correct but expensive). Best approach: draw
// overlapping circles only for on-screen segments, skipping off-screen ones.
function drawSnake(player, isMe) {
  const segs = player.segments;
  if (!segs || segs.length < 2) return;

  const [c1, c2] = skinColors(player);
  const glow = skinGlow(player);
  const w = player.width || 8;

  // Screen bounds check (quick cull)
  const h0 = segs[0];
  const hsx = h0.x - camX, hsy = h0.y - camY;
  const margin = w * 3 + 50;
  // If head is off screen by a lot, check tail too before culling
  if (hsx < -margin || hsx > canvas.width+margin || hsy < -margin || hsy > canvas.height+margin) {
    const tail = segs[segs.length-1];
    const tx = tail.x - camX, ty = tail.y - camY;
    if (tx < -margin || tx > canvas.width+margin || ty < -margin || ty > canvas.height+margin) return;
  }

  ctx.save();
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  // Body: draw as a series of same-width strokes grouped by color segment
  // We render from tail to head so head draws on top
  // Step: skip alternate segs for long snakes
  const skip = segs.length > 180 ? 3 : segs.length > 80 ? 2 : 1;

  // Build groups of consecutive same-color segments
  let path = [];
  let lastColorIdx = -1;

  function flushPath(colorIdx, segWidth, alpha) {
    if (path.length < 2) { path = []; return; }
    ctx.globalAlpha = alpha;
    ctx.strokeStyle = colorIdx === 0 ? c1 : c2;
    ctx.lineWidth   = segWidth * 2;
    ctx.beginPath();
    ctx.moveTo(path[0].x, path[0].y);
    for (let i = 1; i < path.length; i++) ctx.lineTo(path[i].x, path[i].y);
    ctx.stroke();
    path = [];
  }

  // Glow only on self / owner ‚Äî one big blur pass over first 10 segs
  if (isMe || player.isOwner) {
    ctx.shadowColor = glow; ctx.shadowBlur = 12;
    ctx.strokeStyle = glow; ctx.globalAlpha = 0.25; ctx.lineWidth = w * 2.5;
    ctx.beginPath();
    const n = Math.min(10, segs.length);
    ctx.moveTo(segs[0].x - camX, segs[0].y - camY);
    for (let i = 1; i < n; i++) ctx.lineTo(segs[i].x - camX, segs[i].y - camY);
    ctx.stroke();
    ctx.shadowBlur = 0; ctx.globalAlpha = 1;
  }

  // Render body in color groups (tail ‚Üí head)
  let prevColorIdx = -99, prevW = 0;
  path = [];
  for (let i = segs.length - 1; i >= 0; i -= skip) {
    const seg = segs[i];
    const sx = seg.x - camX, sy = seg.y - camY;
    if (sx < -w-30 || sx > canvas.width+w+30 || sy < -w-30 || sy > canvas.height+w+30) {
      if (path.length) {
        const alpha = 0.35 + 0.65 * (1 - (i / segs.length) * 0.45);
        flushPath(prevColorIdx, prevW, alpha);
      }
      continue;
    }
    const t = i / segs.length;
    const segW = Math.max(2, w * (1 - t * 0.38));
    const colorIdx = (Math.floor(i / 3) % 2);
    if (colorIdx !== prevColorIdx || Math.abs(segW - prevW) > 1) {
      if (path.length > 0) {
        const alpha = 0.35 + 0.65 * (1 - (i / segs.length) * 0.45);
        flushPath(prevColorIdx, prevW, alpha);
        path.push({ x: sx, y: sy }); // start new path from last point
      }
      prevColorIdx = colorIdx; prevW = segW;
    }
    path.push({ x: sx, y: sy });
  }
  if (path.length) flushPath(prevColorIdx, prevW, 1);
  ctx.globalAlpha = 1;

  // Trail cosmetic (particle trail behind snake)
  if (player.equippedTrail && frameCount % 2 === 0) {
    const trailPal = { trail_fire:'#ff4400', trail_ice:'#00ccff', trail_gold:'#ffd700', trail_void:'#aa00ff', trail_electric:'#00ffff', owner_trail:'#ffd700' };
    const tc = player.equippedTrail === 'trail_rainbow'
      ? `hsl(${(rainbowT*60)%360},100%,60%)` : (trailPal[player.equippedTrail] || '#fff');
    const end = Math.min(18, segs.length);
    ctx.fillStyle = tc + 'cc';
    for (let i = 3; i < end; i += 2) {
      const seg = segs[i];
      const sx = seg.x - camX, sy = seg.y - camY;
      if (sx < -30 || sx > canvas.width+30 || sy < -30 || sy > canvas.height+30) continue;
      ctx.globalAlpha = 0.6 * (1 - i/end);
      ctx.beginPath();
      ctx.arc(sx + (Math.random()-.5)*5, sy + (Math.random()-.5)*5, 2.5, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  // Boost particles
  if (player.boosting && segs.length > 3 && frameCount % 2 === 0) {
    ctx.fillStyle = glow + '99';
    for (let i = 1; i < 5; i++) {
      if (Math.random() < 0.5) continue;
      const seg = segs[Math.min(i+1, segs.length-1)];
      const sx = seg.x - camX, sy = seg.y - camY;
      ctx.beginPath(); ctx.arc(sx+(Math.random()-.5)*14, sy+(Math.random()-.5)*14, 2, 0, Math.PI*2); ctx.fill();
    }
  }

  // Head
  if (isMe || player.isOwner) { ctx.shadowColor = glow; ctx.shadowBlur = 18; }
  ctx.beginPath();
  ctx.arc(hsx, hsy, w, 0, Math.PI*2);
  ctx.fillStyle = c1; ctx.globalAlpha = 1; ctx.fill();
  ctx.shadowBlur = 0;

  // Eyes
  const ang = player.angle || 0;
  const ed = w * 0.52, eyeR = w * 0.28;
  const ex1 = hsx + Math.cos(ang - 0.55) * ed;
  const ey1 = hsy + Math.sin(ang - 0.55) * ed;
  const ex2 = hsx + Math.cos(ang + 0.55) * ed;
  const ey2 = hsy + Math.sin(ang + 0.55) * ed;
  ctx.fillStyle = '#ffffff'; ctx.globalAlpha = 1;
  ctx.beginPath(); ctx.arc(ex1, ey1, eyeR, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(ex2, ey2, eyeR, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.arc(ex1 + Math.cos(ang)*0.7, ey1 + Math.sin(ang)*0.7, eyeR * 0.5, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(ex2 + Math.cos(ang)*0.7, ey2 + Math.sin(ang)*0.7, eyeR * 0.5, 0, Math.PI*2); ctx.fill();

  // Owner crown
  if (player.isOwner) {
    ctx.font = `${w*1.5}px serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
    ctx.globalAlpha = 1; ctx.fillText('üëë', hsx, hsy - w);
  }

  ctx.restore();

  // Name tag (outside save/restore)
  if (hsx > -120 && hsx < canvas.width+120 && hsy > -120 && hsy < canvas.height+120) {
    const badge = player.equippedBadge || '';
    const titleTxt = player.equippedTitle || '';
    const botMark  = player.isBot ? ' ü§ñ' : '';
    const nameStr  = (player.isOwner ? 'üëë ' : '') + badge + (player.name || 'Snake') + botMark;
    const ny = hsy - w - 6;

    ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';

    if (titleTxt) {
      ctx.font = 'bold 10px Orbitron,monospace';
      const tw = ctx.measureText(titleTxt).width;
      ctx.fillStyle = 'rgba(0,0,0,0.65)';
      ctx.fillRect(hsx - tw/2 - 5, ny - 28, tw + 10, 14);
      ctx.fillStyle = player.isOwner ? '#ffd700' : '#aa44ff';
      ctx.fillText(titleTxt, hsx, ny - 16);
    }

    const nf = `bold ${Math.max(10, w + 3)}px Rajdhani,sans-serif`;
    ctx.font = nf;
    const nw = ctx.measureText(nameStr).width;
    ctx.fillStyle = 'rgba(0,0,0,0.62)';
    ctx.fillRect(hsx - nw/2 - 4, ny - 14, nw + 8, 15);
    ctx.fillStyle = player.isBot ? 'rgba(190,190,210,0.8)' : player.isOwner ? '#ffd700' : isMe ? '#ffffff' : '#ccffdd';
    ctx.fillText(nameStr, hsx, ny);
    ctx.textBaseline = 'alphabetic';
  }
}

// ‚îÄ‚îÄ Border ‚îÄ‚îÄ
function drawBorder() {
  const bx = -camX, by = -camY;
  ctx.save();
  ctx.setLineDash([20, 10]);
  ctx.strokeStyle = 'rgba(255,34,68,0.55)'; ctx.lineWidth = 4;
  ctx.strokeRect(bx, by, MAP_SIZE, MAP_SIZE);
  ctx.setLineDash([]);
  ctx.shadowColor = '#ff2244'; ctx.shadowBlur = 12;
  ctx.strokeStyle = 'rgba(255,34,68,0.25)'; ctx.lineWidth = 10;
  ctx.strokeRect(bx, by, MAP_SIZE, MAP_SIZE);
  ctx.restore();
}

// ================================================================
//  HUD
// ================================================================
let lastScore = -1, lastLength = -1, lastCoins = -1, lastBoost = -1;

function updateHUD() {
  const me = gameState.players[myPlayerId];
  if (me) {
    const sc = me.score || 0, ln = (me.segments||[]).length;
    const coins = myProfile.coins + (me.sessionCoins || 0);
    if (sc !== lastScore)   { document.getElementById('scoreVal').textContent  = sc;    lastScore  = sc; }
    if (ln !== lastLength)  { document.getElementById('lengthVal').textContent = ln;    lastLength = ln; }
    if (coins !== lastCoins){ document.getElementById('hudCoins').textContent  = coins; lastCoins  = coins; }

    boosting ? (boostEnergy = Math.max(0, boostEnergy - 0.5)) : (boostEnergy = Math.min(100, boostEnergy + 0.3));
    const bf = boostEnergy | 0;
    if (bf !== lastBoost) { document.getElementById('boost-fill').style.width = bf + '%'; lastBoost = bf; }
    sessionCoinsDisplay = me.sessionCoins || 0;
  }

  const lb = gameState.leaderboard || [];
  let lbHTML = '';
  lb.forEach((e, i) => {
    const rs  = i===0?'top1':i===1?'top2':i===2?'top3':'';
    const sym = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'#'+(i+1);
    const title = e.equippedTitle ? `<span style="font-size:8px;color:#aa44ff;">${e.equippedTitle} </span>` : '';
    const bot   = e.isBot ? `<span class="lb-bot">BOT</span>` : '';
    lbHTML += `<div class="lb-entry"><div class="lb-rank ${rs}">${sym}</div><div class="lb-name${e.isOwner?' is-owner':''}">${title}${e.isOwner?'üëë ':''}${e.equippedBadge||''}${e.name}${bot}</div><div class="lb-len">${e.length}</div></div>`;
  });
  document.getElementById('lbList').innerHTML = lbHTML;
}

function drawMinimap() {
  if (!mmCtx) return;
  const W = 120, H = 120, scale = W / MAP_SIZE;
  mmCtx.fillStyle = 'rgba(0,0,8,0.9)';
  mmCtx.fillRect(0, 0, W, H);

  // Orbs as 1x1 pixel dots
  for (const oid in orbsLocal) {
    const o = orbsLocal[oid];
    mmCtx.fillStyle = o.color;
    mmCtx.fillRect(o.x * scale | 0, o.y * scale | 0, 1, 1);
  }

  // Player dots
  for (const pid in gameState.players) {
    const p = gameState.players[pid];
    if (!p.segments?.length) continue;
    const h = p.segments[0];
    const r = pid === myPlayerId ? 4 : 2.5;
    mmCtx.fillStyle = pid===myPlayerId ? '#00ff8c' : p.isOwner ? '#ffd700' : '#ffffff88';
    mmCtx.beginPath(); mmCtx.arc(h.x * scale, h.y * scale, r, 0, Math.PI*2); mmCtx.fill();
  }
  // Viewport rect
  const vx = camX * scale, vy = camY * scale;
  const vw = canvas.width * scale, vh = canvas.height * scale;
  mmCtx.strokeStyle = 'rgba(0,255,140,0.5)'; mmCtx.lineWidth = 1;
  mmCtx.strokeRect(vx, vy, vw, vh);
  // Border
  mmCtx.strokeStyle = 'rgba(255,34,68,0.5)'; mmCtx.lineWidth = 1;
  mmCtx.strokeRect(0, 0, W, H);
}

// ================================================================
//  KILL FEED
// ================================================================
function addKillFeed(killedId, killerName) {
  const killedName = gameState.players[killedId]?.name || 'Someone';
  const kf = document.getElementById('killfeed');
  const el = document.createElement('div');
  el.className = 'kf-entry';
  el.innerHTML = `<span style="color:#aaa">${killedName}</span> <span style="color:#ff2244">‚úï</span> <span style="color:#00ff8c">${killerName}</span>`;
  kf.appendChild(el);
  setTimeout(() => el.remove(), 5000);
}

// ================================================================
//  TOAST / MESSAGES
// ================================================================
function showSystemMsg(msg) {
  const el = document.getElementById('sysmsg');
  el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}
function showToast(msg, type) {
  const t = document.createElement('div');
  t.className = 'toast' + (type ? ' '+type : '');
  t.textContent = msg;
  document.getElementById('toast-container').appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 2500);
}
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  if (name === 'menuScreen') document.getElementById('menuScreen').classList.remove('hidden');
}

// ================================================================
//  COSMETICS
// ================================================================
function updateCoinDisplays() {
  const total = myProfile.coins + sessionCoinsDisplay;
  document.getElementById('menuCoinBalance').textContent   = myProfile.coins;
  document.getElementById('ingameCoinBalance').textContent = total;
  updateEquippedDisplay();
}
function updateEquippedDisplay() {
  const c = cosmeticsCatalog;
  document.getElementById('equippedTrailDisplay').textContent = myProfile.equippedTrail ? (c[myProfile.equippedTrail]?.name || myProfile.equippedTrail) : 'None';
  document.getElementById('equippedTitleDisplay').textContent = myProfile.equippedTitle || 'None';
  document.getElementById('equippedBadgeDisplay').textContent = myProfile.equippedBadge || '‚Äî';
}
function openIngameCosmetics()  { document.getElementById('ingameCosmeticsPanel').style.display = 'block';  updateCoinDisplays(); renderCosmeticsShop(); }
function closeIngameCosmetics() { document.getElementById('ingameCosmeticsPanel').style.display = 'none'; }

function renderCosmeticsShop() {
  const cont = document.getElementById('cosmeticsShopContent');
  const cat  = cosmeticsCatalog;
  if (!Object.keys(cat).length) { cont.innerHTML = '<p style="color:var(--dim);text-align:center;padding:20px;">Connect to load cosmetics.</p>'; return; }

  const sections = { trail:'üî• TRAILS', title:'üìõ TITLES', badge:'üèÖ BADGES', owner:'üëë OWNER' };
  let html = '';

  for (const [type, label] of Object.entries(sections)) {
    const items = Object.values(cat).filter(c => c.type === type);
    if (!items.length) continue;
    html += `<div class="cosmetic-section-label">${label}</div><div class="cosmetic-grid">`;

    for (const c of items) {
      const owned    = isOwner || myProfile.unlockedCosmetics.includes(c.id);
      const equipped = (c.type==='trail'&&myProfile.equippedTrail===c.id)
                    || (c.type==='title'&&myProfile.equippedTitle===c.text)
                    || (c.type==='badge'&&myProfile.equippedBadge===c.emoji)
                    || (c.type==='owner'&&(myProfile.equippedTrail===c.id||myProfile.equippedTitle===c.text));
      const ownerOnly = !!c.ownerOnly;
      const totalCoins = myProfile.coins + sessionCoinsDisplay;

      let cls = 'cosmetic-card' + (equipped?' equipped':owned?' owned':ownerOnly?' owner-only locked-shop':' locked-shop');
      let btn = '';
      if (equipped)   btn = `<button onclick="doUnequip('${c.type}')" style="margin-top:5px;width:100%;padding:3px;background:rgba(255,34,68,.12);border:1px solid rgba(255,34,68,.28);border-radius:2px;color:#ff4466;font-size:8px;cursor:pointer;font-family:Orbitron,monospace;">UNEQUIP</button>`;
      else if (owned) btn = `<button onclick="doEquip('${c.id}')" style="margin-top:5px;width:100%;padding:3px;background:rgba(0,255,140,.07);border:1px solid rgba(0,255,140,.25);border-radius:2px;color:var(--glow);font-size:8px;cursor:pointer;font-family:Orbitron,monospace;">EQUIP</button>`;
      else if (ownerOnly) btn = `<div style="margin-top:5px;font-size:8px;color:rgba(255,215,0,.4);text-align:center;">OWNER ONLY</div>`;
      else {
        const afford = totalCoins >= c.price;
        btn = `<button onclick="doBuy('${c.id}')" style="margin-top:5px;width:100%;padding:3px;background:${afford?'rgba(255,215,0,.1)':'rgba(255,255,255,.03)'};border:1px solid ${afford?'rgba(255,215,0,.3)':'rgba(255,255,255,.1)'};border-radius:2px;color:${afford?'var(--gold)':'rgba(255,255,255,.2)'};font-size:8px;cursor:${afford?'pointer':'not-allowed'};font-family:Orbitron,monospace;">${c.price} üí∞</button>`;
      }

      html += `<div class="${cls}">${equipped?'<div class="equipped-label">‚úì</div>':''}${ownerOnly?'<div class="cosmetic-badge">üëë</div>':''}
        <span class="cosmetic-icon">${c.emoji}</span>
        <div class="cosmetic-name">${c.name}</div>${btn}</div>`;
    }
    html += '</div>';
  }
  cont.innerHTML = html;
}

function doBuy(id)    { if(socket) socket.emit('buyCosmetic',{cosmeticId:id}); }
function doEquip(id)  { if(socket) socket.emit('equipCosmetic',{cosmeticId:id}); }
function doUnequip(s) { if(socket) socket.emit('unequipCosmetic',{slot:s}); }

// ================================================================
//  OWNER PANEL
// ================================================================
document.getElementById('closeOwnerPanel').onclick = () => document.getElementById('ownerPanel').classList.add('hidden');
document.querySelectorAll('.owner-nav-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.owner-nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.owner-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    const tab = document.getElementById('tab-' + btn.dataset.tab);
    if (tab) tab.classList.add('active');
    if (['players','actions','skins','ownercosmetics'].includes(btn.dataset.tab)) refreshPlayers();
    updateOwnerStats();
  };
});

function openOwnerPanel() {
  document.getElementById('ownerPanel').classList.remove('hidden');
  updateOwnerStats(); refreshPlayers();
}
document.getElementById('owner-tag-hud').onclick = openOwnerPanel;

document.getElementById('ownerToggleBtn').addEventListener('dblclick', () => {
  const p = document.getElementById('ownerPass').value;
  if (p === 'Z3N0ISKING') { isOwner=true; buildSkinSelector(); openOwnerPanel(); }
});

function updateOwnerStats() {
  fetch('/api/stats').then(r=>r.json()).then(d => {
    document.getElementById('os-players').textContent = d.players;
    document.getElementById('os-orbs').textContent    = d.orbs;
    document.getElementById('os-event').textContent   = d.activeEvent || 'NONE';
  }).catch(()=>{});
}
function refreshPlayers() {
  if (!socket) return;
  socket.emit('ownerAction', { action:'getPlayers', password: ownerPass || 'Z3N0ISKING' });
}
function renderPlayerTable(list) {
  const tb = document.getElementById('playerTableBody');
  if (!list.length) { tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:rgba(255,215,0,.3);padding:20px;">No players</td></tr>'; return; }
  tb.innerHTML = list.map(p => `<tr>
    <td><span style="color:${p.isOwner?'#ffd700':'rgba(255,215,0,.8)'}">${p.isOwner?'üëë ':''}${p.name}${p.isBot?' ü§ñ':''}</span></td>
    <td style="font-family:Space Mono;font-size:11px;color:rgba(255,215,0,.55);">${p.length}</td>
    <td style="font-family:Space Mono;font-size:11px;color:rgba(255,215,0,.55);">${p.score}</td>
    <td style="font-family:Space Mono;font-size:11px;color:var(--gold);">üí∞${p.coins||0}</td>
    <td style="font-size:10px;color:rgba(255,215,0,.45);">${p.equippedBadge||''} ${p.equippedTitle||''} ${p.equippedTrail?'üé®':''}</td>
    <td><div style="display:flex;gap:3px;flex-wrap:wrap;">
      <button class="btn btn-danger btn-sm" onclick="quickKill('${p.id}','${esc(p.name)}')">‚ò†Ô∏è</button>
      ${!p.isBot?`<button class="btn btn-sm" style="border:1px solid rgba(255,34,68,.3);color:rgba(255,34,68,.6);padding:5px 7px;font-size:8px;" onclick="quickKick('${p.id}','${esc(p.name)}')">üö´</button>`:''}
      <button class="btn btn-gold btn-sm" onclick="quickSize('${p.id}','${esc(p.name)}')">üìè</button>
      ${!p.isBot?`<button class="btn btn-gold btn-sm" onclick="quickCoins('${p.id}','${esc(p.name)}')">üí∞</button>`:''}
    </div></td>
  </tr>`).join('');
}
function esc(s) { return s.replace(/'/g,"\\'").replace(/"/g,'&quot;'); }
function populateSelects(list) {
  ['sizeTarget','coinsTarget','swapP1','swapP2','kickTarget','killTarget','skinTarget','ownerCosmeticTarget'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    el.innerHTML = list.map(p => `<option value="${p.id}">${p.isOwner?'üëë ':''}${p.name} (${p.length})</option>`).join('');
  });
}
function showOwnerAlert(msg, type) {
  const el = document.getElementById('ownerAlert');
  el.textContent = msg; el.className = 'o-alert ' + type; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}
function ownerAction(action, value, targetId) {
  if (!socket) { showToast('Not connected','error'); return; }
  socket.emit('ownerAction', { action, value, targetId, password: ownerPass || 'Z3N0ISKING' });
}
function doGiveSize()    { ownerAction('giveSize',    document.getElementById('sizeAmount').value,   document.getElementById('sizeTarget').value); }
function doGiveCoins()   { ownerAction('giveCoins',   document.getElementById('coinsAmount').value,  document.getElementById('coinsTarget').value); }
function doSwapSize()    { ownerAction('swapSize',     document.getElementById('swapP2').value,       document.getElementById('swapP1').value); }
function doKick()        { ownerAction('kick',         document.getElementById('kickReason').value||'Kicked by owner.', document.getElementById('kickTarget').value); }
function doInstaKill()   { ownerAction('instaKill',    null,                                           document.getElementById('killTarget').value); }
function doGiveSkin()    { ownerAction('giveSkin',     document.getElementById('skinToGive').value,   document.getElementById('skinTarget').value); }
function doGiveCosmetic(){ ownerAction('giveCosmetic', document.getElementById('ownerCosmeticToGive').value, document.getElementById('ownerCosmeticTarget').value); }
function doBroadcast()   { const m=document.getElementById('broadcastMsg').value.trim(); if(!m)return; ownerAction('broadcast',m); document.getElementById('broadcastMsg').value=''; }

function quickKill (id,n) { if(!confirm(`Kill ${n}?`))return;    ownerAction('instaKill',null,id); }
function quickKick (id,n) { const r=prompt(`Kick reason for ${n}:`,'Kicked by Z3N0'); if(r===null)return; ownerAction('kick',r,id); }
function quickSize (id,n) { const a=prompt(`Give size to ${n}:`,'50'); if(!a)return; ownerAction('giveSize',a,id); }
function quickCoins(id,n) { const a=prompt(`Give coins to ${n}:`,'500'); if(!a)return; ownerAction('giveCoins',a,id); }

// ================================================================
//  MENU STATS + HOW TO
// ================================================================
setInterval(() => {
  fetch('/api/stats').then(r=>r.json()).then(d => {
    document.getElementById('statPlayers').textContent = d.players;
    document.getElementById('statBots').textContent    = d.bots || 0;
    document.getElementById('statOrbs').textContent    = d.orbs;
    document.getElementById('statEvent').style.display = d.activeEvent ? 'inline' : 'none';
  }).catch(()=>{});
}, 3000);

document.getElementById('howToBtn').onclick = () => {
  const bk = boostKey==='shift'?'Shift':boostKey==='space'?'Space':'Shift/Space';
  alert(`üêç Z3N0 SNAKE REALM ‚Äî HOW TO PLAY\n\nControls: ${controlScheme.toUpperCase()}\n${controlScheme==='mouse'?'Move mouse to steer':'Use '+controlScheme.toUpperCase()+' keys to steer'}\nHold Click or ${bk} to BOOST\n\n‚Ä¢ Eat glowing orbs to grow & earn coins\n‚Ä¢ Kill others by making them hit your body\n‚Ä¢ Avoid the red border ‚Äî instant death\n‚Ä¢ Boosting sheds orbs & shrinks you slightly\n\nüí∞ COINS: Buy trails, titles & badges in Cosmetics\nüëë Owner panel: F1 key`);
};

// ================================================================
//  MENU PARTICLES
// ================================================================
(function spawnParticles() {
  const c = document.getElementById('bgParticles');
  for (let i = 0; i < 25; i++) {
    const p = document.createElement('div');
    p.className = 'mp';
    p.style.cssText = `left:${Math.random()*100}%;animation-duration:${4+Math.random()*10}s;animation-delay:${Math.random()*8}s;width:${Math.random()<0.3?3:2}px;height:${Math.random()<0.3?3:2}px;opacity:${0.3+Math.random()*0.5};`;
    c.appendChild(p);
  }
})();

// ================================================================
//  INIT
// ================================================================
updateBoostLabel();
document.getElementById('nameInput').focus();
</script>
</body>
</html>
